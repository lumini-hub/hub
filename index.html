<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumini - Social</title>
    <link rel="icon" href="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" type="image/x-icon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script>
        // Immediate Dark Mode Check
        if (localStorage.getItem('lumini_theme') === 'dark' || (!('lumini_theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        lumini: {
                            blue: '#2563eb',
                            purple: '#9333ea',
                            dark: '#0f172a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-short': 'bounceShort 0.5s ease-in-out 1',
                        'gradient-x': 'gradient-x 3s ease infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        popIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        bounceShort: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' },
                        },
                        'gradient-x': {
                            '0%, 100%': {
                                'background-size':'200% 200%',
                                'background-position': 'left center'
                            },
                            '50%': {
                                'background-size':'200% 200%',
                                'background-position': 'right center'
                            },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        floatUp: {
                            '0%': { transform: 'translateY(0) scale(1)', opacity: '1' },
                            '100%': { transform: 'translateY(-200px) scale(1.5)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255, 255, 255, 0.3); }
        .glass-card { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .glass-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025); }
        
        /* Collapsible Section Styles - Hover to expand */
        .collapsible-section { position: relative; }
        .collapsible-header { display: flex; align-items: center; justify-content: space-between; cursor: default; padding: 10px 14px; border-radius: 12px; transition: background-color 0.2s ease; user-select: none; }
        .collapsible-header h4 { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; margin: 0; }
        .collapsible-chevron { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #94a3b8; font-size: 0.7rem; }
        .collapsible-chevron.collapsed { transform: rotate(-90deg); }
        .collapsible-body { overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, padding 0.3s ease; max-height: 1000px; opacity: 1; }
        .collapsible-body.collapsed { max-height: 0 !important; opacity: 0; padding-top: 0 !important; padding-bottom: 0 !important; }
        html.dark .collapsible-header h4 { color: #64748b; }

        /* Slide-out sidebar overlays */
        .sidebar-overlay {
            position: fixed;
            top: 40px;
            bottom: 0;
            width: 280px;
            z-index: 40;
            transform: translateX(0);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, top 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding: 16px 12px;
        }
        .sidebar-overlay.left-panel { left: 0; transform: translateX(-100%); }
        .sidebar-overlay.right-panel { right: 0; transform: translateX(100%); }
        .sidebar-overlay.left-panel.open { transform: translateX(0); }
        .sidebar-overlay.right-panel.open { transform: translateX(0); }

        /* Hover trigger zones on edges */
        .sidebar-trigger {
            position: fixed;
            top: 40px;
            bottom: 0;
            width: 18px;
            z-index: 39;
            cursor: pointer;
            transition: top 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar-trigger.left-trigger { left: 0; }
        .sidebar-trigger.right-trigger { right: 0; }
        .sidebar-trigger-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 48px;
            border-radius: 4px;
            background: rgba(148, 163, 184, 0.3);
            transition: all 0.3s ease;
        }
        .left-trigger .sidebar-trigger-indicator { left: 6px; }
        .right-trigger .sidebar-trigger-indicator { right: 6px; }
        .sidebar-trigger:hover .sidebar-trigger-indicator {
            background: rgba(30, 41, 59, 0.4);
            height: 64px;
            width: 5px;
        }

        html.dark .sidebar-overlay { background: rgba(15, 23, 42, 0.95); }
        .sidebar-overlay { background: rgba(248, 250, 252, 0.97); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0,0,0,0.1); }

        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; font-weight: 500; font-size: 0.95rem; color: #64748b; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; overflow: hidden; }
        .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.6); color: #1e293b; transform: translateX(3px); }
        .sidebar-link:active { transform: scale(0.98); }
        .sidebar-link i { width: 24px; font-size: 1.2rem; transition: transform 0.3s ease; }
        .sidebar-link:hover i { transform: scale(1.1); }
        .sidebar-link.active { background-color: white; color: #1e293b; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        body { background-color: #fafafa; background-image: none; background-attachment: fixed; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; border: 2px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        .text-gradient { background: linear-gradient(to right, #1e293b, #475569); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .bg-gradient-lumini { background: linear-gradient(135deg, #1e293b, #334155); }
        
        #toast { visibility: hidden; min-width: 250px; background-color: rgba(15, 23, 42, 0.9); backdrop-filter: blur(4px); color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%) translateY(20px); font-size: 14px; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); bottom: 50px; }
        
        /* ====== REVAMPED CHAT BUBBLES ====== */
        .msg-bubble { 
            max-width: 72%; min-width: 40px; padding: 10px 16px; border-radius: 20px; position: relative; 
            word-wrap: break-word; word-break: break-word; font-size: 0.875rem; line-height: 1.55; 
            touch-action: pan-y; 
            animation: msgMorphIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
            transform-origin: bottom center;
            will-change: transform, opacity;
        }
        .msg-bubble:hover { transform: scale(1.015); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .msg-me { 
            background: #1e293b; color: #f1f5f9; 
            border-bottom-right-radius: 6px; margin-left: auto; 
            box-shadow: 0 1px 6px rgba(30, 41, 59, 0.18);
            transform-origin: bottom right;
        }
        .msg-them { 
            background: #ffffff; color: #1e293b; 
            border-bottom-left-radius: 6px; margin-right: auto; 
            border: 1px solid #f1f5f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            transform-origin: bottom left;
        }
        @keyframes msgMorphIn { 
            0% { opacity: 0; transform: translateY(12px) scale(0.85) rotateX(8deg); filter: blur(2px); } 
            60% { opacity: 1; transform: translateY(-2px) scale(1.02) rotateX(0deg); filter: blur(0); }
            100% { opacity: 1; transform: translateY(0) scale(1) rotateX(0deg); filter: blur(0); } 
        }
        /* Staggered entry for multiple messages */
        .msg-group:nth-child(1) .msg-bubble { animation-delay: 0s; }
        .msg-group:nth-child(2) .msg-bubble { animation-delay: 0.04s; }
        .msg-group:nth-child(3) .msg-bubble { animation-delay: 0.08s; }
        .msg-group:nth-child(4) .msg-bubble { animation-delay: 0.12s; }
        .msg-group:nth-child(5) .msg-bubble { animation-delay: 0.16s; }

        /* Timestamp labels between message groups */
        .msg-timestamp-divider {
            display: flex; align-items: center; gap: 12px; margin: 16px 0 8px;
            animation: msgMorphIn 0.4s ease both;
        }
        .msg-timestamp-divider::before, .msg-timestamp-divider::after {
            content: ''; flex: 1; height: 1px; background: #e2e8f0; opacity: 0.5;
        }
        .msg-timestamp-divider span {
            font-size: 0.65rem; color: #94a3b8; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.06em; white-space: nowrap;
        }

        /* Inline timestamp on each bubble */
        .msg-time {
            font-size: 0.6rem; color: rgba(148, 163, 184, 0.8); margin-top: 3px;
            display: flex; align-items: center; gap: 4px;
            transition: opacity 0.2s ease;
        }
        .msg-me .msg-time { color: rgba(241, 245, 249, 0.5); justify-content: flex-end; }

        /* Read receipts */
        .msg-read-receipt { font-size: 0.55rem; display: inline-flex; align-items: center; gap: 2px; }
        .msg-read-receipt .check { color: rgba(241, 245, 249, 0.4); }
        .msg-read-receipt .check.read { color: #60a5fa; }

        /* Typing indicator */
        .typing-indicator {
            display: inline-flex; align-items: center; gap: 4px; padding: 12px 18px;
            background: #ffffff; border: 1px solid #f1f5f9; border-radius: 20px; 
            border-bottom-left-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            animation: msgMorphIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
        }
        .typing-dot {
            width: 6px; height: 6px; border-radius: 50%; background: #94a3b8;
            animation: typingBounce 1.4s ease-in-out infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .typing-dot:nth-child(3) { animation-delay: 0.3s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        /* Chat open morph animation */
        @keyframes chatViewMorphIn {
            0% { opacity: 0; transform: scale(0.96) translateY(8px); filter: blur(3px); }
            100% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
        }
        .chat-morph-enter { animation: chatViewMorphIn 0.45s cubic-bezier(0.22, 1, 0.36, 1) both; }

        /* Message area smooth scroll indicator */
        #chat-messages { scroll-behavior: smooth; }
        
        .msg-system { background: transparent; color: #94a3b8; font-size: 0.7rem; text-align: center; width: 100%; margin: 12px 0; font-style: normal; opacity: 0.7; font-weight: 500; letter-spacing: 0.01em; }
        
        .profile-tab { cursor: pointer; padding-bottom: 12px; color: #64748b; font-weight: 500; transition: all 0.3s ease; border-bottom: 2px solid transparent; position: relative; }
        .profile-tab::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0%; height: 2px; background: #1e293b; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .profile-tab:hover { color: #334155; }
        .profile-tab.active { color: #1e293b; }
        .profile-tab.active::after { width: 100%; }
        
        .notification-dot { position: absolute; top: -2px; right: -2px; width: 12px; height: 12px; background-color: #ef4444; border-radius: 50%; border: 2px solid white; display: none; animation: pulse 2s infinite; }
        
        .shape-blob { position: absolute; filter: blur(80px); z-index: 0; opacity: 0.5; transition: all 1s ease; }
        .blob-1 { top: -10%; left: -10%; width: 400px; height: 400px; background: #9333ea; animation: float 8s ease-in-out infinite, pulse 8s infinite; }
        .blob-2 { bottom: -10%; right: -10%; width: 450px; height: 450px; background: #2563eb; animation: float 10s ease-in-out infinite reverse, pulse 10s infinite reverse; }
        
        /* Interactive Elements */
        .btn-bounce { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-bounce:active { transform: scale(0.95); }
        
        /* Online Status Dot */
        .status-dot-online { width: 12px; height: 12px; background-color: #22c55e; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 0; right: 0; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); }
        
        /* Admin Badge Style */
        .admin-badge {
            background: linear-gradient(45deg, #ff0000, #ff8c00, #ffd700, #ff0000);
            background-size: 300% 300%;
            animation: gradient-x 4s ease infinite;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 5px rgba(255, 0, 0, 0.3);
            vertical-align: middle;
        }
        
        /* Video Call Specific Styles */
        #localVideo { transform: scaleX(-1); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* View Transitions */
        .view-section { animation-duration: 0.4s; animation-fill-mode: both; }

        /* Message Actions */
        .msg-actions { opacity: 0; transition: opacity 0.2s ease; }
        .msg-group:hover .msg-actions { opacity: 1; }

        /* Reply Styles */
        .reply-context {
            font-size: 0.75rem;
            margin-bottom: 4px;
            padding: 4px 8px;
            border-radius: 8px;
            opacity: 0.9;
            background: rgba(0,0,0,0.05);
            border-left: 3px solid #cbd5e1;
            display: flex;
            flex-direction: column;
        }
        .msg-me .reply-context { background: rgba(255,255,255,0.2); border-left-color: rgba(255,255,255,0.5); }
        
        /* Swipe to Reply Indicator */
        .reply-arrow-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        
        /* Mobile Message Context Menu */
        #mobile-message-menu { z-index: 200; }
        .msg-focused { z-index: 201; position: relative; transform: scale(1.02); transition: transform 0.2s; }
        .backdrop-dim { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }

        /* Story Styles */
        .story-ring { padding: 3px; background: linear-gradient(45deg, #1e293b, #64748b); border-radius: 50%; }
        .story-ring-cf { padding: 3px; background: #475569; border-radius: 50%; }
        .story-ring-seen { padding: 3px; background: #cbd5e1; border-radius: 50%; }
        .story-progress-bar { transition: width 0.1s linear; }

        /* Story Interactions - Revamped Animation */
        .heart-particle {
            position: absolute;
            bottom: 70px;
            right: 20px;
            font-size: 24px;
            opacity: 0;
            pointer-events: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            z-index: 60;
        }

        @keyframes float-wobble-1 {
            0% { transform: translateY(0) translateX(0) scale(0.5); opacity: 0; }
            15% { opacity: 1; transform: translateY(-30px) translateX(-5px) scale(1.2); }
            100% { transform: translateY(-500px) translateX(30px) scale(1); opacity: 0; }
        }

        @keyframes float-wobble-2 {
            0% { transform: translateY(0) translateX(0) scale(0.5); opacity: 0; }
            15% { opacity: 1; transform: translateY(-30px) translateX(5px) scale(1.2); }
            100% { transform: translateY(-450px) translateX(-30px) scale(0.9); opacity: 0; }
        }
        
        @keyframes float-straight {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            15% { opacity: 1; transform: translateY(-30px) scale(1.3); }
            100% { transform: translateY(-600px) scale(1); opacity: 0; }
        }

        /* --- HOVER-EXPAND NAVBAR --- */
        #main-navbar { height: 40px !important; }
        .navbar-collapsed-content { display: none !important; }
        .navbar-full-content { position: relative; }
        /* Logo: centered via left:50% + translateX(-50%), slides to left:16px on hover */
        .navbar-full-content .nav-logo { 
            position: absolute; 
            left: 50%; 
            top: 50%;
            transform: translate(-50%, -50%);
            width: fit-content;
            transition: left 0.45s cubic-bezier(0.4, 0, 0.2, 1), transform 0.45s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2;
        }
        /* Hide search & right menu by default */
        .navbar-full-content .nav-search,
        .navbar-full-content .nav-right { 
            opacity: 0; pointer-events: none; 
            transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1) 0.12s, transform 0.35s cubic-bezier(0.4, 0, 0.2, 1) 0.12s; 
        }
        /* Right menu: pinned to the right */
        .navbar-full-content .nav-right {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%) translateY(-4px);
        }
        #main-navbar:hover .navbar-full-content .nav-right {
            transform: translateY(-50%) translateY(0);
        }
        /* Search bar: ensure it stays centered in the flex layout */
        .navbar-full-content .nav-search {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) translateY(-4px);
        }
        #main-navbar:hover .navbar-full-content .nav-search {
            transform: translate(-50%, -50%) translateY(0);
        }
        /* On hover: logo slides to left, others appear */
        #main-navbar:hover { height: 64px !important; }
        #main-navbar:hover .navbar-full-content .nav-logo { 
            left: 16px; 
            transform: translate(0, -50%);
        }
        #main-navbar:hover .navbar-full-content .nav-search,
        #main-navbar:hover .navbar-full-content .nav-right { 
            opacity: 1; pointer-events: auto;
        }

        /* --- DARK MODE OVERRIDES (PURE BLACK) --- */
        html.dark body { background-color: #000000; background-image: none; color: #e2e8f0; }
        html.dark::selection { background: rgba(99, 102, 241, 0.4); color: #f8fafc; }
        html.dark *::selection { background: rgba(99, 102, 241, 0.4); color: #f8fafc; }

        html.dark .glass { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.06); box-shadow: 0 1px 12px rgba(0, 0, 0, 0.5); }
        html.dark .glass-card { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255, 255, 255, 0.06); box-shadow: 0 4px 16px -2px rgba(0, 0, 0, 0.4); }
        html.dark .glass-card:hover { background: rgba(18, 18, 18, 0.85); box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.5); }

        /* Sidebar & navigation */
        html.dark .sidebar-overlay { background: rgba(0, 0, 0, 0.96); backdrop-filter: blur(24px); box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6); }
        html.dark .sidebar-link { color: #8b9dc3; }
        html.dark .sidebar-link:hover { background-color: rgba(99, 102, 241, 0.08); color: #e0e7ff; }
        html.dark .sidebar-link.active { background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(99, 102, 241, 0.1)); color: #c7d2fe; font-weight: 600; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.12); border: 1px solid rgba(99, 102, 241, 0.12); }
        html.dark .sidebar-trigger-indicator { background: rgba(99, 102, 241, 0.25); }
        html.dark .sidebar-trigger:hover .sidebar-trigger-indicator { background: rgba(99, 102, 241, 0.5); }

        /* Layered surfaces */
        html.dark .bg-white { background-color: #0a0a0a !important; }
        html.dark .bg-white\/95 { background-color: rgba(5, 5, 5, 0.95) !important; }
        html.dark .bg-white\/90 { background-color: rgba(5, 5, 5, 0.9) !important; }
        html.dark .bg-white\/80 { background-color: rgba(5, 5, 5, 0.8) !important; }
        html.dark .bg-white\/60 { background-color: rgba(5, 5, 5, 0.6) !important; }
        html.dark .bg-white\/20 { background-color: rgba(255, 255, 255, 0.05) !important; }
        html.dark .bg-white\/10 { background-color: rgba(255, 255, 255, 0.03) !important; }

        html.dark .bg-slate-50 { background-color: #050505 !important; }
        html.dark .bg-slate-50\/50 { background-color: rgba(5, 5, 5, 0.5) !important; }
        html.dark .bg-slate-50\/30 { background-color: rgba(5, 5, 5, 0.3) !important; }
        html.dark .bg-slate-100 { background-color: #111111 !important; }
        html.dark .bg-slate-200 { background-color: #1a1a1a !important; }
        html.dark .bg-slate-300 { background-color: #2a2a2a !important; }
        html.dark .bg-slate-800 { background-color: #000000 !important; }

        /* Hover states */
        html.dark .hover\:bg-slate-50:hover { background-color: #0a0a0a !important; }
        html.dark .hover\:bg-slate-100:hover { background-color: #111111 !important; }
        html.dark .hover\:bg-slate-200:hover { background-color: #1a1a1a !important; }
        html.dark .hover\:bg-blue-50:hover { background-color: rgba(37, 99, 235, 0.15) !important; }
        html.dark .hover\:bg-green-50:hover { background-color: rgba(34, 197, 94, 0.15) !important; }
        html.dark .hover\:bg-red-50:hover { background-color: rgba(239, 68, 68, 0.15) !important; }

        /* Text with improved contrast */
        html.dark .text-slate-900 { color: #f1f5f9 !important; }
        html.dark .text-slate-800 { color: #e8edf5 !important; }
        html.dark .text-slate-700 { color: #d1d9e6 !important; }
        html.dark .text-slate-600 { color: #a8b8d0 !important; }
        html.dark .text-slate-500 { color: #8b9dc3 !important; }
        html.dark .text-slate-400 { color: #6b7fa3 !important; }
        html.dark .text-gradient { background: linear-gradient(to right, #c7d2fe, #a5b4fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Borders - softer */
        html.dark .border-slate-100 { border-color: rgba(148, 163, 184, 0.08) !important; }
        html.dark .border-slate-200 { border-color: rgba(148, 163, 184, 0.12) !important; }
        html.dark .border-slate-300 { border-color: rgba(148, 163, 184, 0.18) !important; }

        /* Inputs & forms */
        html.dark input, html.dark textarea { background-color: rgba(10, 10, 10, 0.9) !important; color: #e2e8f0; border-color: rgba(255, 255, 255, 0.1) !important; }
        html.dark input:focus, html.dark textarea:focus { border-color: rgba(99, 102, 241, 0.5) !important; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12); }
        html.dark input::placeholder, html.dark textarea::placeholder { color: #5a6d8a; }

        /* Chat bubbles - redesigned contrast */
        html.dark .msg-me { background: linear-gradient(135deg, #2563eb, #4f46e5); color: #f0f4ff; box-shadow: 0 2px 10px rgba(37, 99, 235, 0.25); }
        html.dark .msg-me .msg-time { color: rgba(224, 231, 255, 0.5); }
        html.dark .msg-them { background: rgba(15, 15, 15, 0.9); color: #e2e8f0; border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2); }
        html.dark .typing-indicator { background: rgba(15, 15, 15, 0.9); border-color: rgba(255, 255, 255, 0.08); }
        html.dark .typing-dot { background: #6366f1; }
        html.dark .msg-timestamp-divider::before, html.dark .msg-timestamp-divider::after { background: rgba(255, 255, 255, 0.08); }
        html.dark .msg-timestamp-divider span { color: #555; }
        html.dark .msg-time { color: rgba(150, 150, 150, 0.5); }
        html.dark .msg-me .reply-context { background: rgba(255, 255, 255, 0.12); border-left-color: rgba(255,255,255,0.3); }
        html.dark .msg-them .reply-context { background: rgba(255, 255, 255, 0.05); border-left-color: rgba(99, 102, 241, 0.4); }

        /* Notifications & dropdowns */
        html.dark .notification-dot { border-color: #000; }
        html.dark #notification-dropdown, html.dark #profile-menu, html.dark #search-dropdown { background: rgba(5, 5, 5, 0.97) !important; backdrop-filter: blur(24px); border-color: rgba(255, 255, 255, 0.06) !important; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.04) inset !important; }

        /* Shadows - deep and dramatic */
        html.dark .shadow-xl, html.dark .shadow-2xl { box-shadow: 0 20px 40px -8px rgba(0, 0, 0, 0.5), 0 8px 16px -4px rgba(0, 0, 0, 0.3); }
        html.dark .shadow-sm { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        html.dark .shadow-md { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25); }

        /* Story ring dark */
        html.dark .story-ring { background: linear-gradient(45deg, #6366f1, #818cf8); }

        /* Profile tabs */
        html.dark .profile-tab { color: #6b7fa3; }
        html.dark .profile-tab:hover { color: #a5b4fc; }
        html.dark .profile-tab.active { color: #c7d2fe; }
        html.dark .profile-tab.active::after { background: #6366f1; }

        /* Auth overlay */
        html.dark #auth-overlay { background-color: #000000; }
        html.dark #auth-overlay .bg-white\/80 { background: rgba(10, 10, 10, 0.85) !important; }

        /* Toast */
        html.dark #toast { background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }

        /* Mobile bottom nav */
        html.dark #mobile-bottom-nav .bg-white\/95 { background: rgba(0, 0, 0, 0.95) !important; }
        html.dark #mobile-bottom-nav .border-slate-200 { border-color: rgba(255, 255, 255, 0.06) !important; }

        /* Accent colors pop more */
        html.dark .text-blue-600 { color: #60a5fa !important; }
        html.dark .text-blue-500 { color: #818cf8 !important; }
        html.dark .bg-blue-600 { background-color: #4f46e5 !important; }
        html.dark .text-purple-600 { color: #a78bfa !important; }
        html.dark .text-green-600 { color: #4ade80 !important; }
        html.dark .text-red-500 { color: #f87171 !important; }

        /* Floating chat widget */
        html.dark #floating-chat-widget { background: rgba(5, 5, 5, 0.97) !important; border-color: rgba(255, 255, 255, 0.06) !important; }

        /* Collapsible section headers */
        html.dark .collapsible-header h4 { color: #5a6d8a; }
        html.dark .collapsible-chevron { color: #5a6d8a; }
    </style>
</head>
<body class="text-slate-800 font-sans antialiased overflow-x-hidden selection:bg-blue-100 selection:text-blue-900">

    <div id="app" class="min-h-screen flex flex-col transition-all duration-500">
        <!-- RINGTONE AUDIO (Hidden) -->
        <audio id="call-ringtone" loop>
            <source src="https://assets.mixkit.co/active_storage/sfx/2330/2330-preview.m4a" type="audio/mp4">
            <source src="https://www.soundjay.com/phone/telephone-ring-03a.mp3" type="audio/mpeg">
        </audio>
        <!-- NOTIFICATION SOUND (Dynamic source managed by JS) -->
        <audio id="notification-sound" preload="auto"></audio>

        <!-- Navbar -->
        <nav id="main-navbar" class="glass fixed top-0 w-full z-50 h-16 transition-all duration-300 shadow-sm backdrop-blur-md" style="transition: height 0.35s cubic-bezier(0.4, 0, 0.2, 1);">
            <!-- Full navbar content -->
            <div class="navbar-full-content max-w-[1440px] mx-auto h-full flex items-center justify-between px-4 lg:px-6">
                <!-- Logo -->
                <div class="nav-logo flex items-center gap-2 cursor-pointer w-auto md:w-1/4 btn-bounce" onclick="router('feed')">
                    <img src="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" alt="Lumini Logo" class="w-9 h-9 object-contain hover:rotate-12 transition-transform duration-300">
                    <span class="font-heading font-bold text-2xl tracking-tight text-gradient hidden sm:block">Lumini</span>
                </div>

                <!-- Search Bar -->
                <div class="nav-search hidden md:flex relative items-center justify-center w-1/2">
                    <div class="relative w-full max-w-md group">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors duration-300"></i>
                        <input id="global-search" type="text" placeholder="Search Lumini..." class="w-full bg-slate-100 border-2 border-transparent focus:bg-white focus:border-blue-200 focus:ring-4 focus:ring-blue-500/10 rounded-full pl-10 pr-4 py-2.5 text-sm outline-none transition-all duration-300 text-slate-700" autocomplete="off" oninput="handleSearch(this.value)" onfocus="handleSearch(this.value)" onblur="setTimeout(()=>document.getElementById('search-dropdown').classList.add('hidden'), 200)">
                        <div id="search-dropdown" class="absolute top-14 left-0 w-full bg-white rounded-xl shadow-xl border border-slate-100 hidden overflow-hidden z-50 animate-pop-in origin-top"></div>
                    </div>
                </div>

                <!-- Right Menu -->
                <div class="nav-right flex items-center justify-end w-auto md:w-1/4 gap-2 sm:gap-4">
                    <button onclick="router('messaging')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-all duration-300 text-slate-600 relative btn-bounce">
                        <i class="fa-brands fa-facebook-messenger text-xl"></i>
                        <div id="chat-badge" class="notification-dot"></div>
                    </button>
                    
                    <div class="relative">
                        <button onclick="toggleNotificationDropdown()" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-all duration-300 text-slate-600 relative btn-bounce">
                            <i class="fa-solid fa-bell text-xl"></i>
                            <div id="notification-badge" class="notification-dot"></div>
                        </button>
                        <div id="notification-dropdown" class="hidden absolute right-0 top-14 w-80 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-100 py-2 animate-pop-in origin-top-right z-50 max-h-96 overflow-y-auto custom-scrollbar">
                            <div class="px-4 py-2 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <h3 class="font-bold text-sm text-slate-800">Notifications</h3>
                                <button onclick="openClearNotifsModal()" class="text-xs text-red-500 hover:text-red-600 font-bold transition-colors btn-bounce">Clear All</button>
                            </div>
                            <div id="notification-list" class="p-2">
                                <p class="text-center text-xs text-slate-400 py-4">No new notifications.</p>
                            </div>
                        </div>
                    </div>

                    <div onclick="toggleProfileMenu()" class="ml-2 relative cursor-pointer btn-bounce group">
                        <img id="nav-avatar" src="https://placehold.co/100x100?text=User" class="w-9 h-9 rounded-full ring-2 ring-white shadow-md object-cover group-hover:ring-blue-400 transition-all duration-300">
                        <div id="profile-menu" class="hidden absolute right-0 top-14 w-60 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-100 py-2 animate-pop-in origin-top-right z-50">
                            <div class="px-4 py-3 border-b border-slate-100 mb-2 flex items-center gap-3 hover:bg-slate-50 transition-colors cursor-pointer" onclick="viewMyProfile()">
                                <img id="menu-avatar-small" src="" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                                <div><p id="menu-name" class="font-bold text-sm text-slate-800">Guest</p><p class="text-xs text-slate-500">See your profile</p></div>
                            </div>
                            <a href="#" onclick="openCloseFriendsModal()" class="flex items-center gap-3 px-4 py-3 text-sm text-slate-600 hover:bg-slate-50 hover:text-green-600 transition-colors"><i class="fa-solid fa-star text-slate-400 w-5"></i> Close Friends</a>
                            <a href="#" onclick="openSettingsModal()" class="flex items-center gap-3 px-4 py-3 text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600 transition-colors"><i class="fa-solid fa-gear text-slate-400 w-5"></i> Settings & Privacy</a>
                            <a href="#" onclick="handleSignOut()" class="flex items-center gap-3 px-4 py-3 text-sm text-red-500 hover:bg-red-50 transition-colors rounded-b-xl"><i class="fa-solid fa-right-from-bracket w-5"></i> Log Out</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsed navbar content (just centered logo) -->
            <div class="navbar-collapsed-content">
                <img src="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" alt="Lumini" class="w-7 h-7 object-contain cursor-pointer hover:rotate-12 transition-transform duration-300" onclick="router('feed')">
            </div>
        </nav>
        
        <!-- Bottom Mobile Nav (new) -->
        <div id="mobile-bottom-nav" class="fixed bottom-0 left-0 right-0 z-50 md:hidden pb-safe">
            <div class="mx-auto max-w-[1440px]">
                <div class="mx-3 mb-3 rounded-2xl shadow-2xl border border-slate-200 bg-white/95 backdrop-blur-xl">
                    <div class="grid grid-cols-4 text-xs font-semibold text-slate-500">
                        <button onclick="router('feed'); highlightMobileTab('feed')" class="flex flex-col items-center justify-center py-3 gap-1">
                            <i class="fa-solid fa-house"></i>
                            <span>Home</span>
                        </button>
                        <button onclick="viewMyProfile(); highlightMobileTab('profile')" class="flex flex-col items-center justify-center py-3 gap-1">
                            <i class="fa-solid fa-user"></i>
                            <span>Profile</span>
                        </button>
                        <button onclick="router('collaborate'); highlightMobileTab('collaborate')" class="flex flex-col items-center justify-center py-3 gap-1">
                            <i class="fa-solid fa-rocket"></i>
                            <span>Projects</span>
                        </button>
                        <button onclick="router('network'); highlightMobileTab('network')" class="flex flex-col items-center justify-center py-3 gap-1">
                            <i class="fa-solid fa-user-group"></i>
                            <span>Network</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            // === HOVER-EXPAND NAVBAR LOGIC ===
            // Default state is collapsed (40px), navbar auto-expands on hover via CSS.
            // Adjust sidebar/main positions for hover state dynamically.
            (function() {
                const nav = document.getElementById('main-navbar');
                const updatePositions = (expanded) => {
                    const top = expanded ? '64px' : '40px';
                    document.querySelectorAll('.sidebar-overlay, .sidebar-trigger').forEach(el => {
                        el.style.top = top;
                    });
                };
                nav.addEventListener('mouseenter', () => updatePositions(true));
                nav.addEventListener('mouseleave', () => updatePositions(false));
                // Set initial positions for collapsed state
                updatePositions(false);
                const main = document.querySelector('main');
                if (main) main.style.paddingTop = '56px';
            })();

            // Slide-out sidebar panels
            const _panelTimers = {};
            function openSidebarPanel(side) {
                clearTimeout(_panelTimers[side + '_close']);
                _panelTimers[side + '_open'] = setTimeout(function() {
                    const panel = document.getElementById(side === 'left' ? 'left-sidebar-panel' : 'right-sidebar-panel');
                    if (panel) panel.classList.add('open');
                }, 80);
            }
            function closeSidebarPanel(side) {
                clearTimeout(_panelTimers[side + '_open']);
                _panelTimers[side + '_close'] = setTimeout(function() {
                    const panel = document.getElementById(side === 'left' ? 'left-sidebar-panel' : 'right-sidebar-panel');
                    if (panel) panel.classList.remove('open');
                }, 250);
            }

            // Hover-to-expand collapsible sections
            const _hoverTimers = {};
            function expandSection(sectionId) {
                clearTimeout(_hoverTimers[sectionId + '_close']);
                _hoverTimers[sectionId + '_open'] = setTimeout(function() {
                    const body = document.getElementById(sectionId);
                    const chevron = document.getElementById(sectionId + '-chevron');
                    if (body) body.classList.remove('collapsed');
                    if (chevron) chevron.classList.remove('collapsed');
                }, 120);
            }
            function collapseSection(sectionId) {
                clearTimeout(_hoverTimers[sectionId + '_open']);
                _hoverTimers[sectionId + '_close'] = setTimeout(function() {
                    const body = document.getElementById(sectionId);
                    const chevron = document.getElementById(sectionId + '-chevron');
                    if (body) body.classList.add('collapsed');
                    if (chevron) chevron.classList.add('collapsed');
                }, 300);
            }
            // Also keep click toggle for accessibility
            function toggleCollapsible(sectionId) {
                const body = document.getElementById(sectionId);
                const chevron = document.getElementById(sectionId + '-chevron');
                if (!body || !chevron) return;
                body.classList.toggle('collapsed');
                chevron.classList.toggle('collapsed');
            }
            // Start feed sections collapsed
            document.addEventListener('DOMContentLoaded', function() {
                ['stories-section','composer-section','highlights-section'].forEach(function(id) {
                    var body = document.getElementById(id);
                    var chevron = document.getElementById(id + '-chevron');
                    if (body) body.classList.add('collapsed');
                    if (chevron) chevron.classList.add('collapsed');
                });
            });

            // Keep active state in bottom nav in sync with router
            function highlightMobileTab(tab){
                try{
                    const labels = { feed:'Home', profile:'Profile', collaborate:'Projects', network:'Network', messaging:'Messages' };
                    // No heavy DOM operations; visually we rely on color change
                    const root = document.getElementById('mobile-bottom-nav');
                    if(!root) return;
                    root.querySelectorAll('button').forEach(btn=>{
                        btn.classList.remove('text-blue-600');
                        btn.classList.add('text-slate-500');
                    });
                    const map = {
                        feed: 0,
                        profile: 1,
                        collaborate: 2,
                        network: 3,
                        messaging: 4
                    };
                    const idx = map[tab];
                    const target = root.querySelectorAll('button')[idx];
                    if(target){
                        target.classList.remove('text-slate-500');
                        target.classList.add('text-blue-600');
                    }
                }catch(e){ /* silent */ }
            }

            // Optional: expose a small hook to update badge
            function setMobileChatBadge(visible){
                const el = document.getElementById('mobile-chat-badge');
                if(!el) return;
                el.style.display = visible ? 'block' : 'none';
            }
        </script>

        <!-- Auth Overlay -->
        <div id="auth-overlay" class="fixed inset-0 bg-slate-50 z-[60] flex items-center justify-center p-4 md:p-8 transition-all duration-700 ease-in-out overflow-hidden">
            <div class="shape-blob blob-1 rounded-full"></div>
            <div class="shape-blob blob-2 rounded-full"></div>
            <div class="relative w-full max-w-5xl h-full md:h-[650px] bg-white/80 backdrop-blur-2xl rounded-3xl shadow-2xl border border-white/60 overflow-hidden flex flex-col md:flex-row animate-pop-in">
                <div class="w-full md:w-1/2 bg-gradient-to-br from-blue-600 to-purple-700 p-8 md:p-12 flex flex-col justify-between relative overflow-hidden text-white group">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-8"><img src="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" class="w-12 h-12 object-contain drop-shadow-lg group-hover:rotate-12 transition-transform duration-500"><span class="font-heading font-bold text-2xl tracking-tight">Lumini</span></div>
                        <h1 class="font-heading text-4xl md:text-5xl font-bold leading-tight mb-6 animate-slide-up" style="animation-delay: 0.1s;">Connect. <br> Collaborate. <br> Create.</h1>
                        <p class="text-blue-100 text-lg font-light mb-8 animate-slide-up" style="animation-delay: 0.2s;">Join the community where developers and creators build the future together.</p>
                    </div>
                </div>
                <div class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center bg-white/60">
                    <div class="max-w-sm mx-auto w-full animate-slide-up" style="animation-delay: 0.3s;">
                        <h2 class="font-heading text-2xl font-bold text-slate-900 mb-2">Get Started</h2>
                        <p class="text-slate-500 mb-8 text-sm">Create an account or sign in.</p>
                        <div class="space-y-4">
                            <button onclick="handleGoogleAuth()" class="w-full bg-white border border-slate-200 hover:bg-slate-50 hover:border-slate-300 text-slate-700 font-semibold py-3 rounded-xl flex items-center justify-center gap-3 transition-all duration-300 shadow-sm hover:shadow-md btn-bounce"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Continue with Google</button>
                            <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200"></div><span class="flex-shrink mx-4 text-slate-400 text-xs font-semibold uppercase">Or with email</span><div class="flex-grow border-t border-slate-200"></div></div>
                            <input id="auth-email" type="email" placeholder="Email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-300">
                            <input id="auth-password" type="password" placeholder="Password" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-300">
                            <button onclick="handleEmailAuth()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition-all duration-300 hover:shadow-blue-500/50 btn-bounce">Sign In / Sign Up</button>
                        </div>
                        <p id="auth-error" class="text-red-500 text-xs mt-4 text-center hidden animate-bounce-short"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <main class="flex-grow pt-20 pb-6 px-4">
            <div class="max-w-[1440px] mx-auto grid grid-cols-1 md:grid-cols-12 gap-8">
                
                <!-- Left Sidebar Hover Trigger -->
                <div class="sidebar-trigger left-trigger hidden md:block" onmouseenter="openSidebarPanel('left')" id="left-trigger">
                    <div class="sidebar-trigger-indicator"></div>
                </div>

                <!-- Left Sidebar (Slide-out Overlay) -->
                <aside id="left-sidebar-panel" class="sidebar-overlay left-panel hidden md:block custom-scrollbar space-y-1" onmouseenter="openSidebarPanel('left')" onmouseleave="closeSidebarPanel('left')">
                    <div onclick="viewMyProfile()" class="sidebar-link mb-3 hover:bg-slate-200 rounded-xl transition-colors group">
                        <img id="sidebar-mini-avatar" src="" class="w-8 h-8 rounded-full object-cover bg-slate-300 ring-2 ring-transparent group-hover:ring-blue-400 transition-all">
                        <span id="sidebar-mini-name" class="font-bold text-slate-800 text-sm">Guest</span>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="glass-card rounded-xl bg-white/90 overflow-hidden mb-2">
                        <div class="px-3 py-2">
                            <div onclick="router('feed')" class="sidebar-link active" id="nav-link-feed"><i class="fa-solid fa-house text-slate-500"></i> <span>Home</span></div>
                            <div onclick="viewMyProfile()" class="sidebar-link" id="nav-link-profile"><i class="fa-solid fa-user text-slate-500"></i> <span>Profile</span></div>
                            <div onclick="router('network')" class="sidebar-link" id="nav-link-network"><i class="fa-solid fa-user-group text-slate-500"></i> <span>Network</span></div>
                            <div onclick="router('collaborate')" class="sidebar-link" id="nav-link-collaborate"><i class="fa-solid fa-rocket text-slate-500"></i> <span>Collaborate</span></div>
                            <div onclick="router('messaging')" class="sidebar-link" id="nav-link-messaging"><i class="fa-solid fa-comment-dots text-slate-500"></i> <span>Messages</span></div>
                            <div onclick="router('saved')" class="sidebar-link" id="nav-link-saved"><i class="fa-solid fa-bookmark text-slate-500"></i> <span>Saved</span></div>
                        </div>
                    </div>
                    
                    <!-- Quick Links -->
                    <div class="glass-card rounded-xl bg-white/90 overflow-hidden">
                        <div class="px-3 py-2">
                            <div onclick="openCloseFriendsModal()" class="sidebar-link"><i class="fa-solid fa-star text-slate-500"></i> <span>Close Friends</span></div>
                            <div onclick="openSettingsModal()" class="sidebar-link"><i class="fa-solid fa-gear text-slate-500"></i> <span>Settings</span></div>
                        </div>
                    </div>
                    
                    <div class="mt-6 px-4 text-[10px] text-slate-400 leading-relaxed opacity-50 hover:opacity-100 transition-opacity">Lumini  2025  Privacy  Terms  Cookies  More</div>
                </aside>

                <!-- Center Content -->
                <section id="main-container" class="col-span-12 max-w-3xl mx-auto w-full animate-slide-up" style="animation-delay: 0.2s;" data-default-class="col-span-12 max-w-3xl mx-auto w-full animate-slide-up">
                    
                    <!-- View: Feed -->
                    <div id="view-feed" class="view-section space-y-4">
                        <!-- Stories Bar (Collapsible) -->
                        <div class="glass-card rounded-2xl bg-white/90 overflow-hidden collapsible-section" onmouseenter="expandSection('stories-section')" onmouseleave="collapseSection('stories-section')">
                            <div class="collapsible-header" onclick="toggleCollapsible('stories-section')">
                                <h4><i class="fa-solid fa-circle-play mr-2"></i>Stories</h4>
                                <i id="stories-section-chevron" class="fa-solid fa-chevron-down collapsible-chevron"></i>
                            </div>
                            <div id="stories-section" class="collapsible-body px-4 pb-4">
                                <div class="overflow-x-auto custom-scrollbar flex gap-4" id="stories-bar">
                                    <div class="flex flex-col items-center gap-2 cursor-pointer min-w-[70px]" onclick="openStoryUploadModal()">
                                        <div class="relative w-14 h-14 group">
                                             <img id="story-my-avatar" src="" class="w-full h-full rounded-full border-2 border-white object-cover group-hover:opacity-80 transition-opacity">
                                             <div class="absolute bottom-0 right-0 bg-slate-800 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] border-2 border-white"><i class="fa-solid fa-plus"></i></div>
                                        </div>
                                        <span class="text-[10px] font-medium text-slate-500 truncate w-14 text-center">Add Story</span>
                                    </div>
                                    <div id="stories-list" class="flex gap-4"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Composer (Collapsible) -->
                        <div class="glass-card rounded-2xl bg-white/90 overflow-hidden collapsible-section" onmouseenter="expandSection('composer-section')" onmouseleave="collapseSection('composer-section')">
                            <div class="collapsible-header" onclick="toggleCollapsible('composer-section')">
                                <h4><i class="fa-solid fa-pen-to-square mr-2"></i>Create Post</h4>
                                <i id="composer-section-chevron" class="fa-solid fa-chevron-down collapsible-chevron"></i>
                            </div>
                            <div id="composer-section" class="collapsible-body px-4 pb-4">
                                <div class="flex gap-3 mb-3">
                                    <img id="composer-avatar" src="https://placehold.co/100x100?text=User" class="w-10 h-10 rounded-full bg-slate-100 object-cover ring-2 ring-white">
                                    <div onclick="openPostModal()" class="flex-grow bg-slate-50 hover:bg-slate-100 rounded-full px-4 py-2.5 cursor-pointer transition-colors text-slate-400 text-sm flex items-center">What's on your mind, <span id="composer-name-placeholder" class="ml-1">User</span>?</div>
                                </div>
                                <div class="flex items-center gap-2 pt-2 border-t border-slate-100/60">
                                    <button onclick="openPostModal('image')" class="px-3 py-1.5 text-slate-400 hover:bg-slate-100 hover:text-slate-700 rounded-lg transition-all text-xs font-medium flex items-center gap-1.5 btn-bounce"><i class="fa-solid fa-image text-slate-400"></i> Photo</button>
                                    <button onclick="openPostModal('project')" class="px-3 py-1.5 text-slate-400 hover:bg-slate-100 hover:text-slate-700 rounded-lg transition-all text-xs font-medium flex items-center gap-1.5 btn-bounce"><i class="fa-solid fa-rocket text-slate-400"></i> Project</button>
                                </div>
                            </div>
                        </div>

                        <!-- Feed Stream -->
                        <div id="feed-stream" class="space-y-4 pb-20"><div class="text-center py-12"><i class="fa-solid fa-circle-notch fa-spin text-slate-400 text-xl"></i></div></div>
                    </div>

                    <!-- View: Saved -->
                    <div id="view-saved" class="view-section hidden space-y-6">
                        <div class="glass-card rounded-2xl p-6 bg-white/90">
                            <h2 class="font-heading font-bold text-2xl text-slate-800 flex items-center gap-3"><i class="fa-solid fa-bookmark text-slate-500"></i> Saved Posts</h2>
                            <p class="text-slate-500 text-sm mt-1">Only you can see what you've saved.</p>
                        </div>
                        <div id="saved-posts-stream" class="space-y-5 pb-20"></div>
                    </div>

                    <!-- View: Network -->
                    <div id="view-network" class="view-section hidden space-y-4">
                        <div class="glass-card rounded-2xl p-6 mb-6 bg-white/90">
                            <h2 class="font-heading font-bold text-2xl text-slate-800">Grow your Network</h2>
                            <p class="text-slate-500 text-sm mt-1">Find collaborators. <span class="text-xs text-slate-400">(Real users appear here)</span></p>
                        </div>
                        <div id="network-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    </div>

                    <!-- View: Collaborate -->
                    <div id="view-collaborate" class="view-section hidden space-y-6">
                        <div class="glass-card rounded-2xl p-6 bg-white/90">
                             <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                                <div>
                                    <h2 class="font-heading font-bold text-2xl text-slate-800 flex items-center gap-3"><i class="fa-solid fa-rocket text-slate-500"></i> Project Board</h2>
                                    <p class="text-slate-500 text-sm mt-1">Find collaborators or showcase your work.</p>
                                </div>
                                <button onclick="openPostModal('project')" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-sm hover:bg-slate-700 transition-all duration-200 btn-bounce flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Post Project
                                </button>
                            </div>
                            <div class="flex gap-2 overflow-x-auto custom-scrollbar pb-1" id="collab-filters">
                                <button onclick="filterCollaborate('all')" id="filter-all" class="px-4 py-1.5 rounded-full text-sm font-bold border border-slate-200 bg-slate-900 text-white transition-all duration-200 whitespace-nowrap hover:shadow-md btn-bounce">All</button>
                                <button onclick="filterCollaborate('designer')" id="filter-designer" class="px-4 py-1.5 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap hover:shadow-md btn-bounce">Designers</button>
                                <button onclick="filterCollaborate('developer')" id="filter-developer" class="px-4 py-1.5 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap hover:shadow-md btn-bounce">Developers</button>
                                <button onclick="filterCollaborate('manager')" id="filter-manager" class="px-4 py-1.5 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap hover:shadow-md btn-bounce">Managers</button>
                                 <button onclick="filterCollaborate('marketing')" id="filter-marketing" class="px-4 py-1.5 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap hover:shadow-md btn-bounce">Marketing</button>
                            </div>
                        </div>
                        <div id="collaborate-stream" class="space-y-5 pb-20"></div>
                    </div>

                    <!-- View: Profile -->
                    <div id="view-profile" class="view-section hidden space-y-6">
                        <div class="glass-card rounded-2xl overflow-hidden bg-white/90">
                            <div class="h-40 bg-gradient-to-r from-blue-500 to-purple-600 relative overflow-hidden">
                                <div class="absolute inset-0 bg-white/10 backdrop-blur-[2px]"></div>
                                <div class="shape-blob blob-1 !opacity-30"></div>
                                <button onclick="router('feed')" class="absolute top-4 left-4 bg-black/20 hover:bg-black/40 text-white px-4 py-2 rounded-full backdrop-blur-md transition-all text-sm font-bold btn-bounce"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
                            </div>
                            <div class="px-6 pb-6 relative">
                                <div class="flex flex-col sm:flex-row items-end -mt-12 mb-4 gap-4">
                                    <div class="relative">
                                        <div class="w-32 h-32 rounded-full border-4 border-white shadow-xl bg-white overflow-hidden relative z-10 group">
                                            <img id="profile-page-avatar" src="" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                        </div>
                                    </div>
                                    
                                    <div class="flex-grow mb-2 text-center sm:text-left">
                                        <h2 id="profile-page-name" class="font-heading font-bold text-3xl text-slate-800">User Name</h2>
                                        <p id="profile-page-headline" class="text-slate-500 font-medium text-sm">Headline</p>
                                        
                                        <!-- Followers/Following UI -->
                                        <div class="flex gap-4 text-sm mt-2 text-slate-600 justify-center sm:justify-start">
                                            <span class="cursor-pointer hover:text-blue-600 transition-colors" onclick="openFollowModal('followers')"><b id="profile-followers-count" class="text-slate-900">0</b> Followers</span>
                                            <span class="cursor-pointer hover:text-blue-600 transition-colors" onclick="openFollowModal('following')"><b id="profile-following-count" class="text-slate-900">0</b> Following</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-2 mb-3">
                                         <button id="edit-profile-btn" onclick="openEditProfileModal()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold text-sm hover:bg-slate-300 transition-all hidden flex items-center gap-2 btn-bounce">
                                            <i class="fa-solid fa-pen"></i> Edit Profile
                                        </button>
                                         <button id="follow-btn" onclick="toggleFollow(window.currentViewedUid)" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 transition-all shadow-md flex items-center gap-2 hidden btn-bounce">
                                            <i class="fa-solid fa-user-plus"></i> <span>Follow</span>
                                        </button>
                                        <button id="profile-chat-btn" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold text-sm hover:bg-slate-300 transition-all flex items-center gap-2 hidden btn-bounce">
                                            <i class="fa-brands fa-facebook-messenger"></i> Message
                                        </button>
                                    </div>
                                    <div id="admin-controls-container"></div>
                                </div>
                                
                                <div class="border-t border-slate-200 pt-4 flex gap-8 text-sm font-semibold">
                                    <div onclick="switchProfileTab('posts')" id="tab-posts" class="profile-tab active">Posts</div>
                                    <div onclick="switchProfileTab('about')" id="tab-about" class="profile-tab">About</div>
                                    <div onclick="switchProfileTab('saved')" id="tab-saved" class="profile-tab hidden">Saved</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1 space-y-4 animate-slide-up" style="animation-delay: 0.1s;">
                                <div class="glass-card rounded-2xl p-5 bg-white/90">
                                    <h3 class="font-bold text-slate-800 mb-3 text-lg">Intro</h3>
                                    <p id="profile-page-bio" class="text-sm text-slate-600 mb-4 leading-relaxed whitespace-pre-line"></p>
                                    <div class="text-xs text-slate-400 flex items-center gap-2 mb-2"><i class="fa-solid fa-clock"></i> Joined <span id="profile-join-date">...</span></div>
                                </div>
                            </div>
                            
                            <div class="md:col-span-2 animate-slide-up" style="animation-delay: 0.2s;">
                                <div id="profile-content-posts" class="space-y-6"></div>
                                <div id="profile-content-about" class="hidden glass-card rounded-2xl p-6 bg-white/90">
                                    <h3 class="font-bold text-xl mb-4">Full Bio</h3>
                                    <p id="profile-full-bio" class="text-slate-700 leading-relaxed whitespace-pre-line"></p>
                                </div>
                                <div id="profile-content-saved" class="hidden space-y-6"></div>
                            </div>
                        </div>
                    </div>

                    <!-- View: Messaging -->
                    <div id="view-messaging" class="view-section hidden h-[calc(100vh-90px)] rounded-2xl flex overflow-hidden border border-slate-200/80 bg-white" style="margin: 0 auto;">
                        
                        <div id="msg-list-col" class="w-full md:w-[340px] md:min-w-[340px] border-r border-slate-100 bg-white flex flex-col">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-heading font-bold text-slate-900 text-xl tracking-tight">Messages</h3>
                            </div>
                            <div id="chat-list" class="flex-1 overflow-y-auto p-3 space-y-0.5 custom-scrollbar"></div>
                        </div>
                        
                        <div id="msg-chat-col" class="hidden md:flex w-full flex-col bg-white relative">
                            <div id="chat-header" class="h-[68px] border-b border-slate-100 flex items-center px-6 justify-between bg-white">
                                <div class="flex items-center gap-3">
                                    <button onclick="backToChatList()" class="md:hidden text-slate-500 hover:bg-slate-100 w-8 h-8 rounded-full flex items-center justify-center transition-all duration-200 btn-bounce"><i class="fa-solid fa-arrow-left"></i></button>
                                    <span class="font-semibold text-slate-800">Select a conversation</span>
                                </div>
                                <div class="flex gap-1">
                                    <button id="start-audio-call-btn" onclick="initiateCall('audio')" class="hidden text-slate-400 hover:text-slate-700 w-10 h-10 rounded-full hover:bg-slate-50 flex items-center justify-center transition-all duration-200 btn-bounce" title="Audio Call">
                                        <i class="fa-solid fa-phone"></i>
                                    </button>
                                    <button id="start-video-call-btn" onclick="initiateCall('video')" class="hidden text-slate-400 hover:text-slate-700 w-10 h-10 rounded-full hover:bg-slate-50 flex items-center justify-center transition-all duration-200 btn-bounce" title="Video Call">
                                        <i class="fa-solid fa-video"></i>
                                    </button>
                                    <button id="delete-chat-btn" onclick="deleteChat()" class="hidden text-slate-400 hover:text-red-500 w-10 h-10 rounded-full hover:bg-slate-50 flex items-center justify-center transition-all duration-200 btn-bounce" title="Delete">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="chat-messages" class="flex-1 overflow-y-auto px-8 py-6 space-y-3 bg-slate-50/50 custom-scrollbar flex flex-col relative">
                                <div class="flex h-full items-center justify-center text-slate-300 flex-col gap-3">
                                    <i class="fa-regular fa-comment-dots text-5xl mb-2 animate-float"></i>
                                    <p class="text-sm font-medium text-slate-400">Select a conversation to start chatting</p>
                                </div>
                            </div>
                            
                            <!-- Mobile Context Menu Overlay -->
                            <div id="mobile-message-menu" class="hidden fixed inset-0 backdrop-dim flex items-center justify-center z-[200]">
                                <div id="mobile-menu-content" class="bg-white rounded-2xl shadow-2xl p-4 w-64 animate-pop-in flex flex-col gap-2">
                                    <button id="mm-reply" class="w-full text-left p-3 hover:bg-slate-50 rounded-xl font-medium text-slate-700 flex items-center gap-3 transition-colors duration-200"><i class="fa-solid fa-reply text-slate-400"></i> Reply</button>
                                    <button id="mm-copy" class="w-full text-left p-3 hover:bg-slate-50 rounded-xl font-medium text-slate-700 flex items-center gap-3 transition-colors duration-200"><i class="fa-regular fa-copy text-slate-400"></i> Copy</button>
                                    <button id="mm-edit" class="w-full text-left p-3 hover:bg-slate-50 rounded-xl font-medium text-slate-700 flex items-center gap-3 hidden transition-colors duration-200"><i class="fa-solid fa-pen text-slate-400"></i> Edit</button>
                                    <button id="mm-unsend" class="w-full text-left p-3 hover:bg-red-50 text-red-500 rounded-xl font-medium flex items-center gap-3 hidden transition-colors duration-200"><i class="fa-solid fa-trash"></i> Unsend</button>
                                    <button onclick="document.getElementById('mobile-message-menu').classList.add('hidden'); document.querySelectorAll('.msg-focused').forEach(el=>el.classList.remove('msg-focused'))" class="w-full text-center p-2 text-slate-400 text-sm font-medium mt-1">Cancel</button>
                                </div>
                            </div>

                            <div class="p-5 border-t border-slate-100 bg-white relative z-30">
                                <form id="message-form" class="flex gap-3 relative items-center" onsubmit="sendMessage(event)">
                                    <div id="reply-indicator" class="hidden absolute -top-14 left-0 right-0 bg-white p-2 rounded-t-xl border-t border-x border-slate-100 flex justify-between items-center px-4 shadow-sm" style="animation: msgAppear 0.3s ease both;">
                                         <div class="flex flex-col text-xs overflow-hidden pr-2">
                                             <span class="font-semibold text-slate-600">Replying to <span id="reply-to-name"></span></span>
                                             <span id="reply-to-text" class="text-slate-400 truncate"></span>
                                         </div>
                                         <button type="button" onclick="cancelReply()" class="text-slate-400 hover:text-slate-600 w-6 h-6 flex items-center justify-center rounded-full transition-colors duration-200"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                    <div id="edit-indicator" class="hidden absolute -top-10 left-4 bg-slate-900 text-white text-xs px-3 py-1.5 rounded-xl shadow-lg flex items-center gap-2" style="animation: msgAppear 0.3s ease both;">
                                        <span>Editing message...</span>
                                        <button type="button" onclick="cancelEdit()" class="hover:text-red-300 ml-1 transition-colors duration-200"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                    <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 bg-slate-100 border border-transparent focus:bg-white focus:border-slate-200 rounded-full px-5 py-3.5 outline-none transition-all duration-300 text-sm" disabled>
                                    <button id="message-send-btn" type="submit" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-slate-700 transition-all duration-200 disabled:opacity-30 btn-bounce" disabled><i id="msg-send-icon" class="fa-solid fa-arrow-up text-sm"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Right Sidebar -->
                <!-- Right Sidebar Hover Trigger -->
                <div class="sidebar-trigger right-trigger hidden lg:block" onmouseenter="openSidebarPanel('right')" id="right-trigger">
                    <div class="sidebar-trigger-indicator"></div>
                </div>

                <!-- Right Sidebar (Slide-out Overlay) -->
                <aside id="right-sidebar-panel" class="sidebar-overlay right-panel hidden lg:block custom-scrollbar space-y-3" onmouseenter="openSidebarPanel('right')" onmouseleave="closeSidebarPanel('right')">
                    <!-- Documentation -->
                    <div class="glass-card rounded-2xl bg-white/90 overflow-hidden">
                        <div class="px-3 py-2">
                            <h4 class="text-[10px] font-bold uppercase tracking-wider text-slate-400 px-2 mb-2"><i class="fa-solid fa-book mr-2"></i>Documentation</h4>
                            <div onclick="window.open('https://luminiroyalacademy.github.io/Lumini/', '_blank')" class="flex items-start gap-3 cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition-all duration-300 group">
                                <div class="w-16 h-16 bg-slate-200 rounded-lg overflow-hidden flex-shrink-0 relative shadow-sm group-hover:shadow-md transition-all">
                                    <img src="https://i.postimg.cc/pL3qStZD/Screenshot-2025-11-22-212117.png" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                </div>
                                <div>
                                    <p class="font-semibold text-xs text-slate-700 group-hover:text-blue-600 transition-colors">Project Lumini: Docs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Community Highlights -->
                    <div class="glass-card rounded-2xl bg-white/90 overflow-hidden collapsible-section" onmouseenter="expandSection('highlights-section')" onmouseleave="collapseSection('highlights-section')">
                        <div class="collapsible-header" onclick="toggleCollapsible('highlights-section')">
                            <h4><i class="fa-solid fa-fire mr-2"></i>Community Highlights</h4>
                            <div class="flex items-center gap-2">
                                <button id="admin-add-highlight-btn" onclick="event.stopPropagation(); openHighlightModal()" class="hidden text-blue-600 hover:bg-blue-50 w-5 h-5 rounded-full flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-plus text-[10px]"></i></button>
                                <i id="highlights-section-chevron" class="fa-solid fa-chevron-down collapsible-chevron"></i>
                            </div>
                        </div>
                        <div id="highlights-section" class="collapsible-body px-4 pb-4">
                            <div id="lumini-highlights-content" class="space-y-3">
                                <p class="text-xs text-gray-400">Loading...</p>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </main>

        <!-- Floating Chat Widget -->
        <div id="floating-chat-container" class="fixed bottom-6 right-6 z-[999] hidden">
            <!-- The Widget Window -->
            <div id="floating-chat-widget" class="absolute bottom-16 right-0 w-80 h-[450px] bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-200/60 overflow-hidden flex flex-col origin-bottom-right opacity-0 pointer-events-none" style="transform: scale(0) translateY(20px); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;">
                <!-- Header -->
                <div id="floating-header" class="h-14 p-3 flex items-center justify-between shrink-0 cursor-move" style="background: linear-gradient(135deg, #1e293b, #334155);">
                    <div class="flex items-center gap-2 text-white">
                        <button id="floating-back-btn" onclick="backToFloatingList()" class="hidden hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition-all duration-300"><i class="fa-solid fa-arrow-left text-sm"></i></button>
                        <span id="floating-header-title" class="font-bold text-sm" style="writing-mode: horizontal-tb; text-orientation: mixed;">Messages</span>
                    </div>
                    <button onclick="toggleFloatingWidget()" class="hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition-all duration-300 text-white"><i class="fa-solid fa-xmark text-sm"></i></button>
                </div>

                <!-- List View -->
                <div id="floating-chat-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 bg-slate-50/50">
                    <!-- Injected via JS -->
                </div>

                <!-- Conversation View -->
                <div id="floating-conversation" class="hidden flex-col bg-white h-full" style="display: none;">
                    <div id="floating-messages" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar text-xs" style="scroll-behavior: smooth;"></div>
                    <form onsubmit="sendFloatingMessage(event)" class="p-2 border-t border-slate-100 bg-slate-50/80 flex gap-2 items-center">
                        <input id="floating-input" type="text" placeholder="Type a message..." class="flex-1 bg-white border border-slate-200 rounded-full px-3 py-2 text-xs outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200/50 transition-all duration-300" style="writing-mode: horizontal-tb;">
                        <button type="submit" class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center hover:bg-slate-700 transition-all duration-200 flex-shrink-0"><i class="fa-solid fa-arrow-up text-xs"></i></button>
                    </form>
                </div>
            </div>

            <!-- The Launcher Button -->
            <button onclick="toggleFloatingWidget()" id="floating-launcher" class="fixed bottom-6 right-6 w-14 h-14 rounded-full text-white shadow-lg transition-all duration-500 hidden md:flex items-center justify-center z-10 cursor-move touch-none group" style="background: linear-gradient(135deg, #1e293b, #334155); box-shadow: 0 4px 20px rgba(30, 41, 59, 0.35);">
                <i class="fa-solid fa-comment-dots text-xl transition-transform duration-300 group-hover:scale-110"></i>
                <div class="absolute inset-0 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300" style="background: linear-gradient(135deg, #334155, #475569);"></div>
                <div class="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-white hidden" id="floating-unread-dot" style="animation: pulse 2s infinite;"></div>
            </button>
        </div>
        
        <script>
            // Draggable floating launcher (mobile + desktop)
            (function(){
                const launcher = document.getElementById('floating-launcher');
                if(!launcher) return;

                let dragging = false;
                let startX = 0, startY = 0, startLeft = 0, startTop = 0;

                const getPoint = (e) => {
                    if(e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    return { x: e.clientX, y: e.clientY };
                };

                const clamp = (val, min, max) => Math.max(min, Math.min(max, val));

                const onStart = (e) => {
                    dragging = true;
                    const lrect = launcher.getBoundingClientRect();
                    startLeft = lrect.left;
                    startTop = lrect.top;
                    const p = getPoint(e);
                    startX = p.x; startY = p.y;
                    e.preventDefault();
                };
                const onMove = (e) => {
                    if(!dragging) return;
                    const p = getPoint(e);
                    const dx = p.x - startX; const dy = p.y - startY;
                    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
                    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
                    const lrect = launcher.getBoundingClientRect();
                    const left = clamp(startLeft + dx, 8, vw - lrect.width - 8);
                    const top = clamp(startTop + dy, 8, vh - lrect.height - 8);
                    launcher.style.right = 'auto';
                    launcher.style.bottom = 'auto';
                    launcher.style.left = left + 'px';
                    launcher.style.top = top + 'px';
                };
                const onEnd = () => { dragging = false; };

                launcher.addEventListener('mousedown', onStart);
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onEnd);

                launcher.addEventListener('touchstart', onStart, { passive: false });
                window.addEventListener('touchmove', onMove, { passive: false });
                window.addEventListener('touchend', onEnd, { passive: true });

                // Keep above bottom mobile nav by default
                function nudgeFromBottomUI(){
                    const mobileNav = document.getElementById('mobile-bottom-nav');
                    if(!mobileNav) return;
                    const navRect = mobileNav.getBoundingClientRect();
                    const lrect = launcher.getBoundingClientRect();
                    if(lrect.bottom > navRect.top){
                        const top = Math.max(8, navRect.top - lrect.height - 12);
                        launcher.style.top = top + 'px';
                        launcher.style.bottom = 'auto';
                    }
                }
                window.addEventListener('load', nudgeFromBottomUI);
                window.addEventListener('resize', nudgeFromBottomUI);
            })();
        </script>

        <!-- Modals -->

        <!-- ADD HIGHLIGHT MODAL (ADMIN) -->
        <div id="highlight-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Add Highlight</h3>
                    <button onclick="document.getElementById('highlight-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Project Name</label>
                        <input id="highlight-title" type="text" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 text-sm">
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Image Source</label>
                         <div class="flex gap-2 mb-2">
                             <button onclick="setHighlightImageType('upload')" id="btn-hl-upload" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-blue-600 text-white transition-all">Upload</button>
                             <button onclick="setHighlightImageType('url')" id="btn-hl-url" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-all">URL</button>
                         </div>
                         
                         <!-- Upload Input -->
                         <div id="hl-input-upload" class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center cursor-pointer hover:bg-slate-50" onclick="document.getElementById('hl-file-input').click()">
                             <i class="fa-solid fa-cloud-arrow-up text-slate-400 text-xl mb-1"></i>
                             <p class="text-[10px] text-slate-500">Click to upload image</p>
                             <input type="file" id="hl-file-input" class="hidden" accept="image/*" onchange="handleHighlightImageSelect(this)">
                         </div>
                         
                         <!-- URL Input -->
                         <input id="hl-input-url" type="text" placeholder="https://example.com/image.png" class="hidden w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 text-sm">
                         
                         <!-- Preview -->
                         <img id="hl-preview" src="" class="hidden w-full h-32 object-cover rounded-lg mt-2 border border-slate-200">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Link (Optional)</label>
                        <input id="highlight-link" type="text" placeholder="https://..." class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 text-sm">
                    </div>
                    <button onclick="saveHighlight()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 btn-bounce mt-2">Add Highlight</button>
                </div>
            </div>
        </div>

        <!-- STORY UPLOAD MODAL -->
        <div id="story-upload-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Add to Story</h3>
                    <button onclick="document.getElementById('story-upload-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 text-center">
                    <div class="w-full h-64 bg-slate-100 rounded-xl mb-4 flex items-center justify-center overflow-hidden border-2 border-dashed border-slate-300 relative cursor-pointer hover:bg-slate-50 transition-colors" onclick="document.getElementById('story-file-input').click()">
                        <div id="story-upload-placeholder" class="text-slate-400">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl mb-2"></i>
                            <p class="text-sm">Click to upload photo/video</p>
                        </div>
                        <img id="story-preview-img" class="hidden w-full h-full object-contain">
                        <video id="story-preview-video" class="hidden w-full h-full object-contain" controls></video>
                    </div>
                    <input type="file" id="story-file-input" class="hidden" accept="image/*,video/*" onchange="handleStoryFileSelect(this)">
                    <p class="text-xs text-slate-400 mb-4">Content disappears after 24 hours.</p>
                    
                    <div class="flex gap-3">
                        <button onclick="uploadStory('public')" id="btn-upload-story-public" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 rounded-xl hover:shadow-lg hover:shadow-blue-500/30 transition-all btn-bounce disabled:opacity-50 text-sm" disabled>Your Story</button>
                        <button onclick="uploadStory('close_friends')" id="btn-upload-story-cf" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl hover:shadow-lg hover:shadow-green-500/30 transition-all btn-bounce disabled:opacity-50 flex items-center justify-center gap-1 text-sm" disabled><i class="fa-solid fa-star text-xs"></i> Close Friends</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STORY VIEWER MODAL (UPDATED) -->
        <div id="story-viewer-modal" class="fixed inset-0 bg-black z-[120] hidden flex flex-col items-center justify-center animate-fade-in">
            <!-- Progress Bars -->
            <div id="story-progress-container" class="absolute top-4 left-4 right-4 flex gap-1 z-50"></div>
            
            <!-- Header -->
            <div class="absolute top-8 left-4 right-4 flex justify-between items-center z-50">
                <div class="flex items-center gap-3">
                    <img id="viewer-avatar" src="" class="w-10 h-10 rounded-full border-2 border-white/50">
                    <div>
                        <p id="viewer-name" class="text-white font-bold text-sm text-shadow">User</p>
                        <div class="flex items-center gap-2">
                            <p id="viewer-time" class="text-white/70 text-xs">2h ago</p>
                            <span id="viewer-cf-badge" class="hidden bg-green-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm"><i class="fa-solid fa-star mr-1"></i> Close Friends</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button id="viewer-delete-btn" onclick="deleteStory()" class="hidden text-white/70 hover:text-red-500 transition-colors text-lg" title="Delete Story"><i class="fa-solid fa-trash"></i></button>
                    <button onclick="closeStoryViewer()" class="text-white/80 hover:text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <!-- Content -->
            <div class="relative w-full h-full md:max-w-lg md:h-[90vh] md:rounded-xl overflow-hidden bg-slate-900 flex items-center justify-center">
                 <img id="viewer-img" class="hidden w-full h-full object-cover">
                 <video id="viewer-video" class="hidden w-full h-full object-contain" autoplay playsinline></video>
                 
                 <!-- Navigation Overlay -->
                 <div class="absolute inset-0 flex">
                     <div class="w-1/3 h-full cursor-pointer z-40" onclick="prevStory()"></div>
                     <div class="w-1/3 h-full cursor-pointer z-40" onclick="nextStory()"></div>
                     <div class="w-1/3 h-full cursor-pointer z-40" onclick="nextStory()"></div>
                 </div>

                 <!-- Interaction Bar (Bottom) -->
                 <div class="absolute bottom-0 left-0 right-0 p-4 pb-8 bg-gradient-to-t from-black/80 to-transparent z-50 flex items-center gap-3">
                     <div class="relative flex-grow">
                        <input type="text" id="story-reply-input" placeholder="Send a message..." class="w-full bg-white/10 border border-white/30 rounded-full px-5 py-3 text-white placeholder-white/70 outline-none focus:bg-black/40 backdrop-blur-md transition-all text-sm" oninput="handleStoryInput(this)" onkeydown="if(event.key==='Enter') sendStoryReply()">
                        <button id="story-send-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white w-8 h-8 rounded-full flex items-center justify-center hidden hover:bg-white/20 transition-colors" onclick="sendStoryReply()"><i class="fa-solid fa-paper-plane"></i></button>
                     </div>
                     <button id="story-like-btn" class="text-white text-3xl drop-shadow-md active:scale-90 transition-transform btn-bounce w-10 flex items-center justify-center" onclick="toggleStoryLike()"><i class="fa-regular fa-heart"></i></button>
                 </div>
                 
                 <!-- Reaction Container -->
                 <div id="story-reaction-container" class="absolute inset-0 pointer-events-none overflow-hidden z-40"></div>
            </div>
        </div>

        <!-- CLOSE FRIENDS MODAL -->
        <div id="close-friends-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4 transition-all duration-300">
             <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in h-[500px] flex flex-col">
                 <div class="flex justify-between items-center p-4 border-b border-slate-100">
                     <h3 class="font-heading font-bold text-lg text-slate-800 flex items-center gap-2"><div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-star"></i></div> Close Friends</h3>
                     <button onclick="document.getElementById('close-friends-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                 </div>
                 <div class="p-3 border-b border-slate-50">
                     <input type="text" placeholder="Search friends..." class="w-full bg-slate-100 rounded-lg px-3 py-2 text-sm outline-none" oninput="renderCloseFriendsList(this.value)">
                 </div>
                 <div id="close-friends-list" class="flex-1 overflow-y-auto custom-scrollbar p-2"></div>
                 <div class="p-4 border-t border-slate-100 bg-slate-50 text-center">
                     <p class="text-xs text-slate-500">Only Close Friends can see your green-ringed stories.</p>
                 </div>
             </div>
        </div>

        <!-- MESSAGE OPTIONS MODAL (DESKTOP) -->
        <div id="msg-options-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4 transition-all duration-300">
             <div class="bg-white p-6 rounded-2xl shadow-xl max-w-xs w-full animate-pop-in transform scale-100">
                 <h3 class="font-heading font-bold text-lg text-slate-800 mb-4 text-center">Message Options</h3>
                 <div class="space-y-3">
                     <button onclick="handleReplyAction()" class="w-full py-3 rounded-xl bg-slate-100 hover:bg-blue-50 hover:text-blue-600 text-slate-700 font-bold text-sm transition-all flex items-center justify-center gap-2 btn-bounce">
                         <i class="fa-solid fa-reply"></i> Reply
                     </button>
                     <button id="modal-edit-btn" onclick="handleEditAction()" class="w-full py-3 rounded-xl bg-slate-100 hover:bg-blue-50 hover:text-blue-600 text-slate-700 font-bold text-sm transition-all flex items-center justify-center gap-2 btn-bounce">
                         <i class="fa-solid fa-pen"></i> Edit Message
                     </button>
                     <button onclick="handleUnsendAction()" class="w-full py-3 rounded-xl bg-slate-100 hover:bg-red-50 hover:text-red-600 text-slate-700 font-bold text-sm transition-all flex items-center justify-center gap-2 btn-bounce">
                         <i class="fa-solid fa-trash"></i> Unsend Message
                     </button>
                     <button onclick="closeMsgOptionsModal()" class="w-full py-3 rounded-xl border border-slate-200 text-slate-500 font-bold text-sm hover:bg-slate-50 transition-all btn-bounce">
                         Cancel
                     </button>
                 </div>
             </div>
        </div>

        <!-- REPORT POST MODAL -->
        <div id="report-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800"><i class="fa-solid fa-flag text-orange-500 mr-2"></i>Report Violation</h3>
                    <button onclick="closeReportModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-sm text-slate-600">Please help us understand why this post is inappropriate. A report will be generated and sent to our admin team via email.</p>
                    <textarea id="report-reason" rows="4" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-100 transition-all text-sm" placeholder="Reason for reporting (e.g., Spam, Harassment, Misinformation)..."></textarea>
                </div>
                <div class="p-5 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                    <button onclick="closeReportModal()" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold text-sm transition-colors btn-bounce">Cancel</button>
                    <button onclick="submitReport()" class="px-6 py-2 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-bold text-sm shadow-md transition-all shadow-orange-200 btn-bounce">Submit Report</button>
                </div>
            </div>
        </div>

        <!-- CLEAR NOTIFICATIONS CONFIRM MODAL -->
        <div id="clear-notifs-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in text-center">
                 <div class="p-6">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce-short">
                        <i class="fa-solid fa-trash-can text-2xl text-red-500"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Clear All Notifications?</h3>
                    <p class="text-slate-500 text-sm mb-6">This action cannot be undone. All your current notifications will be permanently removed.</p>
                    <div class="flex gap-3">
                        <button onclick="closeClearNotifsModal()" class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold text-sm transition-colors btn-bounce">Cancel</button>
                        <button onclick="executeClearNotifs()" class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-sm shadow-lg shadow-red-200 transition-colors btn-bounce">Yes, Clear All</button>
                    </div>
                 </div>
            </div>
        </div>
        
        <!-- ADMIN BAN MODAL -->
        <div id="ban-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="p-6 text-center">
                    <div id="ban-icon-container" class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                        <i id="ban-icon" class="fa-solid fa-gavel text-2xl text-red-600"></i>
                    </div>
                    <h3 id="ban-modal-title" class="text-xl font-bold text-slate-800 mb-2">Ban User?</h3>
                    <p id="ban-modal-desc" class="text-slate-500 text-sm mb-6">They will be immediately logged out and lose access.</p>
                    <div class="flex gap-3">
                        <button onclick="closeBanModal()" class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold text-sm transition-colors btn-bounce">Cancel</button>
                        <button id="confirm-ban-btn" onclick="executeBan()" class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-sm shadow-lg shadow-red-200 transition-colors btn-bounce">Ban User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOLLOW LIST MODAL -->
        <div id="follow-list-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4 transition-all duration-300">
             <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in h-[500px] flex flex-col">
                 <div class="flex justify-between items-center p-4 border-b border-slate-100">
                     <h3 id="follow-list-title" class="font-heading font-bold text-lg text-slate-800">Followers</h3>
                     <button onclick="document.getElementById('follow-list-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                 </div>
                 <div id="follow-list-content" class="flex-1 overflow-y-auto custom-scrollbar p-2"></div>
             </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[85] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Settings & Privacy</h3>
                    <button onclick="closeSettingsModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Display Name (Username)</label>
                        <input id="settings-username" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                    </div>

                    <!-- DARK MODE TOGGLE -->
                    <div class="border-t border-slate-100 pt-4 flex justify-between items-center">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Appearance</label>
                            <p class="text-sm font-bold text-slate-700 dark:text-slate-200">Dark Mode</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only peer" onchange="toggleTheme()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <!-- NEW: Sound Settings -->
                    <div class="border-t border-slate-100 pt-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Notification Sound</label>
                        <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl border border-slate-200">
                            <button onclick="previewNotificationSound()" class="w-10 h-10 rounded-full bg-white text-blue-600 flex items-center justify-center transition-colors btn-bounce shadow-sm hover:shadow-md border border-slate-100">
                                <i class="fa-solid fa-play ml-1"></i>
                            </button>
                            <div class="flex-grow">
                                <p id="current-sound-name" class="text-sm font-bold text-slate-700">Default (Ping)</p>
                                <p class="text-[10px] text-slate-400">MP3/WAV  Max 500KB</p>
                            </div>
                            <button onclick="document.getElementById('sound-upload-input').click()" class="text-xs font-bold text-blue-600 hover:text-blue-700 hover:underline px-2">Change</button>
                            <button onclick="resetNotificationSound()" class="text-xs font-bold text-red-500 hover:text-red-600 hover:underline hidden px-2" id="reset-sound-btn">Reset</button>
                        </div>
                        <input type="file" id="sound-upload-input" class="hidden" accept="audio/mp3,audio/wav,audio/ogg" onchange="handleSoundUpload(this)">
                    </div>

                    <div class="border-t border-slate-100 pt-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Account Security</label>
                        <button onclick="resetPassword()" class="w-full flex items-center justify-center gap-2 p-3 border border-red-200 text-red-600 rounded-xl hover:bg-red-50 transition-colors font-semibold btn-bounce">
                            <i class="fa-solid fa-key"></i> Reset Password via Email
                        </button>
                    </div>
                </div>
                <div class="p-5 bg-slate-50 border-t border-slate-100 flex justify-end">
                    <button onclick="saveSettings()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 btn-bounce">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div id="edit-profile-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Edit Profile</h3>
                    <button onclick="closeEditProfileModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex justify-center mb-4">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('pfp-upload-modal').click()">
                            <img id="edit-modal-avatar" src="https://placehold.co/200x200" class="w-24 h-24 rounded-full border-4 border-slate-100 object-cover group-hover:brightness-75 transition-all">
                            <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 backdrop-blur-sm">
                                <i class="fa-solid fa-camera text-white text-2xl"></i>
                            </div>
                            <input type="file" id="pfp-upload-modal" class="hidden" accept="image/*" onchange="handlePfpChange(this)">
                        </div>
                    </div>
                    <div class="text-center text-xs text-slate-400 mb-4">Click picture to change</div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Headline</label>
                        <input id="edit-headline" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all" placeholder="Short description">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bio</label>
                        <textarea id="edit-bio" rows="4" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all" placeholder="Tell us about yourself..."></textarea>
                    </div>
                </div>
                <div class="p-5 bg-slate-50 border-t border-slate-100 flex justify-end">
                    <button onclick="saveProfileData()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 btn-bounce">Save Profile</button>
                </div>
            </div>
        </div>

        <!-- Post Modal -->
        <div id="post-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="relative bg-white w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="relative flex justify-between items-center p-4 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800 flex-grow text-center" id="modal-title">Create Post</h3>
                    <button onclick="closePostModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center absolute right-4 transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-4">
                    <div class="flex gap-3 mb-4">
                        <img id="modal-avatar" src="https://placehold.co/100x100?text=User" class="w-10 h-10 rounded-full">
                        <div><h4 id="modal-name" class="font-bold text-slate-800 text-sm">Guest</h4><select id="post-type-select" class="text-xs bg-slate-100 border-none rounded-md px-2 py-1 outline-none mt-0.5 font-medium text-slate-600"><option value="regular">Public</option><option value="project">Project</option></select></div>
                    </div>
                    <textarea id="post-input" rows="4" class="w-full resize-none outline-none text-slate-700 placeholder-slate-400 text-lg" placeholder="What's on your mind?"></textarea>
                    <div id="attachment-preview" class="hidden mt-2 relative group animate-fade-in"><img id="preview-img" src="" class="max-h-48 rounded-lg border border-slate-200 shadow-sm"><button onclick="clearAttachment()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-black transition-colors"><i class="fa-solid fa-xmark"></i></button></div>
                    <!-- Tagged Users Display -->
                    <div id="tagged-users-display" class="hidden mt-2 flex flex-wrap gap-2 animate-fade-in"></div>
                    
                    <div id="project-tags-input" class="hidden mt-3 pt-3 border-t border-dashed border-slate-200 animate-slide-up"><label class="text-xs font-bold text-slate-500 uppercase mb-1">Tags (Comma separated)</label><input id="tags-input" type="text" class="w-full text-sm bg-slate-50 p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-100 transition-all" placeholder="e.g. #javascript, #design"></div>
                </div>
                <div class="px-4 pb-4 flex justify-between items-center relative">
                    <span class="text-sm font-bold text-slate-700">Add to your post</span>
                    <div class="flex gap-3 text-xl">
                        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
                        <i class="fa-solid fa-image text-green-500 cursor-pointer hover:bg-green-50 p-2 rounded-full transition-all hover:scale-110" onclick="document.getElementById('file-input').click()"></i>
                        <i class="fa-solid fa-user-tag text-purple-500 cursor-pointer hover:bg-purple-50 p-2 rounded-full transition-all hover:scale-110" onclick="toggleTagUserPicker()"></i>
                        <i class="fa-solid fa-tag text-blue-500 cursor-pointer hover:bg-blue-50 p-2 rounded-full transition-all hover:scale-110" onclick="toggleTagPicker()"></i>
                        <i class="fa-solid fa-face-smile text-yellow-500 cursor-pointer hover:bg-yellow-50 p-2 rounded-full transition-all hover:scale-110" onclick="toggleEmojiPicker()"></i>
                    </div>
                </div>
                <div class="p-4 pt-0"><button id="post-submit-btn" onclick="submitPost()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 btn-bounce">Post</button></div>
                
                <div id="emoji-picker" class="hidden absolute bottom-20 right-8 bg-white border border-slate-200 shadow-xl rounded-lg p-2 grid grid-cols-5 gap-2 w-48 z-50 animate-pop-in origin-bottom-right">
                    <span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span>
                </div>
                
                <div id="tag-picker" class="hidden absolute bottom-20 right-20 bg-white border border-slate-200 shadow-xl rounded-lg p-2 w-48 z-50 max-h-40 overflow-y-auto custom-scrollbar animate-pop-in origin-bottom-right">
                   <div id="tag-list" class="space-y-1"></div>
                </div>
                
                <div id="user-tag-picker" class="hidden absolute bottom-20 right-32 bg-white border border-slate-200 shadow-xl rounded-lg p-2 w-56 z-50 max-h-48 overflow-y-auto custom-scrollbar animate-pop-in origin-bottom-right">
                   <div id="user-tag-list" class="space-y-1"></div>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0">
             <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full transform scale-95 transition-all duration-300 text-center">
                 <i class="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-4 animate-bounce-short"></i>
                 <h3 class="font-bold text-lg mb-2">Delete Post?</h3>
                 <p class="text-slate-500 text-sm mb-6">This action cannot be undone.</p>
                 <div class="flex gap-3 justify-center">
                     <button onclick="closeDeleteModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium btn-bounce">Cancel</button>
                     <button onclick="executeDelete()" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium shadow-lg shadow-red-200 btn-bounce">Delete</button>
                 </div>
             </div>
        </div>

        <!-- INCOMING CALL MODAL -->
        <div id="incoming-call-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[100] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white/10 border border-white/20 p-8 rounded-3xl shadow-2xl backdrop-blur-xl text-center max-w-sm w-full animate-pop-in">
                <div class="w-24 h-24 bg-white/20 rounded-full mx-auto flex items-center justify-center mb-6 animate-pulse-slow">
                    <i class="fa-solid fa-phone-volume text-4xl text-white"></i>
                </div>
                <h3 id="caller-name-display" class="text-2xl font-bold text-white mb-2">Incoming Call...</h3>
                <p class="text-blue-100 text-sm mb-8">Someone is trying to reach you.</p>
                <div class="flex gap-4 justify-center">
                    <button onclick="declineCall()" class="w-14 h-14 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center transition-all shadow-lg shadow-red-500/30 transform hover:scale-110 btn-bounce"><i class="fa-solid fa-phone-slash text-xl"></i></button>
                    <button onclick="answerCall()" class="w-14 h-14 rounded-full bg-green-500 hover:bg-green-600 text-white flex items-center justify-center transition-all shadow-lg shadow-green-500/30 transform hover:scale-110 animate-bounce-short btn-bounce"><i class="fa-solid fa-phone text-xl"></i></button>
                </div>
            </div>
        </div>

        <!-- ACTIVE CALL INTERFACE -->
        <div id="call-interface" class="fixed inset-0 bg-slate-900 z-[100] hidden flex flex-col animate-fade-in">
            <!-- Header -->
            <div class="absolute top-0 left-0 w-full p-4 z-20 flex justify-between items-center bg-gradient-to-b from-black/50 to-transparent transition-opacity duration-300">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                    <span id="call-status-text" class="text-white font-medium text-sm shadow-black drop-shadow-md">Connecting...</span>
                </div>
                <i id="call-icon-indicator" class="fa-solid fa-video text-white/50"></i>
            </div>
            
            <!-- Video Container -->
            <div class="relative flex-1 bg-black flex items-center justify-center overflow-hidden">
                <!-- Remote Video (Full) -->
                <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover transition-opacity duration-500"></video>
                
                <!-- Audio Placeholder -->
                <div id="audio-call-placeholder" class="absolute inset-0 flex items-center justify-center bg-slate-800 hidden">
                    <div class="text-center">
                        <div class="w-32 h-32 bg-slate-700 rounded-full flex items-center justify-center mb-4 mx-auto animate-pulse">
                            <i class="fa-solid fa-user text-5xl text-slate-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white">Voice Call</h3>
                    </div>
                </div>

                <!-- Local Video (PIP) -->
                <div class="absolute bottom-24 right-4 w-32 h-48 bg-slate-800 rounded-xl overflow-hidden shadow-2xl border-2 border-white/20 hover:scale-105 transition-transform duration-300">
                    <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover"></video>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="h-24 bg-slate-900/80 backdrop-blur flex items-center justify-center gap-6 pb-safe">
                <button id="btn-toggle-mic" onclick="toggleAudio()" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition-all flex items-center justify-center btn-bounce"><i class="fa-solid fa-microphone"></i></button>
                <button onclick="endCall()" class="w-16 h-16 rounded-full bg-red-600 hover:bg-red-700 text-white shadow-lg shadow-red-600/30 transition-all flex items-center justify-center transform hover:scale-105 btn-bounce"><i class="fa-solid fa-phone-slash text-2xl"></i></button>
                <button id="btn-toggle-cam" onclick="toggleVideo()" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition-all flex items-center justify-center btn-bounce"><i class="fa-solid fa-video"></i></button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, sendPasswordResetEmail, updateProfile, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, increment, setDoc, getDoc, getDocs, arrayUnion, arrayRemove, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- CONFIGURATION ---
        const luminiConfig = {
          apiKey: "AIzaSyDtV1VuCnNCDeuHwGX4ZUCG0WMJM82-hBY",
          authDomain: "luminix-bcc28.firebaseapp.com",
          databaseURL: "https://luminix-bcc28-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "luminix-bcc28",
          storageBucket: "luminix-bcc28.firebasestorage.app",
          messagingSenderId: "217255412785",
          appId: "1:217255412785:web:dccb64a43aa83c6b234110",
          measurementId: "G-TKJELBK1F5"
        };
        
        // Initialize Firebase
        const app = initializeApp(luminiConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "lumini_v1";

        // ADMIN CONFIGURATION
        const ADMIN_EMAILS = [
            "tenzing.jangseld2023@academy.bt",
            "ugyen.rigpay2023@academy.bt",
            "tandin.wangyel2023@academy.bt",
            "jigme.tshering2023@academy.bt",
            "tenzing@gmail.com",
            "tenzingjangseliscool@gmail.com"     
        ];
        
        const checkIsAdmin = (email) => {
            if(!email) return false;
            return ADMIN_EMAILS.map(e => e.toLowerCase()).includes(email.toLowerCase());
        };

        // State
        window.currentUser = null;
        window.userProfileCache = null; 
        window.allChats = []; 
        window.currentViewedUid = null;
        let unsubscribePosts = null;
        let unsubscribeChatList = null;
        let unsubscribeMessages = null;
        let unsubscribeNotifications = null;
        let unsubscribeUsers = null;
        let unsubscribeStories = null; 
        let currentChatId = null;
        let mySavedPosts = [];
        let allPostsCache = []; 
        let allUsersCache = [];
        let allNotifications = [];
        let postToDeleteId = null;
        let editModeId = null;
        let currentAttachment = null;
        window.editingMsgId = null;
        window.taggedUsers = [];
        let currentActionMsgId = null;
        let isFirstNotificationLoad = true;
        let isFirstChatLoad = true;
        let audioContextUnlocked = false;
        
        // --- NEW: Reply & Mobile Interaction State ---
        window.replyingTo = null; // { id, name, text }
        let touchData = {};
        
        // --- NEW: Collaborate State ---
        window.currentCollabFilter = 'all';

        // --- STORIES STATE ---
        let allStories = [];
        let groupedStories = {};
        let activeStoryUid = null;
        let activeStoryIndex = 0;
        let storyTimer = null;
        let currentStoryUpload = { file: null, type: null, data: null };
        
        // --- FLOATING WIDGET STATE ---
        window.isFloatingWidgetOpen = false;
        window.currentFloatingChatId = null;
        window.unsubscribeFloatingMessages = null;
        window.hasDraggedWidget = false;

        // --- CUSTOM SOUND VARIABLES ---
        let pendingSoundData = null;
        let isResettingSound = false;

        // --- HIGHLIGHTS STATE ---
        let currentHighlightImage = null;
        let highlightImageType = 'upload'; // 'upload' or 'url'

        // --- THEME LOGIC (SYNCED) ---
        window.toggleTheme = async () => {
            const isDark = document.getElementById('dark-mode-toggle').checked;
            if(isDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('lumini_theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('lumini_theme', 'light');
            }

            // Sync with Firebase if logged in
            if(currentUser) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), {
                        theme: isDark ? 'dark' : 'light'
                    });
                } catch(e) {
                    console.log("Theme sync error (ignorable):", e);
                }
            }
        };

        // --- AUDIO UNLOCK LOGIC ---
        function unlockAudio() {
            if (audioContextUnlocked) return;
            const audio = document.getElementById('notification-sound');
            if (audio) {
                if(!audio.src) audio.src = "sound.mp3";
                const p = audio.play();
                if (p !== undefined) {
                    p.then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audioContextUnlocked = true;
                        document.removeEventListener('click', unlockAudio);
                        document.removeEventListener('touchstart', unlockAudio);
                        document.removeEventListener('keydown', unlockAudio);
                    }).catch(e => {
                    });
                }
            }
        }

        document.addEventListener('click', unlockAudio);
        document.addEventListener('touchstart', unlockAudio);
        document.addEventListener('keydown', unlockAudio);

        // --- PLAY SOUND LOGIC ---
        window.playNotificationSound = () => {
            const audio = document.getElementById('notification-sound');
            if(!audio) return;
            
            const customSound = window.userProfileCache?.notificationSound;
            const targetSrc = customSound || "sound.mp3";
            
            let shouldUpdate = false;
            
            if (targetSrc.length < 100) {
                 if (!audio.src.endsWith(targetSrc)) shouldUpdate = true;
            } else {
                 if (audio.src !== targetSrc) shouldUpdate = true;
            }
            
            if (shouldUpdate) {
                audio.src = targetSrc;
            }
            
            audio.currentTime = 0;
            audio.play().catch(e => {}); 
        };
        
        window.handleSoundUpload = (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 500 * 1024) { 
                    alert("File is too large. Please select an audio file under 500KB.");
                    input.value = "";
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    pendingSoundData = e.target.result;
                    isResettingSound = false;
                    document.getElementById('current-sound-name').innerText = "Custom Sound Selected";
                    document.getElementById('reset-sound-btn').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        };
        
        window.resetNotificationSound = () => {
            pendingSoundData = null;
            isResettingSound = true;
            document.getElementById('sound-upload-input').value = "";
            document.getElementById('current-sound-name').innerText = "Default (Ping) - Will be reset";
            document.getElementById('reset-sound-btn').classList.add('hidden');
        };
        
        window.previewNotificationSound = () => {
            let srcToPlay = "sound.mp3";
            if (pendingSoundData) {
                srcToPlay = pendingSoundData;
            } else if (!isResettingSound && window.userProfileCache?.notificationSound) {
                srcToPlay = window.userProfileCache.notificationSound;
            }
            const tempAudio = new Audio(srcToPlay);
            tempAudio.play().catch(e => alert("Could not play sound preview."));
        };
        
        // --- ADMIN MODAL LOGIC ---
        let userToBanId = null;
        let userToBanCurrentStatus = false;

        window.toggleBan = (uid, currentStatus) => {
            userToBanId = uid;
            userToBanCurrentStatus = currentStatus;
            
            const modal = document.getElementById('ban-modal');
            const title = document.getElementById('ban-modal-title');
            const desc = document.getElementById('ban-modal-desc');
            const btn = document.getElementById('confirm-ban-btn');
            const iconContainer = document.getElementById('ban-icon-container');
            const icon = document.getElementById('ban-icon');

            if (currentStatus) {
                title.innerText = "Unban User?";
                desc.innerText = "They will regain access to Lumini immediately.";
                btn.innerText = "Unban User";
                btn.classList.remove('bg-red-600', 'hover:bg-red-700', 'shadow-red-200');
                btn.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-green-200');
                iconContainer.classList.remove('bg-red-100');
                iconContainer.classList.add('bg-green-100');
                icon.classList.remove('text-red-600', 'fa-gavel');
                icon.classList.add('text-green-600', 'fa-unlock');
            } else {
                title.innerText = "Ban User?";
                desc.innerText = "They will be immediately logged out and lose access.";
                btn.innerText = "Ban User";
                btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'shadow-green-200');
                btn.classList.add('bg-red-600', 'hover:bg-red-700', 'shadow-red-200');
                iconContainer.classList.remove('bg-green-100');
                iconContainer.classList.add('bg-red-100');
                icon.classList.remove('text-green-600', 'fa-unlock');
                icon.classList.add('text-red-600', 'fa-gavel');
            }
            
            modal.classList.remove('hidden');
        };

        window.closeBanModal = () => {
            document.getElementById('ban-modal').classList.add('hidden');
            userToBanId = null;
        };

        window.executeBan = async () => {
            if (!userToBanId) return;
            const newStatus = !userToBanCurrentStatus;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', userToBanId), {
                    isBanned: newStatus
                });
                closeBanModal();
                viewProfile(userToBanId);
            } catch (e) {
                console.error("Error banning user:", e);
                alert("Failed to update ban status.");
            }
        };

        // --- CALL STATE ---
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentCallId = null;
        let unsubscribeCall = null;
        let incomingCallData = null;
        let callType = 'video';
        let iceCandidateQueue = [];
        
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        // Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDirRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', user.uid);
                const userDirSnap = await getDoc(userDirRef);
                if (userDirSnap.exists() && userDirSnap.data().isBanned) {
                    await signOut(auth);
                    document.getElementById('auth-error').innerText = "Account Banned: Access revoked by Admin.";
                    document.getElementById('auth-error').classList.remove('hidden');
                    document.getElementById('auth-overlay').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                    return;
                }

                if (checkIsAdmin(user.email)) {
                     if (userDirSnap.exists()) {
                         await updateDoc(userDirRef, { isAdmin: true });
                     }
                     const adminBtn = document.getElementById('admin-add-highlight-btn');
                     if(adminBtn) adminBtn.classList.remove('hidden');
                } else {
                     const adminBtn = document.getElementById('admin-add-highlight-btn');
                     if(adminBtn) adminBtn.classList.add('hidden');
                }

                currentUser = user;
                window.currentUser = user;
                
                if(!user.displayName) {
                    const name = user.email.split('@')[0];
                    await updateProfile(user, { displayName: name });
                }
                
                const defaultAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=random`;
                if(!user.photoURL) {
                     await updateProfile(user, { photoURL: defaultAvatar });
                }

                if (!userDirSnap.exists()) {
                    await setDoc(userDirRef, {
                        name: user.displayName || user.email.split('@')[0],
                        photoURL: user.photoURL || defaultAvatar,
                        headline: "",
                        id: user.uid,
                        theme: 'light',
                        createdAt: serverTimestamp()
                    });
                } else {
                    const userData = userDirSnap.data();
                    if(userData.theme) {
                        if(userData.theme === 'dark') {
                            document.documentElement.classList.add('dark');
                            localStorage.setItem('lumini_theme', 'dark');
                            document.getElementById('dark-mode-toggle').checked = true;
                        } else {
                            document.documentElement.classList.remove('dark');
                            localStorage.setItem('lumini_theme', 'light');
                            document.getElementById('dark-mode-toggle').checked = false;
                        }
                    }
                }
                
                const userProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                const userProfileSnap = await getDoc(userProfileRef);
                if(!userProfileSnap.exists()) {
                    await setDoc(userProfileRef, {
                        headline: "",
                        bio: "",
                        savedPosts: [],
                        followers: [],
                        following: [],
                        closeFriends: []
                    });
                }
                
                document.getElementById('auth-overlay').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => document.getElementById('auth-overlay').classList.add('hidden'), 700);

                document.getElementById('floating-chat-container').classList.remove('hidden');

                loadData();
            } else {
                currentUser = null;
                window.currentUser = null;
                document.getElementById('auth-overlay').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                document.getElementById('floating-chat-container').classList.add('hidden');
            }
        });

        // --- NEW: Follow Logic ---
        window.toggleFollow = async (targetUid) => {
            if(!currentUser || !targetUid || targetUid === currentUser.uid) return;

            const myRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
            const targetRef = doc(db, 'artifacts', appId, 'users', targetUid, 'profile', 'main');
            
            const myDoc = await getDoc(myRef);
            const myData = myDoc.data();
            const isFollowing = myData.following && myData.following.includes(targetUid);

            const btn = document.getElementById('follow-btn');
            const btnText = btn.querySelector('span');
            
            if(isFollowing) {
                await updateDoc(myRef, { following: arrayRemove(targetUid) });
                await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
                btnText.innerText = "Follow";
                btn.classList.remove('bg-slate-200', 'text-slate-700');
                btn.classList.add('bg-blue-600', 'text-white');
            } else {
                await updateDoc(myRef, { following: arrayUnion(targetUid) });
                await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
                btnText.innerText = "Unfollow";
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-slate-200', 'text-slate-700');
                
                await addDoc(collection(db, 'artifacts', appId, 'users', targetUid, 'notifications'), {
                    type: 'follow',
                    fromUid: currentUser.uid,
                    fromName: currentUser.displayName,
                    read: false,
                    createdAt: serverTimestamp()
                });
            }
            viewProfile(targetUid);
        };

        window.openFollowModal = async (type) => {
            const uid = window.currentViewedUid || currentUser.uid;
            const modal = document.getElementById('follow-list-modal');
            const title = document.getElementById('follow-list-title');
            const content = document.getElementById('follow-list-content');
            
            title.innerText = type === 'followers' ? 'Followers' : 'Following';
            content.innerHTML = '<div class="flex justify-center p-4"><i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i></div>';
            modal.classList.remove('hidden');
            
            const docRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'main');
            const docSnap = await getDoc(docRef);
            
            if(docSnap.exists()) {
                const data = docSnap.data();
                const listIds = data[type] || [];
                
                if(listIds.length === 0) {
                    content.innerHTML = '<p class="text-center text-slate-400 py-4 text-sm">No users found.</p>';
                    return;
                }
                
                const userPromises = listIds.map(id => getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', id)));
                const userDocs = await Promise.all(userPromises);
                
                content.innerHTML = userDocs.map(d => {
                    if(!d.exists()) return '';
                    const u = d.data();
                    return `
                    <div class="flex items-center gap-3 p-3 hover:bg-slate-50 cursor-pointer rounded-lg transition-colors" onclick="document.getElementById('follow-list-modal').classList.add('hidden'); viewProfile('${u.id}')">
                        <img src="${u.photoURL}" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                        <div>
                            <p class="font-bold text-sm text-slate-800">${u.name}</p>
                            <p class="text-xs text-slate-500 truncate w-48">${u.headline || ''}</p>
                        </div>
                    </div>`;
                }).join('');
            } else {
                 content.innerHTML = '<p class="text-center text-slate-400 py-4 text-sm">Error loading list.</p>';
            }
        };

        // --- CALL LOGIC ---
        function monitorIncomingCalls() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'calls'), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    if (change.type === "added" && data.callee === currentUser.uid && data.status === 'offering') {
                        showIncomingCall(change.doc.id, data);
                    }
                });
            });
        }
        
        function showIncomingCall(callId, data) {
            currentCallId = callId;
            incomingCallData = data;
            const type = data.callType || 'video';
            callType = type;
            document.getElementById('caller-name-display').innerText = (data.callerName || "Someone") + ` is calling (${type})...`;
            document.getElementById('incoming-call-modal').classList.remove('hidden');
            
            const r = document.getElementById('call-ringtone');
            r.currentTime = 0;
            const playPromise = r.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Autoplay blocked. User needs to interact with DOM first.");
                });
            }
        }

        window.declineCall = async () => {
            document.getElementById('incoming-call-modal').classList.add('hidden');
            document.getElementById('call-ringtone').pause();
            if(incomingCallData) {
                logSystemMessage(` Missed ${incomingCallData.callType || 'video'} call`, incomingCallData.caller);
            }
            currentCallId = null;
            incomingCallData = null;
        };

        window.answerCall = async () => {
            document.getElementById('incoming-call-modal').classList.add('hidden');
            document.getElementById('call-ringtone').pause();
            setupCallInterface(callType);
            document.getElementById('call-status-text').innerText = "Connecting...";

            const callId = currentCallId;
            const offer = incomingCallData.offer;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: callType === 'video', audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                const remoteStream = new MediaStream();
                document.getElementById('remoteVideo').srcObject = remoteStream;

                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => {
                    event.streams[0].getTracks().forEach(track => {
                        remoteStream.addTrack(track);
                    });
                };

                peerConnection.onicecandidate = async (event) => {
                    if(event.candidate) {
                        const calleeCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', callId, 'calleeCandidates');
                        await addDoc(calleeCandidatesRef, event.candidate.toJSON());
                    }
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                const callDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', callId);
                await updateDoc(callDoc, { answer: { type: answer.type, sdp: answer.sdp }, status: 'answered' });

                const callerCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', callId, 'callerCandidates');
                onSnapshot(callerCandidatesRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            peerConnection.addIceCandidate(candidate).catch(e => console.error("Error adding candidate", e));
                        }
                    });
                });
                
                onSnapshot(callDoc, (snap) => {
                    if(snap.exists() && snap.data().status === 'ended') endCallCleanup();
                });
            } catch (err) {
                console.error("Error answering call:", err);
                alert("Call Failed: Could not access camera/microphone or connect. Check permissions.");
                endCallCleanup();
            }
        };

        window.initiateCall = async (type = 'video') => {
            if(!currentChatId) return;
            const parts = currentChatId.split('_');
            const targetUid = parts.find(id => id !== currentUser.uid);
            if(!targetUid) return alert("Cannot call this user.");

            callType = type;
            setupCallInterface(type);
            document.getElementById('call-status-text').innerText = "Calling...";
            
            const r = document.getElementById('call-ringtone');
            r.currentTime = 0;
            r.play().catch(e => console.log("Autoplay blocked:", e));

            try {
                const callDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'calls'));
                currentCallId = callDocRef.id;

                localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                const remoteStream = new MediaStream();
                document.getElementById('remoteVideo').srcObject = remoteStream;

                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => {
                    event.streams[0].getTracks().forEach(track => {
                        remoteStream.addTrack(track);
                    });
                };

                peerConnection.onicecandidate = async (event) => {
                    if(event.candidate) {
                        const callerCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'callerCandidates');
                        await addDoc(callerCandidatesRef, event.candidate.toJSON());
                    }
                };

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await setDoc(callDocRef, {
                    caller: currentUser.uid,
                    callerName: document.getElementById('menu-name').innerText,
                    callee: targetUid,
                    callType: type,
                    offer: { type: offer.type, sdp: offer.sdp },
                    status: 'offering',
                    createdAt: serverTimestamp()
                });
                
                logSystemMessage(` Incoming ${type} call`, targetUid);

                unsubscribeCall = onSnapshot(callDocRef, (snap) => {
                    const data = snap.data();
                    if(!data) return;
                    
                    if(!peerConnection.currentRemoteDescription && data.answer) {
                        document.getElementById('call-ringtone').pause();
                        const answer = new RTCSessionDescription(data.answer);
                        peerConnection.setRemoteDescription(answer).then(() => {});
                        document.getElementById('call-status-text').innerText = "Connected";
                    }
                    
                    if(data.status === 'ended') endCallCleanup();
                });

                const calleeCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'calleeCandidates');
                onSnapshot(calleeCandidatesRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            if (peerConnection.remoteDescription) {
                                peerConnection.addIceCandidate(candidate).catch(e => console.error("Error adding candidate", e));
                            } else {
                                setTimeout(() => {
                                     if(peerConnection.remoteDescription) peerConnection.addIceCandidate(candidate).catch(e => console.error(e));
                                }, 1000);
                            }
                        }
                    });
                });
            } catch (err) {
                console.error("Error initiating call:", err);
                alert("Call Failed: Could not access camera/microphone. Ensure you are on HTTPS.");
                endCallCleanup();
            }
        };
        
        function setupCallInterface(type) {
            document.getElementById('call-interface').classList.remove('hidden');
            const icon = document.getElementById('call-icon-indicator');
            const placeholder = document.getElementById('audio-call-placeholder');
            
            if(type === 'audio') {
                icon.className = "fa-solid fa-phone text-green-500 animate-pulse";
                placeholder.classList.remove('hidden');
                document.getElementById('btn-toggle-cam').classList.add('hidden');
            } else {
                icon.className = "fa-solid fa-video text-red-500 animate-pulse";
                placeholder.classList.add('hidden');
                document.getElementById('btn-toggle-cam').classList.remove('hidden');
            }
        }

        window.endCall = async () => {
             if(currentCallId) {
                 try {
                     await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), { status: 'ended' });
                     logSystemMessage("Call ended");
                 } catch(e) {}
             }
             endCallCleanup();
        };

        function endCallCleanup() {
            document.getElementById('call-interface').classList.add('hidden');
            document.getElementById('call-ringtone').pause();
            if(peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if(localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if(unsubscribeCall) unsubscribeCall();
            currentCallId = null;
        }

        window.toggleAudio = () => {
            if(localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('btn-toggle-mic').classList.toggle('bg-red-500');
                document.getElementById('btn-toggle-mic').classList.toggle('bg-slate-700');
            }
        };

        window.toggleVideo = () => {
             if(localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
                document.getElementById('btn-toggle-cam').classList.toggle('bg-red-500');
                document.getElementById('btn-toggle-cam').classList.toggle('bg-slate-700');
            }
        };
        
        async function logSystemMessage(text, targetUid = null) {
            let chatId = currentChatId;
            if(!chatId && targetUid) {
                 chatId = [currentUser.uid, targetUid].sort().join('_');
            }
            if(chatId) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), { 
                    text: text, 
                    type: 'system',
                    senderId: 'system', 
                    createdAt: serverTimestamp() 
                });
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), {
                    lastUpdated: serverTimestamp()
                }, { merge: true });
            }
        }

        // --- Core Functions ---

        function loadData() {
            if (!currentUser) return;
            
            if (unsubscribePosts) unsubscribePosts();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'posts'));
            unsubscribePosts = onSnapshot(q, (snap) => {
                const posts = [];
                snap.forEach(d => posts.push({id: d.id, ...d.data()}));
                posts.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                allPostsCache = posts;
                if(!document.getElementById('view-feed').classList.contains('hidden')) renderFeed(posts);
                if(!document.getElementById('view-collaborate').classList.contains('hidden')) renderCollaborate();
            });

            if(unsubscribeUsers) unsubscribeUsers();
            unsubscribeUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), (snap) => {
                const u = []; 
                snap.forEach(d => u.push({id: d.id, ...d.data()}));
                allUsersCache = u;
                renderNetwork(u);
                if(window.allChats.length) renderChatList(window.allChats);
                renderTaggedUsers();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), (doc) => {
                if(doc.exists()) {
                    const d = doc.data();
                    window.userProfileCache = d; 
                    mySavedPosts = d.savedPosts || [];
                    updateUI(d);
                    
                    const soundNameEl = document.getElementById('current-sound-name');
                    if (d.notificationSound) {
                        if (soundNameEl) soundNameEl.innerText = "Custom Sound Active";
                        document.getElementById('reset-sound-btn').classList.remove('hidden');
                    }
                    
                    if(allPostsCache.length) renderFeed(allPostsCache);
                    renderSavedPosts();
                } else {
                    updateUI({});
                }
            });

            monitorNotifications();
            monitorChats();
            monitorIncomingCalls();
            monitorStories(); 
            monitorHighlights(); 
        }

        function monitorHighlights() {
             const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'highlights'), orderBy('createdAt', 'desc'));
             onSnapshot(q, (snap) => {
                 const items = [];
                 snap.forEach(d => items.push({id: d.id, ...d.data()}));
                 renderHighlights(items);
             });
        }

        function renderHighlights(items) {
             const container = document.getElementById('lumini-highlights-content');
             if(!items.length) {
                 container.innerHTML = '<p class="text-xs text-gray-400">Trending discussions will appear here.</p>';
                 return;
             }
             const isAdmin = checkIsAdmin(currentUser.email);
             container.innerHTML = items.map(item => `
                 <div class="flex items-center gap-3 group relative hover:bg-slate-50 p-2 rounded-xl transition-colors cursor-pointer" onclick="${item.link ? `window.open('${item.link}', '_blank')` : ''}">
                     <img src="${item.imageUrl}" class="w-12 h-12 rounded-lg object-cover bg-slate-200">
                     <div class="flex-grow">
                         <h4 class="font-bold text-sm text-slate-800">${item.title}</h4>
                     </div>
                     ${isAdmin ? `<button onclick="event.stopPropagation(); deleteHighlight('${item.id}')" class="hidden group-hover:block absolute right-2 top-2 text-red-400 hover:text-red-600"><i class="fa-solid fa-trash text-xs"></i></button>` : ''}
                 </div>
             `).join('');
        }

        window.openHighlightModal = () => {
             document.getElementById('highlight-modal').classList.remove('hidden');
             document.getElementById('highlight-title').value = '';
             document.getElementById('highlight-link').value = '';
             document.getElementById('hl-input-url').value = '';
             document.getElementById('hl-file-input').value = '';
             document.getElementById('hl-preview').classList.add('hidden');
             currentHighlightImage = null;
             setHighlightImageType('upload');
        };

        window.setHighlightImageType = (type) => {
            highlightImageType = type;
            if(type === 'upload') {
                document.getElementById('btn-hl-upload').className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-blue-600 text-white transition-all";
                document.getElementById('btn-hl-url').className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-all";
                document.getElementById('hl-input-upload').classList.remove('hidden');
                document.getElementById('hl-input-url').classList.add('hidden');
            } else {
                document.getElementById('btn-hl-upload').className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-all";
                document.getElementById('btn-hl-url').className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-blue-600 text-white transition-all";
                document.getElementById('hl-input-upload').classList.add('hidden');
                document.getElementById('hl-input-url').classList.remove('hidden');
            }
        };

        window.handleHighlightImageSelect = (input) => {
             if(input.files && input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     currentHighlightImage = e.target.result;
                     document.getElementById('hl-preview').src = currentHighlightImage;
                     document.getElementById('hl-preview').classList.remove('hidden');
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        };

        window.saveHighlight = async () => {
             const title = document.getElementById('highlight-title').value;
             const link = document.getElementById('highlight-link').value;
             let imageUrl = currentHighlightImage;
             if(highlightImageType === 'url') {
                 imageUrl = document.getElementById('hl-input-url').value;
             }
             if(!title || !imageUrl) return alert("Title and Image are required.");
             try {
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'highlights'), {
                     title, 
                     imageUrl, 
                     link, 
                     createdAt: serverTimestamp(),
                     createdBy: currentUser.uid
                 });
                 document.getElementById('highlight-modal').classList.add('hidden');
             } catch(e) {
                 console.error("Highlight save failed", e);
                 alert("Failed to save.");
             }
        };
        
        window.deleteHighlight = async (id) => {
             if(confirm("Delete highlight?")) {
                 await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'highlights', id));
             }
        };

        function monitorNotifications() {
            if(unsubscribeNotifications) unsubscribeNotifications();
            const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications'), orderBy('createdAt', 'desc'));
            
            unsubscribeNotifications = onSnapshot(q, (snap) => {
                if (isFirstNotificationLoad) {
                    isFirstNotificationLoad = false;
                } 

                allNotifications = [];
                let unreadCount = 0;
                snap.forEach(d => {
                    const n = {id: d.id, ...d.data()};
                    allNotifications.push(n);
                    if(!n.read) unreadCount++;
                });
                const badge = document.getElementById('notification-badge');
                if(badge) badge.style.display = unreadCount > 0 ? 'block' : 'none';
                renderNotificationsList();
            });
        }
        
        function renderNotificationsList() {
            const list = document.getElementById('notification-list');
            if(allNotifications.length === 0) {
                 list.innerHTML = `<p class="text-center text-xs text-slate-400 py-4">No new notifications.</p>`;
                 return;
            }
            list.innerHTML = allNotifications.map(n => {
                let content = '';
                let icon = 'fa-user';
                let iconColor = 'text-blue-500';
                if(n.type === 'like') { content = `liked your post.`; icon = 'fa-heart'; iconColor = 'text-red-500'; }
                else if(n.type === 'comment') { content = `commented on your post.`; icon = 'fa-comment'; }
                else if(n.type === 'follow') { content = `started following you.`; icon = 'fa-user-plus'; }
                else if(n.type === 'mention') { content = `mentioned you in a post.`; icon = 'fa-at'; iconColor = 'text-purple-500'; }
                else if(n.type === 'tag') { content = `tagged you in a post.`; icon = 'fa-tag'; iconColor = 'text-green-500'; } 
                else if (n.type === 'admin_delete') { content = `removed your post for violating guidelines.`; icon = 'fa-trash'; iconColor = 'text-red-600'; }
                else if(n.type === 'story_like') { content = `liked your story.`; icon = 'fa-heart'; iconColor = 'text-red-500'; }
                else if(n.type === 'story_reply') { content = `replied to your story: "${n.text || ''}"`; icon = 'fa-reply'; iconColor = 'text-purple-500'; }

                return `
                <div class="flex items-start gap-3 p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors ${n.read ? 'opacity-70' : 'bg-blue-50/50'}" onclick="handleNotificationClick('${n.id}', '${n.type}', '${n.postId || ''}', '${n.fromUid}')">
                    <div class="mt-1"><i class="fa-solid ${icon} ${iconColor}"></i></div>
                    <div>
                        <p class="text-sm text-slate-800"><span class="font-bold">${n.fromName || 'Someone'}</span> ${content}</p>
                        <p class="text-xs text-slate-400 mt-1">${n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleDateString() : ''}</p>
                    </div>
                </div>`;
            }).join('');
        }
        
        window.handleNotificationClick = async (nid, type, postId, fromUid) => {
             await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications', nid), { read: true });
             if(type === 'like' || type === 'comment' || type === 'mention' || type === 'tag') {
                 router('feed');
                 setTimeout(() => {
                     const postElement = document.getElementById(`post-${postId}-feed`);
                     if (postElement) {
                         postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         postElement.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2', 'scale-[1.01]', 'transition-transform');
                         setTimeout(() => { postElement.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'scale-[1.01]'); }, 2000);
                     }
                 }, 400);
             } else if (type === 'follow' || type === 'story_like' || type === 'story_reply') {
                 viewProfile(fromUid);
             }
        };

        function monitorChats() {
            if(unsubscribeChatList) unsubscribeChatList();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats'), orderBy('lastUpdated', 'desc'));
            unsubscribeChatList = onSnapshot(q, (snap) => {
                let hasUnread = false;
                const chats = [];
                snap.forEach(d => {
                    const data = d.data();
                    const parts = d.id.split('_');
                    if(parts.includes(currentUser.uid)) {
                        chats.push({id: d.id, ...data});
                        if(data.readBy && !data.readBy.includes(currentUser.uid)) hasUnread = true;
                    }
                });

                if (!isFirstChatLoad) {
                    snap.docChanges().forEach(change => {
                        const data = change.doc.data();
                        if ((change.type === 'added' || change.type === 'modified') &&
                            data.participants && data.participants.includes(currentUser.uid) &&
                            data.readBy && !data.readBy.includes(currentUser.uid)) {
                             window.playNotificationSound(); 
                        }
                    });
                }
                isFirstChatLoad = false;

                const badge = document.getElementById('chat-badge');
                if(badge) badge.style.display = hasUnread ? 'block' : 'none';
                window.allChats = chats;
                renderChatList(chats);
                if(window.isFloatingWidgetOpen) renderFloatingChatList();
            });
        }

        function renderChatList(chats) {
            const container = document.getElementById('chat-list');
            if(chats.length === 0) { container.innerHTML = '<p class="text-center text-xs text-slate-400 mt-4">No chats yet.</p>'; return; }
            container.innerHTML = chats.map(c => {
                const parts = c.id.split('_');
                const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                const otherUser = allUsersCache.find(u => u.id === otherUid) || { name: "User", photoURL: "https://placehold.co/100x100" };
                const isUnread = c.readBy && !c.readBy.includes(currentUser.uid);
                
                return `<div onclick="openChat('${c.id}', '${otherUser.name}')" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all duration-200 ${c.id === currentChatId ? 'bg-white shadow-md ring-1 ring-slate-100 scale-[1.02]' : 'hover:bg-white hover:shadow-sm'} ${isUnread ? 'bg-blue-50/50' : ''}">
                    <div class="relative">
                        <img src="${otherUser.photoURL}" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                        ${isUnread ? '<div class="absolute top-0 right-0 w-3 h-3 bg-blue-500 rounded-full border-2 border-white animate-pulse"></div>' : ''}
                    </div>
                    <div class="truncate flex-grow">
                        <h4 class="font-bold text-sm text-slate-800 ${isUnread ? 'text-black' : ''}">${otherUser.name}</h4>
                        ${isUnread ? '<p class="text-[10px] text-blue-600 font-bold">New message</p>' : ''}
                    </div>
                </div>`;
            }).join('');
        }

        window.openChat = async (chatId, name) => {
            currentChatId = chatId;
            if(window.allChats) renderChatList(window.allChats);
            
            document.querySelector('#chat-header span').innerText = name;
            document.getElementById('start-video-call-btn').classList.remove('hidden');
            document.getElementById('start-audio-call-btn').classList.remove('hidden');
            document.getElementById('delete-chat-btn').classList.remove('hidden');

            const input = document.getElementById('message-input');
            const btn = document.getElementById('message-send-btn');
            input.disabled = false;
            btn.disabled = false;
            input.focus();

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), {
                readBy: arrayUnion(currentUser.uid)
            }, { merge: true });

            if(unsubscribeMessages) unsubscribeMessages();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), orderBy('createdAt', 'asc'));
            
            // --- REVAMPED MESSAGE RENDERING WITH MORPH ANIMATIONS, TIMESTAMPS, READ RECEIPTS ---
            unsubscribeMessages = onSnapshot(q, (snap) => {
                const c = document.getElementById('chat-messages');
                c.innerHTML = '';
                const messages = [];
                snap.forEach(d => messages.push({id: d.id, ...d.data()}));
                
                let lastDateLabel = '';
                
                messages.forEach((m, idx) => {
                    if(m.type === 'system') {
                        c.innerHTML += `<div class="msg-system animate-fade-in">${m.text}</div>`;
                        return;
                    }
                    
                    const isMe = m.senderId === currentUser.uid;
                    const parts = currentChatId.split('_');
                    const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                    const senderName = isMe ? 'You' : name;

                    // DATE DIVIDER
                    if(m.createdAt) {
                        const msgDate = new Date(m.createdAt.toMillis());
                        const today = new Date();
                        const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
                        let dateLabel = '';
                        if(msgDate.toDateString() === today.toDateString()) dateLabel = 'Today';
                        else if(msgDate.toDateString() === yesterday.toDateString()) dateLabel = 'Yesterday';
                        else dateLabel = msgDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: msgDate.getFullYear() !== today.getFullYear() ? 'numeric' : undefined });
                        
                        if(dateLabel !== lastDateLabel) {
                            lastDateLabel = dateLabel;
                            c.innerHTML += `<div class="msg-timestamp-divider"><span>${dateLabel}</span></div>`;
                        }
                    }

                    // TIME STRING
                    let timeStr = '';
                    if(m.createdAt) {
                        const d = new Date(m.createdAt.toMillis());
                        timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    }

                    // REPLY CONTENT UI
                    let replyBlock = '';
                    if(m.replyTo) {
                        replyBlock = `
                        <div class="reply-context">
                             <span class="font-bold text-xs">${m.replyTo.name}</span>
                             <span class="truncate text-xs text-slate-500">${m.replyTo.text}</span>
                        </div>`;
                    }
                    
                    // READ RECEIPT (only for my messages)
                    let receiptHtml = '';
                    if(isMe && timeStr) {
                        // Check if other user has read (chat doc readBy includes otherUid)
                        const chatDoc = window.allChats ? window.allChats.find(ch => ch.id === currentChatId) : null;
                        const isRead = chatDoc && chatDoc.readBy && chatDoc.readBy.includes(otherUid);
                        const isLastMsg = idx === messages.length - 1;
                        receiptHtml = isLastMsg ? `<span class="msg-read-receipt"><i class="fa-solid fa-check-double check ${isRead ? 'read' : ''}"></i></span>` : '';
                    }

                    // DESKTOP TRIGGER
                    let triggerHtml = '';
                    if (isMe) {
                         const now = Date.now();
                         const msgTime = m.createdAt ? m.createdAt.toMillis() : now;
                         const canEdit = (now - msgTime) < 120000;
                         triggerHtml = `
                         <div class="text-[10px] text-slate-400 hover:text-blue-600 cursor-pointer mt-1 mr-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center gap-1 select-none md:flex hidden" onclick="openMsgOptions('${m.id}', ${canEdit})">
                            <i class="fa-solid fa-ellipsis"></i> Options
                         </div>
                         <div class="hidden" id="msg-text-${m.id}">${m.text}</div>
                         `;
                    } else {
                        triggerHtml = `
                         <div class="text-[10px] text-slate-400 hover:text-blue-600 cursor-pointer mt-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center gap-1 select-none md:flex hidden" onclick="startReply('${m.id}', '${senderName}', '${m.text.replace(/'/g, "\\'")}')">
                            <i class="fa-solid fa-reply"></i> Reply
                         </div>
                         <div class="hidden" id="msg-text-${m.id}">${m.text}</div>
                         `;
                    }

                    // SWIPE INDICATOR UI
                    const swipeIndicator = `<div class="reply-arrow-indicator ${isMe ? 'right-full mr-2' : 'left-full ml-2'}"><i class="fa-solid fa-reply"></i></div>`;

                    c.innerHTML += `
                    <div class="flex w-full mb-1 ${isMe?'justify-end':'justify-start'} group msg-group" id="msg-container-${m.id}">
                        <div class="flex flex-col ${isMe?'items-end':'items-start'} max-w-[85%] w-full min-w-0 relative">
                            <div class="msg-bubble ${isMe?'msg-me':'msg-them'} relative" id="msg-bubble-${m.id}">
                                ${swipeIndicator}
                                ${replyBlock}
                                ${m.text}
                                ${m.edited ? '<span class="text-[10px] opacity-60 block text-right italic mt-1">(edited)</span>' : ''}
                            </div>
                            <div class="msg-time ${isMe ? 'flex-row-reverse' : ''}">
                                ${timeStr ? `<span>${timeStr}</span>` : ''}
                                ${receiptHtml}
                            </div>
                            ${triggerHtml}
                        </div>
                    </div>`;
                });
                
                // Add typing indicator placeholder at bottom
                c.innerHTML += `<div id="typing-indicator-container" class="hidden flex justify-start mb-1 msg-group">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>`;
                
                // Attach Touch Listeners manually after render
                messages.forEach(m => {
                    if(m.type !== 'system') {
                        const bubble = document.getElementById(`msg-bubble-${m.id}`);
                        const container = document.getElementById(`msg-container-${m.id}`);
                        const isMe = m.senderId === currentUser.uid;
                        const senderName = isMe ? 'You' : name;
                        
                        if(bubble) {
                            handleSwipe(bubble, m.id, m.text, senderName, isMe);
                            handleMobileLongPress(bubble, m.id, isMe, m.text, senderName);
                        }
                    }
                });

                c.scrollTop = c.scrollHeight;
            });
            router('messaging');
            
            // Apply morph animation to chat column
            const chatCol = document.getElementById('msg-chat-col');
            chatCol.classList.remove('chat-morph-enter');
            void chatCol.offsetWidth; // Force reflow
            chatCol.classList.add('chat-morph-enter');
            
            if(window.innerWidth < 768) {
                document.getElementById('msg-list-col').classList.add('hidden');
                chatCol.classList.remove('hidden');
                chatCol.classList.add('flex');
            }
        };

        // --- MOBILE INTERACTION HANDLERS ---

        function handleSwipe(element, msgId, msgText, msgName, isMe) {
            let startX = 0;
            let currentX = 0;
            let isSwiping = false;
            const threshold = 60; // Distance to trigger reply
            const indicator = element.querySelector('.reply-arrow-indicator');

            element.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isSwiping = false;
                element.style.transition = 'none';
            }, {passive: true});

            element.addEventListener('touchmove', (e) => {
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                
                // Swipe Logic: Left-to-Right OR Right-to-Left depending on side? 
                // Usually swipe towards center triggers it.
                // If message is on LEFT (them), swipe RIGHT.
                // If message is on RIGHT (me), swipe LEFT.
                
                let validSwipe = false;
                let translate = 0;

                if (!isMe && diff > 0) { // Them: Swipe Right
                    validSwipe = true;
                    translate = Math.min(diff, 100);
                } else if (isMe && diff < 0) { // Me: Swipe Left
                    validSwipe = true;
                    translate = Math.max(diff, -100);
                }

                if (validSwipe && Math.abs(diff) > 10) { // Small threshold to avoid scroll jitter
                    isSwiping = true;
                    element.style.transform = `translateX(${translate}px)`;
                    
                    if(indicator) {
                        indicator.style.opacity = Math.abs(diff) > threshold ? '1' : Math.abs(diff)/threshold;
                        indicator.style.transform = `translateY(-50%) scale(${Math.abs(diff) > threshold ? 1.2 : 1})`;
                    }
                }
            }, {passive: true});

            element.addEventListener('touchend', (e) => {
                const diff = currentX - startX;
                element.style.transition = 'transform 0.2s ease-out';
                element.style.transform = 'translateX(0)';
                
                if (indicator) indicator.style.opacity = '0';

                if (isSwiping) {
                    if ((!isMe && diff > threshold) || (isMe && diff < -threshold)) {
                        // Trigger Reply
                        startReply(msgId, msgName, msgText);
                        // Haptic feedback
                        if(navigator.vibrate) navigator.vibrate(20);
                    }
                }
                isSwiping = false;
            });
        }

        function handleMobileLongPress(element, msgId, isMe, msgText, msgName) {
            let pressTimer;
            
            const startPress = () => {
                pressTimer = setTimeout(() => {
                    // Trigger Context Menu
                    showMobileContextMenu(element, msgId, isMe, msgText, msgName);
                    if(navigator.vibrate) navigator.vibrate(50);
                }, 500); // 500ms hold
            };

            const cancelPress = () => {
                clearTimeout(pressTimer);
            };

            element.addEventListener('touchstart', startPress, {passive: true});
            element.addEventListener('touchend', cancelPress);
            element.addEventListener('touchmove', cancelPress);
        }

        function showMobileContextMenu(element, msgId, isMe, msgText, msgName) {
            const menu = document.getElementById('mobile-message-menu');
            const menuContent = document.getElementById('mobile-menu-content');
            
            // Highlight element (Visual trickery)
            element.classList.add('msg-focused');
            
            menu.classList.remove('hidden');
            
            // Setup Buttons
            const btnReply = document.getElementById('mm-reply');
            const btnCopy = document.getElementById('mm-copy');
            const btnEdit = document.getElementById('mm-edit');
            const btnUnsend = document.getElementById('mm-unsend');

            btnReply.onclick = () => { closeMobileMenu(); startReply(msgId, msgName, msgText); };
            
            btnCopy.onclick = () => { 
                closeMobileMenu(); 
                navigator.clipboard.writeText(msgText).then(() => alert('Copied!')); 
            };

            if(isMe) {
                btnEdit.classList.remove('hidden');
                btnUnsend.classList.remove('hidden');
                
                btnEdit.onclick = () => { closeMobileMenu(); startEdit(msgId); };
                btnUnsend.onclick = () => { closeMobileMenu(); currentActionMsgId = msgId; unsendMessage(msgId); };
            } else {
                btnEdit.classList.add('hidden');
                btnUnsend.classList.add('hidden');
            }

            // Clean up when clicking outside
            menu.onclick = (e) => {
                if(e.target === menu) closeMobileMenu();
            };
        }

        function closeMobileMenu() {
            document.getElementById('mobile-message-menu').classList.add('hidden');
            document.querySelectorAll('.msg-focused').forEach(el => el.classList.remove('msg-focused'));
        }

        // --- REPLY FUNCTIONS ---
        
        window.startReply = (msgId, name, text) => {
            window.replyingTo = { id: msgId, name: name, text: text };
            document.getElementById('reply-indicator').classList.remove('hidden');
            document.getElementById('reply-to-name').innerText = name;
            document.getElementById('reply-to-text').innerText = text;
            document.getElementById('message-input').focus();
        };

        window.cancelReply = () => {
            window.replyingTo = null;
            document.getElementById('reply-indicator').classList.add('hidden');
        };

        window.handleReplyAction = () => {
             const textDiv = document.getElementById(`msg-text-${currentActionMsgId}`);
             if(textDiv && currentActionMsgId) {
                  // Hacky way to get name: check if msg-me or msg-them logic used in openChat
                  // For now, assume if I'm replying via modal, it's my message (edit/unsend) or theirs (reply)
                  // But handleReplyAction is in the "Message Options" modal which is mostly for ME
                  // Actually, generic reply from menu:
                  // We need the text and name. The modal is triggered by `openMsgOptions` which is currently only for ME.
                  // But we can enable it for others later.
                  // For "Me", name is "You".
                  startReply(currentActionMsgId, "You", textDiv.innerText);
             }
             closeMsgOptionsModal();
        };

        // -----------------------
        
        window.openMsgOptions = (msgId, canEdit) => {
            currentActionMsgId = msgId;
            const editBtn = document.getElementById('modal-edit-btn');
            
            if(canEdit) {
                editBtn.classList.remove('hidden');
            } else {
                editBtn.classList.add('hidden');
            }
            
            document.getElementById('msg-options-modal').classList.remove('hidden');
        };
        
        window.closeMsgOptionsModal = () => {
            document.getElementById('msg-options-modal').classList.add('hidden');
            currentActionMsgId = null;
        };
        
        window.handleEditAction = () => {
            if(currentActionMsgId) startEdit(currentActionMsgId);
            closeMsgOptionsModal();
        };
        
        window.handleUnsendAction = () => {
            if(currentActionMsgId) unsendMessage(currentActionMsgId);
            closeMsgOptionsModal();
        };

        window.startEdit = (msgId) => {
             const textDiv = document.getElementById(`msg-text-${msgId}`);
             if(!textDiv) return;
             
             window.editingMsgId = msgId;
             const input = document.getElementById('message-input');
             input.value = textDiv.innerText;
             input.focus();
             
             // Hide reply interface if active
             cancelReply();

             document.getElementById('edit-indicator').classList.remove('hidden');
             document.getElementById('msg-send-icon').classList.remove('fa-paper-plane');
             document.getElementById('msg-send-icon').classList.add('fa-check');
        };

        window.cancelEdit = () => {
             window.editingMsgId = null;
             document.getElementById('message-input').value = '';
             document.getElementById('edit-indicator').classList.add('hidden');
             document.getElementById('msg-send-icon').classList.add('fa-paper-plane');
             document.getElementById('msg-send-icon').classList.remove('fa-check');
        };

        window.unsendMessage = async (msgId) => {
             if(confirm("Unsend this message?")) {
                 await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages', msgId));
             }
        };
        
        window.backToChatList = () => {
             document.getElementById('msg-list-col').classList.remove('hidden');
             document.getElementById('msg-chat-col').classList.add('hidden');
             document.getElementById('msg-chat-col').classList.remove('flex');
             currentChatId = null;
             cancelEdit();
             cancelReply();
        };
        
        window.deleteChat = async () => {
            if(!confirm("Delete this conversation?")) return;
            const s = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages'));
            s.docs.forEach(d => deleteDoc(d.ref));
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId));
            
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('start-video-call-btn').classList.add('hidden');
            document.getElementById('start-audio-call-btn').classList.add('hidden');
            document.getElementById('delete-chat-btn').classList.add('hidden');
            document.querySelector('#chat-header span').innerText = "Select a conversation";
            currentChatId = null;
            cancelEdit();
            cancelReply();
            
            if(window.innerWidth < 768) backToChatList();
        };

        window.sendMessage = async (e) => {
            e.preventDefault(); 
            const i = document.getElementById('message-input'); 
            const text = i.value.trim();
            if(!text) return;

            if (window.editingMsgId) {
                // UPDATE EXISTING MESSAGE
                const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages', window.editingMsgId);
                await updateDoc(msgRef, {
                    text: text,
                    edited: true,
                    editedAt: serverTimestamp()
                });
                cancelEdit();
            } else {
                // SEND NEW MESSAGE
                const payload = { 
                    text: text, 
                    senderId: currentUser.uid, 
                    createdAt: serverTimestamp() 
                };

                // Add Reply Data if exists
                if(window.replyingTo) {
                    payload.replyTo = window.replyingTo;
                    cancelReply();
                }

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages'), payload);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId), {
                    lastUpdated: serverTimestamp(),
                    readBy: [currentUser.uid]
                }, { merge: true });
            }
            i.value = '';
        };

        // --- STORIES LOGIC ---
        function monitorStories() {
            if (unsubscribeStories) unsubscribeStories();
            // Fetch all stories. In production, use "where" clause for expiresAt.
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'stories'), orderBy('createdAt', 'desc'));
            unsubscribeStories = onSnapshot(q, (snap) => {
                const now = Date.now();
                allStories = [];
                snap.forEach(d => {
                    const data = d.data();
                    const expires = data.expiresAt ? data.expiresAt.toMillis() : 0;
                    if(expires > now) {
                        // FILTER VISIBILITY
                        // If it's a "Close Friends" story:
                        // Only show if I am the author OR if I am in the author's close friend list (targetAudience)
                        if (data.visibility === 'close_friends') {
                            const amIAuthor = data.uid === currentUser.uid;
                            const amIInAudience = data.targetAudience && data.targetAudience.includes(currentUser.uid);
                            
                            if (amIAuthor || amIInAudience) {
                                allStories.push({id: d.id, ...data});
                            }
                        } else {
                            // Public stories - show to everyone
                            allStories.push({id: d.id, ...data});
                        }
                    }
                });
                
                // Group by User
                groupedStories = {};
                allStories.forEach(s => {
                    if(!groupedStories[s.uid]) {
                        groupedStories[s.uid] = {
                            uid: s.uid,
                            name: s.name,
                            photoURL: s.photoURL,
                            items: []
                        };
                    }
                    groupedStories[s.uid].items.push(s);
                });
                
                // Sort items within user by time ascending for viewing
                Object.values(groupedStories).forEach(group => {
                    group.items.sort((a,b) => (a.createdAt.toMillis()) - (b.createdAt.toMillis()));
                });
                
                renderStoriesBar();
            });
        }
        
        function renderStoriesBar() {
            const container = document.getElementById('stories-list');
            if(!container) return;
            
            // Convert groups to array, filter out current user (shown separately)
            const groups = Object.values(groupedStories).filter(g => g.uid !== currentUser.uid);
            
            container.innerHTML = groups.map(g => {
                const lastStory = g.items[g.items.length - 1];
                const ringClass = (lastStory.visibility === 'close_friends') ? 'story-ring-cf' : 'story-ring';
                
                return `
                <div class="flex flex-col items-center gap-2 cursor-pointer min-w-[70px] group" onclick="openStoryViewer('${g.uid}')">
                    <div class="relative w-16 h-16 ${ringClass} group-hover:scale-105 transition-transform">
                         <img src="${g.photoURL}" class="w-full h-full rounded-full border-2 border-white object-cover bg-white">
                    </div>
                    <span class="text-xs font-medium text-slate-600 truncate w-16 text-center">${g.name.split(' ')[0]}</span>
                </div>
            `;
            }).join('');
            
            // Check if user has active story
            const myStory = groupedStories[currentUser.uid];
            const myAvatar = document.getElementById('story-my-avatar');
            const myContainer = myAvatar.parentElement;
            
            if(myStory && myStory.items.length > 0) {
                 const lastMyStory = myStory.items[myStory.items.length - 1];
                 const myRingClass = (lastMyStory.visibility === 'close_friends') ? 'story-ring-cf' : 'story-ring';
                 
                 // Remove both potential classes first to be safe
                 myContainer.classList.remove('story-ring', 'story-ring-cf');
                 myContainer.classList.add(myRingClass);
                 
                 myContainer.parentElement.onclick = () => openStoryViewer(currentUser.uid);
                 myContainer.querySelector('.fa-plus').className = "fa-solid fa-eye";
                 myContainer.querySelector('div.absolute').classList.replace('bg-blue-600', 'bg-slate-700');
            } else {
                 myContainer.classList.remove('story-ring', 'story-ring-cf');
                 myContainer.parentElement.onclick = openStoryUploadModal;
                 myContainer.querySelector('.fa-solid').className = "fa-solid fa-plus";
                 myContainer.querySelector('div.absolute').classList.replace('bg-slate-700', 'bg-blue-600');
            }
        }
        
        window.openStoryUploadModal = () => {
             document.getElementById('story-upload-modal').classList.remove('hidden');
             // Reset UI
             document.getElementById('story-preview-img').classList.add('hidden');
             document.getElementById('story-preview-video').classList.add('hidden');
             document.getElementById('story-upload-placeholder').classList.remove('hidden');
             
             document.getElementById('btn-upload-story-public').disabled = true;
             document.getElementById('btn-upload-story-cf').disabled = true;
             
             currentStoryUpload = { file: null, type: null, data: null };
        };
        
        window.handleStoryFileSelect = (input) => {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                const isVideo = file.type.startsWith('video/');
                
                if(file.size > 800 * 1024) {
                    alert("File too large. Max 800KB for stories.");
                    input.value = "";
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const res = e.target.result;
                    currentStoryUpload = { file: file, type: isVideo ? 'video' : 'image', data: res };
                    
                    document.getElementById('story-upload-placeholder').classList.add('hidden');
                    if(isVideo) {
                        const vid = document.getElementById('story-preview-video');
                        vid.src = res;
                        vid.classList.remove('hidden');
                        document.getElementById('story-preview-img').classList.add('hidden');
                    } else {
                        const img = document.getElementById('story-preview-img');
                        img.src = res;
                        img.classList.remove('hidden');
                        document.getElementById('story-preview-video').classList.add('hidden');
                    }
                    document.getElementById('btn-upload-story-public').disabled = false;
                    document.getElementById('btn-upload-story-cf').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        };
        
        window.uploadStory = async (visibility) => {
            if(!currentStoryUpload.data) return;
            
            const btnPublic = document.getElementById('btn-upload-story-public');
            const btnCf = document.getElementById('btn-upload-story-cf');
            btnPublic.disabled = true;
            btnCf.disabled = true;
            
            let targetAudience = [];
            if (visibility === 'close_friends') {
                targetAudience = window.userProfileCache?.closeFriends || [];
            }
            
            try {
                const now = new Date();
                const expires = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'stories'), {
                    uid: currentUser.uid,
                    name: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    media: currentStoryUpload.data,
                    type: currentStoryUpload.type,
                    likes: 0,
                    likedBy: [],
                    visibility: visibility, // 'public' or 'close_friends'
                    targetAudience: targetAudience,
                    createdAt: serverTimestamp(),
                    expiresAt: expires
                });
                
                document.getElementById('story-upload-modal').classList.add('hidden');
            } catch(e) {
                console.error("Story upload failed", e);
                alert("Upload failed.");
            } finally {
            }
        };
        
        window.openStoryViewer = (uid) => {
             const group = groupedStories[uid];
             if(!group || !group.items.length) return;
             
             activeStoryUid = uid;
             activeStoryIndex = 0;
             
             document.getElementById('story-viewer-modal').classList.remove('hidden');
             showStory(uid, 0);
        };
        
        window.showStory = (uid, index) => {
            clearTimeout(storyTimer);
            const group = groupedStories[uid];
            if(!group || index >= group.items.length) {
                closeStoryViewer();
                return;
            }
            
            activeStoryIndex = index;
            const story = group.items[index];
            
            // Update Header
            document.getElementById('viewer-avatar').src = group.photoURL;
            document.getElementById('viewer-name').innerText = group.name;
            
            // Time & Badge
            const timeDiff = Date.now() - story.createdAt.toMillis();
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const mins = Math.floor(timeDiff / (1000 * 60));
            document.getElementById('viewer-time').innerText = hours > 0 ? `${hours}h ago` : `${mins}m ago`;
            
            const badge = document.getElementById('viewer-cf-badge');
            if (story.visibility === 'close_friends') {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            // Delete Button visibility
            const deleteBtn = document.getElementById('viewer-delete-btn');
            if (story.uid === currentUser.uid) {
                deleteBtn.classList.remove('hidden');
            } else {
                deleteBtn.classList.add('hidden');
            }
            
            // Show Content
            const imgEl = document.getElementById('viewer-img');
            const vidEl = document.getElementById('viewer-video');
            
            if(story.type === 'video') {
                imgEl.classList.add('hidden');
                vidEl.classList.remove('hidden');
                vidEl.src = story.media;
                vidEl.currentTime = 0;
                vidEl.onended = nextStory;
            } else {
                vidEl.classList.add('hidden');
                imgEl.classList.remove('hidden');
                imgEl.src = story.media;
                storyTimer = setTimeout(nextStory, 5000);
            }

            // Like Button State
            const likeBtn = document.getElementById('story-like-btn');
            const hasLiked = story.likedBy && story.likedBy.includes(currentUser.uid);
            if(hasLiked) {
                likeBtn.innerHTML = '<i class="fa-solid fa-heart text-red-500"></i>';
            } else {
                likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
            }
            
            // Reset Interaction Input
            document.getElementById('story-reply-input').value = "";
            document.getElementById('story-send-btn').classList.add('hidden');
            
            // Render Progress Bars
            const barContainer = document.getElementById('story-progress-container');
            const count = group.items.length;
            barContainer.innerHTML = '';
            
            for(let i=0; i<count; i++) {
                const bar = document.createElement('div');
                bar.className = "h-1 rounded-full bg-white/30 flex-grow overflow-hidden";
                const inner = document.createElement('div');
                inner.className = "h-full bg-white story-progress-bar";
                
                if(i < index) inner.style.width = "100%";
                else if(i > index) inner.style.width = "0%";
                else {
                    // Active bar animation
                    inner.style.width = "0%";
                    setTimeout(() => {
                        inner.style.transition = story.type === 'video' ? `width ${vidEl.duration || 5}s linear` : "width 5s linear";
                        inner.style.width = "100%";
                    }, 10);
                }
                
                bar.appendChild(inner);
                barContainer.appendChild(bar);
            }
        };
        
        window.deleteStory = async () => {
            if(!activeStoryUid) return;
            const group = groupedStories[activeStoryUid];
            const story = group.items[activeStoryIndex];
            
            if(story.uid !== currentUser.uid) return;
            
            if(confirm("Delete this story?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stories', story.id));
                    closeStoryViewer();
                } catch(e) {
                    console.error("Delete story failed", e);
                    alert("Could not delete.");
                }
            }
        };

        window.handleStoryInput = (input) => {
            const btn = document.getElementById('story-send-btn');
            if(input.value.trim().length > 0) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        };

        window.toggleStoryLike = async () => {
            if(!activeStoryUid) return;
            const group = groupedStories[activeStoryUid];
            if(!group || !group.items || !group.items[activeStoryIndex]) return;
            
            const story = group.items[activeStoryIndex];
            if(!story.likedBy) story.likedBy = [];
            
            const likeBtn = document.getElementById('story-like-btn');
            const hasLiked = story.likedBy.includes(currentUser.uid);
            
            if(!hasLiked) {
                // LIKE LOGIC
                story.likedBy.push(currentUser.uid);
                story.likes = (story.likes || 0) + 1;
                likeBtn.innerHTML = '<i class="fa-solid fa-heart text-red-500"></i>';
                spawnHeartBurst();

                try {
                    const storyRef = doc(db, 'artifacts', appId, 'public', 'data', 'stories', story.id);
                    await updateDoc(storyRef, { likes: increment(1), likedBy: arrayUnion(currentUser.uid) });
                    if(story.uid !== currentUser.uid) {
                        addDoc(collection(db, 'artifacts', appId, 'users', story.uid, 'notifications'), {
                            type: 'story_like', fromUid: currentUser.uid, fromName: currentUser.displayName, read: false, createdAt: serverTimestamp()
                        }).catch(e => console.log("Notif error", e));
                    }
                } catch(e) {
                    console.error("Like failed", e);
                    const idx = story.likedBy.indexOf(currentUser.uid);
                    if(idx > -1) story.likedBy.splice(idx, 1);
                    story.likes--;
                    likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
                }
            } else {
                // UNLIKE LOGIC
                const idx = story.likedBy.indexOf(currentUser.uid);
                if(idx > -1) story.likedBy.splice(idx, 1);
                story.likes = Math.max(0, (story.likes || 0) - 1);
                likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';

                try {
                    const storyRef = doc(db, 'artifacts', appId, 'public', 'data', 'stories', story.id);
                    await updateDoc(storyRef, { likes: increment(-1), likedBy: arrayRemove(currentUser.uid) });
                } catch(e) {
                    console.error("Unlike failed", e);
                    story.likedBy.push(currentUser.uid);
                    story.likes++;
                    likeBtn.innerHTML = '<i class="fa-solid fa-heart text-red-500"></i>';
                }
            }
        };

        window.spawnHeartBurst = () => {
            const container = document.getElementById('story-reaction-container');
            const colors = ['#ef4444', '#ec4899', '#a855f7', '#f43f5e'];
            const animations = ['float-wobble-1', 'float-wobble-2', 'float-straight'];
            
            for(let i=0; i<5; i++) {
                const heart = document.createElement('i');
                heart.className = 'heart-particle fa-solid fa-heart';
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                const randomAnim = animations[Math.floor(Math.random() * animations.length)];
                const randomSize = Math.floor(Math.random() * 20) + 15; 
                const duration = (Math.random() * 1 + 1) + 's';
                const delay = (Math.random() * 0.3) + 's';
                
                heart.style.color = randomColor;
                heart.style.fontSize = randomSize + 'px';
                heart.style.right = (20 + (Math.random()*40)) + 'px';
                heart.style.animation = `${randomAnim} ${duration} ease-out forwards ${delay}`;
                container.appendChild(heart);
                setTimeout(() => { if(heart.parentNode) heart.parentNode.removeChild(heart); }, 2500);
            }
        }

        window.sendStoryReply = async () => {
             const input = document.getElementById('story-reply-input');
             const text = input.value.trim();
             if(!text || !activeStoryUid) return;

             const group = groupedStories[activeStoryUid];
             const story = group.items[activeStoryIndex];
             
             input.value = "";
             document.getElementById('story-send-btn').classList.add('hidden');
             
             if(story.uid !== currentUser.uid) {
                  await addDoc(collection(db, 'artifacts', appId, 'users', story.uid, 'notifications'), {
                      type: 'story_reply', 
                      text: text, 
                      fromUid: currentUser.uid, 
                      fromName: currentUser.displayName, 
                      read: false, 
                      createdAt: serverTimestamp()
                  });
             }
             
             const container = document.getElementById('story-reaction-container');
             const feedback = document.createElement('div');
             feedback.innerText = "Sent";
             feedback.className = "absolute bottom-20 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-1 rounded-full text-sm animate-fade-in";
             container.appendChild(feedback);
             setTimeout(() => feedback.remove(), 2000);
        };
        
        window.nextStory = () => {
             showStory(activeStoryUid, activeStoryIndex + 1);
        };
        
        window.prevStory = () => {
             if(activeStoryIndex > 0) {
                 showStory(activeStoryUid, activeStoryIndex - 1);
             } else {
                 showStory(activeStoryUid, 0);
             }
        };
        
        window.closeStoryViewer = () => {
             clearTimeout(storyTimer);
             document.getElementById('story-viewer-modal').classList.add('hidden');
             document.getElementById('viewer-video').pause();
             activeStoryUid = null;
        };
        
        // --- CLOSE FRIENDS LOGIC ---
        
        window.openCloseFriendsModal = () => {
            const modal = document.getElementById('close-friends-modal');
            const list = document.getElementById('close-friends-list');
            modal.classList.remove('hidden');
            renderCloseFriendsList();
        };
        
        window.renderCloseFriendsList = (search = '') => {
            const list = document.getElementById('close-friends-list');
            if(!list) return;
            
            let users = allUsersCache.filter(u => u.id !== currentUser.uid);
            
            if(search.trim()) {
                users = users.filter(u => u.name.toLowerCase().includes(search.toLowerCase()));
            }
            
            const currentCloseFriends = window.userProfileCache?.closeFriends || [];
            
            if(users.length === 0) {
                list.innerHTML = `<p class="text-center text-xs text-slate-400 py-4">No users found.</p>`;
                return;
            }
            
            list.innerHTML = users.map(u => {
                const isCF = currentCloseFriends.includes(u.id);
                return `
                <div class="flex items-center justify-between p-3 hover:bg-slate-50 rounded-xl transition-colors">
                    <div class="flex items-center gap-3">
                        <img src="${u.photoURL}" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                        <div>
                            <p class="font-bold text-sm text-slate-800">${u.name}</p>
                            <p class="text-xs text-slate-500 truncate w-32">${u.headline || ''}</p>
                        </div>
                    </div>
                    <button onclick="toggleCloseFriend('${u.id}')" class="w-8 h-8 rounded-full flex items-center justify-center transition-all btn-bounce ${isCF ? 'bg-green-500 text-white shadow-md' : 'bg-slate-200 text-slate-400 hover:bg-slate-300'}">
                        <i class="fa-solid fa-star text-sm"></i>
                    </button>
                </div>
                `;
            }).join('');
        };
        
        window.toggleCloseFriend = async (uid) => {
            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
            const currentList = window.userProfileCache?.closeFriends || [];
            const isCF = currentList.includes(uid);
            
            try {
                if(isCF) {
                    await updateDoc(userRef, { closeFriends: arrayRemove(uid) });
                } else {
                    await updateDoc(userRef, { closeFriends: arrayUnion(uid) });
                }
            } catch(e) {
                console.error("Error toggling close friend", e);
            }
        };

        // --- Router & UI Helpers ---

        window.router = (view) => {
            document.querySelectorAll('.view-section').forEach(el => {
                if(!el.classList.contains('hidden')) {
                     el.classList.add('hidden');
                }
            });
            
            const newView = document.getElementById(`view-${view}`);
            newView.classList.remove('hidden');
            void newView.offsetWidth; 
            newView.classList.add('animate-fade-in');

            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            const navLink = document.getElementById(`nav-link-${view}`);
            if(navLink) navLink.classList.add('active');

            // Make messaging full-width, restore for other views
            const mainContainer = document.getElementById('main-container');
            if(view === 'messaging') {
                mainContainer.className = 'col-span-12 w-full animate-slide-up';
                mainContainer.style.maxWidth = 'none';
            } else {
                mainContainer.className = 'col-span-12 max-w-3xl mx-auto w-full animate-slide-up';
                mainContainer.style.maxWidth = '';
            }
            
            if(view === 'saved') renderSavedPosts();
            if(view === 'collaborate') renderCollaborate();
            
            if(view === 'messaging' && window.innerWidth < 768 && !currentChatId) {
                 backToChatList();
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        window.handleGoogleAuth = () => {
             const provider = new GoogleAuthProvider();
             signInWithPopup(auth, provider).catch(e => document.getElementById('auth-error').innerText = e.message);
        };
        
        window.handleEmailAuth = async () => {
             const email = document.getElementById('auth-email').value;
             const pass = document.getElementById('auth-password').value;
             try {
                 await signInWithEmailAndPassword(auth, email, pass);
             } catch(e) {
                 try {
                     await createUserWithEmailAndPassword(auth, email, pass);
                 } catch(err) {
                     document.getElementById('auth-error').innerText = err.message;
                     document.getElementById('auth-error').classList.remove('hidden');
                 }
             }
        };

        window.handleSignOut = () => signOut(auth);

        function updateUI(data) {
             const user = currentUser;
             const name = data.name || user.displayName || user.email.split('@')[0] || "User";
             const pic = data.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;
             const headline = data.headline || ""; 

             document.getElementById('nav-avatar').src = pic;
             document.getElementById('sidebar-mini-avatar').src = pic;
             document.getElementById('menu-avatar-small').src = pic;
             document.getElementById('composer-avatar').src = pic;
             document.getElementById('modal-avatar').src = pic;
             document.getElementById('story-my-avatar').src = pic;
             
             document.getElementById('sidebar-mini-name').innerText = name;
             document.getElementById('menu-name').innerText = name;
             document.getElementById('composer-name-placeholder').innerText = name.split(' ')[0];
             
             document.getElementById('settings-username').value = name;
             document.getElementById('edit-headline').value = headline;
             document.getElementById('edit-bio').value = data.bio || "";
             document.getElementById('edit-modal-avatar').src = pic;

             if(data.theme) {
                if(data.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('lumini_theme', 'dark');
                    const toggle = document.getElementById('dark-mode-toggle');
                    if(toggle) toggle.checked = true;
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('lumini_theme', 'light');
                    const toggle = document.getElementById('dark-mode-toggle');
                    if(toggle) toggle.checked = false;
                }
             }
             
             if(!document.getElementById('close-friends-modal').classList.contains('hidden')) {
                 renderCloseFriendsList();
             }
        }

        // --- Post Rendering ---
        
        window.savePost = async (postId) => {
             const isSaved = mySavedPosts.includes(postId);
             
             if(isSaved) {
                 const idx = mySavedPosts.indexOf(postId);
                 if (idx > -1) mySavedPosts.splice(idx, 1);
             } else {
                 mySavedPosts.push(postId);
             }
             
             const btnIcons = document.querySelectorAll(`#post-${postId}-feed .fa-bookmark, #post-${postId}-saved .fa-bookmark, #post-${postId}-profile .fa-bookmark, #post-${postId}-collaborate .fa-bookmark`);
             btnIcons.forEach(btnIcon => {
                 if(isSaved) { 
                     btnIcon.classList.remove('fa-solid', 'text-purple-600');
                     btnIcon.classList.add('fa-regular');
                     btnIcon.parentElement.classList.add('scale-90');
                     setTimeout(() => btnIcon.parentElement.classList.remove('scale-90'), 200);
                 } else { 
                     btnIcon.classList.remove('fa-regular');
                     btnIcon.classList.add('fa-solid', 'text-purple-600');
                     btnIcon.parentElement.classList.add('scale-125');
                     setTimeout(() => btnIcon.parentElement.classList.remove('scale-125'), 200);
                 }
                 const btnText = btnIcon.parentElement; 
                 if(btnText && btnText.innerText.includes('Save')) {
                     btnText.innerText = isSaved ? 'Save' : 'Unsave'; 
                 }
             });
             
             if(!document.getElementById('view-saved').classList.contains('hidden')) {
                 renderSavedPosts();
             }

             const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
             try {
                 if(isSaved) {
                     await updateDoc(userRef, { savedPosts: arrayRemove(postId) });
                 } else {
                     await updateDoc(userRef, { savedPosts: arrayUnion(postId) });
                 }
             } catch(e) {
                 console.error("Save failed", e);
                 if(isSaved) mySavedPosts.push(postId); 
                 else { 
                     const idx = mySavedPosts.indexOf(postId);
                     if(idx > -1) mySavedPosts.splice(idx, 1);
                 }
                 renderFeed(allPostsCache);
                 renderSavedPosts();
             }
        };

        function createPostHTML(post, context) {
            const isProject = post.type === 'project';
            const tags = post.tags ? post.tags.map(t => `<span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100 transition-colors cursor-pointer">#${t}</span>`).join('') : '';
            const hasLiked = post.likedBy && post.likedBy.includes(currentUser.uid);
            const isSaved = mySavedPosts.includes(post.id);
            const likeIconClass = hasLiked ? "fa-solid text-blue-600 scale-110" : "fa-regular";
            const saveIconClass = isSaved ? "fa-solid text-purple-600 scale-110" : "fa-regular";
            const saveText = isSaved ? "Unsave" : "Save";
            
            let taggedHTML = '';
            if(post.taggedUsers && post.taggedUsers.length > 0) {
                const names = post.taggedUsers.map(u => `<span class="font-bold hover:underline cursor-pointer" onclick="viewProfile('${u.id}')">${u.name}</span>`).join(', ');
                taggedHTML = ` <span class="text-slate-500 font-normal">is with ${names}</span>`;
            }
            
            const isAdmin = checkIsAdmin(currentUser.email);
            const canDelete = currentUser.uid === post.uid || isAdmin;
            const canEdit = currentUser.uid === post.uid;

            const postAuthorIsAdmin = allUsersCache.find(u => u.id === post.uid)?.isAdmin;
            const adminBadge = postAuthorIsAdmin ? `<span class="admin-badge">Admin </span>` : '';

            return `<div id="post-${post.id}-${context}" class="glass-card rounded-2xl bg-white p-0 overflow-hidden animate-slide-up mb-4 hover:shadow-lg transition-shadow duration-300">
                <div class="p-4 flex gap-3">
                    <img src="${post.photoURL}" class="w-10 h-10 rounded-full bg-slate-100 object-cover cursor-pointer hover:scale-105 transition-transform" onclick="viewProfile('${post.uid}')">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">
                                    <span class="hover:underline cursor-pointer transition-colors hover:text-blue-600" onclick="viewProfile('${post.uid}')">${post.name}</span>${adminBadge}${taggedHTML}
                                </h4>
                                <p class="text-xs text-slate-400">${post.headline || 'Member'}</p>
                            </div>
                            <div class="relative">
                                <button onclick="toggleMenu('${post.id}', '${context}')" class="text-slate-400 hover:bg-slate-100 w-8 h-8 rounded-full transition-colors btn-bounce"><i class="fa-solid fa-ellipsis"></i></button>
                                <div id="menu-${post.id}-${context}" class="hidden absolute right-0 top-8 bg-white shadow-xl border border-slate-100 rounded-xl py-2 w-32 z-10 animate-pop-in origin-top-right">
                                    <button onclick="savePost('${post.id}')" class="w-full text-left px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm font-medium transition-colors">${saveText}</button>
                                    ${canEdit ? `<button onclick="editPost('${post.id}')" class="w-full text-left px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm font-medium transition-colors">Edit</button>` : ''}
                                    ${canDelete ? `<button onclick="initiateDelete('${post.id}', '${post.uid}')" class="w-full text-left px-4 py-2 text-red-500 hover:bg-red-50 text-sm font-bold transition-colors">Delete</button>` : ''}
                                    <button onclick="reportPost('${post.id}', '${post.uid}')" class="w-full text-left px-4 py-2 text-orange-500 hover:bg-orange-50 text-sm font-medium transition-colors">Report</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="px-4 pb-2">
                    ${isProject ? '<span class="inline-block bg-gradient-to-r from-blue-600 to-purple-600 text-white text-[10px] font-bold px-2 py-1 rounded-full mb-2 animate-pulse-slow"><i class="fa-solid fa-rocket mr-1"></i> PROJECT</span>' : ''}
                    <p class="text-slate-700 text-sm whitespace-pre-line leading-relaxed">${post.text}</p>
                    <div class="mt-2 flex flex-wrap gap-2">${tags}</div>
                </div>
                ${post.attachment ? `<div class="mt-2 overflow-hidden"><img src="${post.attachment}" class="w-full object-cover max-h-[500px] bg-slate-50 hover:scale-[1.01] transition-transform duration-500"></div>` : ''}
                <div class="px-4 py-3 border-t border-slate-100 flex gap-1">
                    <button onclick="toggleLike('${post.id}')" class="flex-1 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 text-slate-500 font-medium text-sm btn-bounce group"><i class="${likeIconClass} fa-heart text-lg transition-transform group-hover:scale-125"></i> <span class="${hasLiked ? 'text-blue-600' : ''}">${post.likes || 0}</span></button>
                    <button onclick="toggleCommentSection('${post.id}', '${context}')" class="flex-1 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 text-slate-500 font-medium text-sm btn-bounce group"><i class="fa-regular fa-comment text-lg transition-transform group-hover:scale-125"></i></button>
                    <button onclick="savePost('${post.id}')" class="flex-1 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 text-slate-500 font-medium text-sm btn-bounce group"><i class="${saveIconClass} fa-bookmark text-lg transition-transform group-hover:scale-125"></i></button>
                </div>
                 <div id="comments-${post.id}-${context}" class="hidden mt-0 bg-slate-50/50 p-4 border-t border-slate-100 animate-slide-up">
                    <div id="comments-list-${post.id}-${context}" class="space-y-3 mb-3 max-h-60 overflow-y-auto custom-scrollbar"></div>
                    <div class="flex gap-2 items-center">
                        <img src="${document.getElementById('nav-avatar').src}" class="w-8 h-8 rounded-full">
                        <div class="flex-grow bg-white border border-slate-200 rounded-full px-4 py-2 flex items-center shadow-sm focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                            <input type="text" id="comment-input-${post.id}-${context}" placeholder="Write a comment..." class="bg-transparent w-full text-sm outline-none" onkeydown="if(event.key==='Enter') submitComment('${post.id}', '${context}')">
                            <button onclick="submitComment('${post.id}', '${context}')" class="text-blue-600 ml-2 hover:bg-blue-50 p-1 rounded-full transition-colors"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        window.renderFeed = (posts) => {
             const container = document.getElementById('feed-stream');
             if(!posts.length) { container.innerHTML = `<div class="text-center py-12 text-slate-400 animate-fade-in">No posts yet.</div>`; return; }
             container.innerHTML = posts.map(p => createPostHTML(p, 'feed')).join('');
        };
        
        window.renderSavedPosts = () => {
             const container = document.getElementById('saved-posts-stream');
             const saved = allPostsCache.filter(p => mySavedPosts.includes(p.id));
             if(!saved.length) { container.innerHTML = `<p class="text-center text-slate-400 py-8 animate-fade-in">No saved posts.</p>`; return; }
             container.innerHTML = saved.map(p => createPostHTML(p, 'saved')).join('');
        };

        window.renderCollaborate = () => {
            const container = document.getElementById('collaborate-stream');
            if(!container) return;

            let projects = allPostsCache.filter(p => p.type === 'project');

            if(window.currentCollabFilter !== 'all') {
                projects = projects.filter(p => {
                    const text = (p.text + ' ' + (p.tags||[]).join(' ')).toLowerCase();
                    return text.includes(window.currentCollabFilter.toLowerCase());
                });
            }

            if(!projects.length) {
                container.innerHTML = `<div class="text-center py-12 text-slate-400 animate-fade-in">No active projects found for this category.</div>`;
                return;
            }

            container.innerHTML = projects.map(p => createPostHTML(p, 'collaborate')).join('');
        };

        window.filterCollaborate = (filter) => {
            window.currentCollabFilter = filter;
            document.querySelectorAll('.collab-filter').forEach(btn => {
                btn.className = "collab-filter px-4 py-1.5 rounded-full text-sm font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap";
            });
            const activeBtn = document.getElementById(`filter-${filter}`);
            if(activeBtn) {
                 activeBtn.className = "collab-filter active px-4 py-1.5 rounded-full text-sm font-medium border border-slate-200 bg-slate-800 text-white transition-all whitespace-nowrap shadow-md";
            }
            renderCollaborate();
        };

        function renderNetwork(users) {
            const g = document.getElementById('network-grid');
            if(!users.length) { 
                if(currentUser) {
                     g.innerHTML = `<p class="col-span-2 text-center text-slate-400 animate-fade-in">Initializing your network...</p>`;
                     return;
                }
                g.innerHTML = `<p class="col-span-2 text-center text-slate-400 animate-fade-in">No users found.</p>`; 
                return; 
            }
            g.innerHTML = users.map(u => `
            <div class="glass-card rounded-xl p-4 flex items-center gap-4 hover:border-blue-300 transition-colors duration-300 animate-pop-in hover:shadow-md">
                <div class="flex items-center gap-4 flex-grow cursor-pointer" onclick="viewProfile('${u.id}')">
                    <img src="${u.photoURL}" class="w-12 h-12 rounded-full bg-slate-100 object-cover">
                    <div>
                        <h4 class="font-bold text-slate-800 text-sm group-hover:text-blue-600 transition-colors">${u.name}</h4>
                        <p class="text-xs text-slate-500 truncate">${u.headline || 'Member'}</p>
                    </div>
                </div>
                <button onclick="startChat('${u.id}', '${u.name}')" class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition-colors z-10 btn-bounce" title="Message">
                    <i class="fa-regular fa-comment-dots"></i>
                </button>
            </div>`).join('');
        }

        window.startChat = async (uid, name) => {
            if(uid === currentUser.uid) return;
            const chatId = [currentUser.uid, uid].sort().join('_');
            const chatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId);
            const chatSnap = await getDoc(chatRef);
            
            if(!chatSnap.exists()) {
                await setDoc(chatRef, {
                    createdAt: serverTimestamp(),
                    lastUpdated: serverTimestamp(),
                    participants: [currentUser.uid, uid],
                    readBy: [currentUser.uid]
                });
            }
            openChat(chatId, name);
        };

        window.toggleLike = async (postId) => {
             const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
             const p = allPostsCache.find(x => x.id === postId);
             if(!p) return;
             const hasLiked = p.likedBy && p.likedBy.includes(currentUser.uid);
             
             const btns = document.querySelectorAll(`[id^="post-${postId}-"] .fa-heart`);
             btns.forEach(btn => {
                 if(hasLiked) {
                     btn.classList.remove('fa-solid', 'text-blue-600');
                     btn.classList.add('fa-regular');
                 } else {
                     btn.classList.remove('fa-regular');
                     btn.classList.add('fa-solid', 'text-blue-600', 'scale-125');
                     setTimeout(() => btn.classList.remove('scale-125'), 200);
                 }
                 const countSpan = btn.nextElementSibling;
                 if(countSpan) {
                     let count = parseInt(countSpan.innerText) || 0;
                     countSpan.innerText = hasLiked ? Math.max(0, count - 1) : count + 1;
                     if (hasLiked) countSpan.classList.remove('text-blue-600');
                     else countSpan.classList.add('text-blue-600');
                 }
             });
             
             if(hasLiked) {
                 await updateDoc(postRef, { likes: increment(-1), likedBy: arrayRemove(currentUser.uid) });
             } else {
                 await updateDoc(postRef, { likes: increment(1), likedBy: arrayUnion(currentUser.uid) });
                 if(p.uid !== currentUser.uid) {
                      addDoc(collection(db, 'artifacts', appId, 'users', p.uid, 'notifications'), {
                          type: 'like', postId: postId, fromUid: currentUser.uid, fromName: document.getElementById('menu-name').innerText, read: false, createdAt: serverTimestamp()
                      });
                 }
             }
        };

        window.toggleMenu = (pid, ctx) => document.getElementById(`menu-${pid}-${ctx}`).classList.toggle('hidden');
        
        window.toggleCommentSection = (pid, ctx) => {
            const el = document.getElementById(`comments-${pid}-${ctx}`);
            el.classList.toggle('hidden');
            if(!el.classList.contains('hidden')) loadComments(pid, ctx);
        };

        window.loadComments = (pid, ctx) => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'posts', pid, 'comments'), orderBy('createdAt', 'asc'));
            onSnapshot(q, (snap) => {
                const list = document.getElementById(`comments-list-${pid}-${ctx}`);
                list.innerHTML = '';
                snap.forEach(d => {
                    const c = d.data();
                    list.innerHTML += `<div class="flex gap-2 animate-fade-in"><img src="${c.photoURL}" class="w-6 h-6 rounded-full mt-1"><div class="bg-white p-2 rounded-r-xl rounded-bl-xl shadow-sm border border-slate-100 text-sm"><p class="font-bold text-xs text-slate-800">${c.name}</p><p class="text-slate-600">${c.text}</p></div></div>`;
                });
                list.scrollTop = list.scrollHeight;
            });
        };

        window.submitComment = async (pid, ctx) => {
            const inp = document.getElementById(`comment-input-${pid}-${ctx}`);
            if(!inp.value.trim()) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts', pid, 'comments'), {
                text: inp.value,
                uid: currentUser.uid,
                name: document.getElementById('menu-name').innerText,
                photoURL: document.getElementById('nav-avatar').src,
                createdAt: serverTimestamp()
            });
            const p = allPostsCache.find(x => x.id === pid);
            if(p && p.uid !== currentUser.uid) {
                 addDoc(collection(db, 'artifacts', appId, 'users', p.uid, 'notifications'), {
                      type: 'comment', postId: pid, fromUid: currentUser.uid, fromName: document.getElementById('menu-name').innerText, read: false, createdAt: serverTimestamp()
                 });
            }
            inp.value = '';
        };

        window.toggleTagUserPicker = () => {
            const picker = document.getElementById('user-tag-picker');
            picker.classList.toggle('hidden');
            if(!picker.classList.contains('hidden')) {
                const list = document.getElementById('user-tag-list');
                list.innerHTML = allUsersCache.map(u => `
                    <div class="flex items-center gap-2 p-1 hover:bg-slate-50 cursor-pointer transition-colors" onclick="toggleUserTag('${u.id}', '${u.name}')">
                        <img src="${u.photoURL}" class="w-6 h-6 rounded-full">
                        <span class="text-xs font-bold text-slate-700 truncate">${u.name}</span>
                        ${window.taggedUsers.find(t => t.id === u.id) ? '<i class="fa-solid fa-check text-green-50 ml-auto"></i>' : ''}
                    </div>
                `).join('');
            }
        };

        window.toggleUserTag = (uid, name) => {
            const existing = window.taggedUsers.findIndex(t => t.id === uid);
            if(existing > -1) {
                window.taggedUsers.splice(existing, 1);
            } else {
                window.taggedUsers.push({id: uid, name: name});
            }
            renderTaggedUsers();
            toggleTagUserPicker();
        };

        function renderTaggedUsers() {
             const container = document.getElementById('tagged-users-display');
             if(window.taggedUsers.length === 0) {
                 container.classList.add('hidden');
                 container.innerHTML = '';
                 return;
             }
             container.classList.remove('hidden');
             container.innerHTML = window.taggedUsers.map(t => `
                 <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1 animate-pop-in">
                    @${t.name} 
                    <i class="fa-solid fa-xmark cursor-pointer hover:text-blue-900" onclick="toggleUserTag('${t.id}', '${t.name}')"></i>
                 </span>
             `).join('');
        }

        window.editPost = (pid) => {
            const p = allPostsCache.find(x => x.id === pid);
            if(!p) return;
            editModeId = pid;
            
            document.getElementById('modal-title').innerText = "Edit Post";
            document.getElementById('post-input').value = p.text || "";
            document.getElementById('post-submit-btn').innerText = "Update Post";
            
            const typeSelect = document.getElementById('post-type-select');
            typeSelect.value = p.type || 'regular';
            if(p.type === 'project') {
                document.getElementById('project-tags-input').classList.remove('hidden');
                document.getElementById('tags-input').value = (p.tags || []).join(', ');
            }
            
            if(p.attachment) {
                 currentAttachment = p.attachment;
                 document.getElementById('preview-img').src = currentAttachment;
                 document.getElementById('attachment-preview').classList.remove('hidden');
            }
            
            window.taggedUsers = p.taggedUsers || [];
            renderTaggedUsers();
            
            document.getElementById('post-modal').classList.remove('hidden');
        };

        window.openPostModal = (type='regular') => {
             editModeId = null;
             currentAttachment = null;
             window.taggedUsers = [];
             renderTaggedUsers();
             document.getElementById('attachment-preview').classList.add('hidden');
             document.getElementById('modal-title').innerText = "Create Post";
             document.getElementById('post-submit-btn').innerText = "Post";
             document.getElementById('post-input').value = "";
             document.getElementById('project-tags-input').classList.add('hidden');
             
             document.getElementById('post-modal').classList.remove('hidden');
             if(type === 'project') document.getElementById('post-type-select').value = 'project';
             document.getElementById('post-input').focus();
        };
        
        window.closePostModal = () => document.getElementById('post-modal').classList.add('hidden');
        
        window.submitPost = async () => {
             const text = document.getElementById('post-input').value;
             const type = document.getElementById('post-type-select').value;
             
             if(!text.trim() && !currentAttachment) return;
             
             const userHeadline = document.getElementById('edit-headline').value || "Member";

             closePostModal();
             
             const postData = {
                 text: text,
                 type: type,
                 uid: currentUser.uid,
                 name: document.getElementById('menu-name').innerText,
                 photoURL: document.getElementById('nav-avatar').src,
                 headline: userHeadline, 
                 attachment: currentAttachment,
                 taggedUsers: window.taggedUsers,
                 tags: type==='project'? document.getElementById('tags-input').value.split(',').map(s=>s.trim().replace('#','')).filter(s=>s) : [],
                 lastEdited: serverTimestamp()
             };

             if (editModeId) {
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', editModeId), postData);
                 editModeId = null; 
             } else {
                 postData.likes = 0;
                 postData.createdAt = serverTimestamp();
                 const newPostRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), postData);
                 
                 if(window.taggedUsers.length > 0) {
                     window.taggedUsers.forEach(u => {
                         if(u.id !== currentUser.uid) {
                             addDoc(collection(db, 'artifacts', appId, 'users', u.id, 'notifications'), {
                                type: 'tag',
                                fromUid: currentUser.uid,
                                fromName: currentUser.displayName,
                                postId: newPostRef.id,
                                read: false,
                                createdAt: serverTimestamp()
                             });
                         }
                     });
                 }
             }

             document.getElementById('post-input').value = '';
             currentAttachment = null;
             window.taggedUsers = [];
             document.getElementById('attachment-preview').classList.add('hidden');
        };

        let postToDeleteOwnerUid = null;

        window.initiateDelete = (pid, ownerUid) => {
            postToDeleteId = pid;
            postToDeleteOwnerUid = ownerUid;
            document.getElementById('delete-modal').classList.remove('hidden', 'opacity-0');
        };

        window.closeDeleteModal = () => {
            postToDeleteId = null;
            postToDeleteOwnerUid = null;
            document.getElementById('delete-modal').classList.add('hidden', 'opacity-0');
        };

        window.executeDelete = async () => {
             if(postToDeleteId) {
                 await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', postToDeleteId));
                 
                 if(checkIsAdmin(currentUser.email) && postToDeleteOwnerUid !== currentUser.uid) {
                     await addDoc(collection(db, 'artifacts', appId, 'users', postToDeleteOwnerUid, 'notifications'), {
                        type: 'admin_delete',
                        fromUid: 'admin',
                        fromName: 'Lumini Admin',
                        read: false,
                        createdAt: serverTimestamp()
                     });
                 }
             }
             closeDeleteModal();
        };

        window.confirmDelete = window.executeDelete;

        window.handleFileSelect = (input) => {
             if(input.files && input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     currentAttachment = e.target.result;
                     document.getElementById('preview-img').src = currentAttachment;
                     document.getElementById('attachment-preview').classList.remove('hidden');
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        };
        
        window.clearAttachment = () => {
            currentAttachment = null;
            document.getElementById('file-input').value = '';
            document.getElementById('attachment-preview').classList.add('hidden');
        };

        window.viewMyProfile = () => { if(currentUser) viewProfile(currentUser.uid); };
        window.viewProfile = async (uid) => {
             window.currentViewedUid = uid; 
             
             let user = allUsersCache.find(u => u.id === uid);
             if(!user && uid === currentUser.uid) {
                 user = { name: "Me", photoURL: document.getElementById('nav-avatar').src, headline: "My Headline" };
             } else if (!user) {
                 const uDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', uid));
                 if(uDoc.exists()) {
                     user = uDoc.data();
                 } else {
                     user = { name: "Unknown User", photoURL: "https://placehold.co/100x100" };
                 }
             }
             
             document.getElementById('profile-page-name').innerText = user ? user.name : "User";
             document.getElementById('profile-page-avatar').src = user ? user.photoURL : "https://placehold.co/100x100";
             document.getElementById('profile-page-headline').innerText = user ? (user.headline || "") : "";
             
             const dateSpan = document.getElementById('profile-join-date');
             if (user.createdAt) {
                 const date = new Date(user.createdAt.seconds * 1000);
                 dateSpan.innerText = date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
             } else {
                 dateSpan.innerText = "Unknown";
             }

             if(uid === currentUser.uid) {
                 document.getElementById('edit-profile-btn').classList.remove('hidden');
                 document.getElementById('follow-btn').classList.add('hidden');
                 document.getElementById('profile-chat-btn').classList.add('hidden');
             } else {
                 document.getElementById('edit-profile-btn').classList.add('hidden');
                 document.getElementById('follow-btn').classList.remove('hidden');
                 document.getElementById('profile-chat-btn').classList.remove('hidden');
                 document.getElementById('profile-chat-btn').onclick = () => startChat(uid, user.name);
             }
             
             const pDoc = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'profile', 'main'));
             
             let followerCount = 0;
             let followingCount = 0;
             
             if(pDoc.exists()) {
                 const d = pDoc.data();
                 document.getElementById('profile-page-bio').innerText = d.bio || "No bio yet.";
                 document.getElementById('profile-full-bio').innerText = d.bio || "No details available.";
                 followerCount = (d.followers || []).length;
                 followingCount = (d.following || []).length;
                 
                 if(uid !== currentUser.uid) {
                     const myRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
                     const mySnap = await getDoc(myRef);
                     const isFollowing = mySnap.exists() && (mySnap.data().following || []).includes(uid);
                     
                     const btn = document.getElementById('follow-btn');
                     const btnText = btn.querySelector('span');
                     if(isFollowing) {
                        btnText.innerText = "Unfollow";
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-slate-200', 'text-slate-700');
                     } else {
                        btnText.innerText = "Follow";
                        btn.classList.remove('bg-slate-200', 'text-slate-700');
                        btn.classList.add('bg-blue-600', 'text-white');
                     }
                 }
                 
             } else {
                 document.getElementById('profile-page-bio').innerText = "No bio yet.";
                 document.getElementById('profile-full-bio').innerText = "No details available.";
             }
             
             document.getElementById('profile-followers-count').innerText = followerCount;
             document.getElementById('profile-following-count').innerText = followingCount;
             
             if (checkIsAdmin(currentUser.email) && uid !== currentUser.uid) {
                 const isBanned = user.isBanned || false;
                 let adminControls = document.getElementById('admin-controls-container');
                 adminControls.innerHTML = `
                     <div class="mt-4 pt-4 border-t border-red-100 animate-fade-in">
                         <h4 class="text-xs font-bold text-red-500 uppercase mb-2">Admin Controls</h4>
                         <button onclick="toggleBan('${uid}', ${isBanned})" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold text-xs hover:bg-red-200 transition-colors btn-bounce">
                             ${isBanned ? 'Unban User' : 'Ban User'}
                         </button>
                     </div>
                 `;
             } else {
                 document.getElementById('admin-controls-container').innerHTML = '';
             }

             const userPosts = allPostsCache.filter(p => p.uid === uid);
             document.getElementById('profile-content-posts').innerHTML = userPosts.length ? userPosts.map(p => createPostHTML(p, 'profile')).join('') : '<p class="text-center text-slate-400 py-8 animate-fade-in">No posts yet.</p>';
             
             router('profile');
        };

        window.openSettingsModal = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.closeSettingsModal = () => document.getElementById('settings-modal').classList.add('hidden');
        
        window.saveSettings = async () => {
             const updates = {};
             
             const newName = document.getElementById('settings-username').value;
             if(newName && newName !== currentUser.displayName) {
                 await updateProfile(currentUser, { displayName: newName });
                 updates.name = newName;
             }
             
             if (isResettingSound) {
                 await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                     notificationSound: ""
                 });
                 isResettingSound = false;
             } else if (pendingSoundData) {
                 await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                     notificationSound: pendingSoundData
                 });
                 pendingSoundData = null;
             }

             const isDark = document.getElementById('dark-mode-toggle').checked;
             updates.theme = isDark ? 'dark' : 'light';

             if (Object.keys(updates).length > 0) {
                 await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), updates, { merge: true });
             }
             
             if (newName && newName !== currentUser.displayName) location.reload();
             else {
                 closeSettingsModal();
                 alert("Settings Saved!");
             }
        };

        window.openEditProfileModal = () => document.getElementById('edit-profile-modal').classList.remove('hidden');
        window.closeEditProfileModal = () => document.getElementById('edit-profile-modal').classList.add('hidden');
        
        window.saveProfileData = async () => {
             const headline = document.getElementById('edit-headline').value;
             const bio = document.getElementById('edit-bio').value;
             
             await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                 headline, bio, savedPosts: mySavedPosts
             }, { merge: true });
             
             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), {
                 name: currentUser.displayName,
                 photoURL: currentUser.photoURL,
                 headline: headline
             }, { merge: true });
             
             closeEditProfileModal();
             viewMyProfile();
        };

        window.handlePfpChange = (input) => {
             if(input.files && input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = async (e) => {
                     const dataUrl = e.target.result;
                     await updateProfile(currentUser, { photoURL: dataUrl });
                     await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), { photoURL: dataUrl }, { merge: true });
                     document.getElementById('edit-modal-avatar').src = dataUrl;
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        };

        window.switchProfileTab = (tab) => {
             document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
             document.getElementById(`tab-${tab}`).classList.add('active');
             
             if(tab === 'posts') {
                 document.getElementById('profile-content-posts').classList.remove('hidden');
                 document.getElementById('profile-content-about').classList.add('hidden');
                 document.getElementById('profile-content-saved').classList.add('hidden');
             } else if(tab === 'about') {
                 document.getElementById('profile-content-posts').classList.add('hidden');
                 document.getElementById('profile-content-about').classList.remove('hidden');
                 document.getElementById('profile-content-saved').classList.add('hidden');
             } else {
                 document.getElementById('profile-content-posts').classList.add('hidden');
                 document.getElementById('profile-content-about').classList.add('hidden');
                 document.getElementById('profile-content-saved').classList.remove('hidden');
             }
        };
        
        window.toggleProfileMenu = () => document.getElementById('profile-menu').classList.toggle('hidden');
        window.toggleNotificationDropdown = () => document.getElementById('notification-dropdown').classList.toggle('hidden');
        
        window.handleSearch = (val) => {
             const dropdown = document.getElementById('search-dropdown');
             if(!val.trim()) { dropdown.classList.add('hidden'); return; }
             
             const matches = allUsersCache.filter(u => u.name.toLowerCase().includes(val.toLowerCase()));
             dropdown.classList.remove('hidden');
             if(!matches.length) { dropdown.innerHTML = `<p class="p-4 text-xs text-slate-400">No users found.</p>`; return; }
             
             dropdown.innerHTML = matches.map(u => `<div onclick="viewProfile('${u.id}')" class="flex items-center gap-3 p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 transition-colors"><img src="${u.photoURL}" class="w-8 h-8 rounded-full bg-slate-200"><span class="font-bold text-sm text-slate-700">${u.name}</span></div>`).join('');
        };
        
        window.toggleEmojiPicker = () => document.getElementById('emoji-picker').classList.toggle('hidden');
        window.insertEmoji = (e) => { document.getElementById('post-input').value += e; };
        window.toggleTagPicker = () => {
             const p = document.getElementById('tag-picker');
             p.classList.toggle('hidden');
             if(!p.classList.contains('hidden')) {
                  document.getElementById('tag-list').innerHTML = `
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600 transition-colors" onclick="addTag('javascript')">#javascript</div>
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600 transition-colors" onclick="addTag('design')">#design</div>
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600 transition-colors" onclick="addTag('react')">#react</div>
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600 transition-colors" onclick="addTag('firebase')">#firebase</div>
                  `;
             }
        };
        window.addTag = (t) => {
             const el = document.getElementById('post-type-select');
             if(el.value !== 'project') { el.value = 'project'; document.getElementById('project-tags-input').classList.remove('hidden'); }
             const i = document.getElementById('tags-input');
             i.value = i.value ? i.value + ', ' + t : t;
             document.getElementById('tag-picker').classList.add('hidden');
        };

        document.addEventListener('click', (e) => {
            if(!e.target.closest('.relative')) {
                document.getElementById('profile-menu').classList.add('hidden');
                document.getElementById('notification-dropdown').classList.add('hidden');
                document.getElementById('emoji-picker').classList.add('hidden');
                document.getElementById('tag-picker').classList.add('hidden');
                document.getElementById('user-tag-picker').classList.add('hidden');
            }
        });

        window.openClearNotifsModal = () => {
            if(allNotifications.length === 0) return;
            document.getElementById('clear-notifs-modal').classList.remove('hidden');
        };

        window.closeClearNotifsModal = () => {
            document.getElementById('clear-notifs-modal').classList.add('hidden');
        };

        window.executeClearNotifs = async () => {
            closeClearNotifsModal();
            try {
                const batch = writeBatch(db);
                const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications'));
                const snap = await getDocs(q);
                
                snap.forEach(d => {
                    batch.delete(d.ref);
                });
                
                await batch.commit();
            } catch(e) {
                console.error("Error clearing notifications:", e);
                alert("Failed to clear notifications.");
            }
        };
        
        window.clearAllNotifications = window.openClearNotifsModal;

        let reportTargetPostId = null;
        let reportTargetUid = null;

        window.reportPost = (postId, postUid) => {
             reportTargetPostId = postId;
             reportTargetUid = postUid;
             document.getElementById('report-reason').value = ""; 
             document.getElementById('report-modal').classList.remove('hidden');
        };

        window.closeReportModal = () => {
             document.getElementById('report-modal').classList.add('hidden');
             reportTargetPostId = null;
             reportTargetUid = null;
        };

        window.submitReport = async () => {
             const reason = document.getElementById('report-reason').value;
             if (!reason.trim()) {
                 alert("Please provide a reason for the report.");
                 return;
             }

             const targetUser = allUsersCache.find(u => u.id === reportTargetUid);
             const targetName = targetUser ? targetUser.name : "Unknown User";
             const postLink = window.location.origin + window.location.pathname + "#post-" + reportTargetPostId;

             try {
                 await addDoc(collection(db, 'artifacts', appId, 'reports'), {
                     reporterUid: currentUser.uid,
                     reporterName: currentUser.displayName,
                     reporterEmail: currentUser.email,
                     targetUid: reportTargetUid,
                     targetName: targetName,
                     postId: reportTargetPostId,
                     reason: reason,
                     postLink: postLink,
                     createdAt: serverTimestamp(),
                     status: 'pending' 
                 });

                 const formData = {
                     access_key: "c26a3fd9-3218-48b0-9bb6-217299229a3f",
                     subject: "LUMINI REPORT: Violation Flagged",
                     from_name: "Lumini Security",
                     message: `
                        REPORT DETAILS:
                        ----------------
                        REPORTER: ${currentUser.displayName} (${currentUser.email})
                        TARGET USER: ${targetName}
                        REASON: ${reason}
                        
                        POST LINK: ${postLink}
                        
                        Please investigate immediately.
                     `
                 };

                 await fetch("https://api.web3forms.com/submit", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Accept: "application/json"
                    },
                    body: JSON.stringify(formData)
                 });

                 alert("Report submitted to admins.");
             } catch (e) {
                 console.error("Error submitting report:", e);
                 alert("Failed to submit report.");
             }

             closeReportModal();
        };

        // --- FLOATING CHAT WIDGET LOGIC ---

        window.toggleFloatingWidget = () => {
            if(window.hasDraggedWidget) return;
            const widget = document.getElementById('floating-chat-widget');
            const launcher = document.getElementById('floating-launcher');
            window.isFloatingWidgetOpen = !window.isFloatingWidgetOpen;
            if(window.isFloatingWidgetOpen) {
                widget.style.transform = 'scale(1) translateY(0)';
                widget.style.opacity = '1';
                widget.classList.remove('pointer-events-none');
                widget.classList.add('pointer-events-auto');
                launcher.style.transform = 'scale(0) rotate(90deg)';
                launcher.style.opacity = '0';
                launcher.classList.add('pointer-events-none');
                renderFloatingChatList();
            } else {
                widget.style.transform = 'scale(0) translateY(20px)';
                widget.style.opacity = '0';
                widget.classList.add('pointer-events-none');
                widget.classList.remove('pointer-events-auto');
                launcher.style.transform = 'scale(1) rotate(0deg)';
                launcher.style.opacity = '1';
                launcher.classList.remove('pointer-events-none');
                if(window.unsubscribeFloatingMessages) window.unsubscribeFloatingMessages();
                backToFloatingList(); 
            }
        };

        window.renderFloatingChatList = () => {
            const container = document.getElementById('floating-chat-list');
            if(!window.allChats || window.allChats.length === 0) {
                 container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;padding:40px 16px;"><i class="fa-regular fa-comment-dots" style="font-size:28px;color:#cbd5e1;"></i><p style="font-size:11px;color:#94a3b8;font-weight:500;">No conversations yet</p></div>';
                 return;
            }
            container.innerHTML = window.allChats.map((c, i) => {
                const parts = c.id.split('_');
                const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                const otherUser = allUsersCache.find(u => u.id === otherUid) || { name: "User", photoURL: "https://placehold.co/100x100" };
                const isUnread = c.readBy && !c.readBy.includes(currentUser.uid);
                
                return `
                <div onclick="openFloatingChat('${c.id}', '${otherUser.name}')" class="flex items-center gap-3 p-2.5 hover:bg-white rounded-xl cursor-pointer transition-all duration-200 mb-0.5 ${isUnread ? 'bg-blue-50/60' : ''}" style="animation: msgMorphIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; animation-delay: ${i * 0.05}s; writing-mode: horizontal-tb;">
                    <div class="relative flex-shrink-0">
                        <img src="${otherUser.photoURL}" class="w-9 h-9 rounded-full bg-slate-200 object-cover" style="min-width:36px;">
                        ${isUnread ? '<div class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-blue-500 rounded-full border-2 border-white" style="animation: pulse 2s infinite;"></div>' : ''}
                    </div>
                    <div class="truncate flex-grow" style="min-width:0;">
                        <p class="font-semibold text-xs text-slate-800 truncate" style="writing-mode: horizontal-tb;">${otherUser.name}</p>
                        ${isUnread ? '<p class="text-[10px] text-blue-600 font-bold">New message</p>' : '<p class="text-[10px] text-slate-400">Tap to chat</p>'}
                    </div>
                </div>`;
            }).join('');
        };

        window.openFloatingChat = async (chatId, name) => {
            window.currentFloatingChatId = chatId;
            document.getElementById('floating-chat-list').style.display = 'none';
            const convo = document.getElementById('floating-conversation');
            convo.style.display = 'flex';
            convo.style.flexDirection = 'column';
            convo.style.flex = '1';
            document.getElementById('floating-back-btn').classList.remove('hidden');
            document.getElementById('floating-header-title').innerText = name;
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), {
                readBy: arrayUnion(currentUser.uid)
            }, { merge: true });

            if(window.unsubscribeFloatingMessages) window.unsubscribeFloatingMessages();
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), orderBy('createdAt', 'asc'));
            window.unsubscribeFloatingMessages = onSnapshot(q, (snap) => {
                const container = document.getElementById('floating-messages');
                container.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    if(m.type === 'system') {
                         container.innerHTML += `<div class="text-[10px] text-center text-slate-400 my-2 font-medium">${m.text}</div>`;
                         return;
                    }
                    const isMe = m.senderId === currentUser.uid;
                    let timeStr = '';
                    if(m.createdAt) {
                        const dt = new Date(m.createdAt.toMillis());
                        timeStr = dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    }
                    container.innerHTML += `
                    <div class="flex w-full mb-1 ${isMe?'justify-end':'justify-start'}" style="animation: msgMorphIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;">
                        <div style="max-width: 85%; writing-mode: horizontal-tb;">
                            <div class="px-3 py-2 text-xs leading-relaxed ${isMe ? 'bg-slate-800 text-white rounded-2xl rounded-br-sm' : 'bg-white text-slate-800 rounded-2xl rounded-bl-sm border border-slate-100'}" style="box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                                ${m.text}
                            </div>
                            ${timeStr ? `<div class="text-[9px] mt-0.5 ${isMe ? 'text-right' : 'text-left'}" style="color: rgba(148,163,184,0.6);">${timeStr}</div>` : ''}
                        </div>
                    </div>`;
                });
                container.scrollTop = container.scrollHeight;
            });
        };

        window.backToFloatingList = () => {
            document.getElementById('floating-conversation').style.display = 'none';
            document.getElementById('floating-chat-list').style.display = '';
            document.getElementById('floating-back-btn').classList.add('hidden');
            document.getElementById('floating-header-title').innerText = "Messages";
            window.currentFloatingChatId = null;
            if(window.unsubscribeFloatingMessages) {
                window.unsubscribeFloatingMessages();
                window.unsubscribeFloatingMessages = null;
            }
        };

        window.sendFloatingMessage = async (e) => {
            e.preventDefault();
            const input = document.getElementById('floating-input');
            const text = input.value.trim();
            if(!text || !window.currentFloatingChatId) return;

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', window.currentFloatingChatId, 'messages'), { 
                text: text, 
                senderId: currentUser.uid, 
                createdAt: serverTimestamp() 
            });
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', window.currentFloatingChatId), {
                lastUpdated: serverTimestamp(),
                readBy: [currentUser.uid]
            }, { merge: true });
            
            input.value = '';
        };

        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = document.getElementById("floating-header");
            const launcher = document.getElementById("floating-launcher");
            if (header) {
                header.onmousedown = dragMouseDown;
            }
            if (launcher) {
                launcher.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                // Allow clicking buttons inside without dragging
                if(e.target.closest('button') && e.target.id !== 'floating-launcher') return;

                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // set the element's new position:
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                // Remove bottom/right positioning once we start dragging to allow free movement
                elmnt.style.bottom = "auto";
                elmnt.style.right = "auto";
                
                window.hasDraggedWidget = true;
            }

            function closeDragElement() {
                // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
                setTimeout(() => { window.hasDraggedWidget = false; }, 100);
            }
        }
        
        // Check if floating widget exists before initializing
        const floatingWidget = document.getElementById("floating-chat-container");
        if(floatingWidget) {
             makeDraggable(floatingWidget);
        }

    </script>
</body>
</html>
