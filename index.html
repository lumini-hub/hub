<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumini - Social</title>
    <link rel="icon" href="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" type="image/x-icon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script>
        // Immediate Dark Mode Check
        if (localStorage.getItem('lumini_theme') === 'dark' || (!('lumini_theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        lumini: {
                            blue: '#2563eb',
                            purple: '#9333ea',
                            dark: '#0f172a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-short': 'bounceShort 0.5s ease-in-out 1',
                        'gradient-x': 'gradient-x 3s ease infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        popIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        bounceShort: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' },
                        },
                        'gradient-x': {
                            '0%, 100%': {
                                'background-size':'200% 200%',
                                'background-position': 'left center'
                            },
                            '50%': {
                                'background-size':'200% 200%',
                                'background-position': 'right center'
                            },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        floatUp: {
                            '0%': { transform: 'translateY(0) scale(1)', opacity: '1' },
                            '100%': { transform: 'translateY(-200px) scale(1.5)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255, 255, 255, 0.3); }
        .glass-card { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .glass-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025); }
        
        /* Collapsible Section Styles - Hover to expand */
        .collapsible-section { position: relative; }
        .collapsible-header { display: flex; align-items: center; justify-content: space-between; cursor: default; padding: 10px 14px; border-radius: 12px; transition: background-color 0.2s ease; user-select: none; }
        .collapsible-header h4 { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; margin: 0; }
        .collapsible-chevron { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #94a3b8; font-size: 0.7rem; }
        .collapsible-chevron.collapsed { transform: rotate(-90deg); }
        .collapsible-body { overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, padding 0.3s ease; max-height: 1000px; opacity: 1; }
        .collapsible-body.collapsed { max-height: 0 !important; opacity: 0; padding-top: 0 !important; padding-bottom: 0 !important; }
        html.dark .collapsible-header h4 { color: #64748b; }

        /* Slide-out sidebar overlays */
        .sidebar-overlay {
            position: fixed;
            top: 40px;
            bottom: 0;
            width: 280px;
            z-index: 40;
            transform: translateX(0);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, top 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            padding: 16px 12px;
        }
        .sidebar-overlay.left-panel { left: 0; transform: translateX(-100%); }
        .sidebar-overlay.right-panel { right: 0; transform: translateX(100%); }
        .sidebar-overlay.left-panel.open { transform: translateX(0); }
        .sidebar-overlay.right-panel.open { transform: translateX(0); }

        /* Hover trigger zones on edges */
        .sidebar-trigger {
            position: fixed;
            top: 40px;
            bottom: 0;
            width: 18px;
            z-index: 39;
            cursor: pointer;
            transition: top 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar-trigger.left-trigger { left: 0; }
        .sidebar-trigger.right-trigger { right: 0; }
        .sidebar-trigger-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 48px;
            border-radius: 4px;
            background: rgba(148, 163, 184, 0.3);
            transition: all 0.3s ease;
        }
        .left-trigger .sidebar-trigger-indicator { left: 6px; }
        .right-trigger .sidebar-trigger-indicator { right: 6px; }
        .sidebar-trigger:hover .sidebar-trigger-indicator {
            background: rgba(30, 41, 59, 0.4);
            height: 64px;
            width: 5px;
        }

        html.dark .sidebar-overlay { background: rgba(15, 23, 42, 0.95); }
        .sidebar-overlay { background: rgba(248, 250, 252, 0.97); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0,0,0,0.1); }

        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; font-weight: 500; font-size: 0.95rem; color: #64748b; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; overflow: hidden; }
        .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.6); color: #1e293b; transform: translateX(3px); }
        .sidebar-link:active { transform: scale(0.98); }
        .sidebar-link i { width: 24px; font-size: 1.2rem; transition: transform 0.3s ease; }
        .sidebar-link:hover i { transform: scale(1.1); }
        .sidebar-link.active { background-color: white; color: #1e293b; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        body { background-color: #fafafa; background-image: none; background-attachment: fixed; }
        
        .post-video-wrapper { position: relative; background: #000; border-radius: 0; overflow: hidden; }
        .post-video-wrapper video { display: block; width: 100%; cursor: pointer; }
        .post-video-wrapper video::-webkit-media-controls { display: none !important; }
        .post-video-wrapper video::-webkit-media-controls-enclosure { display: none !important; }
        .post-video-controls { position: absolute; bottom: 0; left: 0; right: 0; padding: 48px 14px 12px 14px; background: linear-gradient(0deg, rgba(0,0,0,0.75) 0%, rgba(0,0,0,0.35) 60%, transparent 100%); display: flex; flex-direction: column; gap: 8px; opacity: 0; transition: opacity 0.25s ease; pointer-events: none; z-index: 5; }
        .post-video-wrapper.pv-show-controls .post-video-controls { opacity: 1; pointer-events: auto; }
        .post-video-controls .pv-row { display: flex; align-items: center; gap: 10px; }
        .post-video-controls .pv-play-btn { background: none; border: none; color: #fff; font-size: 17px; cursor: pointer; padding: 6px; display: flex; align-items: center; justify-content: center; opacity: 0.9; transition: opacity 0.15s, transform 0.15s; flex-shrink: 0; }
        .post-video-controls .pv-play-btn:hover { opacity: 1; transform: scale(1.15); }
        .post-video-controls .pv-time { color: rgba(255,255,255,0.8); font-size: 11px; font-weight: 500; min-width: 78px; text-align: center; font-variant-numeric: tabular-nums; flex-shrink: 0; }
        .post-video-controls .pv-progress-track { flex: 1; height: 6px; background: rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; position: relative; overflow: visible; }
        .post-video-controls .pv-progress-track:hover { height: 8px; }
        .post-video-controls .pv-progress-fill { height: 100%; background: #fff; border-radius: 6px; pointer-events: none; width: 0%; }
        .post-video-controls .pv-progress-thumb { position: absolute; top: 50%; right: 0; width: 14px; height: 14px; background: #fff; border-radius: 50%; transform: translate(50%, -50%) scale(0); transition: transform 0.15s ease; box-shadow: 0 0 6px rgba(0,0,0,0.4); pointer-events: none; }
        .post-video-controls .pv-progress-track:hover .pv-progress-thumb,
        .post-video-wrapper.pv-scrubbing .pv-progress-thumb { transform: translate(50%, -50%) scale(1); }
        .post-video-controls .pv-vol-btn { background: none; border: none; color: #fff; font-size: 15px; cursor: pointer; padding: 6px; opacity: 0.85; transition: opacity 0.15s, transform 0.15s; flex-shrink: 0; }
        .post-video-controls .pv-vol-btn:hover { opacity: 1; transform: scale(1.15); }
        .post-video-controls .pv-fs-btn { background: none; border: none; color: #fff; font-size: 15px; cursor: pointer; padding: 6px; opacity: 0.85; transition: opacity 0.15s, transform 0.15s; margin-left: auto; flex-shrink: 0; }
        .post-video-controls .pv-fs-btn:hover { opacity: 1; transform: scale(1.15); }
        .post-video-big-play { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(0,0,0,0.45); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 22px; cursor: pointer; border: 2px solid rgba(255,255,255,0.15); opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; pointer-events: none; z-index: 4; }
        .post-video-wrapper.paused .post-video-big-play { opacity: 1; pointer-events: auto; }
        .post-video-big-play:hover { background: rgba(0,0,0,0.6); transform: translate(-50%, -50%) scale(1.1); }
        .post-video-wrapper.pv-scrubbing .post-video-controls { opacity: 1; pointer-events: auto; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; border: 2px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        .text-gradient { background: linear-gradient(to right, #1e293b, #475569); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .bg-gradient-lumini { background: linear-gradient(135deg, #1e293b, #334155); }
        
        #toast { visibility: hidden; min-width: 250px; background-color: rgba(15, 23, 42, 0.9); backdrop-filter: blur(4px); color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%) translateY(20px); font-size: 14px; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); bottom: 50px; }
        
        /* ====== REVAMPED CHAT BUBBLES ====== */
        .msg-bubble { 
            max-width: 72%; min-width: 40px; padding: 10px 16px; border-radius: 20px; position: relative; 
            word-wrap: break-word; word-break: break-word; font-size: 0.875rem; line-height: 1.55; 
            touch-action: pan-y; 
            animation: msgMorphIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
            transform-origin: bottom center;
            will-change: transform, opacity;
        }
        .msg-bubble:hover { transform: scale(1.015); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .msg-me { 
            background: #1e293b; color: #f1f5f9; 
            border-bottom-right-radius: 6px; margin-left: auto; 
            box-shadow: 0 1px 6px rgba(30, 41, 59, 0.18);
            transform-origin: bottom right;
        }
        .msg-them { 
            background: #ffffff; color: #1e293b; 
            border-bottom-left-radius: 6px; margin-right: auto; 
            border: 1px solid #f1f5f9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            transform-origin: bottom left;
        }
        @keyframes msgMorphIn { 
            0% { opacity: 0; transform: translateY(12px) scale(0.85) rotateX(8deg); filter: blur(2px); } 
            60% { opacity: 1; transform: translateY(-2px) scale(1.02) rotateX(0deg); filter: blur(0); }
            100% { opacity: 1; transform: translateY(0) scale(1) rotateX(0deg); filter: blur(0); } 
        }
        /* Staggered entry for multiple messages */
        .msg-group:nth-child(1) .msg-bubble { animation-delay: 0s; }
        .msg-group:nth-child(2) .msg-bubble { animation-delay: 0.04s; }
        .msg-group:nth-child(3) .msg-bubble { animation-delay: 0.08s; }
        .msg-group:nth-child(4) .msg-bubble { animation-delay: 0.12s; }
        .msg-group:nth-child(5) .msg-bubble { animation-delay: 0.16s; }

        /* Timestamp labels between message groups */
        .msg-timestamp-divider {
            display: flex; align-items: center; gap: 12px; margin: 16px 0 8px;
            animation: msgMorphIn 0.4s ease both;
        }
        .msg-timestamp-divider::before, .msg-timestamp-divider::after {
            content: ''; flex: 1; height: 1px; background: #e2e8f0; opacity: 0.5;
        }
        .msg-timestamp-divider span {
            font-size: 0.65rem; color: #94a3b8; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.06em; white-space: nowrap;
        }

        /* Inline timestamp on each bubble */
        .msg-time {
            font-size: 0.6rem; color: rgba(148, 163, 184, 0.8); margin-top: 3px;
            display: flex; align-items: center; gap: 4px;
            transition: opacity 0.2s ease;
        }
        .msg-me .msg-time { color: rgba(241, 245, 249, 0.5); justify-content: flex-end; }




        /* Typing indicator */
        .typing-indicator {
            display: inline-flex; align-items: center; gap: 4px; padding: 12px 18px;
            background: #ffffff; border: 1px solid #f1f5f9; border-radius: 20px; 
            border-bottom-left-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            animation: msgMorphIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
        }
        .typing-dot {
            width: 6px; height: 6px; border-radius: 50%; background: #94a3b8;
            animation: typingBounce 1.4s ease-in-out infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .typing-dot:nth-child(3) { animation-delay: 0.3s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        /* Chat open morph animation */
        @keyframes chatViewMorphIn {
            0% { opacity: 0; transform: scale(0.96) translateY(8px); filter: blur(3px); }
            100% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
        }
        .chat-morph-enter { animation: chatViewMorphIn 0.45s cubic-bezier(0.22, 1, 0.36, 1) both; }

        /* Message area smooth scroll indicator */
        #chat-messages { scroll-behavior: smooth; }
        
        .msg-system { background: transparent; color: #94a3b8; font-size: 0.7rem; text-align: center; width: 100%; margin: 12px 0; font-style: normal; opacity: 0.7; font-weight: 500; letter-spacing: 0.01em; }
        
        .profile-tab { cursor: pointer; color: #64748b; font-weight: 600; transition: all 0.3s ease; position: relative; }
        .profile-tab:hover { color: #334155; background: rgba(0,0,0,0.04); }
        .profile-tab.active { color: #1e293b; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        
        .notification-dot { position: absolute; top: -2px; right: -2px; width: 12px; height: 12px; background-color: #ef4444; border-radius: 50%; border: 2px solid white; display: none; animation: pulse 2s infinite; }
        
        .shape-blob { position: absolute; filter: blur(80px); z-index: 0; opacity: 0.5; transition: all 1s ease; }
        .blob-1 { top: -10%; left: -10%; width: 400px; height: 400px; background: #9333ea; animation: float 8s ease-in-out infinite, pulse 8s infinite; }
        .blob-2 { bottom: -10%; right: -10%; width: 450px; height: 450px; background: #2563eb; animation: float 10s ease-in-out infinite reverse, pulse 10s infinite reverse; }
        
        /* Interactive Elements */
        .btn-bounce { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-bounce:active { transform: scale(0.95); }

        /* Enhanced Page Headers */
        .page-hero {
            position: relative;
            overflow: hidden;
            border-radius: 1.5rem;
            padding: 2rem 2.5rem;
        }
        .page-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: rgba(37, 99, 235, 0.06);
            filter: blur(40px);
            transition: transform 0.6s ease;
        }
        .page-hero:hover::before {
            transform: scale(1.3) translate(-10%, 10%);
        }

        /* Network Card Enhanced */
        .network-card {
            position: relative;
            overflow: hidden;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .network-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, #2563eb, #9333ea);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .network-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 16px 40px -8px rgba(0, 0, 0, 0.1), 0 6px 12px -4px rgba(0, 0, 0, 0.06);
        }
        .network-card:hover::after {
            transform: scaleX(1);
        }
        .network-card .network-avatar {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .network-card:hover .network-avatar {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
        }
        .network-card .network-action {
            opacity: 0;
            transform: translateX(8px);
            transition: all 0.3s ease;
        }
        .network-card:hover .network-action {
            opacity: 1;
            transform: translateX(0);
        }

        /* Collaborate Filter Pills Enhanced */
        .collab-filter-pill {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .collab-filter-pill::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: inherit;
            z-index: 0;
        }
        .collab-filter-pill > * { position: relative; z-index: 1; }
        .collab-filter-pill { isolation: isolate; }
        .collab-filter-pill:hover::before {
            opacity: 0.08;
        }
        .collab-filter-pill.active-filter::before {
            opacity: 0;
        }

        /* Saved Posts Empty State */
        .saved-empty-icon {
            animation: float 3s ease-in-out infinite;
        }

        /* Collection Tabs */
        .collection-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            border: 1.5px solid transparent;
            background: rgba(255,255,255,0.8);
            color: #64748b;
        }
        .collection-tab:hover { background: #f1f5f9; color: #334155; }
        .collection-tab.active-collection {
            background: #1e293b;
            color: #f8fafc;
            border-color: #1e293b;
            box-shadow: 0 2px 8px rgba(30,41,59,0.2);
        }
        html.dark .collection-tab { background: rgba(255,255,255,0.05); color: #8b9dc3; border-color: rgba(255,255,255,0.06); }
        html.dark .collection-tab:hover { background: rgba(255,255,255,0.1); color: #c7d2fe; }
        html.dark .collection-tab.active-collection { background: #6366f1; color: white; border-color: #6366f1; }

        /* Save Collection Modal */
        #save-collection-modal {
            z-index: 150;
        }
        .collection-pick-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px; border-radius: 12px;
            cursor: pointer; transition: all 0.2s ease;
            border: 1.5px solid transparent;
        }
        .collection-pick-item:hover { background: #f8fafc; border-color: #e2e8f0; }
        .collection-pick-item.selected { background: #eff6ff; border-color: #3b82f6; }
        html.dark .collection-pick-item:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        html.dark .collection-pick-item.selected { background: rgba(99,102,241,0.15); border-color: #6366f1; }

        /* Audio wave animation for voice calls */
        @keyframes audioWave {
            0%, 100% { transform: scaleY(0.5); opacity: 0.4; }
            50% { transform: scaleY(1.3); opacity: 1; }
        }

        /* Call timer pill */
        .call-timer-pill {
            font-variant-numeric: tabular-nums;
        }

        /* Comment highlight animation */
        .comment-highlight-flash {
            animation: commentFlash 2s ease both;
        }
        @keyframes commentFlash {
            0% { background: rgba(59,130,246,0.2); transform: scale(1.02); }
            100% { background: transparent; transform: scale(1); }
        }

        /* Comment count bubble revamp */
        .comment-count-bubble {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 20px; height: 20px; padding: 0 6px;
            border-radius: 10px;
            font-size: 0.7rem; font-weight: 700;
            background: #f1f5f9; color: #64748b;
            transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
        }
        .comment-count-bubble.has-comments { background: #eff6ff; color: #2563eb; }
        html.dark .comment-count-bubble { background: rgba(255,255,255,0.08); color: #8b9dc3; }
        html.dark .comment-count-bubble.has-comments { background: rgba(99,102,241,0.15); color: #a5b4fc; }

        /* Long press spotlight revamp - pulse ring */
        .long-press-ring {
            position: absolute; inset: 0; border-radius: inherit;
            border: 3px solid rgba(99,102,241,0.6);
            opacity: 0; transform: scale(1);
            pointer-events: none; z-index: 20;
        }
        .long-press-ring.active {
            animation: lpRingPulse 0.6s cubic-bezier(0.4,0,0.2,1) forwards;
        }
        @keyframes lpRingPulse {
            0% { opacity: 0; transform: scale(0.95); border-color: rgba(99,102,241,0.6); }
            50% { opacity: 1; transform: scale(1.02); border-color: rgba(99,102,241,0.8); }
            100% { opacity: 0.5; transform: scale(1); border-color: rgba(99,102,241,0.4); }
        }
        .long-press-glow {
            position: absolute; inset: -4px; border-radius: inherit;
            background: radial-gradient(circle, rgba(99,102,241,0.15), transparent 70%);
            opacity: 0; pointer-events: none; z-index: 19;
            transition: opacity 0.3s ease;
        }
        .long-press-glow.active { opacity: 1; }

        /* Progress bar for long press */
        .lp-progress-bar {
            position: absolute; bottom: 0; left: 0; height: 3px;
            background: linear-gradient(90deg, #6366f1, #3b82f6);
            border-radius: 0 0 inherit inherit;
            width: 0%; z-index: 25;
            transition: width 0.05s linear;
        }

        /* Interactive stat counters */
        .stat-hover {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .stat-hover:hover {
            transform: scale(1.08);
            color: #2563eb;
        }

        /* Profile cover enhanced */
        .profile-cover {
            position: relative;
            overflow: hidden;
        }
        .profile-cover::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(to top, rgba(0,0,0,0.15), transparent);
        }

        /* Dark mode enhancements */
        html.dark .page-hero::before { background: rgba(99, 102, 241, 0.08); }
        html.dark .network-card:hover { box-shadow: 0 16px 40px -8px rgba(0, 0, 0, 0.4); }
        html.dark .network-card::after { background: linear-gradient(to right, #6366f1, #a78bfa); }
        
        /* Online Status Dot */
        .status-dot-online { width: 12px; height: 12px; background-color: #22c55e; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 0; right: 0; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); animation: onlinePulse 2s ease-in-out infinite; }
        @keyframes onlinePulse {
            0%, 100% { box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); }
            50% { box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.1); }
        }
        html.dark .status-dot-online { border-color: #0a0a0a; }
        
        /* Admin Badge Style */
        .admin-badge {
            background: linear-gradient(45deg, #ff0000, #ff8c00, #ffd700, #ff0000);
            background-size: 300% 300%;
            animation: gradient-x 4s ease infinite;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-left: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 5px rgba(255, 0, 0, 0.3);
            vertical-align: middle;
        }

        /* Verified Badge Style */
        .verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            margin-left: 4px;
            vertical-align: middle;
            flex-shrink: 0;
        }
        .verified-badge svg {
            width: 18px;
            height: 18px;
        }
        
        /* Chat Media Styles */
        .chat-media-img, .chat-media-video { max-width: 360px; max-height: 320px; border-radius: 12px; object-fit: cover; cursor: pointer; transition: transform 0.2s ease; }

        /* Image Lightbox / Spotlight */
        #image-lightbox { display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); align-items: center; justify-content: center; cursor: zoom-out; animation: lbFadeIn 0.25s ease; }
        #image-lightbox.active { display: flex; }
        #image-lightbox img { max-width: 92vw; max-height: 90vh; object-fit: contain; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: lbZoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #image-lightbox .lb-close { position: absolute; top: 16px; right: 20px; color: white; font-size: 1.5rem; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.15); transition: background 0.2s; }
        #image-lightbox .lb-close:hover { background: rgba(255,255,255,0.3); }
        @keyframes lbFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes lbZoomIn { from { transform: scale(0.85); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .chat-media-img:hover, .chat-media-video:hover { transform: scale(1.02); }
        .chat-file-attachment { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 10px; background: rgba(0,0,0,0.05); cursor: pointer; transition: background 0.2s; text-decoration: none; color: inherit; }
        .chat-file-attachment:hover { background: rgba(0,0,0,0.1); }
        .msg-me .chat-file-attachment { background: rgba(255,255,255,0.15); }
        .msg-me .chat-file-attachment:hover { background: rgba(255,255,255,0.25); }
        html.dark .msg-them .chat-file-attachment { background: rgba(255,255,255,0.08); }
        html.dark .msg-them .chat-file-attachment:hover { background: rgba(255,255,255,0.14); }
        .voice-msg-player { display: flex; align-items: center; gap: 8px; min-width: 180px; }
        .voice-msg-player button { width: 32px; height: 32px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .msg-me .voice-msg-player button { background: rgba(255,255,255,0.2); color: #f1f5f9; }
        .msg-me .voice-msg-player button:hover { background: rgba(255,255,255,0.35); }
        .msg-them .voice-msg-player button { background: rgba(0,0,0,0.08); color: #1e293b; }
        .msg-them .voice-msg-player button:hover { background: rgba(0,0,0,0.15); }
        html.dark .msg-them .voice-msg-player button { background: rgba(255,255,255,0.1); color: #e2e8f0; }
        .voice-waveform { flex: 1; height: 28px; display: flex; align-items: center; gap: 1.5px; cursor: pointer; position: relative; }
        .voice-waveform-bar { width: 3px; border-radius: 2px; transition: background 0.15s ease, height 0.15s ease; }
        .msg-me .voice-waveform-bar { background: rgba(255,255,255,0.3); }
        .msg-me .voice-waveform-bar.played { background: rgba(255,255,255,0.9); }
        .msg-them .voice-waveform-bar { background: rgba(0,0,0,0.15); }
        .msg-them .voice-waveform-bar.played { background: rgba(59,130,246,0.8); }
        html.dark .msg-them .voice-waveform-bar { background: rgba(255,255,255,0.15); }
        html.dark .msg-them .voice-waveform-bar.played { background: rgba(96,165,250,0.85); }
        .voice-duration { font-size: 0.65rem; min-width: 32px; text-align: center; opacity: 0.7; }
        .chat-attachment-toolbar { display: flex; align-items: center; gap: 2px; }
        .chat-attachment-toolbar button { width: 34px; height: 34px; border-radius: 50%; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #64748b; transition: all 0.2s; font-size: 0.95rem; }
        .chat-attachment-toolbar button:hover { background: #f1f5f9; color: #1e293b; transform: scale(1.1); }
        html.dark .chat-attachment-toolbar button:hover { background: rgba(255,255,255,0.08); color: #e2e8f0; }
        .chat-attach-preview { padding: 8px 12px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #e2e8f0; animation: msgMorphIn 0.3s ease both; }
        html.dark .chat-attach-preview { border-top-color: rgba(255,255,255,0.08); }
        .chat-attach-preview img, .chat-attach-preview video { max-height: 60px; max-width: 80px; border-radius: 8px; object-fit: cover; }
        .voice-recording-indicator { display: flex; align-items: center; gap: 8px; flex: 1; }
        .voice-rec-dot { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; animation: pulse 1s infinite; }
        .voice-rec-timer { font-size: 0.85rem; font-weight: 600; color: #ef4444; font-variant-numeric: tabular-nums; }

        /* Video Call Specific Styles */
        #localVideo { transform: scaleX(-1); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* View Transitions */
        .view-section { animation-duration: 0.4s; animation-fill-mode: both; }

        /* Message Actions */
        .msg-actions { opacity: 0; transition: opacity 0.2s ease; }
        .msg-group:hover .msg-actions { opacity: 1; }

        /* Emoji Reaction Picker - Side positioned with hover bridge */
        .emoji-reaction-wrapper {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            z-index: 10;
        }
        /* For "my" messages: emojis appear on the LEFT */
        .msg-me-wrapper .emoji-reaction-wrapper {
            right: 100%;
            flex-direction: row-reverse;
        }
        /* For "their" messages: emojis appear on the RIGHT */
        .msg-them-wrapper .emoji-reaction-wrapper {
            left: 100%;
            flex-direction: row;
        }
        /* Invisible hover bridge */
        .emoji-hover-bridge {
            width: 12px;
            height: 40px;
            flex-shrink: 0;
        }
        /* Emoji pill container */
        .emoji-pill {
            display: flex;
            align-items: center;
            gap: 2px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 3px 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            pointer-events: auto;
        }
        html.dark .emoji-pill {
            background: #1a1a1a;
            border-color: rgba(255,255,255,0.1);
        }
        /* Slide + fade from side - smooth */
        .msg-them-wrapper .emoji-pill {
            transform: translateX(-6px);
            opacity: 0;
            transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.25s ease;
        }
        .msg-me-wrapper .emoji-pill {
            transform: translateX(6px);
            opacity: 0;
            transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.25s ease;
        }
        /* Show on hover of the msg-group row */
        .msg-group:hover .emoji-reaction-wrapper {
            opacity: 1;
            pointer-events: auto;
        }
        .msg-group:hover .emoji-pill {
            transform: translateX(0);
            opacity: 1;
        }

        /* Reply Styles */
        .reply-context {
            font-size: 0.75rem;
            margin-bottom: 4px;
            padding: 4px 8px;
            border-radius: 8px;
            opacity: 0.9;
            background: rgba(0,0,0,0.05);
            border-left: 3px solid #cbd5e1;
            display: flex;
            flex-direction: column;
        }
        .msg-me .reply-context { background: rgba(255,255,255,0.2); border-left-color: rgba(255,255,255,0.5); }
        
        /* Swipe to Reply Indicator */
        .reply-arrow-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        
        /* Mobile Message Context Menu */
        #mobile-message-menu { z-index: 200; }
        .msg-focused { z-index: 201; position: relative; transform: scale(1.02); transition: transform 0.2s; }
        .backdrop-dim { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }

        /* Story Styles */
        .story-ring { padding: 3px; background: linear-gradient(45deg, #1e293b, #64748b); border-radius: 50%; }
        .story-ring-cf { padding: 3px; background: #475569; border-radius: 50%; }
        .story-ring-seen { padding: 3px; background: #cbd5e1; border-radius: 50%; }
        .story-progress-bar { transition: width 0.1s linear; }

        /* Story Interactions - Revamped Animation */
        .heart-particle {
            position: absolute;
            bottom: 70px;
            right: 20px;
            font-size: 24px;
            opacity: 0;
            pointer-events: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            z-index: 60;
        }

        @keyframes float-wobble-1 {
            0% { transform: translateY(0) translateX(0) scale(0.5); opacity: 0; }
            15% { opacity: 1; transform: translateY(-30px) translateX(-5px) scale(1.2); }
            100% { transform: translateY(-500px) translateX(30px) scale(1); opacity: 0; }
        }

        @keyframes float-wobble-2 {
            0% { transform: translateY(0) translateX(0) scale(0.5); opacity: 0; }
            15% { opacity: 1; transform: translateY(-30px) translateX(5px) scale(1.2); }
            100% { transform: translateY(-450px) translateX(-30px) scale(0.9); opacity: 0; }
        }
        
        @keyframes float-straight {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            15% { opacity: 1; transform: translateY(-30px) scale(1.3); }
            100% { transform: translateY(-600px) scale(1); opacity: 0; }
        }

        /* --- HOVER-EXPAND NAVBAR --- */
        #main-navbar { height: 40px !important; }
        .navbar-collapsed-content { display: none !important; }
        .navbar-full-content { position: relative; }
        /* Logo: centered via left:50% + translateX(-50%), slides to left:16px on hover */
        .navbar-full-content .nav-logo { 
            position: absolute; 
            left: 50%; 
            top: 50%;
            transform: translate(-50%, -50%);
            width: fit-content;
            transition: left 0.45s cubic-bezier(0.4, 0, 0.2, 1), transform 0.45s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2;
        }
        /* Hide search & right menu by default */
        .navbar-full-content .nav-search,
        .navbar-full-content .nav-right { 
            opacity: 0; pointer-events: none; 
            transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1) 0.12s, transform 0.35s cubic-bezier(0.4, 0, 0.2, 1) 0.12s; 
        }
        /* Right menu: pinned to the right */
        .navbar-full-content .nav-right {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%) translateY(-4px);
        }
        #main-navbar:hover .navbar-full-content .nav-right {
            transform: translateY(-50%) translateY(0);
        }
        /* Search bar: ensure it stays centered in the flex layout */
        .navbar-full-content .nav-search {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) translateY(-4px);
        }
        #main-navbar:hover .navbar-full-content .nav-search {
            transform: translate(-50%, -50%) translateY(0);
        }
        /* On hover: logo slides to left, others appear */
        #main-navbar:hover { height: 64px !important; }
        #main-navbar:hover .navbar-full-content .nav-logo { 
            left: 16px; 
            transform: translate(0, -50%);
        }
        #main-navbar:hover .navbar-full-content .nav-search,
        #main-navbar:hover .navbar-full-content .nav-right { 
            opacity: 1; pointer-events: auto;
        }

        /* --- DARK MODE OVERRIDES (PURE BLACK) --- */
        html.dark body { background-color: #000000; background-image: none; color: #e2e8f0; }
        html.dark::selection { background: rgba(99, 102, 241, 0.4); color: #f8fafc; }
        html.dark *::selection { background: rgba(99, 102, 241, 0.4); color: #f8fafc; }

        html.dark .glass { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.06); box-shadow: 0 1px 12px rgba(0, 0, 0, 0.5); }
        html.dark .glass-card { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255, 255, 255, 0.06); box-shadow: 0 4px 16px -2px rgba(0, 0, 0, 0.4); }
        html.dark .glass-card:hover { background: rgba(18, 18, 18, 0.85); box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.5); }

        /* Sidebar & navigation */
        html.dark .sidebar-overlay { background: rgba(0, 0, 0, 0.96); backdrop-filter: blur(24px); box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6); }
        html.dark .sidebar-link { color: #8b9dc3; }
        html.dark .sidebar-link:hover { background-color: rgba(99, 102, 241, 0.08); color: #e0e7ff; }
        html.dark .sidebar-link.active { background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(99, 102, 241, 0.1)); color: #c7d2fe; font-weight: 600; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.12); border: 1px solid rgba(99, 102, 241, 0.12); }
        html.dark .sidebar-trigger-indicator { background: rgba(99, 102, 241, 0.25); }
        html.dark .sidebar-trigger:hover .sidebar-trigger-indicator { background: rgba(99, 102, 241, 0.5); }

        /* Layered surfaces */
        html.dark .bg-white { background-color: #0a0a0a !important; }
        html.dark .bg-white\/95 { background-color: rgba(5, 5, 5, 0.95) !important; }
        html.dark .bg-white\/90 { background-color: rgba(5, 5, 5, 0.9) !important; }
        html.dark .bg-white\/80 { background-color: rgba(5, 5, 5, 0.8) !important; }
        html.dark .bg-white\/60 { background-color: rgba(5, 5, 5, 0.6) !important; }
        html.dark .bg-white\/20 { background-color: rgba(255, 255, 255, 0.05) !important; }
        html.dark .bg-white\/10 { background-color: rgba(255, 255, 255, 0.03) !important; }

        html.dark .bg-slate-50 { background-color: #050505 !important; }
        html.dark .bg-slate-50\/50 { background-color: rgba(5, 5, 5, 0.5) !important; }
        html.dark .bg-slate-50\/30 { background-color: rgba(5, 5, 5, 0.3) !important; }
        html.dark .bg-slate-100 { background-color: #111111 !important; }
        html.dark .bg-slate-200 { background-color: #1a1a1a !important; }
        html.dark .bg-slate-300 { background-color: #2a2a2a !important; }
        html.dark .bg-slate-800 { background-color: #000000 !important; }

        /* Hover states */
        html.dark .hover\:bg-slate-50:hover { background-color: #0a0a0a !important; }
        html.dark .hover\:bg-slate-100:hover { background-color: #111111 !important; }
        html.dark .hover\:bg-slate-200:hover { background-color: #1a1a1a !important; }
        html.dark .hover\:bg-blue-50:hover { background-color: rgba(37, 99, 235, 0.15) !important; }
        html.dark .hover\:bg-green-50:hover { background-color: rgba(34, 197, 94, 0.15) !important; }
        html.dark .hover\:bg-red-50:hover { background-color: rgba(239, 68, 68, 0.15) !important; }

        /* Text with improved contrast */
        html.dark .text-slate-900 { color: #f1f5f9 !important; }
        html.dark .text-slate-800 { color: #e8edf5 !important; }
        html.dark .text-slate-700 { color: #d1d9e6 !important; }
        html.dark .text-slate-600 { color: #a8b8d0 !important; }
        html.dark .text-slate-500 { color: #8b9dc3 !important; }
        html.dark .text-slate-400 { color: #6b7fa3 !important; }
        html.dark .text-gradient { background: linear-gradient(to right, #c7d2fe, #a5b4fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Borders - softer */
        html.dark .border-slate-100 { border-color: rgba(148, 163, 184, 0.08) !important; }
        html.dark .border-slate-200 { border-color: rgba(148, 163, 184, 0.12) !important; }
        html.dark .border-slate-300 { border-color: rgba(148, 163, 184, 0.18) !important; }

        /* Inputs & forms */
        html.dark input, html.dark textarea { background-color: rgba(10, 10, 10, 0.9) !important; color: #e2e8f0; border-color: rgba(255, 255, 255, 0.1) !important; }
        html.dark input:focus, html.dark textarea:focus { border-color: rgba(99, 102, 241, 0.5) !important; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12); }
        html.dark input::placeholder, html.dark textarea::placeholder { color: #5a6d8a; }

        /* Chat bubbles - redesigned contrast */
        html.dark .msg-me { background: linear-gradient(135deg, #2563eb, #4f46e5); color: #f0f4ff; box-shadow: 0 2px 10px rgba(37, 99, 235, 0.25); }
        html.dark .msg-me .msg-time { color: rgba(224, 231, 255, 0.5); }
        html.dark .msg-them { background: rgba(15, 15, 15, 0.9); color: #e2e8f0; border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2); }
        html.dark .typing-indicator { background: rgba(15, 15, 15, 0.9); border-color: rgba(255, 255, 255, 0.08); }
        html.dark .typing-dot { background: #6366f1; }
        html.dark .msg-timestamp-divider::before, html.dark .msg-timestamp-divider::after { background: rgba(255, 255, 255, 0.08); }
        html.dark .msg-timestamp-divider span { color: #555; }
        html.dark .msg-time { color: rgba(150, 150, 150, 0.5); }
        html.dark .msg-me .reply-context { background: rgba(255, 255, 255, 0.12); border-left-color: rgba(255,255,255,0.3); }
        html.dark .msg-them .reply-context { background: rgba(255, 255, 255, 0.05); border-left-color: rgba(99, 102, 241, 0.4); }

        /* Notifications & dropdowns */
        html.dark .notification-dot { border-color: #000; }
        html.dark #notification-dropdown, html.dark #profile-menu, html.dark #search-dropdown { background: rgba(5, 5, 5, 0.97) !important; backdrop-filter: blur(24px); border-color: rgba(255, 255, 255, 0.06) !important; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.04) inset !important; }

        /* Shadows - deep and dramatic */
        html.dark .shadow-xl, html.dark .shadow-2xl { box-shadow: 0 20px 40px -8px rgba(0, 0, 0, 0.5), 0 8px 16px -4px rgba(0, 0, 0, 0.3); }
        html.dark .shadow-sm { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        html.dark .shadow-md { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25); }

        /* Story ring dark */
        html.dark .story-ring { background: linear-gradient(45deg, #6366f1, #818cf8); }

        /* Profile tabs */
        html.dark .profile-tab { color: #6b7fa3; }
        html.dark .profile-tab:hover { color: #a5b4fc; }
        html.dark .profile-tab.active { color: #c7d2fe; }
        html.dark .profile-tab.active::after { background: #6366f1; }

        /* Auth overlay */
        html.dark #auth-overlay { background-color: #000000; }
        html.dark #auth-overlay .bg-white\/80 { background: rgba(10, 10, 10, 0.85) !important; }

        /* Toast */
        html.dark #toast { background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }

        /* Mobile bottom nav */
        html.dark #mobile-bottom-nav .bg-white\/95 { background: rgba(0, 0, 0, 0.95) !important; }
        html.dark #mobile-bottom-nav .border-slate-200 { border-color: rgba(255, 255, 255, 0.06) !important; }

        /* Accent colors pop more */
        html.dark .text-blue-600 { color: #60a5fa !important; }
        html.dark .text-blue-500 { color: #818cf8 !important; }
        html.dark .bg-blue-600 { background-color: #4f46e5 !important; }
        html.dark .text-purple-600 { color: #a78bfa !important; }
        html.dark .text-green-600 { color: #4ade80 !important; }
        html.dark .text-red-500 { color: #f87171 !important; }

        /* Floating chat widget */
        html.dark #floating-chat-widget { background: rgba(5, 5, 5, 0.97) !important; border-color: rgba(255, 255, 255, 0.06) !important; }

        /* Collapsible section headers */
        html.dark .collapsible-header h4 { color: #5a6d8a; }
        html.dark .collapsible-chevron { color: #5a6d8a; }
    </style>
</head>
<body class="text-slate-800 font-sans antialiased overflow-x-hidden selection:bg-blue-100 selection:text-blue-900">

    <div id="app" class="min-h-screen flex flex-col transition-all duration-500">
        <!-- RINGTONE AUDIO (Hidden) -->
        <audio id="call-ringtone" loop>
            <source src="https://assets.mixkit.co/active_storage/sfx/2330/2330-preview.m4a" type="audio/mp4">
            <source src="https://www.soundjay.com/phone/telephone-ring-03a.mp3" type="audio/mpeg">
        </audio>
        <!-- NOTIFICATION SOUND (Dynamic source managed by JS) -->
        <audio id="notification-sound" preload="auto"></audio>

        <!-- Navbar -->
        <nav id="main-navbar" class="glass fixed top-0 w-full z-50 h-16 transition-all duration-300 shadow-sm backdrop-blur-md" style="transition: height 0.35s cubic-bezier(0.4, 0, 0.2, 1);">
            <!-- Full navbar content -->
            <div class="navbar-full-content max-w-[1440px] mx-auto h-full flex items-center justify-between px-4 lg:px-6">
                <!-- Logo -->
                <div class="nav-logo flex items-center gap-2 cursor-pointer w-auto md:w-1/4 btn-bounce" onclick="router('feed')">
                    <img src="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" alt="Lumini Logo" class="w-9 h-9 object-contain hover:rotate-12 transition-transform duration-300">
                    <span class="font-heading font-bold text-2xl tracking-tight text-gradient hidden sm:block">Lumini</span>
                </div>

                <!-- Search Bar -->
                <div class="nav-search hidden md:flex relative items-center justify-center w-1/2">
                    <div class="relative w-full max-w-md group">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors duration-300"></i>
                        <input id="global-search" type="text" placeholder="Search Lumini..." class="w-full bg-slate-100 border-2 border-transparent focus:bg-white focus:border-blue-200 focus:ring-4 focus:ring-blue-500/10 rounded-full pl-10 pr-4 py-2.5 text-sm outline-none transition-all duration-300 text-slate-700" autocomplete="off" oninput="handleSearch(this.value)" onfocus="handleSearch(this.value)" onblur="setTimeout(()=>document.getElementById('search-dropdown').classList.add('hidden'), 200)">
                        <div id="search-dropdown" class="absolute top-14 left-0 w-full bg-white rounded-xl shadow-xl border border-slate-100 hidden overflow-hidden z-50 animate-pop-in origin-top"></div>
                    </div>
                </div>

                <!-- Right Menu -->
                <div class="nav-right flex items-center justify-end w-auto md:w-1/4 gap-2 sm:gap-4">
                    <button onclick="router('messaging')" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-all duration-300 text-slate-600 relative btn-bounce">
                        <i class="fa-brands fa-facebook-messenger text-xl"></i>
                        <div id="chat-badge" class="notification-dot"></div>
                    </button>
                    
                    <div class="relative">
                        <button onclick="toggleNotificationDropdown()" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-all duration-300 text-slate-600 relative btn-bounce">
                            <i class="fa-solid fa-bell text-xl"></i>
                            <div id="notification-badge" class="notification-dot"></div>
                        </button>
                        <div id="notification-dropdown" class="hidden absolute right-0 top-14 w-80 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-100 py-2 animate-pop-in origin-top-right z-50 max-h-96 overflow-y-auto custom-scrollbar">
                            <div class="px-4 py-2 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <h3 class="font-bold text-sm text-slate-800">Notifications</h3>
                                <button onclick="openClearNotifsModal()" class="text-xs text-red-500 hover:text-red-600 font-bold transition-colors btn-bounce">Clear All</button>
                            </div>
                            <div id="notification-list" class="p-2">
                                <p class="text-center text-xs text-slate-400 py-4">No new notifications.</p>
                            </div>
                        </div>
                    </div>

                    <div onclick="toggleProfileMenu()" class="ml-2 relative cursor-pointer btn-bounce group">
                        <img id="nav-avatar" src="https://placehold.co/100x100?text=User" class="w-9 h-9 rounded-full ring-2 ring-white shadow-md object-cover group-hover:ring-blue-400 transition-all duration-300">
                        <div id="profile-menu" class="hidden absolute right-0 top-14 w-60 bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-100 py-2 animate-pop-in origin-top-right z-50">
                            <div class="px-4 py-3 border-b border-slate-100 mb-2 flex items-center gap-3 hover:bg-slate-50 transition-colors cursor-pointer" onclick="viewMyProfile()">
                                <img id="menu-avatar-small" src="" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                                <div><p id="menu-name" class="font-bold text-sm text-slate-800">Guest</p><p class="text-xs text-slate-500">See your profile</p></div>
                            </div>
                            <a href="#" onclick="openCloseFriendsModal()" class="flex items-center gap-3 px-4 py-3 text-sm text-slate-600 hover:bg-slate-50 hover:text-green-600 transition-colors"><i class="fa-solid fa-star text-slate-400 w-5"></i> Close Friends</a>
                            <a href="#" onclick="openSettingsModal()" class="flex items-center gap-3 px-4 py-3 text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600 transition-colors"><i class="fa-solid fa-gear text-slate-400 w-5"></i> Settings & Privacy</a>
                            <a href="#" onclick="handleSignOut()" class="flex items-center gap-3 px-4 py-3 text-sm text-red-500 hover:bg-red-50 transition-colors rounded-b-xl"><i class="fa-solid fa-right-from-bracket w-5"></i> Log Out</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsed navbar content (just centered logo) -->
            <div class="navbar-collapsed-content">
                <img src="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" alt="Lumini" class="w-7 h-7 object-contain cursor-pointer hover:rotate-12 transition-transform duration-300" onclick="router('feed')">
            </div>
        </nav>
        
        <!-- Bottom Mobile Nav (new) -->
        <div id="mobile-bottom-nav" class="fixed bottom-0 left-0 right-0 z-50 md:hidden pb-safe">
            <div class="mx-auto max-w-[1440px]">
                <div class="mx-3 mb-3 rounded-2xl shadow-2xl border border-slate-200 bg-white/95 backdrop-blur-xl">
                    <div class="grid grid-cols-4 text-xs font-semibold text-slate-500">
                        <button onclick="router('feed'); highlightMobileTab('feed')" class="flex flex-col items-center justify-center py-3 gap-1">
                            <i class="fa-solid fa-house"></i>
                            <span>Home</span>
                        </button>
                        <button onclick="viewMyProfile(); highlightMobileTab('profile')" class="flex flex-col items-center justify-center py-3 gap-1">
                            <i class="fa-solid fa-user"></i>
                            <span>Profile</span>
                        </button>
                        <button onclick="router('collaborate'); highlightMobileTab('collaborate')" class="flex flex-col items-center justify-center py-3 gap-1">
                            <i class="fa-solid fa-rocket"></i>
                            <span>Projects</span>
                        </button>
                        <button onclick="router('network'); highlightMobileTab('network')" class="flex flex-col items-center justify-center py-3 gap-1">
                            <i class="fa-solid fa-user-group"></i>
                            <span>Network</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            // === HOVER-EXPAND NAVBAR LOGIC ===
            // Default state is collapsed (40px), navbar auto-expands on hover via CSS.
            // Adjust sidebar/main positions for hover state dynamically.
            (function() {
                const nav = document.getElementById('main-navbar');
                const updatePositions = (expanded) => {
                    const top = expanded ? '64px' : '40px';
                    document.querySelectorAll('.sidebar-overlay, .sidebar-trigger').forEach(el => {
                        el.style.top = top;
                    });
                };
                nav.addEventListener('mouseenter', () => updatePositions(true));
                nav.addEventListener('mouseleave', () => updatePositions(false));
                // Set initial positions for collapsed state
                updatePositions(false);
                const main = document.querySelector('main');
                if (main) main.style.paddingTop = '56px';
            })();

            // Slide-out sidebar panels
            const _panelTimers = {};
            function openSidebarPanel(side) {
                clearTimeout(_panelTimers[side + '_close']);
                _panelTimers[side + '_open'] = setTimeout(function() {
                    const panel = document.getElementById(side === 'left' ? 'left-sidebar-panel' : 'right-sidebar-panel');
                    if (panel) panel.classList.add('open');
                }, 80);
            }
            function closeSidebarPanel(side) {
                clearTimeout(_panelTimers[side + '_open']);
                _panelTimers[side + '_close'] = setTimeout(function() {
                    const panel = document.getElementById(side === 'left' ? 'left-sidebar-panel' : 'right-sidebar-panel');
                    if (panel) panel.classList.remove('open');
                }, 250);
            }

            // Hover-to-expand collapsible sections
            const _hoverTimers = {};
            function expandSection(sectionId) {
                clearTimeout(_hoverTimers[sectionId + '_close']);
                _hoverTimers[sectionId + '_open'] = setTimeout(function() {
                    const body = document.getElementById(sectionId);
                    const chevron = document.getElementById(sectionId + '-chevron');
                    if (body) body.classList.remove('collapsed');
                    if (chevron) chevron.classList.remove('collapsed');
                }, 120);
            }
            function collapseSection(sectionId) {
                clearTimeout(_hoverTimers[sectionId + '_open']);
                _hoverTimers[sectionId + '_close'] = setTimeout(function() {
                    const body = document.getElementById(sectionId);
                    const chevron = document.getElementById(sectionId + '-chevron');
                    if (body) body.classList.add('collapsed');
                    if (chevron) chevron.classList.add('collapsed');
                }, 300);
            }
            // Also keep click toggle for accessibility
            function toggleCollapsible(sectionId) {
                const body = document.getElementById(sectionId);
                const chevron = document.getElementById(sectionId + '-chevron');
                if (!body || !chevron) return;
                body.classList.toggle('collapsed');
                chevron.classList.toggle('collapsed');
            }
            // Start feed sections collapsed
            document.addEventListener('DOMContentLoaded', function() {
                ['stories-section','composer-section','highlights-section'].forEach(function(id) {
                    var body = document.getElementById(id);
                    var chevron = document.getElementById(id + '-chevron');
                    if (body) body.classList.add('collapsed');
                    if (chevron) chevron.classList.add('collapsed');
                });
            });

            // Keep active state in bottom nav in sync with router
            function highlightMobileTab(tab){
                try{
                    const labels = { feed:'Home', profile:'Profile', collaborate:'Projects', network:'Network', messaging:'Messages' };
                    // No heavy DOM operations; visually we rely on color change
                    const root = document.getElementById('mobile-bottom-nav');
                    if(!root) return;
                    root.querySelectorAll('button').forEach(btn=>{
                        btn.classList.remove('text-blue-600');
                        btn.classList.add('text-slate-500');
                    });
                    const map = {
                        feed: 0,
                        profile: 1,
                        collaborate: 2,
                        network: 3,
                        messaging: 4
                    };
                    const idx = map[tab];
                    const target = root.querySelectorAll('button')[idx];
                    if(target){
                        target.classList.remove('text-slate-500');
                        target.classList.add('text-blue-600');
                    }
                }catch(e){ /* silent */ }
            }

            // Optional: expose a small hook to update badge
            function setMobileChatBadge(visible){
                const el = document.getElementById('mobile-chat-badge');
                if(!el) return;
                el.style.display = visible ? 'block' : 'none';
            }
        </script>

        <!-- Auth Overlay -->
        <div id="auth-overlay" class="fixed inset-0 bg-slate-50 z-[60] flex items-center justify-center p-4 md:p-8 transition-all duration-700 ease-in-out overflow-hidden">
            <div class="shape-blob blob-1 rounded-full"></div>
            <div class="shape-blob blob-2 rounded-full"></div>
            <div class="relative w-full max-w-5xl h-full md:h-[650px] bg-white/80 backdrop-blur-2xl rounded-3xl shadow-2xl border border-white/60 overflow-hidden flex flex-col md:flex-row animate-pop-in">
                <div class="w-full md:w-1/2 bg-gradient-to-br from-blue-600 to-purple-700 p-8 md:p-12 flex flex-col justify-between relative overflow-hidden text-white group">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-8"><img src="https://i.ibb.co/XZVSKkBT/Screenshot-2025-11-10-174930-Photoroom.png" class="w-12 h-12 object-contain drop-shadow-lg group-hover:rotate-12 transition-transform duration-500"><span class="font-heading font-bold text-2xl tracking-tight">Lumini</span></div>
                        <h1 class="font-heading text-4xl md:text-5xl font-bold leading-tight mb-6 animate-slide-up" style="animation-delay: 0.1s;">Connect. <br> Collaborate. <br> Create.</h1>
                        <p class="text-blue-100 text-lg font-light mb-8 animate-slide-up" style="animation-delay: 0.2s;">Join the community where developers and creators build the future together.</p>
                    </div>
                </div>
                <div class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center bg-white/60">
                    <div class="max-w-sm mx-auto w-full animate-slide-up" style="animation-delay: 0.3s;">
                        <h2 class="font-heading text-2xl font-bold text-slate-900 mb-2">Get Started</h2>
                        <p class="text-slate-500 mb-8 text-sm">Create an account or sign in.</p>
                        <div class="space-y-4">
                            <button onclick="handleGoogleAuth()" class="w-full bg-white border border-slate-200 hover:bg-slate-50 hover:border-slate-300 text-slate-700 font-semibold py-3 rounded-xl flex items-center justify-center gap-3 transition-all duration-300 shadow-sm hover:shadow-md btn-bounce"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Continue with Google</button>
                            <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200"></div><span class="flex-shrink mx-4 text-slate-400 text-xs font-semibold uppercase">Or with email</span><div class="flex-grow border-t border-slate-200"></div></div>
                            <input id="auth-email" type="email" placeholder="Email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-300">
                            <input id="auth-password" type="password" placeholder="Password" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-300">
                            <button onclick="handleEmailAuth()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition-all duration-300 hover:shadow-blue-500/50 btn-bounce">Sign In / Sign Up</button>
                        </div>
                        <p id="auth-error" class="text-red-500 text-xs mt-4 text-center hidden animate-bounce-short"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <main class="flex-grow pt-20 pb-6 px-4">
            <div class="max-w-[1440px] mx-auto grid grid-cols-1 md:grid-cols-12 gap-8">
                
                <!-- Left Sidebar Hover Trigger -->
                <div class="sidebar-trigger left-trigger hidden md:block" onmouseenter="openSidebarPanel('left')" id="left-trigger">
                    <div class="sidebar-trigger-indicator"></div>
                </div>

                <!-- Left Sidebar (Slide-out Overlay) -->
                <aside id="left-sidebar-panel" class="sidebar-overlay left-panel hidden md:block custom-scrollbar space-y-1" onmouseenter="openSidebarPanel('left')" onmouseleave="closeSidebarPanel('left')">
                    <div onclick="viewMyProfile()" class="sidebar-link mb-3 hover:bg-slate-200 rounded-xl transition-colors group">
                        <img id="sidebar-mini-avatar" src="" class="w-8 h-8 rounded-full object-cover bg-slate-300 ring-2 ring-transparent group-hover:ring-blue-400 transition-all">
                        <span id="sidebar-mini-name" class="font-bold text-slate-800 text-sm">Guest</span>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="glass-card rounded-xl bg-white/90 overflow-hidden mb-2">
                        <div class="px-3 py-2">
                            <div onclick="router('feed')" class="sidebar-link active" id="nav-link-feed"><i class="fa-solid fa-house text-slate-500"></i> <span>Home</span></div>
                            <div onclick="viewMyProfile()" class="sidebar-link" id="nav-link-profile"><i class="fa-solid fa-user text-slate-500"></i> <span>Profile</span></div>
                            <div onclick="router('network')" class="sidebar-link" id="nav-link-network"><i class="fa-solid fa-user-group text-slate-500"></i> <span>Network</span></div>
                            <div onclick="router('collaborate')" class="sidebar-link" id="nav-link-collaborate"><i class="fa-solid fa-rocket text-slate-500"></i> <span>Collaborate</span></div>
                            <div onclick="router('messaging')" class="sidebar-link" id="nav-link-messaging"><i class="fa-solid fa-comment-dots text-slate-500"></i> <span>Messages</span></div>
                            <div onclick="router('saved')" class="sidebar-link" id="nav-link-saved"><i class="fa-solid fa-bookmark text-slate-500"></i> <span>Saved</span></div>
                        </div>
                    </div>
                    
                    <!-- Quick Links -->
                    <div class="glass-card rounded-xl bg-white/90 overflow-hidden">
                        <div class="px-3 py-2">
                            <div onclick="openCloseFriendsModal()" class="sidebar-link"><i class="fa-solid fa-star text-slate-500"></i> <span>Close Friends</span></div>
                            <div onclick="openSettingsModal()" class="sidebar-link"><i class="fa-solid fa-gear text-slate-500"></i> <span>Settings</span></div>
                        </div>
                    </div>
                    
                    <div class="mt-6 px-4 text-[10px] text-slate-400 leading-relaxed opacity-50 hover:opacity-100 transition-opacity">Lumini  2025  Privacy  Terms  Cookies  More</div>
                </aside>

                <!-- Center Content -->
                <section id="main-container" class="col-span-12 max-w-3xl mx-auto w-full animate-slide-up" style="animation-delay: 0.2s;" data-default-class="col-span-12 max-w-3xl mx-auto w-full animate-slide-up">
                    
                    <!-- View: Feed -->
                    <div id="view-feed" class="view-section space-y-4">
                        <!-- Stories Bar (Collapsible) -->
                        <div class="glass-card rounded-2xl bg-white/90 overflow-hidden collapsible-section" onmouseenter="expandSection('stories-section')" onmouseleave="collapseSection('stories-section')">
                            <div class="collapsible-header" onclick="toggleCollapsible('stories-section')">
                                <h4><i class="fa-solid fa-circle-play mr-2"></i>Stories</h4>
                                <i id="stories-section-chevron" class="fa-solid fa-chevron-down collapsible-chevron"></i>
                            </div>
                            <div id="stories-section" class="collapsible-body px-4 pb-4">
                                <div class="overflow-x-auto custom-scrollbar flex gap-4" id="stories-bar">
                                    <div class="flex flex-col items-center gap-2 cursor-pointer min-w-[70px]" onclick="openStoryUploadModal()">
                                        <div class="relative w-14 h-14 group">
                                             <img id="story-my-avatar" src="" class="w-full h-full rounded-full border-2 border-white object-cover group-hover:opacity-80 transition-opacity">
                                             <div class="absolute bottom-0 right-0 bg-slate-800 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] border-2 border-white"><i class="fa-solid fa-plus"></i></div>
                                        </div>
                                        <span class="text-[10px] font-medium text-slate-500 truncate w-14 text-center">Add Story</span>
                                    </div>
                                    <div id="stories-list" class="flex gap-4"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Composer (Collapsible) -->
                        <div class="glass-card rounded-2xl bg-white/90 overflow-hidden collapsible-section" onmouseenter="expandSection('composer-section')" onmouseleave="collapseSection('composer-section')">
                            <div class="collapsible-header" onclick="toggleCollapsible('composer-section')">
                                <h4><i class="fa-solid fa-pen-to-square mr-2"></i>Create Post</h4>
                                <i id="composer-section-chevron" class="fa-solid fa-chevron-down collapsible-chevron"></i>
                            </div>
                            <div id="composer-section" class="collapsible-body px-4 pb-4">
                                <div class="flex gap-3 mb-3">
                                    <img id="composer-avatar" src="https://placehold.co/100x100?text=User" class="w-10 h-10 rounded-full bg-slate-100 object-cover ring-2 ring-white">
                                    <div onclick="openPostModal()" class="flex-grow bg-slate-50 hover:bg-slate-100 rounded-full px-4 py-2.5 cursor-pointer transition-colors text-slate-400 text-sm flex items-center">What's on your mind, <span id="composer-name-placeholder" class="ml-1">User</span>?</div>
                                </div>
                                <div class="flex items-center gap-2 pt-2 border-t border-slate-100/60">
                                    <button onclick="openPostModal('image')" class="px-3 py-1.5 text-slate-400 hover:bg-slate-100 hover:text-slate-700 rounded-lg transition-all text-xs font-medium flex items-center gap-1.5 btn-bounce"><i class="fa-solid fa-image text-slate-400"></i> Photo</button>
                                    <button onclick="openPostModal()" class="px-3 py-1.5 text-slate-400 hover:bg-slate-100 hover:text-slate-700 rounded-lg transition-all text-xs font-medium flex items-center gap-1.5 btn-bounce"><i class="fa-solid fa-video text-red-400"></i> Video</button>
                                    <button onclick="openPostModal('project')" class="px-3 py-1.5 text-slate-400 hover:bg-slate-100 hover:text-slate-700 rounded-lg transition-all text-xs font-medium flex items-center gap-1.5 btn-bounce"><i class="fa-solid fa-rocket text-slate-400"></i> Project</button>
                                </div>
                            </div>
                        </div>

                        <!-- Feed Stream -->
                        <div id="feed-stream" class="space-y-4 pb-20"><div class="text-center py-12"><i class="fa-solid fa-circle-notch fa-spin text-slate-400 text-xl"></i></div></div>
                    </div>

                    <!-- View: Saved -->
                    <div id="view-saved" class="view-section hidden space-y-6">
                        <div class="glass-card page-hero bg-white/90">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white text-xl shadow-lg shadow-purple-200">
                                            <i class="fa-solid fa-bookmark"></i>
                                        </div>
                                        <h2 class="font-heading font-bold text-3xl text-slate-800">Saved Posts</h2>
                                    </div>
                                    <p class="text-slate-500 text-sm mt-2 ml-1">Your personal collection  only you can see these.</p>
                                </div>
                                <div class="text-right">
                                    <div id="saved-count" class="text-3xl font-heading font-bold text-slate-300">0</div>
                                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Saved</div>
                                </div>
                            </div>
                        </div>
                        <!-- Collection Tabs -->
                        <div class="flex items-center gap-2 overflow-x-auto custom-scrollbar pb-1">
                            <div id="collection-tabs-container" class="flex items-center gap-2">
                                <button onclick="switchCollection('all')" class="collection-tab active-collection" data-collection="all">
                                    <i class="fa-solid fa-layer-group mr-1.5 text-xs"></i> All
                                </button>
                            </div>
                            <button onclick="openCreateCollectionModal()" class="collection-tab flex items-center gap-1.5" style="border-style: dashed; border-color: #cbd5e1;">
                                <i class="fa-solid fa-plus text-xs"></i> New
                            </button>
                        </div>
                        <div id="saved-posts-stream" class="space-y-5 pb-20"></div>
                    </div>

                    <!-- View: Network -->
                    <div id="view-network" class="view-section hidden space-y-6">
                        <div class="glass-card page-hero bg-white/90">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center text-white text-xl shadow-lg shadow-blue-200">
                                            <i class="fa-solid fa-user-group"></i>
                                        </div>
                                        <h2 class="font-heading font-bold text-3xl text-slate-800">Grow your Network</h2>
                                    </div>
                                    <p class="text-slate-500 text-sm mt-2 ml-1">Find collaborators and connect with people who share your interests.</p>
                                </div>
                                <div class="text-right">
                                    <div id="network-count" class="text-3xl font-heading font-bold text-slate-300">0</div>
                                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">People</div>
                                </div>
                            </div>
                        </div>
                        <div id="network-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-5"></div>
                    </div>

                    <!-- View: Collaborate -->
                    <div id="view-collaborate" class="view-section hidden space-y-6">
                        <div class="glass-card page-hero bg-white/90">
                             <div class="flex justify-between items-start mb-5 flex-wrap gap-4">
                                <div>
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-orange-500 to-pink-500 flex items-center justify-center text-white text-xl shadow-lg shadow-orange-200">
                                            <i class="fa-solid fa-rocket"></i>
                                        </div>
                                        <h2 class="font-heading font-bold text-3xl text-slate-800">Project Board</h2>
                                    </div>
                                    <p class="text-slate-500 text-sm mt-2 ml-1">Find collaborators or showcase your work to the community.</p>
                                </div>
                                <button onclick="openPostModal('project')" class="bg-gradient-to-r from-slate-900 to-slate-700 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg shadow-slate-300 hover:shadow-xl hover:shadow-slate-400 hover:scale-105 transition-all duration-300 btn-bounce flex items-center gap-2 group">
                                    <i class="fa-solid fa-plus group-hover:rotate-90 transition-transform duration-300"></i> Post Project
                                </button>
                            </div>
                            <div class="flex gap-2.5 overflow-x-auto custom-scrollbar pb-1" id="collab-filters">
                                <button onclick="filterCollaborate('all')" id="filter-all" class="collab-filter-pill active-filter px-5 py-2 rounded-full text-sm font-bold border border-slate-200 bg-slate-900 text-white transition-all duration-200 whitespace-nowrap hover:shadow-md btn-bounce">All</button>
                                <button onclick="filterCollaborate('designer')" id="filter-designer" class="collab-filter-pill px-5 py-2 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap hover:shadow-md btn-bounce"> Designers</button>
                                <button onclick="filterCollaborate('developer')" id="filter-developer" class="collab-filter-pill px-5 py-2 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap hover:shadow-md btn-bounce"> Developers</button>
                                <button onclick="filterCollaborate('manager')" id="filter-manager" class="collab-filter-pill px-5 py-2 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap hover:shadow-md btn-bounce"> Managers</button>
                                <button onclick="filterCollaborate('marketing')" id="filter-marketing" class="collab-filter-pill px-5 py-2 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap hover:shadow-md btn-bounce"> Marketing</button>
                            </div>
                        </div>
                        <div id="collaborate-stream" class="space-y-5 pb-20"></div>
                    </div>

                    <!-- View: Profile -->
                    <div id="view-profile" class="view-section hidden space-y-8 max-w-5xl mx-auto w-full">
                        <!-- Hero Banner - Full width, taller, unique style -->
                        <div class="glass-card rounded-3xl overflow-hidden bg-white/90 shadow-lg">
                            <div id="profile-cover-container" class="h-72 relative overflow-hidden profile-cover" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 40%, #334155 70%, #475569 100%);">
                                <img id="profile-cover-img" class="hidden absolute inset-0 w-full h-full object-cover">
                                <div id="profile-cover-overlay" class="absolute inset-0" style="background: radial-gradient(circle at 70% 30%, rgba(99,102,241,0.3), transparent 60%), radial-gradient(circle at 20% 80%, rgba(37,99,235,0.2), transparent 50%);"></div>
                                <!-- Decorative grid pattern -->
                                <div id="profile-cover-grid" class="absolute inset-0 opacity-[0.04]" style="background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 40px 40px;"></div>
                                <button onclick="router('feed')" class="absolute top-5 left-5 bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 rounded-xl backdrop-blur-md transition-all text-sm font-bold btn-bounce border border-white/10 z-10"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button>
                                <!-- Cover photo upload button (own profile only) -->
                                <button id="cover-upload-btn" onclick="document.getElementById('cover-photo-input').click()" class="hidden absolute top-5 right-5 bg-white/10 hover:bg-white/20 text-white px-4 py-2.5 rounded-xl backdrop-blur-md transition-all text-sm font-bold btn-bounce border border-white/10 z-10"><i class="fa-solid fa-camera mr-1.5"></i> Cover Photo</button>
                                <input type="file" id="cover-photo-input" class="hidden" accept="image/*" onchange="handleCoverPhotoChange(this)">
                                <!-- Floating badge -->
                                <div class="absolute bottom-6 right-6 bg-white/10 backdrop-blur-md border border-white/10 rounded-xl px-4 py-2 text-white/70 text-xs font-medium z-10">
                                    <i class="fa-solid fa-sparkles mr-1.5"></i> Member since <span id="profile-join-date">...</span>
                                </div>
                            </div>
                            
                            <div class="px-8 md:px-12 pb-8 relative">
                                <!-- Avatar + Name Row -->
                                <div class="flex flex-col md:flex-row items-center md:items-end -mt-16 mb-4 gap-6">
                                    <div class="relative group">
                                        <div class="w-36 h-36 rounded-2xl border-4 border-white shadow-2xl bg-white overflow-hidden relative z-10 transition-transform duration-500 group-hover:scale-105 group-hover:rotate-1">
                                            <img id="profile-page-avatar" src="" class="w-full h-full object-cover">
                                        </div>
                                        <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-400 rounded-full border-[3px] border-white z-20"></div>
                                    </div>
                                    
                                    <div class="flex-1 text-center md:text-left pb-1 min-w-0 w-full">
                                        <div class="flex items-start gap-2 flex-wrap justify-center md:justify-start">
                                            <h2 id="profile-page-name" class="font-heading font-extrabold text-2xl md:text-4xl text-slate-900 tracking-tight break-words leading-tight" style="word-break: break-word; overflow-wrap: anywhere;">User Name</h2>
                                            <span id="profile-verified-badge" class="verified-badge hidden mt-1" title="Verified"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#2563eb"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                                        </div>
                                        <p id="profile-page-headline" class="text-slate-500 font-medium text-base mt-1.5 break-words" style="word-break: break-word; overflow-wrap: anywhere;">Headline</p>
                                    </div>
                                </div>

                                <div class="flex flex-wrap items-center justify-center md:justify-start gap-2.5 mb-6 w-full">
                                    <button id="edit-profile-btn" onclick="openEditProfileModal()" class="bg-slate-900 text-white px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-slate-800 transition-all hidden items-center gap-2 btn-bounce shadow-md hover:shadow-lg whitespace-nowrap">
                                        <i class="fa-solid fa-pen-to-square"></i> Edit
                                    </button>
                                     <button id="follow-btn" onclick="toggleFollow(window.currentViewedUid)" class="bg-blue-600 text-white px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-blue-700 transition-all shadow-lg hover:shadow-xl items-center gap-2 hidden btn-bounce hover:-translate-y-0.5 whitespace-nowrap">
                                        <i class="fa-solid fa-user-plus"></i> <span>Follow</span>
                                    </button>
                                    <button id="profile-chat-btn" class="bg-slate-100 text-slate-700 px-4 md:px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-slate-200 transition-all items-center gap-2 hidden btn-bounce whitespace-nowrap">
                                        <i class="fa-solid fa-paper-plane"></i> Message
                                    </button>
                                    <!-- Admin verify button -->
                                    <button id="verify-user-btn" onclick="toggleVerify(window.currentViewedUid)" class="hidden bg-blue-100 text-blue-600 px-4 py-2.5 rounded-xl font-bold text-xs hover:bg-blue-200 transition-all items-center gap-1.5 btn-bounce whitespace-nowrap">
                                        <i class="fa-solid fa-circle-check"></i> <span>Verify</span>
                                    </button>
                                    <div id="admin-controls-container" class="flex-shrink-0"></div>
                                </div>

                                <!-- Stats Bar -->
                                <div class="flex flex-wrap gap-3 mb-6 justify-center md:justify-start">
                                    <div class="stat-hover cursor-pointer rounded-2xl px-6 py-4 bg-gradient-to-br from-slate-50 to-slate-100/80 hover:from-blue-50 hover:to-indigo-50 transition-all border border-slate-100 hover:border-blue-200 group" onclick="openFollowModal('followers')">
                                        <div class="text-2xl font-extrabold text-slate-900 group-hover:text-blue-600 transition-colors" id="profile-followers-count">0</div>
                                        <div class="text-xs text-slate-500 font-semibold uppercase tracking-wider mt-0.5">Followers</div>
                                    </div>
                                    <div class="stat-hover cursor-pointer rounded-2xl px-6 py-4 bg-gradient-to-br from-slate-50 to-slate-100/80 hover:from-blue-50 hover:to-indigo-50 transition-all border border-slate-100 hover:border-blue-200 group" onclick="openFollowModal('following')">
                                        <div class="text-2xl font-extrabold text-slate-900 group-hover:text-blue-600 transition-colors" id="profile-following-count">0</div>
                                        <div class="text-xs text-slate-500 font-semibold uppercase tracking-wider mt-0.5">Following</div>
                                    </div>
                                    <div class="stat-hover rounded-2xl px-6 py-4 bg-gradient-to-br from-slate-50 to-slate-100/80 border border-slate-100 group">
                                        <div class="text-2xl font-extrabold text-slate-900" id="profile-posts-count">0</div>
                                        <div class="text-xs text-slate-500 font-semibold uppercase tracking-wider mt-0.5">Posts</div>
                                    </div>
                                </div>
                                
                                <!-- Tabs - pill style -->
                                <div class="flex gap-2 bg-slate-100 rounded-xl p-1.5 w-fit">
                                    <div onclick="switchProfileTab('posts')" id="tab-posts" class="profile-tab active cursor-pointer px-5 py-2.5 rounded-lg text-sm font-bold transition-all">
                                        <i class="fa-solid fa-grid-2 mr-1.5 text-xs"></i> Posts
                                    </div>
                                    <div onclick="switchProfileTab('about')" id="tab-about" class="profile-tab cursor-pointer px-5 py-2.5 rounded-lg text-sm font-bold transition-all">
                                        <i class="fa-solid fa-user mr-1.5 text-xs"></i> About
                                    </div>
                                    <div onclick="switchProfileTab('saved')" id="tab-saved" class="profile-tab hidden cursor-pointer px-5 py-2.5 rounded-lg text-sm font-bold transition-all">
                                        <i class="fa-solid fa-bookmark mr-1.5 text-xs"></i> Saved
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Content area - full width -->
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                            <div class="lg:col-span-1 space-y-5 animate-slide-up" style="animation-delay: 0.1s;">
                                <div class="glass-card rounded-2xl p-6 bg-white/90">
                                    <h3 class="font-bold text-slate-800 mb-4 text-base flex items-center gap-2"><i class="fa-solid fa-circle-info text-blue-500"></i> About</h3>
                                    <p id="profile-page-bio" class="text-sm text-slate-600 mb-4 leading-relaxed whitespace-pre-line"></p>
                                </div>
                                <!-- Quick Links card -->
                                <div class="glass-card rounded-2xl p-6 bg-white/90">
                                    <h3 class="font-bold text-slate-800 mb-4 text-base flex items-center gap-2"><i class="fa-solid fa-link text-indigo-500"></i> Quick Links</h3>
                                    <div id="profile-quick-links" class="space-y-2.5">
                                        <p class="text-xs text-slate-400 italic">No links added yet.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lg:col-span-3 animate-slide-up" style="animation-delay: 0.2s;">
                                <div id="profile-content-posts" class="space-y-6"></div>
                                <div id="profile-content-about" class="hidden glass-card rounded-2xl p-8 bg-white/90">
                                    <h3 class="font-bold text-2xl mb-5 flex items-center gap-3"><i class="fa-solid fa-address-card text-blue-500"></i> Full Bio</h3>
                                    <p id="profile-full-bio" class="text-slate-700 leading-relaxed whitespace-pre-line text-base"></p>
                                </div>
                                <div id="profile-content-saved" class="hidden space-y-6"></div>
                            </div>
                        </div>
                    </div>

                    <!-- View: Messaging -->
                    <div id="view-messaging" class="view-section hidden h-[calc(100vh-90px)] rounded-2xl flex overflow-hidden border border-slate-200/80 bg-white" style="margin: 0 auto;">
                        
                        <div id="msg-list-col" class="w-full md:w-[340px] md:min-w-[340px] border-r border-slate-100 bg-white flex flex-col">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-heading font-bold text-slate-900 text-xl tracking-tight">Messages</h3>
                            </div>
                            <div id="chat-list" class="flex-1 overflow-y-auto p-3 space-y-0.5 custom-scrollbar"></div>
                        </div>
                        
                        <div id="msg-chat-col" class="hidden md:flex w-full flex-col bg-white relative">
                            <div id="chat-header" class="h-[68px] border-b border-slate-100 flex items-center px-6 justify-between bg-white">
                                <div class="flex items-center gap-3">
                                    <button onclick="backToChatList()" class="md:hidden text-slate-500 hover:bg-slate-100 w-8 h-8 rounded-full flex items-center justify-center transition-all duration-200 btn-bounce"><i class="fa-solid fa-arrow-left"></i></button>
                                    <div>
                                        <span class="font-semibold text-slate-800" id="chat-header-name">Select a conversation</span>
                                        <p id="chat-header-status" class="text-[10px] text-slate-400 hidden"></p>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button id="start-audio-call-btn" onclick="initiateCall('audio')" class="hidden text-slate-400 hover:text-slate-700 w-10 h-10 rounded-full hover:bg-slate-50 flex items-center justify-center transition-all duration-200 btn-bounce" title="Audio Call">
                                        <i class="fa-solid fa-phone"></i>
                                    </button>
                                    <button id="start-video-call-btn" onclick="initiateCall('video')" class="hidden text-slate-400 hover:text-slate-700 w-10 h-10 rounded-full hover:bg-slate-50 flex items-center justify-center transition-all duration-200 btn-bounce" title="Video Call">
                                        <i class="fa-solid fa-video"></i>
                                    </button>
                                    <button id="delete-chat-btn" onclick="deleteChat()" class="hidden text-slate-400 hover:text-red-500 w-10 h-10 rounded-full hover:bg-slate-50 flex items-center justify-center transition-all duration-200 btn-bounce" title="Delete">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="chat-messages" class="flex-1 overflow-y-auto px-8 py-6 space-y-3 bg-slate-50/50 custom-scrollbar flex flex-col relative">
                                <div class="flex h-full items-center justify-center text-slate-300 flex-col gap-3">
                                    <i class="fa-regular fa-comment-dots text-5xl mb-2 animate-float"></i>
                                    <p class="text-sm font-medium text-slate-400">Select a conversation to start chatting</p>
                                </div>
                            </div>
                            
                            <!-- Mobile Context Menu Overlay -->
                            <div id="mobile-message-menu" class="hidden fixed inset-0 backdrop-dim flex items-center justify-center z-[200]">
                                <div id="mobile-menu-content" class="bg-white rounded-2xl shadow-2xl p-4 w-64 animate-pop-in flex flex-col gap-2">
                                    <button id="mm-reply" class="w-full text-left p-3 hover:bg-slate-50 rounded-xl font-medium text-slate-700 flex items-center gap-3 transition-colors duration-200"><i class="fa-solid fa-reply text-slate-400"></i> Reply</button>
                                    <button id="mm-copy" class="w-full text-left p-3 hover:bg-slate-50 rounded-xl font-medium text-slate-700 flex items-center gap-3 transition-colors duration-200"><i class="fa-regular fa-copy text-slate-400"></i> Copy</button>
                                    <button id="mm-edit" class="w-full text-left p-3 hover:bg-slate-50 rounded-xl font-medium text-slate-700 flex items-center gap-3 hidden transition-colors duration-200"><i class="fa-solid fa-pen text-slate-400"></i> Edit</button>
                                    <button id="mm-unsend" class="w-full text-left p-3 hover:bg-red-50 text-red-500 rounded-xl font-medium flex items-center gap-3 hidden transition-colors duration-200"><i class="fa-solid fa-trash"></i> Unsend</button>
                                    <button onclick="document.getElementById('mobile-message-menu').classList.add('hidden'); document.querySelectorAll('.msg-focused').forEach(el=>el.classList.remove('msg-focused'))" class="w-full text-center p-2 text-slate-400 text-sm font-medium mt-1">Cancel</button>
                                </div>
                            </div>

                            <div class="p-3 border-t border-slate-100 bg-white relative z-30">
                                <!-- Chat Attachment Preview -->
                                <div id="chat-attach-preview" class="chat-attach-preview hidden">
                                    <div id="chat-attach-thumb"></div>
                                    <div class="flex-1 min-w-0">
                                        <p id="chat-attach-name" class="text-xs font-semibold text-slate-700 truncate"></p>
                                        <p id="chat-attach-size" class="text-[10px] text-slate-400"></p>
                                    </div>
                                    <button type="button" onclick="clearChatAttachment()" class="text-slate-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full transition-colors flex-shrink-0"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                                <!-- Voice Recording Indicator -->
                                <div id="voice-rec-bar" class="chat-attach-preview hidden">
                                    <div class="voice-recording-indicator">
                                        <div class="voice-rec-dot"></div>
                                        <span class="voice-rec-timer" id="voice-rec-timer">0:00</span>
                                        <div class="voice-waveform" id="voice-rec-waveform" style="flex:1;"></div>
                                    </div>
                                    <button type="button" onclick="cancelVoiceRecording()" class="text-slate-400 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full transition-colors flex-shrink-0" title="Cancel"><i class="fa-solid fa-xmark"></i></button>
                                    <button type="button" onclick="stopAndSendVoice()" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700 transition-colors flex-shrink-0" title="Send voice"><i class="fa-solid fa-arrow-up text-xs"></i></button>
                                </div>
                                <form id="message-form" class="flex gap-2 relative items-center" onsubmit="sendMessage(event)">
                                    <div id="reply-indicator" class="hidden absolute -top-14 left-0 right-0 bg-white p-2 rounded-t-xl border-t border-x border-slate-100 flex justify-between items-center px-4 shadow-sm" style="animation: msgAppear 0.3s ease both;">
                                         <div class="flex flex-col text-xs overflow-hidden pr-2">
                                             <span class="font-semibold text-slate-600">Replying to <span id="reply-to-name"></span></span>
                                             <span id="reply-to-text" class="text-slate-400 truncate"></span>
                                         </div>
                                         <button type="button" onclick="cancelReply()" class="text-slate-400 hover:text-slate-600 w-6 h-6 flex items-center justify-center rounded-full transition-colors duration-200"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                    <div id="edit-indicator" class="hidden absolute -top-10 left-4 bg-slate-900 text-white text-xs px-3 py-1.5 rounded-xl shadow-lg flex items-center gap-2" style="animation: msgAppear 0.3s ease both;">
                                        <span>Editing message...</span>
                                        <button type="button" onclick="cancelEdit()" class="hover:text-red-300 ml-1 transition-colors duration-200"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                    <!-- Hidden file inputs -->
                                    <input type="file" id="chat-img-input" class="hidden" accept="image/*,video/*" onchange="handleChatMediaSelect(this)">
                                    <input type="file" id="chat-file-input" class="hidden" accept="*/*" onchange="handleChatFileSelect(this)">
                                    <!-- Attachment toolbar -->
                                    <div class="chat-attachment-toolbar flex-shrink-0">
                                        <button type="button" onclick="document.getElementById('chat-img-input').click()" title="Image or Video" class="disabled-chat-btn"><i class="fa-solid fa-image text-green-500"></i></button>
                                        <button type="button" onclick="document.getElementById('chat-file-input').click()" title="Attachment" class="disabled-chat-btn"><i class="fa-solid fa-paperclip text-blue-500"></i></button>
                                        <button type="button" id="voice-record-btn" onclick="toggleVoiceRecording()" title="Voice Message" class="disabled-chat-btn"><i class="fa-solid fa-microphone text-red-400"></i></button>
                                    </div>
                                    <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 bg-slate-100 border border-transparent focus:bg-white focus:border-slate-200 rounded-full px-5 py-3 outline-none transition-all duration-300 text-sm" disabled oninput="handleTypingIndicator()">
                                    <button id="message-send-btn" type="submit" class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-slate-700 transition-all duration-200 disabled:opacity-30 btn-bounce flex-shrink-0" disabled><i id="msg-send-icon" class="fa-solid fa-arrow-up text-sm"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Right Sidebar -->
                <!-- Right Sidebar Hover Trigger -->
                <div class="sidebar-trigger right-trigger hidden lg:block" onmouseenter="openSidebarPanel('right')" id="right-trigger">
                    <div class="sidebar-trigger-indicator"></div>
                </div>

                <!-- Right Sidebar (Slide-out Overlay) -->
                <aside id="right-sidebar-panel" class="sidebar-overlay right-panel hidden lg:block custom-scrollbar space-y-3" onmouseenter="openSidebarPanel('right')" onmouseleave="closeSidebarPanel('right')">
                    <!-- Documentation -->
                    <div class="glass-card rounded-2xl bg-white/90 overflow-hidden">
                        <div class="px-3 py-2">
                            <h4 class="text-[10px] font-bold uppercase tracking-wider text-slate-400 px-2 mb-2"><i class="fa-solid fa-book mr-2"></i>Documentation</h4>
                            <div onclick="window.open('https://luminiroyalacademy.github.io/Lumini/', '_blank')" class="flex items-start gap-3 cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition-all duration-300 group">
                                <div class="w-16 h-16 bg-slate-200 rounded-lg overflow-hidden flex-shrink-0 relative shadow-sm group-hover:shadow-md transition-all">
                                    <img src="https://i.postimg.cc/pL3qStZD/Screenshot-2025-11-22-212117.png" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                </div>
                                <div>
                                    <p class="font-semibold text-xs text-slate-700 group-hover:text-blue-600 transition-colors">Project Lumini: Docs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Community Highlights -->
                    <div class="glass-card rounded-2xl bg-white/90 overflow-hidden collapsible-section" onmouseenter="expandSection('highlights-section')" onmouseleave="collapseSection('highlights-section')">
                        <div class="collapsible-header" onclick="toggleCollapsible('highlights-section')">
                            <h4><i class="fa-solid fa-fire mr-2"></i>Community Highlights</h4>
                            <div class="flex items-center gap-2">
                                <button id="admin-add-highlight-btn" onclick="event.stopPropagation(); openHighlightModal()" class="hidden text-blue-600 hover:bg-blue-50 w-5 h-5 rounded-full flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-plus text-[10px]"></i></button>
                                <i id="highlights-section-chevron" class="fa-solid fa-chevron-down collapsible-chevron"></i>
                            </div>
                        </div>
                        <div id="highlights-section" class="collapsible-body px-4 pb-4">
                            <div id="lumini-highlights-content" class="space-y-3">
                                <p class="text-xs text-gray-400">Loading...</p>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </main>

        <!-- Floating Chat Widget -->
        <div id="floating-chat-container" class="fixed bottom-6 right-6 z-[999] hidden">
            <!-- The Widget Window -->
            <div id="floating-chat-widget" class="absolute bottom-16 right-0 w-80 h-[450px] bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-200/60 overflow-hidden flex flex-col origin-bottom-right opacity-0 pointer-events-none" style="transform: scale(0) translateY(20px); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;">
                <!-- Header -->
                <div id="floating-header" class="h-14 p-3 flex items-center justify-between shrink-0 cursor-move" style="background: linear-gradient(135deg, #1e293b, #334155);">
                    <div class="flex items-center gap-2 text-white">
                        <button id="floating-back-btn" onclick="backToFloatingList()" class="hidden hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition-all duration-300"><i class="fa-solid fa-arrow-left text-sm"></i></button>
                        <span id="floating-header-title" class="font-bold text-sm" style="writing-mode: horizontal-tb; text-orientation: mixed;">Messages</span>
                    </div>
                    <button onclick="toggleFloatingWidget()" class="hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition-all duration-300 text-white"><i class="fa-solid fa-xmark text-sm"></i></button>
                </div>

                <!-- List View -->
                <div id="floating-chat-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 bg-slate-50/50">
                    <!-- Injected via JS -->
                </div>

                <!-- Conversation View -->
                <div id="floating-conversation" class="hidden flex-col bg-white min-h-0 h-full overflow-hidden" style="display: none; flex: 1;">
                    <div id="floating-messages" class="flex-1 min-h-0 overflow-y-auto p-3 space-y-2 custom-scrollbar text-xs break-words" style="scroll-behavior: smooth;"></div>
                    <form onsubmit="sendFloatingMessage(event)" class="p-2 border-t border-slate-100 bg-slate-50/80 flex gap-2 items-center shrink-0 sticky bottom-0">
                        <input id="floating-input" type="text" placeholder="Type a message..." class="flex-1 min-w-0 bg-white border border-slate-200 rounded-full px-3 py-2 text-xs outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200/50 transition-all duration-300" style="writing-mode: horizontal-tb;" oninput="handleFloatingTyping()">
                        <button type="submit" class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center hover:bg-slate-700 transition-all duration-200 flex-shrink-0"><i class="fa-solid fa-arrow-up text-xs"></i></button>
                    </form>
                </div>
            </div>

            <!-- The Launcher Button -->
            <button onclick="toggleFloatingWidget()" id="floating-launcher" class="fixed bottom-6 right-6 w-14 h-14 rounded-full text-white shadow-lg transition-all duration-500 hidden md:flex items-center justify-center z-10 cursor-move touch-none group" style="background: linear-gradient(135deg, #1e293b, #334155); box-shadow: 0 4px 20px rgba(30, 41, 59, 0.35);">
                <i class="fa-solid fa-comment-dots text-xl transition-transform duration-300 group-hover:scale-110"></i>
                <div class="absolute inset-0 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300" style="background: linear-gradient(135deg, #334155, #475569);"></div>
                <div class="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-white hidden" id="floating-unread-dot" style="animation: pulse 2s infinite;"></div>
            </button>
        </div>
        
        <script>
            // Draggable floating launcher (mobile + desktop)
            (function(){
                const launcher = document.getElementById('floating-launcher');
                if(!launcher) return;

                let dragging = false;
                let startX = 0, startY = 0, startLeft = 0, startTop = 0;

                const getPoint = (e) => {
                    if(e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    return { x: e.clientX, y: e.clientY };
                };

                const clamp = (val, min, max) => Math.max(min, Math.min(max, val));

                const onStart = (e) => {
                    dragging = true;
                    const lrect = launcher.getBoundingClientRect();
                    startLeft = lrect.left;
                    startTop = lrect.top;
                    const p = getPoint(e);
                    startX = p.x; startY = p.y;
                    e.preventDefault();
                };
                const onMove = (e) => {
                    if(!dragging) return;
                    const p = getPoint(e);
                    const dx = p.x - startX; const dy = p.y - startY;
                    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
                    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
                    const lrect = launcher.getBoundingClientRect();
                    const left = clamp(startLeft + dx, 8, vw - lrect.width - 8);
                    const top = clamp(startTop + dy, 8, vh - lrect.height - 8);
                    launcher.style.right = 'auto';
                    launcher.style.bottom = 'auto';
                    launcher.style.left = left + 'px';
                    launcher.style.top = top + 'px';
                };
                const onEnd = () => { dragging = false; };

                launcher.addEventListener('mousedown', onStart);
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onEnd);

                launcher.addEventListener('touchstart', onStart, { passive: false });
                window.addEventListener('touchmove', onMove, { passive: false });
                window.addEventListener('touchend', onEnd, { passive: true });

                // Keep above bottom mobile nav by default
                function nudgeFromBottomUI(){
                    const mobileNav = document.getElementById('mobile-bottom-nav');
                    if(!mobileNav) return;
                    const navRect = mobileNav.getBoundingClientRect();
                    const lrect = launcher.getBoundingClientRect();
                    if(lrect.bottom > navRect.top){
                        const top = Math.max(8, navRect.top - lrect.height - 12);
                        launcher.style.top = top + 'px';
                        launcher.style.bottom = 'auto';
                    }
                }
                window.addEventListener('load', nudgeFromBottomUI);
                window.addEventListener('resize', nudgeFromBottomUI);
            })();
        </script>

        <!-- Modals -->

        <!-- CUSTOM DIALOG MODAL -->
        <div id="custom-dialog-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[140] hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in border border-slate-100">
                <div class="p-5 border-b border-slate-100 flex items-start justify-between gap-3">
                    <h3 id="custom-dialog-title" class="font-heading font-bold text-lg text-slate-800">Notice</h3>
                    <button onclick="closeCustomDialog(false)" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="p-5 space-y-4">
                    <p id="custom-dialog-message" class="text-sm text-slate-600 leading-relaxed">Message</p>
                    <input id="custom-dialog-input" type="text" class="hidden w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all text-sm" placeholder="Type here...">
                    <div class="flex justify-end gap-2.5">
                        <button id="custom-dialog-cancel" onclick="closeCustomDialog(false)" class="hidden px-4 py-2 rounded-xl font-bold text-sm bg-slate-100 text-slate-700 hover:bg-slate-200 transition-all btn-bounce">Cancel</button>
                        <button id="custom-dialog-confirm" onclick="closeCustomDialog(true)" class="px-4 py-2 rounded-xl font-bold text-sm bg-slate-900 text-white hover:bg-slate-800 transition-all btn-bounce">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAVE TO COLLECTION MODAL -->
        <div id="save-collection-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[150] hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
            <div class="bg-white w-full sm:max-w-sm sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden animate-slide-up border-t sm:border border-slate-100 max-h-[80vh] flex flex-col">
                <div class="p-5 border-b border-slate-100 flex items-center justify-between shrink-0">
                    <div>
                        <h3 class="font-heading font-bold text-lg text-slate-800">Save to Collection</h3>
                        <p class="text-xs text-slate-400 mt-0.5">Choose where to save this post</p>
                    </div>
                    <button onclick="closeSaveCollectionModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="p-4 overflow-y-auto custom-scrollbar flex-1">
                    <div id="collection-pick-list" class="space-y-2"></div>
                    <!-- Create new collection inline -->
                    <div id="new-collection-inline" class="mt-3 hidden">
                        <div class="flex gap-2">
                            <input id="new-collection-name-input" type="text" placeholder="Collection name..." class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all text-sm">
                            <button onclick="confirmCreateCollectionInline()" class="px-4 py-2 rounded-xl font-bold text-sm bg-slate-900 text-white hover:bg-slate-800 transition-all btn-bounce">Add</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-100 flex gap-2 shrink-0">
                    <button onclick="toggleNewCollectionInline()" class="flex-1 py-2.5 rounded-xl font-bold text-sm bg-slate-100 text-slate-700 hover:bg-slate-200 transition-all btn-bounce flex items-center justify-center gap-2">
                        <i class="fa-solid fa-folder-plus text-xs"></i> New Collection
                    </button>
                    <button onclick="confirmSaveToCollection()" class="flex-1 py-2.5 rounded-xl font-bold text-sm bg-slate-900 text-white hover:bg-slate-800 transition-all btn-bounce shadow-md">
                        Save Here
                    </button>
                </div>
            </div>
        </div>

        <!-- CREATE COLLECTION MODAL (standalone) -->
        <div id="create-collection-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[155] hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-xs rounded-2xl shadow-2xl overflow-hidden animate-pop-in border border-slate-100">
                <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="font-heading font-bold text-lg text-slate-800">New Collection</h3>
                    <button onclick="document.getElementById('create-collection-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-5 space-y-4">
                    <input id="standalone-collection-name" type="text" placeholder="e.g. Design Inspiration" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all text-sm">
                    <button onclick="createStandaloneCollection()" class="w-full py-2.5 rounded-xl font-bold text-sm bg-slate-900 text-white hover:bg-slate-800 transition-all btn-bounce shadow-md">Create Collection</button>
                </div>
            </div>
        </div>

        <!-- ADD HIGHLIGHT MODAL (ADMIN) -->
        <div id="highlight-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Add Highlight</h3>
                    <button onclick="document.getElementById('highlight-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Project Name</label>
                        <input id="highlight-title" type="text" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 text-sm">
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Image Source</label>
                         <div class="flex gap-2 mb-2">
                             <button onclick="setHighlightImageType('upload')" id="btn-hl-upload" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-blue-600 text-white transition-all">Upload</button>
                             <button onclick="setHighlightImageType('url')" id="btn-hl-url" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-all">URL</button>
                         </div>
                         
                         <!-- Upload Input -->
                         <div id="hl-input-upload" class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center cursor-pointer hover:bg-slate-50" onclick="document.getElementById('hl-file-input').click()">
                             <i class="fa-solid fa-cloud-arrow-up text-slate-400 text-xl mb-1"></i>
                             <p class="text-[10px] text-slate-500">Click to upload image</p>
                             <input type="file" id="hl-file-input" class="hidden" accept="image/*" onchange="handleHighlightImageSelect(this)">
                         </div>
                         
                         <!-- URL Input -->
                         <input id="hl-input-url" type="text" placeholder="https://example.com/image.png" class="hidden w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 text-sm">
                         
                         <!-- Preview -->
                         <img id="hl-preview" src="" class="hidden w-full h-32 object-cover rounded-lg mt-2 border border-slate-200">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Link (Optional)</label>
                        <input id="highlight-link" type="text" placeholder="https://..." class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 text-sm">
                    </div>
                    <button onclick="saveHighlight()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 btn-bounce mt-2">Add Highlight</button>
                </div>
            </div>
        </div>

        <!-- STORY UPLOAD MODAL -->
        <div id="story-upload-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Add to Story</h3>
                    <button onclick="document.getElementById('story-upload-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 text-center">
                    <div class="flex gap-2 mb-3">
                        <button onclick="setStorySourceType('upload')" id="btn-story-upload" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-blue-600 text-white transition-all">Upload</button>
                        <button onclick="setStorySourceType('url')" id="btn-story-url" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-all">Paste URL</button>
                    </div>
                    <div id="story-upload-area" class="w-full h-64 bg-slate-100 rounded-xl mb-4 flex items-center justify-center overflow-hidden border-2 border-dashed border-slate-300 relative cursor-pointer hover:bg-slate-50 transition-colors" onclick="document.getElementById('story-file-input').click()">
                        <div id="story-upload-placeholder" class="text-slate-400">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl mb-2"></i>
                            <p class="text-sm">Click to upload photo/video</p>
                            <p class="text-[10px] text-slate-300 mt-1">No size limit</p>
                        </div>
                        <img id="story-preview-img" class="hidden w-full h-full object-contain">
                        <video id="story-preview-video" class="hidden w-full h-full object-contain" controls></video>
                    </div>
                    <div id="story-url-area" class="hidden mb-4">
                        <div class="flex gap-2">
                            <input id="story-url-input" type="url" placeholder="Paste image or video URL..." class="flex-grow text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition-all">
                            <button onclick="handleStoryUrlPaste()" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 transition-colors">Load</button>
                        </div>
                        <div id="story-url-preview" class="hidden mt-3 w-full h-56 bg-slate-100 rounded-xl overflow-hidden border border-slate-200"></div>
                    </div>
                    <input type="file" id="story-file-input" class="hidden" accept="image/*,video/*" onchange="handleStoryFileSelect(this)">
                    <p class="text-xs text-slate-400 mb-4">Content disappears after 24 hours.</p>
                    <div id="story-upload-progress" class="hidden mb-3"><div class="w-full bg-slate-200 rounded-full h-2"><div id="story-progress-fill" class="bg-blue-600 h-2 rounded-full transition-all" style="width:0%"></div></div><p class="text-xs text-slate-500 mt-1">Uploading to cloud...</p></div>
                    
                    <div class="flex gap-3">
                        <button onclick="uploadStory('public')" id="btn-upload-story-public" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 rounded-xl hover:shadow-lg hover:shadow-blue-500/30 transition-all btn-bounce disabled:opacity-50 text-sm" disabled>Your Story</button>
                        <button onclick="uploadStory('close_friends')" id="btn-upload-story-cf" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl hover:shadow-lg hover:shadow-green-500/30 transition-all btn-bounce disabled:opacity-50 flex items-center justify-center gap-1 text-sm" disabled><i class="fa-solid fa-star text-xs"></i> Close Friends</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STORY VIEWER MODAL (UPDATED) -->
        <div id="story-viewer-modal" class="fixed inset-0 bg-black z-[120] hidden flex flex-col items-center justify-center animate-fade-in">
            <!-- Progress Bars -->
            <div id="story-progress-container" class="absolute top-4 left-4 right-4 flex gap-1 z-50"></div>
            
            <!-- Header -->
            <div class="absolute top-8 left-4 right-4 flex justify-between items-center z-50">
                <div class="flex items-center gap-3">
                    <img id="viewer-avatar" src="" class="w-10 h-10 rounded-full border-2 border-white/50">
                    <div>
                        <p id="viewer-name" class="text-white font-bold text-sm text-shadow">User</p>
                        <div class="flex items-center gap-2">
                            <p id="viewer-time" class="text-white/70 text-xs">2h ago</p>
                            <span id="viewer-cf-badge" class="hidden bg-green-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm"><i class="fa-solid fa-star mr-1"></i> Close Friends</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button id="viewer-delete-btn" onclick="deleteStory()" class="hidden text-white/70 hover:text-red-500 transition-colors text-lg" title="Delete Story"><i class="fa-solid fa-trash"></i></button>
                    <button onclick="closeStoryViewer()" class="text-white/80 hover:text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <!-- Content -->
            <div class="relative w-full h-full md:max-w-lg md:h-[90vh] md:rounded-xl overflow-hidden bg-slate-900 flex items-center justify-center">
                 <img id="viewer-img" class="hidden w-full h-full object-contain">
                 <video id="viewer-video" class="hidden w-full h-full object-contain" autoplay playsinline></video>
                 
                 <!-- Navigation Overlay -->
                 <div class="absolute inset-0 flex">
                     <div class="w-1/3 h-full cursor-pointer z-40" onclick="prevStory()"></div>
                     <div class="w-1/3 h-full cursor-pointer z-40" onclick="nextStory()"></div>
                     <div class="w-1/3 h-full cursor-pointer z-40" onclick="nextStory()"></div>
                 </div>

                 <!-- Interaction Bar (Bottom) -->
                 <div class="absolute bottom-0 left-0 right-0 p-4 pb-8 bg-gradient-to-t from-black/80 to-transparent z-50 flex items-center gap-3">
                     <div class="relative flex-grow">
                        <input type="text" id="story-reply-input" placeholder="Send a message..." class="w-full bg-white/10 border border-white/30 rounded-full px-5 py-3 text-white placeholder-white/70 outline-none focus:bg-black/40 backdrop-blur-md transition-all text-sm" oninput="handleStoryInput(this)" onkeydown="if(event.key==='Enter') sendStoryReply()">
                        <button id="story-send-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white w-8 h-8 rounded-full flex items-center justify-center hidden hover:bg-white/20 transition-colors" onclick="sendStoryReply()"><i class="fa-solid fa-paper-plane"></i></button>
                     </div>
                     <button id="story-like-btn" class="text-white text-3xl drop-shadow-md active:scale-90 transition-transform btn-bounce w-10 flex items-center justify-center" onclick="toggleStoryLike()"><i class="fa-regular fa-heart"></i></button>
                 </div>
                 
                 <!-- Reaction Container -->
                 <div id="story-reaction-container" class="absolute inset-0 pointer-events-none overflow-hidden z-40"></div>
            </div>
        </div>

        <!-- CLOSE FRIENDS MODAL -->
        <div id="close-friends-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4 transition-all duration-300">
             <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in h-[500px] flex flex-col">
                 <div class="flex justify-between items-center p-4 border-b border-slate-100">
                     <h3 class="font-heading font-bold text-lg text-slate-800 flex items-center gap-2"><div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs"><i class="fa-solid fa-star"></i></div> Close Friends</h3>
                     <button onclick="document.getElementById('close-friends-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                 </div>
                 <div class="p-3 border-b border-slate-50">
                     <input type="text" placeholder="Search friends..." class="w-full bg-slate-100 rounded-lg px-3 py-2 text-sm outline-none" oninput="renderCloseFriendsList(this.value)">
                 </div>
                 <div id="close-friends-list" class="flex-1 overflow-y-auto custom-scrollbar p-2"></div>
                 <div class="p-4 border-t border-slate-100 bg-slate-50 text-center">
                     <p class="text-xs text-slate-500">Only Close Friends can see your green-ringed stories.</p>
                 </div>
             </div>
        </div>

        <!-- MESSAGE OPTIONS MODAL (DESKTOP) -->
        <div id="msg-options-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-4 transition-all duration-300">
             <div class="bg-white p-6 rounded-2xl shadow-xl max-w-xs w-full animate-pop-in transform scale-100">
                 <h3 class="font-heading font-bold text-lg text-slate-800 mb-4 text-center">Message Options</h3>
                 <div class="space-y-3">
                     <button onclick="handleReplyAction()" class="w-full py-3 rounded-xl bg-slate-100 hover:bg-blue-50 hover:text-blue-600 text-slate-700 font-bold text-sm transition-all flex items-center justify-center gap-2 btn-bounce">
                         <i class="fa-solid fa-reply"></i> Reply
                     </button>
                     <button id="modal-edit-btn" onclick="handleEditAction()" class="w-full py-3 rounded-xl bg-slate-100 hover:bg-blue-50 hover:text-blue-600 text-slate-700 font-bold text-sm transition-all flex items-center justify-center gap-2 btn-bounce">
                         <i class="fa-solid fa-pen"></i> Edit Message
                     </button>
                     <button onclick="handleUnsendAction()" class="w-full py-3 rounded-xl bg-slate-100 hover:bg-red-50 hover:text-red-600 text-slate-700 font-bold text-sm transition-all flex items-center justify-center gap-2 btn-bounce">
                         <i class="fa-solid fa-trash"></i> Unsend Message
                     </button>
                     <button onclick="closeMsgOptionsModal()" class="w-full py-3 rounded-xl border border-slate-200 text-slate-500 font-bold text-sm hover:bg-slate-50 transition-all btn-bounce">
                         Cancel
                     </button>
                 </div>
             </div>
        </div>

        <!-- REPORT POST MODAL -->
        <div id="report-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800"><i class="fa-solid fa-flag text-orange-500 mr-2"></i>Report Violation</h3>
                    <button onclick="closeReportModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-sm text-slate-600">Please help us understand why this post is inappropriate. A report will be generated and sent to our admin team via email.</p>
                    <textarea id="report-reason" rows="4" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-orange-500 focus:ring-4 focus:ring-orange-100 transition-all text-sm" placeholder="Reason for reporting (e.g., Spam, Harassment, Misinformation)..."></textarea>
                </div>
                <div class="p-5 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                    <button onclick="closeReportModal()" class="px-4 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold text-sm transition-colors btn-bounce">Cancel</button>
                    <button onclick="submitReport()" class="px-6 py-2 rounded-lg bg-orange-500 hover:bg-orange-600 text-white font-bold text-sm shadow-md transition-all shadow-orange-200 btn-bounce">Submit Report</button>
                </div>
            </div>
        </div>

        <!-- CLEAR NOTIFICATIONS CONFIRM MODAL -->
        <div id="clear-notifs-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in text-center">
                 <div class="p-6">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce-short">
                        <i class="fa-solid fa-trash-can text-2xl text-red-500"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Clear All Notifications?</h3>
                    <p class="text-slate-500 text-sm mb-6">This action cannot be undone. All your current notifications will be permanently removed.</p>
                    <div class="flex gap-3">
                        <button onclick="closeClearNotifsModal()" class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold text-sm transition-colors btn-bounce">Cancel</button>
                        <button onclick="executeClearNotifs()" class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-sm shadow-lg shadow-red-200 transition-colors btn-bounce">Yes, Clear All</button>
                    </div>
                 </div>
            </div>
        </div>
        
        <!-- ADMIN BAN MODAL -->
        <div id="ban-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="p-6 text-center">
                    <div id="ban-icon-container" class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                        <i id="ban-icon" class="fa-solid fa-gavel text-2xl text-red-600"></i>
                    </div>
                    <h3 id="ban-modal-title" class="text-xl font-bold text-slate-800 mb-2">Ban User?</h3>
                    <p id="ban-modal-desc" class="text-slate-500 text-sm mb-6">They will be immediately logged out and lose access.</p>
                    <div class="flex gap-3">
                        <button onclick="closeBanModal()" class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold text-sm transition-colors btn-bounce">Cancel</button>
                        <button id="confirm-ban-btn" onclick="executeBan()" class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-sm shadow-lg shadow-red-200 transition-colors btn-bounce">Ban User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOLLOW LIST MODAL -->
        <div id="follow-list-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[95] hidden flex items-center justify-center p-4 transition-all duration-300">
             <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-pop-in h-[500px] flex flex-col">
                 <div class="flex justify-between items-center p-4 border-b border-slate-100">
                     <h3 id="follow-list-title" class="font-heading font-bold text-lg text-slate-800">Followers</h3>
                     <button onclick="document.getElementById('follow-list-modal').classList.add('hidden')" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                 </div>
                 <div id="follow-list-content" class="flex-1 overflow-y-auto custom-scrollbar p-2"></div>
             </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[85] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Settings & Privacy</h3>
                    <button onclick="closeSettingsModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Display Name (Username)</label>
                        <input id="settings-username" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                    </div>

                    <!-- DARK MODE TOGGLE -->
                    <div class="border-t border-slate-100 pt-4 flex justify-between items-center">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Appearance</label>
                            <p class="text-sm font-bold text-slate-700 dark:text-slate-200">Dark Mode</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only peer" onchange="toggleTheme()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <!-- NEW: Sound Settings -->
                    <div class="border-t border-slate-100 pt-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Notification Sound</label>
                        <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl border border-slate-200">
                            <button onclick="previewNotificationSound()" class="w-10 h-10 rounded-full bg-white text-blue-600 flex items-center justify-center transition-colors btn-bounce shadow-sm hover:shadow-md border border-slate-100">
                                <i class="fa-solid fa-play ml-1"></i>
                            </button>
                            <div class="flex-grow">
                                <p id="current-sound-name" class="text-sm font-bold text-slate-700">Default (Ping)</p>
                                <p class="text-[10px] text-slate-400">MP3/WAV  Max 500KB</p>
                            </div>
                            <button onclick="document.getElementById('sound-upload-input').click()" class="text-xs font-bold text-blue-600 hover:text-blue-700 hover:underline px-2">Change</button>
                            <button onclick="resetNotificationSound()" class="text-xs font-bold text-red-500 hover:text-red-600 hover:underline hidden px-2" id="reset-sound-btn">Reset</button>
                        </div>
                        <input type="file" id="sound-upload-input" class="hidden" accept="audio/mp3,audio/wav,audio/ogg" onchange="handleSoundUpload(this)">
                    </div>

                    <div class="border-t border-slate-100 pt-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Account Security</label>
                        <button onclick="resetPassword()" class="w-full flex items-center justify-center gap-2 p-3 border border-red-200 text-red-600 rounded-xl hover:bg-red-50 transition-colors font-semibold btn-bounce">
                            <i class="fa-solid fa-key"></i> Reset Password via Email
                        </button>
                    </div>
                </div>
                <div class="p-5 bg-slate-50 border-t border-slate-100 flex justify-end">
                    <button onclick="saveSettings()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 btn-bounce">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div id="edit-profile-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="flex justify-between items-center p-5 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800">Edit Profile</h3>
                    <button onclick="closeEditProfileModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex justify-center mb-4">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('pfp-upload-modal').click()">
                            <img id="edit-modal-avatar" src="https://placehold.co/200x200" class="w-24 h-24 rounded-full border-4 border-slate-100 object-cover group-hover:brightness-75 transition-all">
                            <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 backdrop-blur-sm">
                                <i class="fa-solid fa-camera text-white text-2xl"></i>
                            </div>
                            <input type="file" id="pfp-upload-modal" class="hidden" accept="image/*" onchange="handlePfpChange(this)">
                        </div>
                    </div>
                    <div class="text-center text-xs text-slate-400 mb-4">Click picture to change</div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Headline</label>
                        <input id="edit-headline" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all" placeholder="Short description">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bio</label>
                        <textarea id="edit-bio" rows="3" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    <div class="pt-2 border-t border-slate-100">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2"><i class="fa-solid fa-link mr-1"></i> Quick Links</label>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-globe text-slate-400 w-5 text-center"></i>
                                <input id="edit-link-website" type="url" class="flex-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all text-sm" placeholder="Portfolio URL">
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa-brands fa-github text-slate-400 w-5 text-center"></i>
                                <input id="edit-link-github" type="url" class="flex-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all text-sm" placeholder="GitHub URL">
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa-brands fa-linkedin text-slate-400 w-5 text-center"></i>
                                <input id="edit-link-linkedin" type="url" class="flex-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all text-sm" placeholder="LinkedIn URL">
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa-brands fa-twitter text-slate-400 w-5 text-center"></i>
                                <input id="edit-link-twitter" type="url" class="flex-1 p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all text-sm" placeholder="Twitter/X URL">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-5 bg-slate-50 border-t border-slate-100 flex justify-end">
                    <button onclick="saveProfileData()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 btn-bounce">Save Profile</button>
                </div>
            </div>
        </div>

        <!-- Post Modal -->
        <div id="post-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4 transition-all duration-300">
            <div class="relative bg-white w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden animate-pop-in">
                <div class="relative flex justify-between items-center p-4 border-b border-slate-100">
                    <h3 class="font-heading font-bold text-lg text-slate-800 flex-grow text-center" id="modal-title">Create Post</h3>
                    <button onclick="closePostModal()" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center absolute right-4 transition-colors btn-bounce"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-4">
                    <div class="flex gap-3 mb-4">
                        <img id="modal-avatar" src="https://placehold.co/100x100?text=User" class="w-10 h-10 rounded-full">
                        <div><h4 id="modal-name" class="font-bold text-slate-800 text-sm">Guest</h4><select id="post-type-select" class="text-xs bg-slate-100 border-none rounded-md px-2 py-1 outline-none mt-0.5 font-medium text-slate-600"><option value="regular">Public</option><option value="project">Project</option></select></div>
                    </div>
                    <textarea id="post-input" rows="4" class="w-full resize-none outline-none text-slate-700 placeholder-slate-400 text-lg" placeholder="What's on your mind?"></textarea>
                    <div id="attachment-preview" class="hidden mt-2 relative group animate-fade-in">
                        <img id="preview-img" src="" class="max-h-48 rounded-lg border border-slate-200 shadow-sm">
                        <video id="preview-vid" src="" class="hidden max-h-48 rounded-lg border border-slate-200 shadow-sm" controls></video>
                        <button onclick="clearAttachment()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-black transition-colors"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <!-- Tagged Users Display -->
                    <div id="tagged-users-display" class="hidden mt-2 flex flex-wrap gap-2 animate-fade-in"></div>
                    
                    <div id="project-tags-input" class="hidden mt-3 pt-3 border-t border-dashed border-slate-200 animate-slide-up"><label class="text-xs font-bold text-slate-500 uppercase mb-1">Tags (Comma separated)</label><input id="tags-input" type="text" class="w-full text-sm bg-slate-50 p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-100 transition-all" placeholder="e.g. #javascript, #design"></div>
                </div>
                <!-- URL Paste Input -->
                <div id="url-paste-container" class="hidden px-4 pb-2 animate-slide-up">
                    <div class="flex gap-2 items-center">
                        <input id="url-paste-input" type="url" placeholder="Paste image or video URL here..." class="flex-grow text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition-all">
                        <button onclick="handleUrlPaste()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition-all btn-bounce">Add</button>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1 ml-1">Supports direct image/video URLs  bypasses upload limits</p>
                </div>
                <div class="px-4 pb-4 flex justify-between items-center relative">
                    <span class="text-sm font-bold text-slate-700">Add to your post</span>
                    <div class="flex gap-3 text-xl">
                        <input type="file" id="file-input" class="hidden" accept="image/*,video/*" onchange="handleFileSelect(this)">
                        <i class="fa-solid fa-image text-green-500 cursor-pointer hover:bg-green-50 p-2 rounded-full transition-all hover:scale-110" onclick="document.getElementById('file-input').click()" title="Photo/Video"></i>
                        <i class="fa-solid fa-video text-red-500 cursor-pointer hover:bg-red-50 p-2 rounded-full transition-all hover:scale-110" onclick="document.getElementById('file-input').click()" title="Video"></i>
                        <i class="fa-solid fa-link text-cyan-500 cursor-pointer hover:bg-cyan-50 p-2 rounded-full transition-all hover:scale-110" onclick="toggleUrlPasteInput()" title="Paste URL"></i>
                        <i class="fa-solid fa-user-tag text-purple-500 cursor-pointer hover:bg-purple-50 p-2 rounded-full transition-all hover:scale-110" onclick="toggleTagUserPicker()"></i>
                        <i class="fa-solid fa-tag text-blue-500 cursor-pointer hover:bg-blue-50 p-2 rounded-full transition-all hover:scale-110" onclick="toggleTagPicker()"></i>
                        <i class="fa-solid fa-face-smile text-yellow-500 cursor-pointer hover:bg-yellow-50 p-2 rounded-full transition-all hover:scale-110" onclick="toggleEmojiPicker()"></i>
                    </div>
                </div>
                <div class="p-4 pt-0"><button id="post-submit-btn" onclick="submitPost()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 btn-bounce">Post</button></div>
                
                <div id="emoji-picker" class="hidden absolute bottom-20 right-8 bg-white border border-slate-200 shadow-xl rounded-lg p-2 grid grid-cols-5 gap-2 w-48 z-50 animate-pop-in origin-bottom-right">
                    <span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span><span class="cursor-pointer hover:bg-slate-100 p-1 rounded text-center transition-transform hover:scale-125" onclick="insertEmoji('')"></span>
                </div>
                
                <div id="tag-picker" class="hidden absolute bottom-20 right-20 bg-white border border-slate-200 shadow-xl rounded-lg p-2 w-48 z-50 max-h-40 overflow-y-auto custom-scrollbar animate-pop-in origin-bottom-right">
                   <div id="tag-list" class="space-y-1"></div>
                </div>
                
                <div id="user-tag-picker" class="hidden absolute bottom-20 right-32 bg-white border border-slate-200 shadow-xl rounded-lg p-2 w-56 z-50 max-h-48 overflow-y-auto custom-scrollbar animate-pop-in origin-bottom-right">
                   <div id="user-tag-list" class="space-y-1"></div>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[90] hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0">
             <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full transform scale-95 transition-all duration-300 text-center">
                 <i class="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-4 animate-bounce-short"></i>
                 <h3 class="font-bold text-lg mb-2">Delete Post?</h3>
                 <p class="text-slate-500 text-sm mb-6">This action cannot be undone.</p>
                 <div class="flex gap-3 justify-center">
                     <button onclick="closeDeleteModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium btn-bounce">Cancel</button>
                     <button onclick="executeDelete()" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium shadow-lg shadow-red-200 btn-bounce">Delete</button>
                 </div>
             </div>
        </div>

        <!-- INCOMING CALL MODAL -->
        <div id="incoming-call-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 transition-all duration-300" style="background: radial-gradient(ellipse at center, rgba(15,23,42,0.92) 0%, rgba(0,0,0,0.97) 100%); backdrop-filter: blur(20px);">
            <div class="text-center max-w-sm w-full animate-pop-in relative">
                <!-- Animated rings -->
                <div class="relative w-36 h-36 mx-auto mb-8">
                    <div class="absolute inset-0 rounded-full border-2 border-green-400/30 animate-ping" style="animation-duration: 2s;"></div>
                    <div class="absolute inset-2 rounded-full border-2 border-green-400/20 animate-ping" style="animation-duration: 2.5s;"></div>
                    <div class="absolute inset-4 rounded-full border border-green-400/10 animate-ping" style="animation-duration: 3s;"></div>
                    <img id="caller-avatar-display" src="https://placehold.co/100x100?text=User" class="absolute inset-6 w-24 h-24 rounded-full object-cover border-4 border-white/20 shadow-2xl" style="left:50%;top:50%;transform:translate(-50%,-50%);width:96px;height:96px;">
                </div>
                <h3 id="caller-name-display" class="text-3xl font-bold text-white mb-2 tracking-tight">Incoming Call...</h3>
                <p id="caller-call-type-label" class="text-white/50 text-sm mb-1 font-medium uppercase tracking-widest">Video Call</p>
                <p class="text-white/30 text-xs mb-10">Lumini</p>
                <div class="flex gap-8 justify-center items-center">
                    <div class="flex flex-col items-center gap-2">
                        <button onclick="declineCall()" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center transition-all shadow-lg shadow-red-500/40 transform hover:scale-110 btn-bounce" style="animation: pulse 2s infinite;"><i class="fa-solid fa-phone-slash text-xl"></i></button>
                        <span class="text-white/40 text-[11px] font-medium">Decline</span>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <button onclick="answerCall()" class="w-16 h-16 rounded-full bg-green-500 hover:bg-green-600 text-white flex items-center justify-center transition-all shadow-lg shadow-green-500/40 transform hover:scale-110 btn-bounce" style="animation: bounceShort 1.5s ease-in-out infinite;"><i class="fa-solid fa-phone text-xl"></i></button>
                        <span class="text-white/40 text-[11px] font-medium">Accept</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACTIVE CALL INTERFACE -->
        <div id="call-interface" class="fixed inset-0 z-[100] hidden flex flex-col animate-fade-in" style="background: linear-gradient(180deg, #0a0a0a 0%, #111827 50%, #0a0a0a 100%);">
            <!-- Header -->
            <div class="absolute top-0 left-0 w-full p-5 z-20 flex justify-between items-center" style="background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);">
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 bg-white/10 backdrop-blur-md rounded-full px-3 py-1.5 border border-white/10">
                        <div class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse"></div>
                        <span id="call-status-text" class="text-white font-semibold text-xs tracking-wide">Connecting...</span>
                    </div>
                    <span id="call-timer-display" class="text-white/40 text-xs font-mono hidden">00:00</span>
                </div>
                <div class="flex items-center gap-3">
                    <i id="call-icon-indicator" class="fa-solid fa-video text-white/30"></i>
                    <span id="call-quality-indicator" class="text-[10px] text-green-400 font-bold hidden">HD</span>
                </div>
            </div>
            
            <!-- Video Container -->
            <div class="relative flex-1 bg-black flex items-center justify-center overflow-hidden">
                <!-- Remote Video (Full) -->
                <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover transition-opacity duration-500"></video>
                
                <!-- Audio Call Placeholder -->
                <div id="audio-call-placeholder" class="absolute inset-0 flex items-center justify-center hidden" style="background: radial-gradient(ellipse at center, #1e293b 0%, #0f172a 60%, #000 100%);">
                    <div class="text-center">
                        <!-- Sound wave animation -->
                        <div class="flex items-center justify-center gap-1 mb-6" id="audio-wave-bars">
                            <div class="w-1 bg-blue-400/60 rounded-full" style="height:16px;animation:audioWave 1.2s ease-in-out infinite;"></div>
                            <div class="w-1 bg-blue-400/60 rounded-full" style="height:24px;animation:audioWave 1.2s ease-in-out 0.1s infinite;"></div>
                            <div class="w-1 bg-blue-400/60 rounded-full" style="height:32px;animation:audioWave 1.2s ease-in-out 0.2s infinite;"></div>
                            <div class="w-1 bg-blue-400/60 rounded-full" style="height:40px;animation:audioWave 1.2s ease-in-out 0.3s infinite;"></div>
                            <div class="w-1 bg-blue-400/60 rounded-full" style="height:32px;animation:audioWave 1.2s ease-in-out 0.4s infinite;"></div>
                            <div class="w-1 bg-blue-400/60 rounded-full" style="height:24px;animation:audioWave 1.2s ease-in-out 0.5s infinite;"></div>
                            <div class="w-1 bg-blue-400/60 rounded-full" style="height:16px;animation:audioWave 1.2s ease-in-out 0.6s infinite;"></div>
                        </div>
                        <div class="relative w-28 h-28 mx-auto mb-6">
                            <div class="absolute inset-0 rounded-full border-2 border-blue-400/20 animate-ping" style="animation-duration:3s;"></div>
                            <img id="audio-call-avatar" src="https://placehold.co/100x100?text=User" class="w-28 h-28 rounded-full object-cover border-4 border-white/10 shadow-2xl">
                        </div>
                        <h3 id="audio-call-name" class="text-2xl font-bold text-white mb-1">Voice Call</h3>
                        <p id="audio-call-subtitle" class="text-white/40 text-sm">Connected</p>
                    </div>
                </div>

                <!-- Local Video (PIP) -->
                <div class="absolute bottom-28 right-4 w-32 h-44 bg-slate-900 rounded-2xl overflow-hidden shadow-2xl border border-white/10 hover:scale-105 transition-transform duration-300" style="box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
                    <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover"></video>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="pb-safe" style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); position:absolute; bottom:0; left:0; right:0; z-index:20;">
                <div class="flex items-center justify-center gap-5 py-6 px-4">
                    <button id="btn-toggle-mic" onclick="toggleAudio()" class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all flex items-center justify-center btn-bounce backdrop-blur-sm border border-white/10" title="Toggle Mic"><i class="fa-solid fa-microphone text-lg"></i></button>
                    <button onclick="endCall()" class="w-[72px] h-[72px] rounded-full bg-red-500 hover:bg-red-600 text-white shadow-xl shadow-red-600/40 transition-all flex items-center justify-center transform hover:scale-105 btn-bounce" title="End Call"><i class="fa-solid fa-phone-slash text-2xl"></i></button>
                    <button id="btn-toggle-cam" onclick="toggleVideo()" class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all flex items-center justify-center btn-bounce backdrop-blur-sm border border-white/10" title="Toggle Camera"><i class="fa-solid fa-video text-lg"></i></button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, sendPasswordResetEmail, updateProfile, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, increment, setDoc, getDoc, getDocs, arrayUnion, arrayRemove, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- CONFIGURATION ---
        const luminiConfig = {
          apiKey: "AIzaSyDtV1VuCnNCDeuHwGX4ZUCG0WMJM82-hBY",
          authDomain: "luminix-bcc28.firebaseapp.com",
          databaseURL: "https://luminix-bcc28-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "luminix-bcc28",
          storageBucket: "luminix-bcc28.firebasestorage.app",
          messagingSenderId: "217255412785",
          appId: "1:217255412785:web:dccb64a43aa83c6b234110",
          measurementId: "G-TKJELBK1F5"
        };
        
        // Initialize Firebase
        const app = initializeApp(luminiConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "lumini_v1";

        // ADMIN CONFIGURATION
        const ADMIN_EMAILS = [
            "tenzing.jangseld2023@academy.bt",
            "ugyen.rigpay2023@academy.bt",
            "tandin.wangyel2023@academy.bt",
            "jigme.tshering2023@academy.bt",
            "tenzing@gmail.com",
            "tenzingjangseliscool@gmail.com"     
        ];
        
        const checkIsAdmin = (email) => {
            if(!email) return false;
            return ADMIN_EMAILS.map(e => e.toLowerCase()).includes(email.toLowerCase());
        };

        // State
        window.currentUser = null;
        window.userProfileCache = null; 
        window.allChats = []; 
        window.currentViewedUid = null;
        let unsubscribePosts = null;
        let unsubscribeChatList = null;
        let unsubscribeMessages = null;
        let unsubscribeNotifications = null;
        let unsubscribeUsers = null;
        let unsubscribeStories = null; 
        let currentChatId = null;
        let mySavedPosts = [];
        let allPostsCache = []; 
        let allUsersCache = [];
        let allNotifications = [];
        let postToDeleteId = null;
        let editModeId = null;
        let currentAttachment = null;
        window.editingMsgId = null;
        window.taggedUsers = [];
        let currentActionMsgId = null;
        let isFirstNotificationLoad = true;
        let isFirstChatLoad = true;
        let audioContextUnlocked = false;
        let lastNotifiedMessageTimeByChat = new Map();
        
        // --- NEW: Reply & Mobile Interaction State ---
        window.replyingTo = null; // { id, name, text }
        let touchData = {};

        // --- CHAT MEDIA / VOICE STATE ---
        let chatAttachment = null; // { type: 'image'|'video'|'file'|'voice', data: base64, name: string, size: string, mimeType: string, duration?: number, waveform?: number[] }
        let voiceMediaRecorder = null;
        let voiceChunks = [];
        let voiceRecStartTime = null;
        let voiceRecInterval = null;
        let voiceRecStream = null;
        
        // --- NEW: Collaborate State ---
        window.currentCollabFilter = 'all';

        // --- STORIES STATE ---
        let allStories = [];
        let groupedStories = {};
        let activeStoryUid = null;
        let activeStoryIndex = 0;
        let storyTimer = null;
        let currentStoryUpload = { file: null, type: null, data: null, sourceType: 'upload', urlValue: null };
        let storySourceType = 'upload';

        // --- CLOUDINARY STATE ---
        let cloudinaryConfig = null;
        let currentAttachmentFile = null;
        let currentAttachmentType = null;

        async function fetchCloudinaryConfig() {
            try {
                const cfgDoc = await getDoc(doc(db, 'artifacts', appId, 'config', 'cloudinary'));
                if (cfgDoc.exists()) {
                    cloudinaryConfig = cfgDoc.data();
                } else {
                    console.warn('Cloudinary config not found');
                }
            } catch(e) {
                console.error('Failed to fetch Cloudinary config:', e);
            }
        }

        async function uploadToCloudinary(file, folder = 'lumini_posts') {
            if (!cloudinaryConfig) return null;
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', cloudinaryConfig.uploadPreset);
            fd.append('folder', folder);
            const url = `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/auto/upload`;
            try {
                const res = await fetch(url, { method: 'POST', body: fd });
                const data = await res.json();
                if (data.secure_url) {
                    return { url: data.secure_url, publicId: data.public_id, resourceType: data.resource_type };
                } else {
                    console.error('Cloudinary upload error:', data);
                    return null;
                }
            } catch(e) {
                console.error('Cloudinary upload failed:', e);
                return null;
            }
        }

        async function deleteFromCloudinary(publicId, resourceType) {
            if (!cloudinaryConfig || !publicId) return;
            try {
                const timestamp = Math.floor(Date.now() / 1000);
                const toSign = `public_id=${publicId}&timestamp=${timestamp}${cloudinaryConfig.apiSecret}`;
                const msgBuffer = new TextEncoder().encode(toSign);
                const hashBuffer = await crypto.subtle.digest('SHA-1', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const signature = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                const fd = new FormData();
                fd.append('public_id', publicId);
                fd.append('signature', signature);
                fd.append('api_key', cloudinaryConfig.apiKey);
                fd.append('timestamp', timestamp);
                const url = `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${resourceType || 'image'}/destroy`;
                await fetch(url, { method: 'POST', body: fd });
            } catch(e) {
                console.error('Cloudinary delete failed:', e);
            }
        }

        // --- FLOATING WIDGET STATE ---
        window.isFloatingWidgetOpen = false;
        window.currentFloatingChatId = null;
        window.unsubscribeFloatingMessages = null;
        window.hasDraggedWidget = false;

        // --- LAST SEEN HELPER ---
        function getLastSeenText(lastSeen) {
            if (!lastSeen) return '';
            const ts = lastSeen.seconds ? lastSeen.seconds * 1000 : (lastSeen.toMillis ? lastSeen.toMillis() : 0);
            if (!ts) return '';
            const diff = Date.now() - ts;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            if (mins < 1) return 'Last seen just now';
            if (mins < 60) return `Last seen ${mins}m ago`;
            if (hours < 24) return `Last seen ${hours}h ago`;
            if (days < 7) return `Last seen ${days}d ago`;
            return 'Last seen a while ago';
        }

        // --- CUSTOM SOUND VARIABLES ---
        let pendingSoundData = null;
        let isResettingSound = false;

        // --- HIGHLIGHTS STATE ---
        let currentHighlightImage = null;
        let currentHighlightFile = null;
        let highlightImageType = 'upload'; // 'upload' or 'url'

        // --- CUSTOM TOAST & DIALOG ---
        let customDialogResolver = null;
        let customDialogType = 'alert';

        window.showToast = (message = 'Done') => {
            let toastEl = document.getElementById('toast');
            if (!toastEl) {
                toastEl = document.createElement('div');
                toastEl.id = 'toast';
                document.body.appendChild(toastEl);
            }
            toastEl.textContent = message;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 2200);
        };

        window.showCustomDialog = ({ type = 'alert', title = 'Notice', message = '', confirmText = 'OK', cancelText = 'Cancel', placeholder = '' } = {}) => {
            customDialogType = type;
            const modal = document.getElementById('custom-dialog-modal');
            const titleEl = document.getElementById('custom-dialog-title');
            const msgEl = document.getElementById('custom-dialog-message');
            const inputEl = document.getElementById('custom-dialog-input');
            const cancelBtn = document.getElementById('custom-dialog-cancel');
            const confirmBtn = document.getElementById('custom-dialog-confirm');

            if (!modal) {
                window.showToast(message || title);
                return Promise.resolve(type === 'confirm' ? false : '');
            }

            titleEl.textContent = title;
            msgEl.textContent = message;
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;

            const needsInput = type === 'prompt';
            inputEl.classList.toggle('hidden', !needsInput);
            cancelBtn.classList.toggle('hidden', type === 'alert');

            if (needsInput) {
                inputEl.value = '';
                inputEl.placeholder = placeholder || 'Type here...';
                setTimeout(() => inputEl.focus(), 30);
            }

            modal.classList.remove('hidden');

            return new Promise((resolve) => {
                customDialogResolver = resolve;
            });
        };

        window.closeCustomDialog = (confirmed = false) => {
            const modal = document.getElementById('custom-dialog-modal');
            const inputEl = document.getElementById('custom-dialog-input');
            if (modal) modal.classList.add('hidden');
            if (!customDialogResolver) return;

            let result;
            if (customDialogType === 'confirm') result = confirmed;
            else if (customDialogType === 'prompt') result = confirmed ? inputEl.value.trim() : null;
            else result = confirmed;

            customDialogResolver(result);
            customDialogResolver = null;
        };

        window.showAlert = (message, title = 'Notice') => window.showCustomDialog({ type: 'alert', title, message, confirmText: 'OK' });
        window.showConfirm = (message, title = 'Please confirm') => window.showCustomDialog({ type: 'confirm', title, message, confirmText: 'Confirm', cancelText: 'Cancel' });
        window.showPrompt = (message, title = 'Enter value', placeholder = '') => window.showCustomDialog({ type: 'prompt', title, message, placeholder, confirmText: 'Submit', cancelText: 'Cancel' });

        // --- THEME LOGIC (SYNCED) ---
        window.toggleTheme = async () => {
            const isDark = document.getElementById('dark-mode-toggle').checked;
            if(isDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('lumini_theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('lumini_theme', 'light');
            }

            // Sync with Firebase if logged in
            if(currentUser) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), {
                        theme: isDark ? 'dark' : 'light'
                    });
                } catch(e) {
                    console.log("Theme sync error (ignorable):", e);
                }
            }
        };

        // --- AUDIO UNLOCK LOGIC ---
        function unlockAudio() {
            if (audioContextUnlocked) return;
            const audio = document.getElementById('notification-sound');
            if (audio) {
                if(!audio.src) audio.src = "sound.mp3";
                const p = audio.play();
                if (p !== undefined) {
                    p.then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audioContextUnlocked = true;
                        document.removeEventListener('click', unlockAudio);
                        document.removeEventListener('touchstart', unlockAudio);
                        document.removeEventListener('keydown', unlockAudio);
                    }).catch(e => {
                    });
                }
            }
        }

        document.addEventListener('click', unlockAudio);
        document.addEventListener('touchstart', unlockAudio);
        document.addEventListener('keydown', unlockAudio);

        // --- PLAY SOUND LOGIC ---
        window.playNotificationSound = () => {
            const audio = document.getElementById('notification-sound');
            if(!audio) return;
            
            const customSound = window.userProfileCache?.notificationSound;
            const targetSrc = customSound || "sound.mp3";
            
            let shouldUpdate = false;
            
            if (targetSrc.length < 100) {
                 if (!audio.src.endsWith(targetSrc)) shouldUpdate = true;
            } else {
                 if (audio.src !== targetSrc) shouldUpdate = true;
            }
            
            if (shouldUpdate) {
                audio.src = targetSrc;
            }
            
            audio.currentTime = 0;
            audio.play().catch(e => {}); 
        };
        
        window.handleSoundUpload = (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 500 * 1024) { 
                    showAlert("File is too large. Please select an audio file under 500KB.", "Upload limit");
                    input.value = "";
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    pendingSoundData = e.target.result;
                    isResettingSound = false;
                    document.getElementById('current-sound-name').innerText = "Custom Sound Selected";
                    document.getElementById('reset-sound-btn').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        };
        
        window.resetNotificationSound = () => {
            pendingSoundData = null;
            isResettingSound = true;
            document.getElementById('sound-upload-input').value = "";
            document.getElementById('current-sound-name').innerText = "Default (Ping) - Will be reset";
            document.getElementById('reset-sound-btn').classList.add('hidden');
        };
        
        window.previewNotificationSound = () => {
            let srcToPlay = "sound.mp3";
            if (pendingSoundData) {
                srcToPlay = pendingSoundData;
            } else if (!isResettingSound && window.userProfileCache?.notificationSound) {
                srcToPlay = window.userProfileCache.notificationSound;
            }
            const tempAudio = new Audio(srcToPlay);
            tempAudio.play().catch(async () => await showAlert("Could not play sound preview.", "Audio error"));
        };
        
        // --- ADMIN MODAL LOGIC ---
        let userToBanId = null;
        let userToBanCurrentStatus = false;

        window.toggleBan = (uid, currentStatus) => {
            userToBanId = uid;
            userToBanCurrentStatus = currentStatus;
            
            const modal = document.getElementById('ban-modal');
            const title = document.getElementById('ban-modal-title');
            const desc = document.getElementById('ban-modal-desc');
            const btn = document.getElementById('confirm-ban-btn');
            const iconContainer = document.getElementById('ban-icon-container');
            const icon = document.getElementById('ban-icon');

            if (currentStatus) {
                title.innerText = "Unban User?";
                desc.innerText = "They will regain access to Lumini immediately.";
                btn.innerText = "Unban User";
                btn.classList.remove('bg-red-600', 'hover:bg-red-700', 'shadow-red-200');
                btn.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-green-200');
                iconContainer.classList.remove('bg-red-100');
                iconContainer.classList.add('bg-green-100');
                icon.classList.remove('text-red-600', 'fa-gavel');
                icon.classList.add('text-green-600', 'fa-unlock');
            } else {
                title.innerText = "Ban User?";
                desc.innerText = "They will be immediately logged out and lose access.";
                btn.innerText = "Ban User";
                btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'shadow-green-200');
                btn.classList.add('bg-red-600', 'hover:bg-red-700', 'shadow-red-200');
                iconContainer.classList.remove('bg-green-100');
                iconContainer.classList.add('bg-red-100');
                icon.classList.remove('text-green-600', 'fa-unlock');
                icon.classList.add('text-red-600', 'fa-gavel');
            }
            
            modal.classList.remove('hidden');
        };

        window.closeBanModal = () => {
            document.getElementById('ban-modal').classList.add('hidden');
            userToBanId = null;
        };

        window.executeBan = async () => {
            if (!userToBanId) return;
            const newStatus = !userToBanCurrentStatus;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', userToBanId), {
                    isBanned: newStatus
                });
                // Update cache immediately so UI reflects change without refresh
                const cached = allUsersCache.find(u => u.id === userToBanId);
                if(cached) cached.isBanned = newStatus;
                showToast(newStatus ? 'User has been banned' : 'User has been unbanned');
                closeBanModal();
                viewProfile(userToBanId);
            } catch (e) {
                console.error("Error banning user:", e);
                await showAlert("Failed to update ban status.", "Update failed");
            }
        };

        // --- CALL STATE ---
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentCallId = null;
        let unsubscribeCall = null;
        let incomingCallData = null;
        let callType = 'video';
        let iceCandidateQueue = [];
        
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ]
        };

        // Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDirRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', user.uid);
                const userDirSnap = await getDoc(userDirRef);
                if (userDirSnap.exists() && userDirSnap.data().isBanned) {
                    await signOut(auth);
                    document.getElementById('auth-error').innerText = "Account Banned: Access revoked by Admin.";
                    document.getElementById('auth-error').classList.remove('hidden');
                    document.getElementById('auth-overlay').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                    return;
                }

                if (checkIsAdmin(user.email)) {
                     if (userDirSnap.exists()) {
                         await updateDoc(userDirRef, { isAdmin: true });
                     }
                     const adminBtn = document.getElementById('admin-add-highlight-btn');
                     if(adminBtn) adminBtn.classList.remove('hidden');
                } else {
                     const adminBtn = document.getElementById('admin-add-highlight-btn');
                     if(adminBtn) adminBtn.classList.add('hidden');
                }

                currentUser = user;
                window.currentUser = user;
                
                if(!user.displayName) {
                    const name = user.email.split('@')[0];
                    await updateProfile(user, { displayName: name });
                }
                
                const defaultAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=random`;
                if(!user.photoURL) {
                     await updateProfile(user, { photoURL: defaultAvatar });
                }

                if (!userDirSnap.exists()) {
                    await setDoc(userDirRef, {
                        name: user.displayName || user.email.split('@')[0],
                        photoURL: user.photoURL || defaultAvatar,
                        headline: "",
                        id: user.uid,
                        theme: 'light',
                        createdAt: serverTimestamp()
                    });
                } else {
                    const userData = userDirSnap.data();
                    if(userData.theme) {
                        if(userData.theme === 'dark') {
                            document.documentElement.classList.add('dark');
                            localStorage.setItem('lumini_theme', 'dark');
                            document.getElementById('dark-mode-toggle').checked = true;
                        } else {
                            document.documentElement.classList.remove('dark');
                            localStorage.setItem('lumini_theme', 'light');
                            document.getElementById('dark-mode-toggle').checked = false;
                        }
                    }
                }
                
                const userProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                const userProfileSnap = await getDoc(userProfileRef);
                if(!userProfileSnap.exists()) {
                    await setDoc(userProfileRef, {
                        headline: "",
                        bio: "",
                        savedPosts: [],
                        savedCollections: {},
                        followers: [],
                        following: [],
                        closeFriends: []
                    });
                }
                
                document.getElementById('auth-overlay').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => document.getElementById('auth-overlay').classList.add('hidden'), 700);

                document.getElementById('floating-chat-container').classList.remove('hidden');

                startPresence();
                loadData();
            } else {
                stopPresence();
                currentUser = null;
                window.currentUser = null;
                document.getElementById('auth-overlay').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                document.getElementById('floating-chat-container').classList.add('hidden');
            }
        });

        // --- NEW: Follow Logic ---
        window.toggleFollow = async (targetUid) => {
            if(!currentUser || !targetUid || targetUid === currentUser.uid) return;

            const myRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
            const targetRef = doc(db, 'artifacts', appId, 'users', targetUid, 'profile', 'main');
            
            const myDoc = await getDoc(myRef);
            const myData = myDoc.data();
            const isFollowing = myData.following && myData.following.includes(targetUid);

            const btn = document.getElementById('follow-btn');
            const btnText = btn.querySelector('span');
            
            if(isFollowing) {
                await updateDoc(myRef, { following: arrayRemove(targetUid) });
                await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
                btnText.innerText = "Follow";
                btn.classList.remove('bg-slate-200', 'text-slate-700');
                btn.classList.add('bg-blue-600', 'text-white');
            } else {
                await updateDoc(myRef, { following: arrayUnion(targetUid) });
                await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
                btnText.innerText = "Unfollow";
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-slate-200', 'text-slate-700');
                
                await addDoc(collection(db, 'artifacts', appId, 'users', targetUid, 'notifications'), {
                    type: 'follow',
                    fromUid: currentUser.uid,
                    fromName: currentUser.displayName,
                    read: false,
                    createdAt: serverTimestamp()
                });
            }
            viewProfile(targetUid);
        };

        window.openFollowModal = async (type) => {
            const uid = window.currentViewedUid || currentUser.uid;
            const modal = document.getElementById('follow-list-modal');
            const title = document.getElementById('follow-list-title');
            const content = document.getElementById('follow-list-content');
            
            title.innerText = type === 'followers' ? 'Followers' : 'Following';
            content.innerHTML = '<div class="flex justify-center p-4"><i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i></div>';
            modal.classList.remove('hidden');
            
            const docRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'main');
            const docSnap = await getDoc(docRef);
            
            if(docSnap.exists()) {
                const data = docSnap.data();
                const listIds = data[type] || [];
                
                if(listIds.length === 0) {
                    content.innerHTML = '<p class="text-center text-slate-400 py-4 text-sm">No users found.</p>';
                    return;
                }
                
                const userPromises = listIds.map(id => getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', id)));
                const userDocs = await Promise.all(userPromises);
                
                content.innerHTML = userDocs.map(d => {
                    if(!d.exists()) return '';
                    const u = d.data();
                    return `
                    <div class="flex items-center gap-3 p-3 hover:bg-slate-50 cursor-pointer rounded-lg transition-colors" onclick="document.getElementById('follow-list-modal').classList.add('hidden'); viewProfile('${u.id}')">
                        <img src="${u.photoURL}" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                        <div>
                            <p class="font-bold text-sm text-slate-800">${u.name}</p>
                            <p class="text-xs text-slate-500 truncate w-48">${u.headline || ''}</p>
                        </div>
                    </div>`;
                }).join('');
            } else {
                 content.innerHTML = '<p class="text-center text-slate-400 py-4 text-sm">Error loading list.</p>';
            }
        };

        // --- CALL LOGIC ---
        function monitorIncomingCalls() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'calls'), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    if (change.type === "added" && data.callee === currentUser.uid && data.status === 'offering') {
                        showIncomingCall(change.doc.id, data);
                    }
                });
            });
        }
        
        function showIncomingCall(callId, data) {
            currentCallId = callId;
            incomingCallData = data;
            const type = data.callType || 'video';
            callType = type;
            document.getElementById('caller-name-display').innerText = data.callerName || 'Someone';
            document.getElementById('caller-call-type-label').innerText = type === 'audio' ? 'Voice Call' : 'Video Call';
            const callerUser = allUsersCache.find(u => u.id === data.caller);
            if(callerUser) {
                document.getElementById('caller-avatar-display').src = callerUser.photoURL;
            }
            document.getElementById('incoming-call-modal').classList.remove('hidden');
            
            const r = document.getElementById('call-ringtone');
            r.currentTime = 0;
            const playPromise = r.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Autoplay blocked. User needs to interact with DOM first.");
                });
            }
        }

        window.declineCall = async () => {
            document.getElementById('incoming-call-modal').classList.add('hidden');
            document.getElementById('call-ringtone').pause();
            if(incomingCallData) {
                logSystemMessage(` Missed ${incomingCallData.callType || 'video'} call`, incomingCallData.caller);
            }
            currentCallId = null;
            incomingCallData = null;
        };

        window.answerCall = async () => {
            document.getElementById('incoming-call-modal').classList.add('hidden');
            document.getElementById('call-ringtone').pause();
            setupCallInterface(callType);
            document.getElementById('call-status-text').innerText = "Connecting...";

            const callId = currentCallId;
            const offer = incomingCallData.offer;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: callType === 'video', audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                const remoteStream = new MediaStream();
                document.getElementById('remoteVideo').srcObject = remoteStream;

                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => {
                    event.streams[0].getTracks().forEach(track => {
                        remoteStream.addTrack(track);
                    });
                };

                peerConnection.onicecandidate = async (event) => {
                    if(event.candidate) {
                        const calleeCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', callId, 'calleeCandidates');
                        await addDoc(calleeCandidatesRef, event.candidate.toJSON());
                    }
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                const callDoc = doc(db, 'artifacts', appId, 'public', 'data', 'calls', callId);
                await updateDoc(callDoc, { answer: { type: answer.type, sdp: answer.sdp }, status: 'answered' });

                const callerCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', callId, 'callerCandidates');
                onSnapshot(callerCandidatesRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            peerConnection.addIceCandidate(candidate).catch(e => console.error("Error adding candidate", e));
                        }
                    });
                });
                
                onSnapshot(callDoc, (snap) => {
                    if(snap.exists() && snap.data().status === 'ended') endCallCleanup();
                });
                document.getElementById('call-status-text').innerText = "Connected";
                startCallTimer();
                if(callType === 'audio') document.getElementById('audio-call-subtitle').textContent = 'Connected';
                document.getElementById('call-quality-indicator').classList.remove('hidden');
            } catch (err) {
                console.error("Error answering call:", err);
                await showAlert("Call Failed: Could not access camera/microphone or connect. Check permissions.", "Call failed");
                endCallCleanup();
            }
        };

        window.initiateCall = async (type = 'video') => {
            if(!currentChatId) return;
            const parts = currentChatId.split('_');
            const targetUid = parts.find(id => id !== currentUser.uid);
            if(!targetUid) { await showAlert("Cannot call this user.", "Call unavailable"); return; }

            callType = type;
            setupCallInterface(type);
            document.getElementById('call-status-text').innerText = "Calling...";
            
            const r = document.getElementById('call-ringtone');
            r.currentTime = 0;
            r.play().catch(e => console.log("Autoplay blocked:", e));

            try {
                const callDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'calls'));
                currentCallId = callDocRef.id;

                localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                const remoteStream = new MediaStream();
                document.getElementById('remoteVideo').srcObject = remoteStream;

                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = (event) => {
                    event.streams[0].getTracks().forEach(track => {
                        remoteStream.addTrack(track);
                    });
                };

                peerConnection.onicecandidate = async (event) => {
                    if(event.candidate) {
                        const callerCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'callerCandidates');
                        await addDoc(callerCandidatesRef, event.candidate.toJSON());
                    }
                };

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await setDoc(callDocRef, {
                    caller: currentUser.uid,
                    callerName: document.getElementById('menu-name').innerText,
                    callee: targetUid,
                    callType: type,
                    offer: { type: offer.type, sdp: offer.sdp },
                    status: 'offering',
                    createdAt: serverTimestamp()
                });
                
                logSystemMessage(` Incoming ${type} call`, targetUid);

                unsubscribeCall = onSnapshot(callDocRef, (snap) => {
                    const data = snap.data();
                    if(!data) return;
                    
                    if(!peerConnection.currentRemoteDescription && data.answer) {
                        document.getElementById('call-ringtone').pause();
                        const answer = new RTCSessionDescription(data.answer);
                        peerConnection.setRemoteDescription(answer).then(() => {});
                        document.getElementById('call-status-text').innerText = "Connected";
                        startCallTimer();
                        if(callType === 'audio') document.getElementById('audio-call-subtitle').textContent = 'Connected';
                        document.getElementById('call-quality-indicator').classList.remove('hidden');
                    }
                    
                    if(data.status === 'ended') endCallCleanup();
                });

                const calleeCandidatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId, 'calleeCandidates');
                onSnapshot(calleeCandidatesRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const candidate = new RTCIceCandidate(change.doc.data());
                            if (peerConnection.remoteDescription) {
                                peerConnection.addIceCandidate(candidate).catch(e => console.error("Error adding candidate", e));
                            } else {
                                setTimeout(() => {
                                     if(peerConnection.remoteDescription) peerConnection.addIceCandidate(candidate).catch(e => console.error(e));
                                }, 1000);
                            }
                        }
                    });
                });
            } catch (err) {
                console.error("Error initiating call:", err);
                await showAlert("Call Failed: Could not access camera/microphone. Ensure you are on HTTPS.", "Call failed");
                endCallCleanup();
            }
        };
        
        let callTimerInterval = null;
        let callStartTime = null;

        function setupCallInterface(type) {
            document.getElementById('call-interface').classList.remove('hidden');
            const icon = document.getElementById('call-icon-indicator');
            const placeholder = document.getElementById('audio-call-placeholder');
            const timerEl = document.getElementById('call-timer-display');
            timerEl.classList.add('hidden');
            timerEl.textContent = '00:00';
            
            const parts = currentChatId ? currentChatId.split('_') : [];
            const otherUid = parts.find(id => id !== currentUser.uid);
            const otherUser = otherUid ? allUsersCache.find(u => u.id === otherUid) : null;
            
            if(type === 'audio') {
                icon.className = "fa-solid fa-phone text-green-400";
                placeholder.classList.remove('hidden');
                document.getElementById('btn-toggle-cam').classList.add('hidden');
                if(otherUser) {
                    document.getElementById('audio-call-avatar').src = otherUser.photoURL;
                    document.getElementById('audio-call-name').textContent = otherUser.name;
                }
                document.getElementById('audio-call-subtitle').textContent = 'Connecting...';
            } else {
                icon.className = "fa-solid fa-video text-red-400";
                placeholder.classList.add('hidden');
                document.getElementById('btn-toggle-cam').classList.remove('hidden');
            }
        }

        function startCallTimer() {
            callStartTime = Date.now();
            const timerEl = document.getElementById('call-timer-display');
            timerEl.classList.remove('hidden');
            callTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const m = Math.floor(elapsed / 60);
                const s = elapsed % 60;
                timerEl.textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
            }, 1000);
        }

        function stopCallTimer() {
            if(callTimerInterval) { clearInterval(callTimerInterval); callTimerInterval = null; }
            callStartTime = null;
        }

        window.endCall = async () => {
             if(currentCallId) {
                 try {
                     await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calls', currentCallId), { status: 'ended' });
                     logSystemMessage("Call ended");
                 } catch(e) {}
             }
             endCallCleanup();
        };

        function endCallCleanup() {
            document.getElementById('call-interface').classList.add('hidden');
            document.getElementById('call-ringtone').pause();
            document.getElementById('call-quality-indicator').classList.add('hidden');
            stopCallTimer();
            if(peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if(localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if(unsubscribeCall) unsubscribeCall();
            currentCallId = null;
        }

        window.toggleAudio = () => {
            if(localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('btn-toggle-mic').classList.toggle('bg-red-500');
                document.getElementById('btn-toggle-mic').classList.toggle('bg-slate-700');
            }
        };

        window.toggleVideo = () => {
             if(localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
                document.getElementById('btn-toggle-cam').classList.toggle('bg-red-500');
                document.getElementById('btn-toggle-cam').classList.toggle('bg-slate-700');
            }
        };
        
        async function logSystemMessage(text, targetUid = null) {
            let chatId = currentChatId;
            if(!chatId && targetUid) {
                 chatId = [currentUser.uid, targetUid].sort().join('_');
            }
            if(chatId) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), { 
                    text: text, 
                    type: 'system',
                    senderId: 'system', 
                    createdAt: serverTimestamp() 
                });
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), {
                    lastUpdated: serverTimestamp()
                }, { merge: true });
            }
        }

        // --- Core Functions ---

        function loadData() {
            if (!currentUser) return;
            fetchCloudinaryConfig();
            
            if (unsubscribePosts) unsubscribePosts();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'posts'));
            let isFirstPostLoad = true;
            unsubscribePosts = onSnapshot(q, (snap) => {
                const posts = [];
                snap.forEach(d => posts.push({id: d.id, ...d.data()}));
                posts.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                allPostsCache = posts;
                const changes = snap.docChanges();
                const hasStructuralChange = isFirstPostLoad || changes.some(c => c.type === 'added' || c.type === 'removed');
                isFirstPostLoad = false;
                if(hasStructuralChange) {
                    if(!document.getElementById('view-feed').classList.contains('hidden')) renderFeed(posts);
                    if(!document.getElementById('view-collaborate').classList.contains('hidden')) renderCollaborate();
                } else {
                    changes.forEach(c => {
                        if(c.type === 'modified') {
                            const p = {id: c.doc.id, ...c.doc.data()};
                            updatePostInPlace(p);
                        }
                    });
                }
            });

            if(unsubscribeUsers) unsubscribeUsers();
            unsubscribeUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), (snap) => {
                const u = []; 
                snap.forEach(d => u.push({id: d.id, ...d.data()}));
                allUsersCache = u;
                renderNetwork(u);
                if(window.allChats.length) renderChatList(window.allChats);
                renderTaggedUsers();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), (doc) => {
                if(doc.exists()) {
                    const d = doc.data();
                    window.userProfileCache = d; 
                    mySavedPosts = d.savedPosts || [];
                    window.mySavedCollections = d.savedCollections || {};
                    updateUI(d);
                    
                    const soundNameEl = document.getElementById('current-sound-name');
                    if (d.notificationSound) {
                        if (soundNameEl) soundNameEl.innerText = "Custom Sound Active";
                        document.getElementById('reset-sound-btn').classList.remove('hidden');
                    }
                    
                    renderSavedPosts();
                } else {
                    updateUI({});
                }
            });

            monitorNotifications();
            monitorChats();
            monitorIncomingCalls();
            monitorStories(); 
            monitorHighlights(); 
        }

        function monitorHighlights() {
             const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'highlights'), orderBy('createdAt', 'desc'));
             onSnapshot(q, (snap) => {
                 const items = [];
                 snap.forEach(d => items.push({id: d.id, ...d.data()}));
                 renderHighlights(items);
             });
        }

        function renderHighlights(items) {
             const container = document.getElementById('lumini-highlights-content');
             if(!items.length) {
                 container.innerHTML = '<p class="text-xs text-gray-400">Trending discussions will appear here.</p>';
                 return;
             }
             const isAdmin = checkIsAdmin(currentUser.email);
             container.innerHTML = items.map(item => `
                 <div class="flex items-center gap-3 group relative hover:bg-slate-50 p-2 rounded-xl transition-colors cursor-pointer" onclick="${item.link ? `window.open('${item.link}', '_blank')` : ''}">
                     <img src="${item.imageUrl}" class="w-12 h-12 rounded-lg object-cover bg-slate-200">
                     <div class="flex-grow">
                         <h4 class="font-bold text-sm text-slate-800">${item.title}</h4>
                     </div>
                     ${isAdmin ? `<button onclick="event.stopPropagation(); deleteHighlight('${item.id}')" class="hidden group-hover:block absolute right-2 top-2 text-red-400 hover:text-red-600"><i class="fa-solid fa-trash text-xs"></i></button>` : ''}
                 </div>
             `).join('');
        }

        window.openHighlightModal = () => {
             document.getElementById('highlight-modal').classList.remove('hidden');
             document.getElementById('highlight-title').value = '';
             document.getElementById('highlight-link').value = '';
             document.getElementById('hl-input-url').value = '';
             document.getElementById('hl-file-input').value = '';
             document.getElementById('hl-preview').classList.add('hidden');
             currentHighlightImage = null;
             currentHighlightFile = null;
             setHighlightImageType('upload');
        };

        window.setHighlightImageType = (type) => {
            highlightImageType = type;
            if(type === 'upload') {
                document.getElementById('btn-hl-upload').className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-blue-600 text-white transition-all";
                document.getElementById('btn-hl-url').className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-all";
                document.getElementById('hl-input-upload').classList.remove('hidden');
                document.getElementById('hl-input-url').classList.add('hidden');
            } else {
                document.getElementById('btn-hl-upload').className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-all";
                document.getElementById('btn-hl-url').className = "flex-1 py-1.5 rounded-lg text-xs font-bold bg-blue-600 text-white transition-all";
                document.getElementById('hl-input-upload').classList.add('hidden');
                document.getElementById('hl-input-url').classList.remove('hidden');
            }
        };

        window.handleHighlightImageSelect = (input) => {
             if(input.files && input.files[0]) {
                 currentHighlightFile = input.files[0];
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     currentHighlightImage = e.target.result;
                     document.getElementById('hl-preview').src = currentHighlightImage;
                     document.getElementById('hl-preview').classList.remove('hidden');
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        };

        window.saveHighlight = async () => {
             const title = document.getElementById('highlight-title').value;
             const link = document.getElementById('highlight-link').value;
             let imageUrl = currentHighlightImage;
             let cldPublicId = null;
             let cldResourceType = null;
             if(highlightImageType === 'url') {
                 imageUrl = document.getElementById('hl-input-url').value;
             }
             if(!title || (!imageUrl && !currentHighlightFile)) {
                 await showAlert("Title and Image are required.", "Missing fields");
                 return;
             }
             try {
                 if (highlightImageType === 'upload' && currentHighlightFile && cloudinaryConfig) {
                     const result = await uploadToCloudinary(currentHighlightFile, 'lumini_highlights');
                     if (result) {
                         imageUrl = result.url;
                         cldPublicId = result.publicId;
                         cldResourceType = result.resourceType;
                     } else {
                         showToast('Upload failed. Try again.');
                         return;
                     }
                 }
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'highlights'), {
                     title, 
                     imageUrl, 
                     link, 
                     cloudinaryPublicId: cldPublicId || null,
                     cloudinaryResourceType: cldResourceType || null,
                     createdAt: serverTimestamp(),
                     createdBy: currentUser.uid
                 });
                 document.getElementById('highlight-modal').classList.add('hidden');
                 currentHighlightFile = null;
             } catch(e) {
                 console.error("Highlight save failed", e);
                 await showAlert("Failed to save highlight.", "Save failed");
             }
        };
        
        window.deleteHighlight = async (id) => {
             const confirmed = await showConfirm("Delete highlight?", "Delete highlight");
             if(confirmed) {
                 try {
                     const hlDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'highlights', id));
                     if (hlDoc.exists() && hlDoc.data().cloudinaryPublicId) {
                         deleteFromCloudinary(hlDoc.data().cloudinaryPublicId, hlDoc.data().cloudinaryResourceType || 'image');
                     }
                 } catch(e) {}
                 await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'highlights', id));
             }
        };

        function monitorNotifications() {
            if(unsubscribeNotifications) unsubscribeNotifications();
            const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications'), orderBy('createdAt', 'desc'));
            
            unsubscribeNotifications = onSnapshot(q, (snap) => {
                if (isFirstNotificationLoad) {
                    isFirstNotificationLoad = false;
                } 

                allNotifications = [];
                let unreadCount = 0;
                snap.forEach(d => {
                    const n = {id: d.id, ...d.data()};
                    allNotifications.push(n);
                    if(!n.read) unreadCount++;
                });
                const badge = document.getElementById('notification-badge');
                if(badge) badge.style.display = unreadCount > 0 ? 'block' : 'none';
                renderNotificationsList();
            });
        }
        
        function renderNotificationsList() {
            const list = document.getElementById('notification-list');
            if(allNotifications.length === 0) {
                 list.innerHTML = `<p class="text-center text-xs text-slate-400 py-4">No new notifications.</p>`;
                 return;
            }
            list.innerHTML = allNotifications.map(n => {
                let content = '';
                let icon = 'fa-user';
                let iconColor = 'text-blue-500';
                if(n.type === 'like') { content = `liked your post.`; icon = 'fa-heart'; iconColor = 'text-red-500'; }
                else if(n.type === 'comment') { content = `commented on your post.`; icon = 'fa-comment'; }
                else if(n.type === 'comment_reply') { content = `replied to your comment.`; icon = 'fa-reply'; iconColor = 'text-indigo-500'; }
                else if(n.type === 'follow') { content = `started following you.`; icon = 'fa-user-plus'; }
                else if(n.type === 'mention') { content = `mentioned you in a post.`; icon = 'fa-at'; iconColor = 'text-purple-500'; }
                else if(n.type === 'tag') { content = `tagged you in a post.`; icon = 'fa-tag'; iconColor = 'text-green-500'; } 
                else if (n.type === 'admin_delete') { content = `removed your post for violating guidelines.`; icon = 'fa-trash'; iconColor = 'text-red-600'; }
                else if(n.type === 'story_like') { content = `liked your story.`; icon = 'fa-heart'; iconColor = 'text-red-500'; }
                else if(n.type === 'story_reply') { content = `replied to your story: "${n.text || ''}"`; icon = 'fa-reply'; iconColor = 'text-purple-500'; }

                return `
                <div class="flex items-start gap-3 p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors ${n.read ? 'opacity-70' : 'bg-blue-50/50'}" onclick="handleNotificationClick('${n.id}', '${n.type}', '${n.postId || ''}', '${n.fromUid}', '${n.commentId || ''}')">
                    <div class="mt-1"><i class="fa-solid ${icon} ${iconColor}"></i></div>
                    <div>
                        <p class="text-sm text-slate-800"><span class="font-bold">${n.fromName || 'Someone'}</span> ${content}</p>
                        <p class="text-xs text-slate-400 mt-1">${n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleDateString() : ''}</p>
                    </div>
                </div>`;
            }).join('');
        }
        
        window.handleNotificationClick = async (nid, type, postId, fromUid, commentId) => {
             await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications', nid), { read: true });
             if(type === 'like' || type === 'comment' || type === 'comment_reply' || type === 'mention' || type === 'tag') {
                 router('feed');
                 setTimeout(() => {
                     const postElement = document.getElementById(`post-${postId}-feed`);
                     if (postElement) {
                         postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         postElement.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2', 'scale-[1.01]', 'transition-transform');
                         setTimeout(() => { postElement.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2', 'scale-[1.01]'); }, 2000);
                         
                         if((type === 'comment' || type === 'comment_reply') && commentId) {
                             window._pendingCommentHighlight = commentId;
                             toggleCommentSection(postId, 'feed');
                         }
                     }
                 }, 400);
             } else if (type === 'follow' || type === 'story_like' || type === 'story_reply') {
                 viewProfile(fromUid);
             }
        };

        function monitorChats() {
            if(unsubscribeChatList) unsubscribeChatList();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats'), orderBy('lastUpdated', 'desc'));
            unsubscribeChatList = onSnapshot(q, (snap) => {
                let hasUnread = false;
                const chats = [];
                snap.forEach(d => {
                    const data = d.data();
                    const parts = d.id.split('_');
                    if(parts.includes(currentUser.uid)) {
                        chats.push({id: d.id, ...data});
                        const lastUpdatedMillis = data.lastUpdated?.toMillis?.() || 0;
                        if (!lastNotifiedMessageTimeByChat.has(d.id)) {
                            lastNotifiedMessageTimeByChat.set(d.id, lastUpdatedMillis);
                        }
                        if(data.readBy && !data.readBy.includes(currentUser.uid)) hasUnread = true;
                    }
                });

                if (!isFirstChatLoad) {
                    snap.docChanges().forEach(change => {
                        const data = change.doc.data();
                        const chatId = change.doc.id;
                        const lastUpdatedMillis = data.lastUpdated?.toMillis?.() || 0;
                        const previousMillis = lastNotifiedMessageTimeByChat.get(chatId) || 0;
                        const hasNewMessage = lastUpdatedMillis > previousMillis;
                        const isUnread = data.readBy && !data.readBy.includes(currentUser.uid);

                        if ((change.type === 'added' || change.type === 'modified') &&
                            data.participants && data.participants.includes(currentUser.uid) &&
                            isUnread && hasNewMessage) {
                             window.playNotificationSound();
                        }

                        if (lastUpdatedMillis > previousMillis) {
                            lastNotifiedMessageTimeByChat.set(chatId, lastUpdatedMillis);
                        }
                    });
                }
                isFirstChatLoad = false;

                const badge = document.getElementById('chat-badge');
                if(badge) badge.style.display = hasUnread ? 'block' : 'none';
                window.allChats = chats;
                renderChatList(chats);
                if(window.isFloatingWidgetOpen) renderFloatingChatList();
            });
        }

        function renderChatList(chats) {
            const container = document.getElementById('chat-list');
            if(chats.length === 0) { container.innerHTML = '<p class="text-center text-xs text-slate-400 mt-4">No chats yet.</p>'; return; }
            container.innerHTML = chats.map(c => {
                const parts = c.id.split('_');
                const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                const otherUser = allUsersCache.find(u => u.id === otherUid) || { name: "User", photoURL: "https://placehold.co/100x100" };
                const isUnread = c.readBy && !c.readBy.includes(currentUser.uid);
                
                const isOnline = otherUser.isOnline === true;
                const lastSeenText = !isOnline && otherUser.lastSeen ? getLastSeenText(otherUser.lastSeen) : '';
                
                return `<div onclick="openChat('${c.id}', '${otherUser.name}')" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all duration-200 ${c.id === currentChatId ? 'bg-white shadow-md ring-1 ring-slate-100 scale-[1.02]' : 'hover:bg-white hover:shadow-sm'} ${isUnread ? 'bg-blue-50/50' : ''}">
                    <div class="relative">
                        <img src="${otherUser.photoURL}" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                        ${isOnline ? '<div class="status-dot-online"></div>' : ''}
                        ${isUnread && !isOnline ? '<div class="absolute top-0 right-0 w-3 h-3 bg-blue-500 rounded-full border-2 border-white animate-pulse"></div>' : ''}
                    </div>
                    <div class="truncate flex-grow">
                        <h4 class="font-bold text-sm text-slate-800 ${isUnread ? 'text-black' : ''}">${otherUser.name}</h4>
                        ${isUnread ? '<p class="text-[10px] text-blue-600 font-bold">New message</p>' : (isOnline ? '<p class="text-[10px] text-green-500 font-semibold">Online</p>' : (lastSeenText ? `<p class="text-[10px] text-slate-400">${lastSeenText}</p>` : ''))}
                    </div>
                </div>`;
            }).join('');
        }

        window.openChat = async (chatId, name) => {
            currentChatId = chatId;
            if(window.allChats) renderChatList(window.allChats);
            monitorTyping(chatId);
            
            document.getElementById('chat-header-name').innerText = name;
            // Show online status in chat header
            const chatParts = chatId.split('_');
            const chatOtherUid = chatParts[0] === currentUser.uid ? chatParts[1] : chatParts[0];
            const chatOtherUser = allUsersCache.find(u => u.id === chatOtherUid);
            const statusEl = document.getElementById('chat-header-status');
            if (chatOtherUser && chatOtherUser.isOnline) {
                statusEl.innerHTML = '<i class="fa-solid fa-circle text-green-500 mr-1" style="font-size:6px;"></i>Online';
                statusEl.classList.remove('hidden');
                statusEl.className = 'text-[10px] text-green-500 font-semibold';
            } else if (chatOtherUser && chatOtherUser.lastSeen) {
                statusEl.innerText = getLastSeenText(chatOtherUser.lastSeen);
                statusEl.classList.remove('hidden');
                statusEl.className = 'text-[10px] text-slate-400';
            } else {
                statusEl.classList.add('hidden');
            }
            document.getElementById('start-video-call-btn').classList.remove('hidden');
            document.getElementById('start-audio-call-btn').classList.remove('hidden');
            document.getElementById('delete-chat-btn').classList.remove('hidden');

            const input = document.getElementById('message-input');
            const btn = document.getElementById('message-send-btn');
            input.disabled = false;
            btn.disabled = false;
            input.focus();

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), {
                readBy: arrayUnion(currentUser.uid)
            }, { merge: true });

            if(unsubscribeMessages) unsubscribeMessages();
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), orderBy('createdAt', 'asc'));
            
            // --- REVAMPED MESSAGE RENDERING WITH MORPH ANIMATIONS, TIMESTAMPS, READ RECEIPTS ---
            unsubscribeMessages = onSnapshot(q, (snap) => {
                const c = document.getElementById('chat-messages');
                c.innerHTML = '';
                const messages = [];
                snap.forEach(d => messages.push({id: d.id, ...d.data()}));
                
                let lastDateLabel = '';
                
                messages.forEach((m, idx) => {
                    if(m.type === 'system') {
                        c.innerHTML += `<div class="msg-system animate-fade-in">${m.text}</div>`;
                        return;
                    }
                    
                    const isMe = m.senderId === currentUser.uid;
                    const parts = currentChatId.split('_');
                    const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                    const senderName = isMe ? 'You' : name;

                    // DATE DIVIDER
                    if(m.createdAt) {
                        const msgDate = new Date(m.createdAt.toMillis());
                        const today = new Date();
                        const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
                        let dateLabel = '';
                        if(msgDate.toDateString() === today.toDateString()) dateLabel = 'Today';
                        else if(msgDate.toDateString() === yesterday.toDateString()) dateLabel = 'Yesterday';
                        else dateLabel = msgDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: msgDate.getFullYear() !== today.getFullYear() ? 'numeric' : undefined });
                        
                        if(dateLabel !== lastDateLabel) {
                            lastDateLabel = dateLabel;
                            c.innerHTML += `<div class="msg-timestamp-divider"><span>${dateLabel}</span></div>`;
                        }
                    }

                    // TIME STRING - only show if 5+ min gap from previous message
                    let timeStr = '';
                    if(m.createdAt) {
                        const d = new Date(m.createdAt.toMillis());
                        let showTime = false;
                        if(idx === 0) {
                            showTime = true;
                        } else {
                            const prevMsg = messages[idx - 1];
                            if(prevMsg && prevMsg.createdAt) {
                                const gap = m.createdAt.toMillis() - prevMsg.createdAt.toMillis();
                                if(gap > 5 * 60 * 1000) showTime = true;
                            } else {
                                showTime = true;
                            }
                        }
                        if(showTime) {
                            timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        }
                    }

                    // REPLY CONTENT UI
                    let replyBlock = '';
                    if(m.replyTo) {
                        replyBlock = `
                        <div class="reply-context">
                             <span class="font-bold text-xs">${m.replyTo.name}</span>
                             <span class="truncate text-xs text-slate-500">${m.replyTo.text}</span>
                        </div>`;
                    }

                    // STORY REPLY CONTEXT UI (Instagram-style)
                    let storyReplyBlock = '';
                    if(m.storyReply) {
                        const storyThumb = m.storyReply.type === 'video'
                            ? `<video src="${m.storyReply.media}" class="w-16 h-20 object-cover rounded-lg" muted preload="metadata"></video>`
                            : `<img src="${m.storyReply.media}" class="w-16 h-20 object-cover rounded-lg" alt="Story">`;
                        const label = isMe ? `Replied to ${m.storyReply.ownerName}'s story` : `Replied to your story`;
                        storyReplyBlock = `
                        <div class="flex items-center gap-2 mb-1.5 opacity-80">
                            <div class="flex-shrink-0 rounded-lg overflow-hidden border border-white/20 shadow-sm">${storyThumb}</div>
                            <span class="text-[11px] italic">${label}</span>
                        </div>`;
                    }
                    
                    let receiptHtml = '';

                    // DESKTOP TRIGGER
                    let triggerHtml = '';
                    const safeText = (m.text || '').replace(/'/g, "\\'");
                    const displayLabel = m.text || (m.media ? (m.media.type === 'voice' ? 'Voice message' : (m.media.type === 'image' ? 'Photo' : (m.media.type === 'video' ? 'Video' : 'Attachment'))) : '');
                    if (isMe) {
                         const now = Date.now();
                         const msgTime = m.createdAt ? m.createdAt.toMillis() : now;
                         const canEdit = (now - msgTime) < 120000;
                         triggerHtml = `
                         <div class="text-[10px] text-slate-400 hover:text-blue-600 cursor-pointer mt-1 mr-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center gap-1 select-none md:flex hidden" onclick="openMsgOptions('${m.id}', ${canEdit})">
                            <i class="fa-solid fa-ellipsis"></i> Options
                         </div>
                         <div class="hidden" id="msg-text-${m.id}">${displayLabel}</div>
                         `;
                    } else {
                        triggerHtml = `
                         <div class="text-[10px] text-slate-400 hover:text-blue-600 cursor-pointer mt-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center gap-1 select-none md:flex hidden" onclick="startReply('${m.id}', '${senderName}', '${safeText || displayLabel.replace(/'/g, "\\'")}')">
                            <i class="fa-solid fa-reply"></i> Reply
                         </div>
                         <div class="hidden" id="msg-text-${m.id}">${displayLabel}</div>
                         `;
                    }

                    // SWIPE INDICATOR UI
                    const swipeIndicator = `<div class="reply-arrow-indicator ${isMe ? 'right-full mr-2' : 'left-full ml-2'}"><i class="fa-solid fa-reply"></i></div>`;

                    // Reaction display
                    const reactions = m.reactions || {};
                    const reactionCounts = {};
                    Object.values(reactions).forEach(emoji => { reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1; });
                    const reactionDisplay = Object.keys(reactionCounts).length ? 
                        `<div class="flex gap-1 mt-1 ${isMe ? 'justify-end' : 'justify-start'}">` + 
                        Object.entries(reactionCounts).map(([emoji, count]) => 
                            `<span class="inline-flex items-center gap-0.5 bg-white border border-slate-200 rounded-full px-1.5 py-0.5 text-xs cursor-pointer hover:scale-110 transition-transform shadow-sm" onclick="toggleReaction('${chatId}', '${m.id}', '${emoji}')">${emoji}${count > 1 ? `<span class="text-[9px] text-slate-500 font-bold">${count}</span>` : ''}</span>`
                        ).join('') + '</div>' : '';

                    // MEDIA CONTENT
                    let mediaHtml = '';
                    if(m.media) {
                        const md = m.media;
                        if(md.type === 'image') {
                            mediaHtml = `<img src="${md.data}" alt="Image" class="chat-media-img mb-1" onclick="openLightbox(this.src)">`;
                        } else if(md.type === 'video') {
                            mediaHtml = `<video src="${md.data}" class="chat-media-video mb-1" controls preload="metadata"></video>`;
                        } else if(md.type === 'voice') {
                            const dur = md.duration || 0;
                            const mins = Math.floor(dur/60); const secs = Math.floor(dur%60);
                            const durStr = mins + ':' + String(secs).padStart(2,'0');
                            const bars = (md.waveform && md.waveform.length) ? md.waveform : Array.from({length:28}, ()=>Math.random()*0.7+0.15);
                            const barsHtml = bars.map(v=>`<div class="voice-waveform-bar" style="height:${Math.max(3,v*26)}px"></div>`).join('');
                mediaHtml = `<div class="voice-msg-player" data-src="${md.data}" data-bar-count="${bars.length}">
<button type="button" onclick="playVoiceMsg(this.closest('.voice-msg-player'))"><i class="fa-solid fa-play text-xs"></i></button>
<div class="voice-waveform" onclick="seekVoice(event, this.closest('.voice-msg-player'))">${barsHtml}</div>
<span class="voice-duration">${durStr}</span>
<audio src="${md.data}" preload="metadata"></audio>
</div>`;
                        } else if(md.type === 'file') {
                            const icon = md.mimeType && md.mimeType.startsWith('application/pdf') ? 'fa-file-pdf text-red-500' : 'fa-file text-blue-500';
                            mediaHtml = `<a href="${md.data}" download="${md.name||'file'}" class="chat-file-attachment mb-1">
                                <i class="fa-solid ${icon} text-lg"></i>
                                <div class="min-w-0 flex-1">
                                    <p class="text-xs font-semibold truncate">${md.name||'File'}</p>
                                    <p class="text-[10px] opacity-60">${md.size||''}</p>
                                </div>
                                <i class="fa-solid fa-download text-xs opacity-50"></i>
                            </a>`;
                        }
                    }

                    c.innerHTML += `
                    <div class="flex w-full mb-1 ${isMe?'justify-end':'justify-start'} group msg-group" id="msg-container-${m.id}">
                        <div class="flex flex-col ${isMe?'items-end':'items-start'} max-w-[85%] w-full min-w-0 relative ${isMe?'msg-me-wrapper':'msg-them-wrapper'}">
                            <div class="msg-bubble ${isMe?'msg-me':'msg-them'} relative" id="msg-bubble-${m.id}">
${swipeIndicator}
${storyReplyBlock}
${replyBlock}
${mediaHtml}
                                ${m.text ? m.text : ''}
                                ${m.edited ? '<span class="text-[10px] opacity-60 block text-right italic mt-1">(edited)</span>' : ''}
                                <!-- Side emoji reaction picker with hover bridge -->
                                <div class="emoji-reaction-wrapper">
                                    <div class="emoji-hover-bridge"></div>
                                    <div class="emoji-pill">
                                        <button onclick="event.stopPropagation(); toggleReaction('${chatId}', '${m.id}', '')" class="hover:scale-125 transition-transform text-xs p-0.5" title="Love"></button>
                                        <button onclick="event.stopPropagation(); toggleReaction('${chatId}', '${m.id}', '')" class="hover:scale-125 transition-transform text-xs p-0.5" title="Laugh"></button>
                                        <button onclick="event.stopPropagation(); toggleReaction('${chatId}', '${m.id}', '')" class="hover:scale-125 transition-transform text-xs p-0.5" title="Like"></button>
                                        <button onclick="event.stopPropagation(); toggleReaction('${chatId}', '${m.id}', '')" class="hover:scale-125 transition-transform text-xs p-0.5" title="Wow"></button>
                                        <button onclick="event.stopPropagation(); toggleReaction('${chatId}', '${m.id}', '')" class="hover:scale-125 transition-transform text-xs p-0.5" title="Sad"></button>
                                    </div>
                                </div>
                            </div>
                            ${reactionDisplay}
                            <div class="msg-time ${isMe ? 'flex-row-reverse' : ''}">
                                ${timeStr ? `<span>${timeStr}</span>` : ''}
                                ${receiptHtml}
                            </div>
                            ${triggerHtml}
                        </div>
                    </div>`;
                });
                
                // Add typing indicator placeholder at bottom
                c.innerHTML += `<div id="typing-indicator-container" class="${window._otherUserIsTyping ? '' : 'hidden'} flex justify-start mb-1 msg-group">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>`;
                
                // Attach Touch Listeners manually after render
                messages.forEach(m => {
                    if(m.type !== 'system') {
                        const bubble = document.getElementById(`msg-bubble-${m.id}`);
                        const container = document.getElementById(`msg-container-${m.id}`);
                        const isMe = m.senderId === currentUser.uid;
                        const senderName = isMe ? 'You' : name;
                        
                        if(bubble) {
                            const mobileText = m.text || (m.media ? (m.media.type === 'voice' ? 'Voice message' : (m.media.type === 'image' ? 'Photo' : (m.media.type === 'video' ? 'Video' : 'Attachment'))) : '');
                            handleSwipe(bubble, m.id, mobileText, senderName, isMe);
                            handleMobileLongPress(bubble, m.id, isMe, mobileText, senderName);
                        }
                    }
                });

                const chatDoc = window.allChats ? window.allChats.find(ch => ch.id === currentChatId) : null;
                updateLiveReadReceipts(currentChatId, chatDoc?.readBy || []);
                c.scrollTop = c.scrollHeight;
            });
            router('messaging');
            
            // Apply morph animation to chat column
            const chatCol = document.getElementById('msg-chat-col');
            chatCol.classList.remove('chat-morph-enter');
            void chatCol.offsetWidth; // Force reflow
            chatCol.classList.add('chat-morph-enter');
            
            if(window.innerWidth < 768) {
                document.getElementById('msg-list-col').classList.add('hidden');
                chatCol.classList.remove('hidden');
                chatCol.classList.add('flex');
            }
        };

        // --- MOBILE INTERACTION HANDLERS ---

        function handleSwipe(element, msgId, msgText, msgName, isMe) {
            let startX = 0;
            let currentX = 0;
            let isSwiping = false;
            const threshold = 60; // Distance to trigger reply
            const indicator = element.querySelector('.reply-arrow-indicator');

            element.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isSwiping = false;
                element.style.transition = 'none';
            }, {passive: true});

            element.addEventListener('touchmove', (e) => {
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                
                // Swipe Logic: Left-to-Right OR Right-to-Left depending on side? 
                // Usually swipe towards center triggers it.
                // If message is on LEFT (them), swipe RIGHT.
                // If message is on RIGHT (me), swipe LEFT.
                
                let validSwipe = false;
                let translate = 0;

                if (!isMe && diff > 0) { // Them: Swipe Right
                    validSwipe = true;
                    translate = Math.min(diff, 100);
                } else if (isMe && diff < 0) { // Me: Swipe Left
                    validSwipe = true;
                    translate = Math.max(diff, -100);
                }

                if (validSwipe && Math.abs(diff) > 10) { // Small threshold to avoid scroll jitter
                    isSwiping = true;
                    element.style.transform = `translateX(${translate}px)`;
                    
                    if(indicator) {
                        indicator.style.opacity = Math.abs(diff) > threshold ? '1' : Math.abs(diff)/threshold;
                        indicator.style.transform = `translateY(-50%) scale(${Math.abs(diff) > threshold ? 1.2 : 1})`;
                    }
                }
            }, {passive: true});

            element.addEventListener('touchend', (e) => {
                const diff = currentX - startX;
                element.style.transition = 'transform 0.2s ease-out';
                element.style.transform = 'translateX(0)';
                
                if (indicator) indicator.style.opacity = '0';

                if (isSwiping) {
                    if ((!isMe && diff > threshold) || (isMe && diff < -threshold)) {
                        // Trigger Reply
                        startReply(msgId, msgName, msgText);
                        // Haptic feedback
                        if(navigator.vibrate) navigator.vibrate(20);
                    }
                }
                isSwiping = false;
            });
        }

        function handleMobileLongPress(element, msgId, isMe, msgText, msgName) {
            let pressTimer;
            
            const startPress = () => {
                pressTimer = setTimeout(() => {
                    // Trigger Context Menu
                    showMobileContextMenu(element, msgId, isMe, msgText, msgName);
                    if(navigator.vibrate) navigator.vibrate(50);
                }, 500); // 500ms hold
            };

            const cancelPress = () => {
                clearTimeout(pressTimer);
            };

            element.addEventListener('touchstart', startPress, {passive: true});
            element.addEventListener('touchend', cancelPress);
            element.addEventListener('touchmove', cancelPress);
        }

        function showMobileContextMenu(element, msgId, isMe, msgText, msgName) {
            const menu = document.getElementById('mobile-message-menu');
            const menuContent = document.getElementById('mobile-menu-content');
            
            // Highlight element (Visual trickery)
            element.classList.add('msg-focused');
            
            menu.classList.remove('hidden');
            
            // Setup Buttons
            const btnReply = document.getElementById('mm-reply');
            const btnCopy = document.getElementById('mm-copy');
            const btnEdit = document.getElementById('mm-edit');
            const btnUnsend = document.getElementById('mm-unsend');

            btnReply.onclick = () => { closeMobileMenu(); startReply(msgId, msgName, msgText); };
            
            btnCopy.onclick = () => { 
                closeMobileMenu(); 
                navigator.clipboard.writeText(msgText).then(() => showToast('Copied!')); 
            };

            if(isMe) {
                btnEdit.classList.remove('hidden');
                btnUnsend.classList.remove('hidden');
                
                btnEdit.onclick = () => { closeMobileMenu(); startEdit(msgId); };
                btnUnsend.onclick = () => { closeMobileMenu(); currentActionMsgId = msgId; unsendMessage(msgId); };
            } else {
                btnEdit.classList.add('hidden');
                btnUnsend.classList.add('hidden');
            }

            // Clean up when clicking outside
            menu.onclick = (e) => {
                if(e.target === menu) closeMobileMenu();
            };
        }

        function closeMobileMenu() {
            document.getElementById('mobile-message-menu').classList.add('hidden');
            document.querySelectorAll('.msg-focused').forEach(el => el.classList.remove('msg-focused'));
        }

        // --- REPLY FUNCTIONS ---
        
        window.startReply = (msgId, name, text) => {
            window.replyingTo = { id: msgId, name: name, text: text };
            document.getElementById('reply-indicator').classList.remove('hidden');
            document.getElementById('reply-to-name').innerText = name;
            document.getElementById('reply-to-text').innerText = text;
            document.getElementById('message-input').focus();
        };

        window.cancelReply = () => {
            window.replyingTo = null;
            document.getElementById('reply-indicator').classList.add('hidden');
        };

        window.handleReplyAction = () => {
             const textDiv = document.getElementById(`msg-text-${currentActionMsgId}`);
             if(textDiv && currentActionMsgId) {
                  // Hacky way to get name: check if msg-me or msg-them logic used in openChat
                  // For now, assume if I'm replying via modal, it's my message (edit/unsend) or theirs (reply)
                  // But handleReplyAction is in the "Message Options" modal which is mostly for ME
                  // Actually, generic reply from menu:
                  // We need the text and name. The modal is triggered by `openMsgOptions` which is currently only for ME.
                  // But we can enable it for others later.
                  // For "Me", name is "You".
                  startReply(currentActionMsgId, "You", textDiv.innerText);
             }
             closeMsgOptionsModal();
        };

        // -----------------------

        window.toggleReaction = async (chatId, msgId, emoji) => {
            if(!currentUser || !chatId) return;
            const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages', msgId);
            const msgSnap = await getDoc(msgRef);
            if(!msgSnap.exists()) return;
            const reactions = msgSnap.data().reactions || {};
            if(reactions[currentUser.uid] === emoji) {
                delete reactions[currentUser.uid];
            } else {
                reactions[currentUser.uid] = emoji;
            }
            await updateDoc(msgRef, { reactions });
        };
        
        window.openMsgOptions = (msgId, canEdit) => {
            currentActionMsgId = msgId;
            const editBtn = document.getElementById('modal-edit-btn');
            
            if(canEdit) {
                editBtn.classList.remove('hidden');
            } else {
                editBtn.classList.add('hidden');
            }
            
            document.getElementById('msg-options-modal').classList.remove('hidden');
        };
        
        window.closeMsgOptionsModal = () => {
            document.getElementById('msg-options-modal').classList.add('hidden');
            currentActionMsgId = null;
        };
        
        window.handleEditAction = () => {
            if(currentActionMsgId) startEdit(currentActionMsgId);
            closeMsgOptionsModal();
        };
        
        window.handleUnsendAction = () => {
            if(currentActionMsgId) unsendMessage(currentActionMsgId);
            closeMsgOptionsModal();
        };

        window.startEdit = (msgId) => {
             const textDiv = document.getElementById(`msg-text-${msgId}`);
             if(!textDiv) return;
             
             window.editingMsgId = msgId;
             const input = document.getElementById('message-input');
             input.value = textDiv.innerText;
             input.focus();
             
             // Hide reply interface if active
             cancelReply();

             document.getElementById('edit-indicator').classList.remove('hidden');
             document.getElementById('msg-send-icon').classList.remove('fa-paper-plane');
             document.getElementById('msg-send-icon').classList.add('fa-check');
        };

        window.cancelEdit = () => {
             window.editingMsgId = null;
             document.getElementById('message-input').value = '';
             document.getElementById('edit-indicator').classList.add('hidden');
             document.getElementById('msg-send-icon').classList.add('fa-paper-plane');
             document.getElementById('msg-send-icon').classList.remove('fa-check');
        };

        window.unsendMessage = async (msgId) => {
             const confirmed = await showConfirm("Unsend this message?", "Unsend message");
             if(confirmed) {
                 try {
                     const msgDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages', msgId));
                     if (msgDoc.exists() && msgDoc.data().media && msgDoc.data().media.cloudinaryPublicId) {
                         deleteFromCloudinary(msgDoc.data().media.cloudinaryPublicId, msgDoc.data().media.cloudinaryResourceType || 'image');
                     }
                 } catch(e) {}
                 await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages', msgId));
             }
        };
        
        window.backToChatList = () => {
             document.getElementById('msg-list-col').classList.remove('hidden');
             document.getElementById('msg-chat-col').classList.add('hidden');
             document.getElementById('msg-chat-col').classList.remove('flex');
             currentChatId = null;
             cancelEdit();
             cancelReply();
        };
        
        window.deleteChat = async () => {
            const confirmed = await showConfirm("Delete this conversation?", "Delete conversation");
            if(!confirmed) return;
            const s = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages'));
            s.docs.forEach(d => {
                const mData = d.data();
                if (mData.media && mData.media.cloudinaryPublicId) {
                    deleteFromCloudinary(mData.media.cloudinaryPublicId, mData.media.cloudinaryResourceType || 'image');
                }
                deleteDoc(d.ref);
            });
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId));
            
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('start-video-call-btn').classList.add('hidden');
            document.getElementById('start-audio-call-btn').classList.add('hidden');
            document.getElementById('delete-chat-btn').classList.add('hidden');
            document.getElementById('chat-header-name').innerText = "Select a conversation";
            document.getElementById('chat-header-status').classList.add('hidden');
            currentChatId = null;
            cancelEdit();
            cancelReply();
            
            if(window.innerWidth < 768) backToChatList();
        };

        window.sendMessage = async (e) => {
            e.preventDefault(); 
            const i = document.getElementById('message-input'); 
            const text = i.value.trim();
            if(!text && !chatAttachment) return;

            if (window.editingMsgId) {
                // UPDATE EXISTING MESSAGE
                const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages', window.editingMsgId);
                await updateDoc(msgRef, {
                    text: text,
                    edited: true,
                    editedAt: serverTimestamp()
                });
                cancelEdit();
            } else {
                // SEND NEW MESSAGE
                const payload = { 
                    text: text, 
                    senderId: currentUser.uid, 
                    createdAt: serverTimestamp() 
                };

                // Add Reply Data if exists
                if(window.replyingTo) {
                    payload.replyTo = window.replyingTo;
                    cancelReply();
                }

                // Add media/attachment if exists
                if(chatAttachment) {
                    let mediaData = chatAttachment.data;
                    let chatCldPublicId = null;
                    let chatCldResourceType = null;

                    if (chatAttachment.file && cloudinaryConfig) {
                        const cldResult = await uploadToCloudinary(chatAttachment.file, 'lumini_chats');
                        if (cldResult) {
                            mediaData = cldResult.url;
                            chatCldPublicId = cldResult.publicId;
                            chatCldResourceType = cldResult.resourceType;
                        }
                    }

                    payload.media = {
                        type: chatAttachment.type,
                        data: mediaData,
                        name: chatAttachment.name || '',
                        size: chatAttachment.size || '',
                        mimeType: chatAttachment.mimeType || '',
                        cloudinaryPublicId: chatCldPublicId || null,
                        cloudinaryResourceType: chatCldResourceType || null
                    };
                    if(chatAttachment.type === 'voice') {
                        payload.media.duration = chatAttachment.duration || 0;
                        payload.media.waveform = chatAttachment.waveform || [];
                    }
                    clearChatAttachment();
                }

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId, 'messages'), payload);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId), {
                    lastUpdated: serverTimestamp(),
                    readBy: [currentUser.uid],
                    [`typing_${currentUser.uid}`]: false
                }, { merge: true });
                isTyping = false;
                clearTimeout(typingTimeout);
            }
            i.value = '';
        };

        // --- TYPING INDICATOR LOGIC ---
        let typingTimeout = null;
        let isTyping = false;

        // --- LIVE READ RECEIPTS (REMOVED) ---
        window.updateLiveReadReceipts = () => {};


        // --- ONLINE PRESENCE SYSTEM ---
        let presenceInterval = null;

        function startPresence() {
            if (!currentUser) return;
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid);
            
            // Set online immediately
            setDoc(userRef, { isOnline: true, lastSeen: serverTimestamp() }, { merge: true });

            // Heartbeat every 60 seconds
            presenceInterval = setInterval(() => {
                if (currentUser) {
                    setDoc(userRef, { isOnline: true, lastSeen: serverTimestamp() }, { merge: true });
                }
            }, 60000);

            // Helper: set offline via sendBeacon (works during page close)
            function sendOfflineBeacon() {
                if (!currentUser) return;
                const uid = currentUser.uid;
                const firestoreUrl = `https://firestore.googleapis.com/v1/projects/luminix-bcc28/databases/(default)/documents/artifacts/lumini_v1/public/data/users_directory/${uid}?updateMask.fieldPaths=isOnline&updateMask.fieldPaths=lastSeen`;
                const body = JSON.stringify({
                    fields: {
                        isOnline: { booleanValue: false },
                        lastSeen: { timestampValue: new Date().toISOString() }
                    }
                });
                if (navigator.sendBeacon) {
                    navigator.sendBeacon(firestoreUrl + '&currentDocument.exists=true', new Blob([body], { type: 'application/json' }));
                } else {
                    // Fallback: sync XHR (last resort)
                    const xhr = new XMLHttpRequest();
                    xhr.open('PATCH', firestoreUrl, false);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(body);
                }
            }

            // Go offline on page close
            window.addEventListener('beforeunload', sendOfflineBeacon);

            // Also handle pagehide (more reliable on mobile and some browsers)
            window.addEventListener('pagehide', sendOfflineBeacon);

            // Also handle visibilitychange
            document.addEventListener('visibilitychange', () => {
                if (!currentUser) return;
                if (document.visibilityState === 'hidden') {
                    sendOfflineBeacon();
                    setDoc(userRef, { isOnline: false, lastSeen: serverTimestamp() }, { merge: true }).catch(() => {});
                } else {
                    setDoc(userRef, { isOnline: true, lastSeen: serverTimestamp() }, { merge: true });
                }
            });
        }

        function stopPresence() {
            if (presenceInterval) {
                clearInterval(presenceInterval);
                presenceInterval = null;
            }
        }

        window.handleTypingIndicator = () => {
            if(!currentChatId || !currentUser) return;
            
            if(!isTyping) {
                isTyping = true;
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId), {
                    [`typing_${currentUser.uid}`]: true
                }, { merge: true });
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', currentChatId), {
                    [`typing_${currentUser.uid}`]: false
                }, { merge: true });
            }, 2000);
        };
        
        // Monitor typing status of other user
        let unsubscribeTyping = null;
        window._otherUserIsTyping = false;

        function updateLiveReadReceipts(chatId, readBy = []) {
            // Read receipts removed
        }

        function monitorTyping(chatId) {
            if(unsubscribeTyping) unsubscribeTyping();
            window._otherUserIsTyping = false;
            unsubscribeTyping = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), (snap) => {
                if(!snap.exists()) return;
                const data = snap.data();
                const parts = chatId.split('_');
                const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                const otherTyping = data[`typing_${otherUid}`] === true;
                window._otherUserIsTyping = otherTyping;
                
                // Update read receipt state in allChats cache for real-time read status
                if(window.allChats) {
                    const chatObj = window.allChats.find(ch => ch.id === chatId);
                    if(chatObj && data.readBy) chatObj.readBy = data.readBy;
                }
                updateLiveReadReceipts(chatId, data.readBy || []);
                
                const indicator = document.getElementById('typing-indicator-container');
                if(indicator) {
                    indicator.classList.toggle('hidden', !otherTyping);
                    if(otherTyping) {
                        const c = document.getElementById('chat-messages');
                        if(c) c.scrollTop = c.scrollHeight;
                    }
                }
            });
        }

        // --- VERIFIED BADGE LOGIC ---
        window.toggleVerify = async (uid) => {
            if(!currentUser || !checkIsAdmin(currentUser.email)) return;
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', uid);
            const userSnap = await getDoc(userRef);
            const isVerified = userSnap.exists() && userSnap.data().isVerified;
            
            await updateDoc(userRef, { isVerified: !isVerified });
            
            // Update cache
            const cached = allUsersCache.find(u => u.id === uid);
            if(cached) cached.isVerified = !isVerified;
            
            showToast(isVerified ? 'Verification removed' : 'User verified ');
            viewProfile(uid);
        };


        function monitorStories() {
            if (unsubscribeStories) unsubscribeStories();
            // Fetch all stories. In production, use "where" clause for expiresAt.
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'stories'), orderBy('createdAt', 'desc'));
            unsubscribeStories = onSnapshot(q, (snap) => {
                const now = Date.now();
                allStories = [];
                snap.forEach(d => {
                    const data = d.data();
                    const expires = data.expiresAt ? data.expiresAt.toMillis() : 0;
                    if(expires > now) {
                        // FILTER VISIBILITY
                        // If it's a "Close Friends" story:
                        // Only show if I am the author OR if I am in the author's close friend list (targetAudience)
                        if (data.visibility === 'close_friends') {
                            const amIAuthor = data.uid === currentUser.uid;
                            const amIInAudience = data.targetAudience && data.targetAudience.includes(currentUser.uid);
                            
                            if (amIAuthor || amIInAudience) {
                                allStories.push({id: d.id, ...data});
                            }
                        } else {
                            // Public stories - show to everyone
                            allStories.push({id: d.id, ...data});
                        }
                    }
                });
                
                // Group by User
                groupedStories = {};
                allStories.forEach(s => {
                    if(!groupedStories[s.uid]) {
                        groupedStories[s.uid] = {
                            uid: s.uid,
                            name: s.name,
                            photoURL: s.photoURL,
                            items: []
                        };
                    }
                    groupedStories[s.uid].items.push(s);
                });
                
                // Sort items within user by time ascending for viewing
                Object.values(groupedStories).forEach(group => {
                    group.items.sort((a,b) => (a.createdAt.toMillis()) - (b.createdAt.toMillis()));
                });
                
                renderStoriesBar();
            });
        }
        
        function renderStoriesBar() {
            const container = document.getElementById('stories-list');
            if(!container) return;
            
            // Convert groups to array, filter out current user (shown separately)
            const groups = Object.values(groupedStories).filter(g => g.uid !== currentUser.uid);
            
            container.innerHTML = groups.map(g => {
                const lastStory = g.items[g.items.length - 1];
                const ringClass = (lastStory.visibility === 'close_friends') ? 'story-ring-cf' : 'story-ring';
                
                return `
                <div class="flex flex-col items-center gap-2 cursor-pointer min-w-[70px] group" onclick="openStoryViewer('${g.uid}')">
                    <div class="relative w-16 h-16 ${ringClass} group-hover:scale-105 transition-transform">
                         <img src="${g.photoURL}" class="w-full h-full rounded-full border-2 border-white object-cover bg-white">
                    </div>
                    <span class="text-xs font-medium text-slate-600 truncate w-16 text-center">${g.name.split(' ')[0]}</span>
                </div>
            `;
            }).join('');
            
            // Check if user has active story
            const myStory = groupedStories[currentUser.uid];
            const myAvatar = document.getElementById('story-my-avatar');
            const myContainer = myAvatar.parentElement;
            
            if(myStory && myStory.items.length > 0) {
                 const lastMyStory = myStory.items[myStory.items.length - 1];
                 const myRingClass = (lastMyStory.visibility === 'close_friends') ? 'story-ring-cf' : 'story-ring';
                 
                 // Remove both potential classes first to be safe
                 myContainer.classList.remove('story-ring', 'story-ring-cf');
                 myContainer.classList.add(myRingClass);
                 
                 myContainer.parentElement.onclick = () => openStoryViewer(currentUser.uid);
                 myContainer.querySelector('.fa-plus').className = "fa-solid fa-eye";
                 myContainer.querySelector('div.absolute').classList.replace('bg-blue-600', 'bg-slate-700');
            } else {
                 myContainer.classList.remove('story-ring', 'story-ring-cf');
                 myContainer.parentElement.onclick = openStoryUploadModal;
                 myContainer.querySelector('.fa-solid').className = "fa-solid fa-plus";
                 myContainer.querySelector('div.absolute').classList.replace('bg-slate-700', 'bg-blue-600');
            }
        }
        
        window.openStoryUploadModal = () => {
             document.getElementById('story-upload-modal').classList.remove('hidden');
             document.getElementById('story-preview-img').classList.add('hidden');
             document.getElementById('story-preview-video').classList.add('hidden');
             document.getElementById('story-upload-placeholder').classList.remove('hidden');
             document.getElementById('story-upload-progress').classList.add('hidden');
             document.getElementById('story-url-input') && (document.getElementById('story-url-input').value = '');
             const urlPreview = document.getElementById('story-url-preview');
             if(urlPreview) { urlPreview.classList.add('hidden'); urlPreview.innerHTML = ''; }
             
             document.getElementById('btn-upload-story-public').disabled = true;
             document.getElementById('btn-upload-story-cf').disabled = true;
             
             currentStoryUpload = { file: null, type: null, data: null, sourceType: 'upload' };
             setStorySourceType('upload');
        };
        
        window.setStorySourceType = (type) => {
            storySourceType = type;
            if(type === 'upload') {
                document.getElementById('btn-story-upload').className = 'flex-1 py-1.5 rounded-lg text-xs font-bold bg-blue-600 text-white transition-all';
                document.getElementById('btn-story-url').className = 'flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-all';
                document.getElementById('story-upload-area').classList.remove('hidden');
                document.getElementById('story-url-area').classList.add('hidden');
            } else {
                document.getElementById('btn-story-upload').className = 'flex-1 py-1.5 rounded-lg text-xs font-bold bg-slate-100 text-slate-500 transition-all';
                document.getElementById('btn-story-url').className = 'flex-1 py-1.5 rounded-lg text-xs font-bold bg-blue-600 text-white transition-all';
                document.getElementById('story-upload-area').classList.add('hidden');
                document.getElementById('story-url-area').classList.remove('hidden');
            }
        };

        window.handleStoryUrlPaste = () => {
            const url = document.getElementById('story-url-input').value.trim();
            if(!url) return;
            const isVideo = /\.(mp4|webm|mov|ogg|avi|mkv)($|\?)/i.test(url) || url.includes('/video/');
            currentStoryUpload = { file: null, type: isVideo ? 'video' : 'image', data: url, sourceType: 'url', urlValue: url };
            const preview = document.getElementById('story-url-preview');
            preview.classList.remove('hidden');
            if(isVideo) {
                preview.innerHTML = `<video src="${url}" class="w-full h-full object-contain" controls></video>`;
            } else {
                preview.innerHTML = `<img src="${url}" class="w-full h-full object-contain">`;
            }
            document.getElementById('btn-upload-story-public').disabled = false;
            document.getElementById('btn-upload-story-cf').disabled = false;
        };

        window.handleStoryFileSelect = (input) => {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                const isVideo = file.type.startsWith('video/');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const res = e.target.result;
                    currentStoryUpload = { file: file, type: isVideo ? 'video' : 'image', data: res, sourceType: 'upload' };
                    
                    document.getElementById('story-upload-placeholder').classList.add('hidden');
                    if(isVideo) {
                        const vid = document.getElementById('story-preview-video');
                        vid.src = res;
                        vid.classList.remove('hidden');
                        document.getElementById('story-preview-img').classList.add('hidden');
                    } else {
                        const img = document.getElementById('story-preview-img');
                        img.src = res;
                        img.classList.remove('hidden');
                        document.getElementById('story-preview-video').classList.add('hidden');
                    }
                    document.getElementById('btn-upload-story-public').disabled = false;
                    document.getElementById('btn-upload-story-cf').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        };
        
        window.uploadStory = async (visibility) => {
            if(!currentStoryUpload.data) return;
            
            const btnPublic = document.getElementById('btn-upload-story-public');
            const btnCf = document.getElementById('btn-upload-story-cf');
            btnPublic.disabled = true;
            btnCf.disabled = true;
            
            let targetAudience = [];
            if (visibility === 'close_friends') {
                targetAudience = window.userProfileCache?.closeFriends || [];
            }
            
            try {
                const now = new Date();
                const expires = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                
                let mediaUrl = currentStoryUpload.data;
                let cldPublicId = null;
                let cldResourceType = null;

                if (currentStoryUpload.sourceType === 'url') {
                    mediaUrl = currentStoryUpload.urlValue;
                } else if (currentStoryUpload.file && cloudinaryConfig) {
                    document.getElementById('story-upload-progress').classList.remove('hidden');
                    document.getElementById('story-progress-fill').style.width = '40%';
                    const result = await uploadToCloudinary(currentStoryUpload.file, 'lumini_stories');
                    document.getElementById('story-progress-fill').style.width = '90%';
                    if (result) {
                        mediaUrl = result.url;
                        cldPublicId = result.publicId;
                        cldResourceType = result.resourceType;
                    } else {
                        showToast('Upload failed. Try again.');
                        btnPublic.disabled = false;
                        btnCf.disabled = false;
                        document.getElementById('story-upload-progress').classList.add('hidden');
                        return;
                    }
                }

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'stories'), {
                    uid: currentUser.uid,
                    name: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    media: mediaUrl,
                    type: currentStoryUpload.type,
                    likes: 0,
                    likedBy: [],
                    visibility: visibility,
                    targetAudience: targetAudience,
                    cloudinaryPublicId: cldPublicId || null,
                    cloudinaryResourceType: cldResourceType || null,
                    createdAt: serverTimestamp(),
                    expiresAt: expires
                });
                
                document.getElementById('story-upload-progress').classList.add('hidden');
                document.getElementById('story-upload-modal').classList.add('hidden');
            } catch(e) {
                console.error("Story upload failed", e);
                document.getElementById('story-upload-progress').classList.add('hidden');
                await showAlert("Upload failed.", "Story upload");
            } finally {
                btnPublic.disabled = false;
                btnCf.disabled = false;
            }
        };
        
        window.openStoryViewer = (uid) => {
             const group = groupedStories[uid];
             if(!group || !group.items.length) return;
             
             activeStoryUid = uid;
             activeStoryIndex = 0;
             
             document.getElementById('story-viewer-modal').classList.remove('hidden');
             showStory(uid, 0);
        };
        
        window.showStory = (uid, index) => {
            clearTimeout(storyTimer);
            const group = groupedStories[uid];
            if(!group || index >= group.items.length) {
                closeStoryViewer();
                return;
            }
            
            activeStoryIndex = index;
            const story = group.items[index];
            
            // Update Header
            document.getElementById('viewer-avatar').src = group.photoURL;
            document.getElementById('viewer-name').innerText = group.name;
            
            // Time & Badge
            const timeDiff = Date.now() - story.createdAt.toMillis();
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const mins = Math.floor(timeDiff / (1000 * 60));
            document.getElementById('viewer-time').innerText = hours > 0 ? `${hours}h ago` : `${mins}m ago`;
            
            const badge = document.getElementById('viewer-cf-badge');
            if (story.visibility === 'close_friends') {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            // Delete Button visibility
            const deleteBtn = document.getElementById('viewer-delete-btn');
            if (story.uid === currentUser.uid) {
                deleteBtn.classList.remove('hidden');
            } else {
                deleteBtn.classList.add('hidden');
            }
            
            // Show Content
            const imgEl = document.getElementById('viewer-img');
            const vidEl = document.getElementById('viewer-video');
            
            if(story.type === 'video') {
                imgEl.classList.add('hidden');
                vidEl.classList.remove('hidden');
                vidEl.src = story.media;
                vidEl.currentTime = 0;
                vidEl.onended = nextStory;
                vidEl.onloadedmetadata = () => {
                    startStoryProgressBar(group, index, story, vidEl.duration || 5);
                };
                vidEl.play().catch(()=>{});
            } else {
                vidEl.classList.add('hidden');
                imgEl.classList.remove('hidden');
                imgEl.src = story.media;
                storyTimer = setTimeout(nextStory, 5000);
                startStoryProgressBar(group, index, story, 5);
            }

            // Like Button State
            const likeBtn = document.getElementById('story-like-btn');
            const hasLiked = story.likedBy && story.likedBy.includes(currentUser.uid);
            if(hasLiked) {
                likeBtn.innerHTML = '<i class="fa-solid fa-heart text-red-500"></i>';
            } else {
                likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
            }
            
            // Reset Interaction Input
            document.getElementById('story-reply-input').value = "";
            document.getElementById('story-send-btn').classList.add('hidden');
            
            // Render Progress Bars (static parts only; active bar animated by startStoryProgressBar)
            const barContainer = document.getElementById('story-progress-container');
            const count = group.items.length;
            barContainer.innerHTML = '';
            
            for(let i=0; i<count; i++) {
                const bar = document.createElement('div');
                bar.className = "h-1 rounded-full bg-white/30 flex-grow overflow-hidden";
                const inner = document.createElement('div');
                inner.className = "h-full bg-white story-progress-bar";
                inner.dataset.barIndex = i;
                
                if(i < index) inner.style.width = "100%";
                else inner.style.width = "0%";
                
                bar.appendChild(inner);
                barContainer.appendChild(bar);
            }
        };

        function startStoryProgressBar(group, index, story, durationSec) {
            const barContainer = document.getElementById('story-progress-container');
            const bars = barContainer.querySelectorAll('.story-progress-bar');
            bars.forEach(b => {
                const i = parseInt(b.dataset.barIndex);
                if (i === index) {
                    b.style.width = "0%";
                    b.style.transition = "none";
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            b.style.transition = `width ${durationSec}s linear`;
                            b.style.width = "100%";
                        });
                    });
                }
            });
        }
        
        window.deleteStory = async () => {
            if(!activeStoryUid) return;
            const group = groupedStories[activeStoryUid];
            const story = group.items[activeStoryIndex];
            
            if(story.uid !== currentUser.uid) return;
            
            const confirmed = await showConfirm("Delete this story?", "Delete story");
            if(confirmed) {
                try {
                    if (story.cloudinaryPublicId) {
                        deleteFromCloudinary(story.cloudinaryPublicId, story.cloudinaryResourceType || 'image');
                    }
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stories', story.id));
                    closeStoryViewer();
                } catch(e) {
                    console.error("Delete story failed", e);
                    await showAlert("Could not delete this story.", "Delete failed");
                }
            }
        };

        window.handleStoryInput = (input) => {
            const btn = document.getElementById('story-send-btn');
            if(input.value.trim().length > 0) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        };

        window.toggleStoryLike = async () => {
            if(!activeStoryUid) return;
            const group = groupedStories[activeStoryUid];
            if(!group || !group.items || !group.items[activeStoryIndex]) return;
            
            const story = group.items[activeStoryIndex];
            if(!story.likedBy) story.likedBy = [];
            
            const likeBtn = document.getElementById('story-like-btn');
            const hasLiked = story.likedBy.includes(currentUser.uid);
            
            if(!hasLiked) {
                // LIKE LOGIC
                story.likedBy.push(currentUser.uid);
                story.likes = (story.likes || 0) + 1;
                likeBtn.innerHTML = '<i class="fa-solid fa-heart text-red-500"></i>';
                spawnHeartBurst();

                try {
                    const storyRef = doc(db, 'artifacts', appId, 'public', 'data', 'stories', story.id);
                    await updateDoc(storyRef, { likes: increment(1), likedBy: arrayUnion(currentUser.uid) });
                    if(story.uid !== currentUser.uid) {
                        addDoc(collection(db, 'artifacts', appId, 'users', story.uid, 'notifications'), {
                            type: 'story_like', fromUid: currentUser.uid, fromName: currentUser.displayName, read: false, createdAt: serverTimestamp()
                        }).catch(e => console.log("Notif error", e));
                    }
                } catch(e) {
                    console.error("Like failed", e);
                    const idx = story.likedBy.indexOf(currentUser.uid);
                    if(idx > -1) story.likedBy.splice(idx, 1);
                    story.likes--;
                    likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
                }
            } else {
                // UNLIKE LOGIC
                const idx = story.likedBy.indexOf(currentUser.uid);
                if(idx > -1) story.likedBy.splice(idx, 1);
                story.likes = Math.max(0, (story.likes || 0) - 1);
                likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';

                try {
                    const storyRef = doc(db, 'artifacts', appId, 'public', 'data', 'stories', story.id);
                    await updateDoc(storyRef, { likes: increment(-1), likedBy: arrayRemove(currentUser.uid) });
                } catch(e) {
                    console.error("Unlike failed", e);
                    story.likedBy.push(currentUser.uid);
                    story.likes++;
                    likeBtn.innerHTML = '<i class="fa-solid fa-heart text-red-500"></i>';
                }
            }
        };

        window.spawnHeartBurst = () => {
            const container = document.getElementById('story-reaction-container');
            const colors = ['#ef4444', '#ec4899', '#a855f7', '#f43f5e'];
            const animations = ['float-wobble-1', 'float-wobble-2', 'float-straight'];
            
            for(let i=0; i<5; i++) {
                const heart = document.createElement('i');
                heart.className = 'heart-particle fa-solid fa-heart';
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                const randomAnim = animations[Math.floor(Math.random() * animations.length)];
                const randomSize = Math.floor(Math.random() * 20) + 15; 
                const duration = (Math.random() * 1 + 1) + 's';
                const delay = (Math.random() * 0.3) + 's';
                
                heart.style.color = randomColor;
                heart.style.fontSize = randomSize + 'px';
                heart.style.right = (20 + (Math.random()*40)) + 'px';
                heart.style.animation = `${randomAnim} ${duration} ease-out forwards ${delay}`;
                container.appendChild(heart);
                setTimeout(() => { if(heart.parentNode) heart.parentNode.removeChild(heart); }, 2500);
            }
        }

        window.sendStoryReply = async () => {
             const input = document.getElementById('story-reply-input');
             const text = input.value.trim();
             if(!text || !activeStoryUid) return;

             const group = groupedStories[activeStoryUid];
             const story = group.items[activeStoryIndex];
             
             input.value = "";
             document.getElementById('story-send-btn').classList.add('hidden');
             
             // Send as a DM with story context (like Instagram)
             if(story.uid !== currentUser.uid) {
                  // Create/find chat
                  const chatId = [currentUser.uid, story.uid].sort().join('_');
                  const chatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId);
                  const chatSnap = await getDoc(chatRef);
                  if(!chatSnap.exists()) {
                      await setDoc(chatRef, {
                          lastUpdated: serverTimestamp(),
                          participants: [currentUser.uid, story.uid],
                          readBy: [currentUser.uid]
                      });
                  }
                  // Send the message with storyReply context
                  await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), {
                      text: text,
                      senderId: currentUser.uid,
                      createdAt: serverTimestamp(),
                      storyReply: {
                          media: story.media,
                          type: story.type || 'image',
                          ownerName: group.name || 'their'
                      }
                  });
                  await setDoc(chatRef, {
                      lastUpdated: serverTimestamp(),
                      readBy: [currentUser.uid]
                  }, { merge: true });

                  // Also send notification
                  await addDoc(collection(db, 'artifacts', appId, 'users', story.uid, 'notifications'), {
                      type: 'story_reply', 
                      text: text, 
                      fromUid: currentUser.uid, 
                      fromName: currentUser.displayName, 
                      read: false, 
                      createdAt: serverTimestamp()
                  });
             }
             
             const container = document.getElementById('story-reaction-container');
             const feedback = document.createElement('div');
             feedback.innerText = "Sent";
             feedback.className = "absolute bottom-20 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-1 rounded-full text-sm animate-fade-in";
             container.appendChild(feedback);
             setTimeout(() => feedback.remove(), 2000);
        };
        
        window.nextStory = () => {
             showStory(activeStoryUid, activeStoryIndex + 1);
        };
        
        window.prevStory = () => {
             if(activeStoryIndex > 0) {
                 showStory(activeStoryUid, activeStoryIndex - 1);
             } else {
                 showStory(activeStoryUid, 0);
             }
        };
        
        window.closeStoryViewer = () => {
             clearTimeout(storyTimer);
             document.getElementById('story-viewer-modal').classList.add('hidden');
             document.getElementById('viewer-video').pause();
             activeStoryUid = null;
        };
        
        // --- CLOSE FRIENDS LOGIC ---
        
        window.openCloseFriendsModal = () => {
            const modal = document.getElementById('close-friends-modal');
            const list = document.getElementById('close-friends-list');
            modal.classList.remove('hidden');
            renderCloseFriendsList();
        };
        
        window.renderCloseFriendsList = (search = '') => {
            const list = document.getElementById('close-friends-list');
            if(!list) return;
            
            let users = allUsersCache.filter(u => u.id !== currentUser.uid);
            
            if(search.trim()) {
                users = users.filter(u => u.name.toLowerCase().includes(search.toLowerCase()));
            }
            
            const currentCloseFriends = window.userProfileCache?.closeFriends || [];
            
            if(users.length === 0) {
                list.innerHTML = `<p class="text-center text-xs text-slate-400 py-4">No users found.</p>`;
                return;
            }
            
            list.innerHTML = users.map(u => {
                const isCF = currentCloseFriends.includes(u.id);
                return `
                <div class="flex items-center justify-between p-3 hover:bg-slate-50 rounded-xl transition-colors">
                    <div class="flex items-center gap-3">
                        <img src="${u.photoURL}" class="w-10 h-10 rounded-full bg-slate-200 object-cover">
                        <div>
                            <p class="font-bold text-sm text-slate-800">${u.name}</p>
                            <p class="text-xs text-slate-500 truncate w-32">${u.headline || ''}</p>
                        </div>
                    </div>
                    <button onclick="toggleCloseFriend('${u.id}')" class="w-8 h-8 rounded-full flex items-center justify-center transition-all btn-bounce ${isCF ? 'bg-green-500 text-white shadow-md' : 'bg-slate-200 text-slate-400 hover:bg-slate-300'}">
                        <i class="fa-solid fa-star text-sm"></i>
                    </button>
                </div>
                `;
            }).join('');
        };
        
        window.toggleCloseFriend = async (uid) => {
            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
            const currentList = window.userProfileCache?.closeFriends || [];
            const isCF = currentList.includes(uid);
            
            try {
                if(isCF) {
                    await updateDoc(userRef, { closeFriends: arrayRemove(uid) });
                } else {
                    await updateDoc(userRef, { closeFriends: arrayUnion(uid) });
                }
            } catch(e) {
                console.error("Error toggling close friend", e);
            }
        };

        // --- Router & UI Helpers ---

        window.router = (view) => {
            document.querySelectorAll('.view-section').forEach(el => {
                if(!el.classList.contains('hidden')) {
                     el.classList.add('hidden');
                }
            });
            
            const newView = document.getElementById(`view-${view}`);
            newView.classList.remove('hidden');
            void newView.offsetWidth; 
            newView.classList.add('animate-fade-in');

            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            const navLink = document.getElementById(`nav-link-${view}`);
            if(navLink) navLink.classList.add('active');

            // Make messaging full-width, restore for other views
            const mainContainer = document.getElementById('main-container');
            if(view === 'messaging') {
                mainContainer.className = 'col-span-12 w-full animate-slide-up';
                mainContainer.style.maxWidth = 'none';
            } else {
                mainContainer.className = 'col-span-12 max-w-3xl mx-auto w-full animate-slide-up';
                mainContainer.style.maxWidth = '';
            }
            
            if(view === 'saved') renderSavedPosts();
            if(view === 'collaborate') renderCollaborate();
            
            if(view === 'messaging' && window.innerWidth < 768 && !currentChatId) {
                 backToChatList();
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        window.handleGoogleAuth = () => {
             const provider = new GoogleAuthProvider();
             signInWithPopup(auth, provider).catch(e => document.getElementById('auth-error').innerText = e.message);
        };
        
        window.handleEmailAuth = async () => {
             const email = document.getElementById('auth-email').value;
             const pass = document.getElementById('auth-password').value;
             try {
                 await signInWithEmailAndPassword(auth, email, pass);
             } catch(e) {
                 try {
                     await createUserWithEmailAndPassword(auth, email, pass);
                 } catch(err) {
                     document.getElementById('auth-error').innerText = err.message;
                     document.getElementById('auth-error').classList.remove('hidden');
                 }
             }
        };

        window.handleSignOut = async () => {
            if (currentUser) {
                const uid = currentUser.uid;
                try {
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', uid);
                    await setDoc(userRef, { isOnline: false, lastSeen: serverTimestamp() }, { merge: true });
                } catch(e) {}
                stopPresence();
            }
            signOut(auth);
        };

        function updateUI(data) {
             const user = currentUser;
             const name = data.name || user.displayName || user.email.split('@')[0] || "User";
             const pic = data.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;
             const headline = data.headline || ""; 

             document.getElementById('nav-avatar').src = pic;
             document.getElementById('sidebar-mini-avatar').src = pic;
             document.getElementById('menu-avatar-small').src = pic;
             document.getElementById('composer-avatar').src = pic;
             document.getElementById('modal-avatar').src = pic;
             document.getElementById('story-my-avatar').src = pic;
             
             document.getElementById('sidebar-mini-name').innerText = name;
             document.getElementById('menu-name').innerText = name;
             document.getElementById('composer-name-placeholder').innerText = name.split(' ')[0];
             
             document.getElementById('settings-username').value = name;
             document.getElementById('edit-headline').value = headline;
             document.getElementById('edit-bio').value = data.bio || "";
             document.getElementById('edit-modal-avatar').src = pic;

             if(data.theme) {
                if(data.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('lumini_theme', 'dark');
                    const toggle = document.getElementById('dark-mode-toggle');
                    if(toggle) toggle.checked = true;
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('lumini_theme', 'light');
                    const toggle = document.getElementById('dark-mode-toggle');
                    if(toggle) toggle.checked = false;
                }
             }
             
             if(!document.getElementById('close-friends-modal').classList.contains('hidden')) {
                 renderCloseFriendsList();
             }
        }

        // --- Post Rendering ---
        
        window.savePost = async (postId) => {
             const isSaved = mySavedPosts.includes(postId);
             
             if(isSaved) {
                 const idx = mySavedPosts.indexOf(postId);
                 if (idx > -1) mySavedPosts.splice(idx, 1);
                 // Also remove from any collections
                 if(window.mySavedCollections) {
                     Object.keys(window.mySavedCollections).forEach(col => {
                         const arr = window.mySavedCollections[col];
                         const i = arr.indexOf(postId);
                         if(i > -1) arr.splice(i, 1);
                     });
                 }
             } else {
                 mySavedPosts.push(postId);
             }
             
             const btnIcons = document.querySelectorAll(`#post-${postId}-feed .fa-bookmark, #post-${postId}-saved .fa-bookmark, #post-${postId}-profile .fa-bookmark, #post-${postId}-collaborate .fa-bookmark`);
             btnIcons.forEach(btnIcon => {
                 if(isSaved) { 
                     btnIcon.classList.remove('fa-solid', 'text-purple-600');
                     btnIcon.classList.add('fa-regular');
                     btnIcon.parentElement.classList.add('scale-90');
                     setTimeout(() => btnIcon.parentElement.classList.remove('scale-90'), 200);
                 } else { 
                     btnIcon.classList.remove('fa-regular');
                     btnIcon.classList.add('fa-solid', 'text-purple-600');
                     btnIcon.parentElement.classList.add('scale-125');
                     setTimeout(() => btnIcon.parentElement.classList.remove('scale-125'), 200);
                 }
                 const btnText = btnIcon.parentElement; 
                 if(btnText && btnText.innerText.includes('Save')) {
                     btnText.innerText = isSaved ? 'Save' : 'Unsave'; 
                 }
             });
             
             if(!document.getElementById('view-saved').classList.contains('hidden')) {
                 renderSavedPosts();
             }

             const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
             try {
                 if(isSaved) {
                     await updateDoc(userRef, { savedPosts: arrayRemove(postId), savedCollections: window.mySavedCollections || {} });
                 } else {
                     await updateDoc(userRef, { savedPosts: arrayUnion(postId) });
                 }
             } catch(e) {
                 console.error("Save failed", e);
                 if(isSaved) mySavedPosts.push(postId); 
                 else { 
                     const idx = mySavedPosts.indexOf(postId);
                     if(idx > -1) mySavedPosts.splice(idx, 1);
                 }
                 renderFeed(allPostsCache);
                 renderSavedPosts();
             }
        };

        // --- Collection System ---
        window.mySavedCollections = window.mySavedCollections || {};
        window.currentSavedCollection = 'all';
        window._saveLongPressTimer = null;
        window._saveLongPressPostId = null;
        window._saveLongPressTriggered = false;

        // Long press on bookmark to open collection picker
        window.startSaveLongPress = (postId, e) => {
            window._saveLongPressPostId = postId;
            window._saveLongPressTriggered = false;
            window._saveLongPressTimer = setTimeout(() => {
                window._saveLongPressTriggered = true;
                e.preventDefault && e.preventDefault();
                openSaveCollectionModal(postId);
                window._saveLongPressPostId = null;
            }, 500);
        };
        window.cancelSaveLongPress = () => {
            clearTimeout(window._saveLongPressTimer);
        };

        window.openSaveCollectionModal = (postId) => {
            window._collectionModalPostId = postId;
            window._selectedCollection = null;
            const modal = document.getElementById('save-collection-modal');
            modal.classList.remove('hidden');
            document.getElementById('new-collection-inline').classList.add('hidden');
            renderCollectionPickList();
        };

        window.closeSaveCollectionModal = () => {
            document.getElementById('save-collection-modal').classList.add('hidden');
            window._collectionModalPostId = null;
        };

        window.renderCollectionPickList = () => {
            const list = document.getElementById('collection-pick-list');
            const collections = Object.keys(window.mySavedCollections || {});
            let html = `<div class="collection-pick-item ${!window._selectedCollection ? 'selected' : ''}" onclick="selectCollectionPick(null)">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-slate-500"><i class="fa-solid fa-layer-group"></i></div>
                <div class="flex-1"><div class="font-bold text-sm text-slate-800">All Posts</div><div class="text-[10px] text-slate-400">${mySavedPosts.length} saved</div></div>
                ${!window._selectedCollection ? '<i class="fa-solid fa-circle-check text-blue-500"></i>' : ''}
            </div>`;
            collections.forEach(name => {
                const count = (window.mySavedCollections[name] || []).length;
                const isSelected = window._selectedCollection === name;
                html += `<div class="collection-pick-item ${isSelected ? 'selected' : ''}" onclick="selectCollectionPick('${name.replace(/'/g, "\\'")}')">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-100 to-blue-100 flex items-center justify-center text-purple-500"><i class="fa-solid fa-folder"></i></div>
                    <div class="flex-1"><div class="font-bold text-sm text-slate-800">${name}</div><div class="text-[10px] text-slate-400">${count} post${count !== 1 ? 's' : ''}</div></div>
                    ${isSelected ? '<i class="fa-solid fa-circle-check text-blue-500"></i>' : ''}
                </div>`;
            });
            list.innerHTML = html;
        };

        window.selectCollectionPick = (name) => {
            window._selectedCollection = name;
            renderCollectionPickList();
        };

        window.toggleNewCollectionInline = () => {
            const el = document.getElementById('new-collection-inline');
            el.classList.toggle('hidden');
            if(!el.classList.contains('hidden')) {
                document.getElementById('new-collection-name-input').focus();
            }
        };

        window.confirmCreateCollectionInline = async () => {
            const input = document.getElementById('new-collection-name-input');
            const name = input.value.trim();
            if(!name) return;
            if(!window.mySavedCollections) window.mySavedCollections = {};
            if(window.mySavedCollections[name]) { showToast('Collection already exists'); return; }
            window.mySavedCollections[name] = [];
            input.value = '';
            document.getElementById('new-collection-inline').classList.add('hidden');
            // Save to DB
            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
            await updateDoc(userRef, { savedCollections: window.mySavedCollections });
            renderCollectionPickList();
            renderCollectionTabs();
            showToast(`Collection "${name}" created`);
        };

        window.confirmSaveToCollection = async () => {
            const postId = window._collectionModalPostId;
            if(!postId) return;
            // Ensure post is saved first
            if(!mySavedPosts.includes(postId)) {
                mySavedPosts.push(postId);
                const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
                await updateDoc(userRef, { savedPosts: arrayUnion(postId) });
                // Update bookmark icons
                const btnIcons = document.querySelectorAll(`#post-${postId}-feed .fa-bookmark, #post-${postId}-saved .fa-bookmark, #post-${postId}-profile .fa-bookmark, #post-${postId}-collaborate .fa-bookmark`);
                btnIcons.forEach(btnIcon => {
                    btnIcon.classList.remove('fa-regular');
                    btnIcon.classList.add('fa-solid', 'text-purple-600');
                });
            }
            // Add to selected collection
            const colName = window._selectedCollection;
            if(colName && window.mySavedCollections[colName]) {
                if(!window.mySavedCollections[colName].includes(postId)) {
                    window.mySavedCollections[colName].push(postId);
                }
            }
            // Save collections to DB
            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
            await updateDoc(userRef, { savedCollections: window.mySavedCollections });
            closeSaveCollectionModal();
            renderSavedPosts();
            showToast(colName ? `Saved to "${colName}"` : 'Saved to All');
        };

        // Standalone create collection from Saved view
        window.openCreateCollectionModal = () => {
            document.getElementById('create-collection-modal').classList.remove('hidden');
            document.getElementById('standalone-collection-name').value = '';
            setTimeout(() => document.getElementById('standalone-collection-name').focus(), 100);
        };

        window.createStandaloneCollection = async () => {
            const input = document.getElementById('standalone-collection-name');
            const name = input.value.trim();
            if(!name) return;
            if(!window.mySavedCollections) window.mySavedCollections = {};
            if(window.mySavedCollections[name]) { showToast('Collection already exists'); return; }
            window.mySavedCollections[name] = [];
            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
            await updateDoc(userRef, { savedCollections: window.mySavedCollections });
            document.getElementById('create-collection-modal').classList.add('hidden');
            renderCollectionTabs();
            showToast(`Collection "${name}" created`);
        };

        window.switchCollection = (name) => {
            window.currentSavedCollection = name;
            document.querySelectorAll('.collection-tab').forEach(tab => tab.classList.remove('active-collection'));
            const tabs = document.querySelectorAll('.collection-tab[data-collection]');
            tabs.forEach(t => { if(t.dataset.collection === name) t.classList.add('active-collection'); });
            renderSavedPosts();
        };

        window.renderCollectionTabs = () => {
            const container = document.getElementById('collection-tabs-container');
            if(!container) return;
            const cols = Object.keys(window.mySavedCollections || {});
            let html = `<button onclick="switchCollection('all')" class="collection-tab ${window.currentSavedCollection === 'all' ? 'active-collection' : ''}" data-collection="all">
                <i class="fa-solid fa-layer-group mr-1.5 text-xs"></i> All
            </button>`;
            cols.forEach(name => {
                const count = (window.mySavedCollections[name] || []).length;
                html += `<button onclick="switchCollection('${name.replace(/'/g, "\\'")}')" class="collection-tab ${window.currentSavedCollection === name ? 'active-collection' : ''}" data-collection="${name}">
                    <i class="fa-solid fa-folder mr-1.5 text-xs"></i> ${name} <span class="ml-1 text-[10px] opacity-60">${count}</span>
                </button>`;
            });
            container.innerHTML = html;
        };

        function createPostHTML(post, context) {
            const isProject = post.type === 'project';
            const tags = post.tags ? post.tags.map(t => `<span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md hover:bg-blue-100 transition-colors cursor-pointer">#${t}</span>`).join('') : '';
            const hasLiked = post.likedBy && post.likedBy.includes(currentUser.uid);
            const isSaved = mySavedPosts.includes(post.id);
            const likeIconClass = hasLiked ? "fa-solid text-blue-600 scale-110" : "fa-regular";
            const saveIconClass = isSaved ? "fa-solid text-purple-600 scale-110" : "fa-regular";
            const saveText = isSaved ? "Unsave" : "Save";
            
            let taggedHTML = '';
            if(post.taggedUsers && post.taggedUsers.length > 0) {
                const names = post.taggedUsers.map(u => `<span class="font-bold hover:underline cursor-pointer" onclick="viewProfile('${u.id}')">${u.name}</span>`).join(', ');
                taggedHTML = ` <span class="text-slate-500 font-normal">is with ${names}</span>`;
            }
            
            const isAdmin = checkIsAdmin(currentUser.email);
            const canDelete = currentUser.uid === post.uid || isAdmin;
            const canEdit = currentUser.uid === post.uid;

            const postAuthor = allUsersCache.find(u => u.id === post.uid);
            const postAuthorIsAdmin = postAuthor?.isAdmin;
            const adminBadge = postAuthorIsAdmin ? `<span class="admin-badge">Admin </span>` : '';
            const verifiedBadge = postAuthor?.isVerified ? `<span class="verified-badge" title="Verified"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#2563eb"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>` : '';

            return `<div id="post-${post.id}-${context}" class="glass-card rounded-2xl bg-white p-0 overflow-hidden animate-slide-up mb-4 hover:shadow-lg transition-shadow duration-300">
                <div class="p-4 flex gap-3">
                    <img src="${post.photoURL}" class="w-10 h-10 rounded-full bg-slate-100 object-cover cursor-pointer hover:scale-105 transition-transform" onclick="viewProfile('${post.uid}')">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">
                                    <span class="hover:underline cursor-pointer transition-colors hover:text-blue-600" onclick="viewProfile('${post.uid}')">${post.name}</span>${verifiedBadge}${adminBadge}${taggedHTML}
                                </h4>
                                <p class="text-xs text-slate-400">${post.headline || 'Member'}</p>
                            </div>
                            <div class="relative">
                                <button onclick="toggleMenu('${post.id}', '${context}')" class="text-slate-400 hover:bg-slate-100 w-8 h-8 rounded-full transition-colors btn-bounce"><i class="fa-solid fa-ellipsis"></i></button>
                                <div id="menu-${post.id}-${context}" class="hidden absolute right-0 top-8 bg-white shadow-xl border border-slate-100 rounded-xl py-2 w-32 z-10 animate-pop-in origin-top-right">
                                    <button onclick="savePost('${post.id}')" class="w-full text-left px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm font-medium transition-colors">${saveText}</button>
                                    ${canEdit ? `<button onclick="editPost('${post.id}')" class="w-full text-left px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm font-medium transition-colors">Edit</button>` : ''}
                                    ${canDelete ? `<button onclick="initiateDelete('${post.id}', '${post.uid}')" class="w-full text-left px-4 py-2 text-red-500 hover:bg-red-50 text-sm font-bold transition-colors">Delete</button>` : ''}
                                    <button onclick="reportPost('${post.id}', '${post.uid}')" class="w-full text-left px-4 py-2 text-orange-500 hover:bg-orange-50 text-sm font-medium transition-colors">Report</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="px-4 pb-2">
                    ${isProject ? '<span class="inline-block bg-gradient-to-r from-blue-600 to-purple-600 text-white text-[10px] font-bold px-2 py-1 rounded-full mb-2 animate-pulse-slow"><i class="fa-solid fa-rocket mr-1"></i> PROJECT</span>' : ''}
                    <p class="text-slate-700 text-sm whitespace-pre-line leading-relaxed">${post.text}</p>
                    <div class="mt-2 flex flex-wrap gap-2">${tags}</div>
                </div>
                ${post.attachment ? `<div class="mt-2 overflow-hidden bg-slate-100 flex items-center justify-center">${(post.attachmentType === 'video' || post.attachment.match(/\.(mp4|webm|mov|ogg)($|\?)/i) || post.attachment.includes('/video/upload/')) ? `<div class="post-video-wrapper paused pv-show-controls"><video src="${post.attachment}" class="w-full max-h-[500px] object-contain" preload="metadata" playsinline></video><button class="post-video-big-play"><i class="fa-solid fa-play" style="margin-left:3px"></i></button><div class="post-video-controls"><div class="pv-row"><button class="pv-play-btn"><i class="fa-solid fa-play"></i></button><div class="pv-progress-track"><div class="pv-progress-fill" style="width:0%"></div><div class="pv-progress-thumb" style="left:0%"></div></div><span class="pv-time">0:00 / 0:00</span><button class="pv-vol-btn"><i class="fa-solid fa-volume-high"></i></button><button class="pv-fs-btn"><i class="fa-solid fa-expand"></i></button></div></div></div>` : `<img src="${post.attachment}" class="w-full max-h-[500px] object-contain hover:scale-[1.01] transition-transform duration-500 cursor-pointer" onclick="openLightbox(this.src)">`}</div>` : ''}
                <div class="px-4 py-3 border-t border-slate-100 flex gap-1">
                    <button onclick="toggleLike('${post.id}')" class="flex-1 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 text-slate-500 font-medium text-sm btn-bounce group"><i class="${likeIconClass} fa-heart text-lg transition-transform group-hover:scale-125"></i> <span class="${hasLiked ? 'text-blue-600' : ''}">${post.likes || 0}</span></button>
                    <button onclick="toggleCommentSection('${post.id}', '${context}')" class="flex-1 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 text-slate-500 font-medium text-sm btn-bounce group"><i class="fa-regular fa-comment text-lg transition-transform group-hover:scale-125"></i> <span id="comment-count-${post.id}-${context}" class="comment-count-bubble ${(post.commentCount || 0) > 0 ? 'has-comments' : ''}">${post.commentCount || 0}</span></button>
                    <button onclick="if(window._saveLongPressTriggered){window._saveLongPressTriggered=false;return;}savePost('${post.id}')" onmousedown="startSaveLongPress('${post.id}', event)" onmouseup="cancelSaveLongPress()" onmouseleave="cancelSaveLongPress()" ontouchstart="startSaveLongPress('${post.id}', event)" ontouchend="cancelSaveLongPress()" ontouchcancel="cancelSaveLongPress()" class="flex-1 py-2 rounded-lg hover:bg-slate-50 transition-colors flex items-center justify-center gap-2 text-slate-500 font-medium text-sm btn-bounce group"><i class="${saveIconClass} fa-bookmark text-lg transition-transform group-hover:scale-125"></i></button>
                </div>
                 <div id="comments-${post.id}-${context}" class="hidden mt-0 bg-slate-50/50 p-4 border-t border-slate-100 animate-slide-up">
                    <div id="comments-list-${post.id}-${context}" class="space-y-3 mb-3 max-h-60 overflow-y-auto custom-scrollbar"></div>
                    <div class="flex gap-2 items-center">
                        <img src="${document.getElementById('nav-avatar').src}" class="w-8 h-8 rounded-full">
                        <div class="flex-grow bg-white border border-slate-200 rounded-full px-4 py-2 flex items-center shadow-sm focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                            <input type="text" id="comment-input-${post.id}-${context}" placeholder="Write a comment..." class="bg-transparent w-full text-sm outline-none" onkeydown="if(event.key==='Enter') submitComment('${post.id}', '${context}')">
                            <button onclick="submitComment('${post.id}', '${context}')" class="text-blue-600 ml-2 hover:bg-blue-50 p-1 rounded-full transition-colors"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function pvFmtTime(s) { if(isNaN(s)||!isFinite(s)) return '0:00'; const m = Math.floor(s/60); return m + ':' + String(Math.floor(s%60)).padStart(2,'0'); }

        function pvTogglePlay(wrapper) {
            const v = wrapper.querySelector('video');
            if(!v) return;
            if(v.paused) { v.play().catch(()=>{}); } else { v.pause(); }
        }

        function pvSyncUI(wrapper) {
            const v = wrapper.querySelector('video');
            if(!v) return;
            const paused = v.paused;
            if(paused) wrapper.classList.add('paused'); else wrapper.classList.remove('paused');
            const icon = paused ? 'fa-play' : 'fa-pause';
            const btn = wrapper.querySelector('.pv-play-btn i');
            if(btn) btn.className = 'fa-solid ' + icon;
            const big = wrapper.querySelector('.post-video-big-play i');
            if(big) { big.className = 'fa-solid ' + (paused ? 'fa-play' : 'fa-pause'); big.style.marginLeft = paused ? '3px' : '0'; }
        }

        function pvUpdateProgress(wrapper) {
            const v = wrapper.querySelector('video');
            if(!v || !v.duration || wrapper.classList.contains('pv-scrubbing')) return;
            const pct = (v.currentTime / v.duration * 100);
            const fill = wrapper.querySelector('.pv-progress-fill');
            const thumb = wrapper.querySelector('.pv-progress-thumb');
            const time = wrapper.querySelector('.pv-time');
            if(fill) fill.style.width = pct + '%';
            if(thumb) thumb.style.left = pct + '%';
            if(time) time.textContent = pvFmtTime(v.currentTime) + ' / ' + pvFmtTime(v.duration);
        }

        function pvSeekTo(wrapper, track, clientX) {
            const v = wrapper.querySelector('video');
            if(!v || !v.duration) return;
            const rect = track.getBoundingClientRect();
            const pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
            v.currentTime = pct * v.duration;
            const fill = wrapper.querySelector('.pv-progress-fill');
            const thumb = wrapper.querySelector('.pv-progress-thumb');
            if(fill) fill.style.width = (pct*100) + '%';
            if(thumb) thumb.style.left = (pct*100) + '%';
        }

        let _pvDragCtx = null;
        function pvStartScrub(e, track) {
            e.preventDefault(); e.stopPropagation();
            const wrapper = track.closest('.post-video-wrapper');
            wrapper.classList.add('pv-scrubbing');
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            pvSeekTo(wrapper, track, clientX);
            _pvDragCtx = { wrapper, track };
        }
        document.addEventListener('mousemove', e => { if(_pvDragCtx) { e.preventDefault(); pvSeekTo(_pvDragCtx.wrapper, _pvDragCtx.track, e.clientX); } });
        document.addEventListener('touchmove', e => { if(_pvDragCtx && e.touches[0]) { pvSeekTo(_pvDragCtx.wrapper, _pvDragCtx.track, e.touches[0].clientX); } }, {passive:true});
        function pvEndScrub() { if(_pvDragCtx) { _pvDragCtx.wrapper.classList.remove('pv-scrubbing'); _pvDragCtx = null; } }
        document.addEventListener('mouseup', pvEndScrub);
        document.addEventListener('touchend', pvEndScrub);
        document.addEventListener('touchcancel', pvEndScrub);

        function pvToggleMute(wrapper) {
            const v = wrapper.querySelector('video');
            if(!v) return;
            v.muted = !v.muted;
            const btn = wrapper.querySelector('.pv-vol-btn i');
            if(btn) btn.className = 'fa-solid ' + (v.muted ? 'fa-volume-xmark' : 'fa-volume-high');
        }
        function pvFullscreen(wrapper) {
            const v = wrapper.querySelector('video');
            if(!v) return;
            if(v.requestFullscreen) v.requestFullscreen(); else if(v.webkitEnterFullscreen) v.webkitEnterFullscreen();
        }

        function pvInitVideos(container) {
            (container || document).querySelectorAll('.post-video-wrapper').forEach(wrapper => {
                const v = wrapper.querySelector('video');
                if(!v || v._pvInit) return;
                v._pvInit = true;
                let _hideTimer = null;
                const showControls = () => { wrapper.classList.add('pv-show-controls'); clearTimeout(_hideTimer); };
                const hideControlsDelayed = () => { clearTimeout(_hideTimer); _hideTimer = setTimeout(() => { if(!v.paused && !wrapper.classList.contains('pv-scrubbing')) wrapper.classList.remove('pv-show-controls'); }, 2500); };
                const flashControls = () => { showControls(); hideControlsDelayed(); };

                v.addEventListener('timeupdate', () => pvUpdateProgress(wrapper));
                v.addEventListener('loadedmetadata', () => {
                    const time = wrapper.querySelector('.pv-time');
                    if(time) time.textContent = '0:00 / ' + pvFmtTime(v.duration);
                });
                v.addEventListener('play', () => { pvSyncUI(wrapper); flashControls(); });
                v.addEventListener('pause', () => { pvSyncUI(wrapper); showControls(); });
                v.addEventListener('ended', () => { pvSyncUI(wrapper); showControls(); });

                v.addEventListener('click', (e) => { e.stopPropagation(); pvTogglePlay(wrapper); flashControls(); });

                const bigPlay = wrapper.querySelector('.post-video-big-play');
                if(bigPlay) bigPlay.addEventListener('click', (e) => { e.stopPropagation(); pvTogglePlay(wrapper); });

                const playBtn = wrapper.querySelector('.pv-play-btn');
                if(playBtn) playBtn.addEventListener('click', (e) => { e.stopPropagation(); pvTogglePlay(wrapper); });

                const volBtn = wrapper.querySelector('.pv-vol-btn');
                if(volBtn) volBtn.addEventListener('click', (e) => { e.stopPropagation(); pvToggleMute(wrapper); });

                const fsBtn = wrapper.querySelector('.pv-fs-btn');
                if(fsBtn) fsBtn.addEventListener('click', (e) => { e.stopPropagation(); pvFullscreen(wrapper); });

                const track = wrapper.querySelector('.pv-progress-track');
                if(track) {
                    track.addEventListener('mousedown', (e) => pvStartScrub(e, track));
                    track.addEventListener('touchstart', (e) => pvStartScrub(e, track), {passive:false});
                    track.addEventListener('click', (e) => { e.stopPropagation(); pvSeekTo(wrapper, track, e.clientX); });
                }

                wrapper.addEventListener('mouseenter', flashControls);
                wrapper.addEventListener('mouseleave', () => { if(!v.paused && !wrapper.classList.contains('pv-scrubbing')) { clearTimeout(_hideTimer); _hideTimer = setTimeout(() => wrapper.classList.remove('pv-show-controls'), 400); } });
                wrapper.addEventListener('touchstart', () => { if(wrapper.classList.contains('pv-show-controls') && !v.paused) { wrapper.classList.remove('pv-show-controls'); } else { flashControls(); } }, {passive:true});

                showControls();
            });
        }

        function saveVideoStates(container) {
             const states = {};
             container.querySelectorAll('video').forEach(v => {
                 const postEl = v.closest('[id^="post-"]');
                 if (postEl) {
                     states[postEl.id] = { time: v.currentTime, playing: !v.paused, src: v.src };
                 }
             });
             return states;
        }
        function restoreVideoStates(container, states) {
             Object.keys(states).forEach(pid => {
                 const postEl = document.getElementById(pid);
                 if (!postEl) return;
                 const video = postEl.querySelector('video');
                 if (video && states[pid].src === video.src) {
                     video.currentTime = states[pid].time;
                     if (states[pid].playing) video.play().catch(() => {});
                 }
             });
        }

        window.renderFeed = (posts) => {
             const container = document.getElementById('feed-stream');
             if(!posts.length) { container.innerHTML = `<div class="text-center py-12 text-slate-400 animate-fade-in">No posts yet.</div>`; return; }
             const vs = saveVideoStates(container);
             container.innerHTML = posts.map(p => createPostHTML(p, 'feed')).join('');
             restoreVideoStates(container, vs);
             pvInitVideos(container);
        };
        
        window.renderSavedPosts = () => {
             const container = document.getElementById('saved-posts-stream');
             const activeCollection = window.currentSavedCollection || 'all';
             let savedIds;
             if(activeCollection === 'all') {
                 savedIds = mySavedPosts;
             } else {
                 savedIds = (window.mySavedCollections && window.mySavedCollections[activeCollection]) || [];
             }
             const saved = allPostsCache.filter(p => savedIds.includes(p.id));
             const countEl = document.getElementById('saved-count');
             if(countEl) countEl.innerText = mySavedPosts.length;
             renderCollectionTabs();
             if(!saved.length) { 
                 const emptyMsg = activeCollection === 'all' 
                     ? 'Posts you save will appear here. Tap the bookmark icon on any post to save it.'
                     : `No posts in "${activeCollection}" yet. Hold the bookmark icon to save posts here.`;
                 const emptyTitle = activeCollection === 'all' ? 'Nothing saved yet' : `"${activeCollection}" is empty`;
                 container.innerHTML = `
                 <div class="text-center py-16 animate-fade-in">
                     <div class="saved-empty-icon inline-block mb-4">
                         <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-100 to-blue-100 flex items-center justify-center mx-auto shadow-lg shadow-purple-100">
                             <i class="fa-regular fa-bookmark text-3xl text-purple-400"></i>
                         </div>
                     </div>
                     <h3 class="font-heading font-bold text-lg text-slate-600 mb-2">${emptyTitle}</h3>
                     <p class="text-sm text-slate-400 max-w-xs mx-auto">${emptyMsg}</p>
                 </div>`; 
                 return; 
             }
             const vs = saveVideoStates(container);
             container.innerHTML = saved.map(p => createPostHTML(p, 'saved')).join('');
             restoreVideoStates(container, vs);
             pvInitVideos(container);
        };

        window.renderCollaborate = () => {
            const container = document.getElementById('collaborate-stream');
            if(!container) return;

            let projects = allPostsCache.filter(p => p.type === 'project');

            if(window.currentCollabFilter !== 'all') {
                projects = projects.filter(p => {
                    const text = (p.text + ' ' + (p.tags||[]).join(' ')).toLowerCase();
                    return text.includes(window.currentCollabFilter.toLowerCase());
                });
            }

            if(!projects.length) {
                container.innerHTML = `<div class="text-center py-12 text-slate-400 animate-fade-in">No active projects found for this category.</div>`;
                return;
            }

            container.innerHTML = projects.map(p => createPostHTML(p, 'collaborate')).join('');
        };

        window.filterCollaborate = (filter) => {
            window.currentCollabFilter = filter;
            document.querySelectorAll('#collab-filters button').forEach(btn => {
                btn.className = "collab-filter-pill px-5 py-2 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition-all whitespace-nowrap hover:shadow-md btn-bounce";
            });
            const activeBtn = document.getElementById(`filter-${filter}`);
            if(activeBtn) {
                 activeBtn.className = "collab-filter-pill active-filter px-5 py-2 rounded-full text-sm font-bold border border-slate-200 bg-slate-900 text-white transition-all whitespace-nowrap shadow-md btn-bounce";
            }
            renderCollaborate();
        };

        function renderNetwork(users) {
            const g = document.getElementById('network-grid');
            const countEl = document.getElementById('network-count');
            if(countEl) countEl.innerText = users.length;
            
            if(!users.length) { 
                if(currentUser) {
                     g.innerHTML = `<p class="col-span-2 text-center text-slate-400 animate-fade-in py-12"><i class="fa-solid fa-spinner fa-spin text-2xl mb-3 block"></i>Initializing your network...</p>`;
                     return;
                }
                g.innerHTML = `<p class="col-span-2 text-center text-slate-400 animate-fade-in py-12">No users found.</p>`; 
                return; 
            }
            g.innerHTML = users.map((u, i) => `
            <div class="glass-card network-card rounded-2xl p-5 animate-pop-in" style="animation-delay: ${i * 0.06}s;" onclick="viewProfile('${u.id}')">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <img src="${u.photoURL}" class="network-avatar w-14 h-14 rounded-full bg-slate-100 object-cover ring-2 ring-white shadow-md">
                    </div>
                    <div class="flex-grow min-w-0">
                        <h4 class="font-bold text-slate-800 text-sm truncate">${u.name}</h4>
                        <p class="text-xs text-slate-500 truncate mt-0.5">${u.headline || 'Member'}</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <button onclick="event.stopPropagation(); startChat('${u.id}', '${u.name}')" class="network-action w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 hover:scale-110 transition-all z-10 btn-bounce" title="Message">
                            <i class="fa-regular fa-comment-dots"></i>
                        </button>
                        <button onclick="event.stopPropagation(); viewProfile('${u.id}')" class="network-action w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 hover:scale-110 transition-all z-10 btn-bounce" title="View Profile" style="transition-delay: 0.05s;">
                            <i class="fa-solid fa-arrow-right text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>`).join('');
        }

        window.startChat = async (uid, name) => {
            if(uid === currentUser.uid) return;
            const chatId = [currentUser.uid, uid].sort().join('_');
            const chatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId);
            const chatSnap = await getDoc(chatRef);
            
            if(!chatSnap.exists()) {
                await setDoc(chatRef, {
                    createdAt: serverTimestamp(),
                    lastUpdated: serverTimestamp(),
                    participants: [currentUser.uid, uid],
                    readBy: [currentUser.uid]
                });
            }
            openChat(chatId, name);
        };

        window.toggleLike = async (postId) => {
             const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
             const p = allPostsCache.find(x => x.id === postId);
             if(!p) return;
             const hasLiked = p.likedBy && p.likedBy.includes(currentUser.uid);
             
             const btns = document.querySelectorAll(`[id^="post-${postId}-"] .fa-heart`);
             btns.forEach(btn => {
                 if(hasLiked) {
                     btn.classList.remove('fa-solid', 'text-blue-600');
                     btn.classList.add('fa-regular');
                 } else {
                     btn.classList.remove('fa-regular');
                     btn.classList.add('fa-solid', 'text-blue-600', 'scale-125');
                     setTimeout(() => btn.classList.remove('scale-125'), 200);
                 }
                 const countSpan = btn.nextElementSibling;
                 if(countSpan) {
                     let count = parseInt(countSpan.innerText) || 0;
                     countSpan.innerText = hasLiked ? Math.max(0, count - 1) : count + 1;
                     if (hasLiked) countSpan.classList.remove('text-blue-600');
                     else countSpan.classList.add('text-blue-600');
                 }
             });
             
             if(hasLiked) {
                 await updateDoc(postRef, { likes: increment(-1), likedBy: arrayRemove(currentUser.uid) });
             } else {
                 await updateDoc(postRef, { likes: increment(1), likedBy: arrayUnion(currentUser.uid) });
                 if(p.uid !== currentUser.uid) {
                      addDoc(collection(db, 'artifacts', appId, 'users', p.uid, 'notifications'), {
                          type: 'like', postId: postId, fromUid: currentUser.uid, fromName: document.getElementById('menu-name').innerText, read: false, createdAt: serverTimestamp()
                      });
                 }
             }
        };

        window.toggleMenu = (pid, ctx) => document.getElementById(`menu-${pid}-${ctx}`).classList.toggle('hidden');
        
        window.toggleCommentSection = (pid, ctx) => {
            const el = document.getElementById(`comments-${pid}-${ctx}`);
            if(window._pendingCommentHighlight) {
                if(el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    loadComments(pid, ctx);
                }
            } else {
                el.classList.toggle('hidden');
                if(!el.classList.contains('hidden')) loadComments(pid, ctx);
            }
        };

        window.loadComments = (pid, ctx) => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'posts', pid, 'comments'), orderBy('createdAt', 'asc'));
            onSnapshot(q, (snap) => {
                const list = document.getElementById(`comments-list-${pid}-${ctx}`);
                list.innerHTML = '';
                snap.forEach(d => {
                    const c = d.data();
                    const commentId = d.id;
                    const isMyComment = c.uid === currentUser.uid;
                    const isAdmin = checkIsAdmin(currentUser.email);
                    const canDelete = isMyComment || isAdmin;
                    const replyToHtml = c.replyToName ? `<p class="text-[10px] text-blue-500 font-semibold mb-0.5"><i class="fa-solid fa-reply text-[8px] mr-1"></i>Replying to ${c.replyToName}</p>` : '';
                    list.innerHTML += `<div id="comment-${commentId}" class="flex gap-2 animate-fade-in group/comment rounded-lg p-1 transition-all"><img src="${c.photoURL}" class="w-6 h-6 rounded-full mt-1 cursor-pointer" onclick="viewProfile('${c.uid}')">
                    <div class="flex-1 min-w-0">
                        <div class="bg-white p-2 rounded-r-xl rounded-bl-xl shadow-sm border border-slate-100 text-sm">
                            ${replyToHtml}
                            <p class="font-bold text-xs text-slate-800">${c.name}</p>
                            <p class="text-slate-600">${c.text}</p>
                        </div>
                        <div class="flex items-center gap-3 mt-0.5 ml-1 opacity-0 group-hover/comment:opacity-100 transition-opacity">
                            <button onclick="replyToComment('${pid}','${ctx}','${commentId}','${c.name.replace(/'/g, "\\'")}')"
                                class="text-[10px] text-slate-400 hover:text-blue-500 font-semibold transition-colors">Reply</button>
                            ${canDelete ? `<button onclick="deleteComment('${pid}','${ctx}','${commentId}')" class="text-[10px] text-slate-400 hover:text-red-500 font-semibold transition-colors">Delete</button>` : ''}
                        </div>
                    </div></div>`;
                });
                list.scrollTop = list.scrollHeight;
                const realTotal = snap.size;
                document.querySelectorAll(`[id^="comment-count-${pid}-"]`).forEach(el => {
                    const prev = parseInt(el.textContent) || 0;
                    el.textContent = realTotal;
                    if(realTotal > 0) el.classList.add('has-comments');
                    else el.classList.remove('has-comments');
                    if(realTotal !== prev) {
                        el.style.transform = 'scale(1.3)';
                        setTimeout(() => el.style.transform = '', 300);
                    }
                });
                const cached = allPostsCache.find(x => x.id === pid);
                if(cached) cached.commentCount = realTotal;
                
                // Check if we need to highlight a specific comment
                if(window._pendingCommentHighlight) {
                    const targetEl = document.getElementById(`comment-${window._pendingCommentHighlight}`);
                    if(targetEl) {
                        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetEl.classList.add('comment-highlight-flash');
                        setTimeout(() => targetEl.classList.remove('comment-highlight-flash'), 2500);
                        window._pendingCommentHighlight = null;
                    }
                }
            });
        };

        window._commentReplyState = {};

        window.replyToComment = (pid, ctx, commentId, commentAuthorName) => {
            window._commentReplyState[pid + '-' + ctx] = { commentId, commentAuthorName };
            const inp = document.getElementById(`comment-input-${pid}-${ctx}`);
            if(inp) {
                inp.placeholder = `Replying to ${commentAuthorName}...`;
                inp.focus();
                let cancelBtn = document.getElementById(`cancel-reply-${pid}-${ctx}`);
                if(!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = `cancel-reply-${pid}-${ctx}`;
                    cancelBtn.className = 'text-slate-400 hover:text-red-500 text-xs ml-1 transition-colors flex-shrink-0';
                    cancelBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                    cancelBtn.onclick = () => cancelCommentReply(pid, ctx);
                    inp.parentElement.insertBefore(cancelBtn, inp.parentElement.querySelector('button'));
                }
            }
        };

        window.cancelCommentReply = (pid, ctx) => {
            delete window._commentReplyState[pid + '-' + ctx];
            const inp = document.getElementById(`comment-input-${pid}-${ctx}`);
            if(inp) inp.placeholder = 'Write a comment...';
            const cancelBtn = document.getElementById(`cancel-reply-${pid}-${ctx}`);
            if(cancelBtn) cancelBtn.remove();
        };

        window.deleteComment = async (pid, ctx, commentId) => {
            const confirmed = await showConfirm('Delete this comment?', 'Delete comment');
            if(!confirmed) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', pid, 'comments', commentId));
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', pid), { commentCount: increment(-1) });
            document.querySelectorAll(`[id^="comment-count-${pid}-"]`).forEach(el => {
                const newCount = Math.max(0, (parseInt(el.textContent) || 0) - 1);
                el.textContent = newCount;
                if(newCount === 0) el.classList.remove('has-comments');
            });
        };

        window.submitComment = async (pid, ctx) => {
            const inp = document.getElementById(`comment-input-${pid}-${ctx}`);
            if(!inp.value.trim()) return;
            const commentText = inp.value;
            const myName = document.getElementById('menu-name').innerText;
            const replyState = window._commentReplyState[pid + '-' + ctx];
            const commentData = {
                text: commentText,
                uid: currentUser.uid,
                name: myName,
                photoURL: document.getElementById('nav-avatar').src,
                createdAt: serverTimestamp()
            };
            if(replyState) {
                commentData.replyToCommentId = replyState.commentId;
                commentData.replyToName = replyState.commentAuthorName;
            }
            const newCommentRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts', pid, 'comments'), commentData);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', pid), { commentCount: increment(1) });
            document.querySelectorAll(`[id^="comment-count-${pid}-"]`).forEach(el => {
                const newCount = (parseInt(el.textContent) || 0) + 1;
                el.textContent = newCount;
                if(newCount > 0) el.classList.add('has-comments');
                el.style.transform = 'scale(1.3)';
                setTimeout(() => el.style.transform = '', 300);
            });
            if(replyState) {
                // Notify the comment author that someone replied to their comment
                const replyCommentDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', pid, 'comments', replyState.commentId));
                if(replyCommentDoc.exists()) {
                    const replyCommentData = replyCommentDoc.data();
                    if(replyCommentData.uid !== currentUser.uid) {
                        addDoc(collection(db, 'artifacts', appId, 'users', replyCommentData.uid, 'notifications'), {
                            type: 'comment_reply', postId: pid, commentId: newCommentRef.id, fromUid: currentUser.uid, fromName: myName, read: false, createdAt: serverTimestamp()
                        });
                    }
                }
                cancelCommentReply(pid, ctx);
            } else {
                const p = allPostsCache.find(x => x.id === pid);
                if(p && p.uid !== currentUser.uid) {
                    addDoc(collection(db, 'artifacts', appId, 'users', p.uid, 'notifications'), {
                        type: 'comment', postId: pid, commentId: newCommentRef.id, fromUid: currentUser.uid, fromName: myName, read: false, createdAt: serverTimestamp()
                    });
                }
            }
            inp.value = '';
        };

        window.toggleTagUserPicker = () => {
            const picker = document.getElementById('user-tag-picker');
            picker.classList.toggle('hidden');
            if(!picker.classList.contains('hidden')) {
                const list = document.getElementById('user-tag-list');
                list.innerHTML = allUsersCache.map(u => `
                    <div class="flex items-center gap-2 p-1 hover:bg-slate-50 cursor-pointer transition-colors" onclick="toggleUserTag('${u.id}', '${u.name}')">
                        <img src="${u.photoURL}" class="w-6 h-6 rounded-full">
                        <span class="text-xs font-bold text-slate-700 truncate">${u.name}</span>
                        ${window.taggedUsers.find(t => t.id === u.id) ? '<i class="fa-solid fa-check text-green-50 ml-auto"></i>' : ''}
                    </div>
                `).join('');
            }
        };

        window.toggleUserTag = (uid, name) => {
            const existing = window.taggedUsers.findIndex(t => t.id === uid);
            if(existing > -1) {
                window.taggedUsers.splice(existing, 1);
            } else {
                window.taggedUsers.push({id: uid, name: name});
            }
            renderTaggedUsers();
            toggleTagUserPicker();
        };

        function renderTaggedUsers() {
             const container = document.getElementById('tagged-users-display');
             if(window.taggedUsers.length === 0) {
                 container.classList.add('hidden');
                 container.innerHTML = '';
                 return;
             }
             container.classList.remove('hidden');
             container.innerHTML = window.taggedUsers.map(t => `
                 <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1 animate-pop-in">
                    @${t.name} 
                    <i class="fa-solid fa-xmark cursor-pointer hover:text-blue-900" onclick="toggleUserTag('${t.id}', '${t.name}')"></i>
                 </span>
             `).join('');
        }

        window.editPost = (pid) => {
            const p = allPostsCache.find(x => x.id === pid);
            if(!p) return;
            editModeId = pid;
            currentAttachmentFile = null;
            currentAttachmentType = p.attachmentType || null;
            
            document.getElementById('modal-title').innerText = "Edit Post";
            document.getElementById('post-input').value = p.text || "";
            document.getElementById('post-submit-btn').innerText = "Update Post";
            
            const typeSelect = document.getElementById('post-type-select');
            typeSelect.value = p.type || 'regular';
            if(p.type === 'project') {
                document.getElementById('project-tags-input').classList.remove('hidden');
                document.getElementById('tags-input').value = (p.tags || []).join(', ');
            }
            
            if(p.attachment) {
                 currentAttachment = p.attachment;
                 const isVideo = p.attachmentType === 'video' || /\.(mp4|webm|mov|ogg)($|\?)/i.test(p.attachment) || p.attachment.includes('/video/upload/');
                 const previewImg = document.getElementById('preview-img');
                 const previewVid = document.getElementById('preview-vid');
                 if(isVideo) {
                     previewImg.classList.add('hidden');
                     previewVid.src = currentAttachment;
                     previewVid.classList.remove('hidden');
                     currentAttachmentType = 'video';
                 } else {
                     previewVid.classList.add('hidden');
                     previewImg.src = currentAttachment;
                     previewImg.classList.remove('hidden');
                 }
                 document.getElementById('attachment-preview').classList.remove('hidden');
            }
            
            document.getElementById('url-paste-container').classList.add('hidden');
            document.getElementById('url-paste-input').value = '';
            
            window.taggedUsers = p.taggedUsers || [];
            renderTaggedUsers();
            
            document.getElementById('post-modal').classList.remove('hidden');
        };

        window.openPostModal = (type='regular') => {
             editModeId = null;
             currentAttachment = null;
             currentAttachmentFile = null;
             currentAttachmentType = null;
             window.taggedUsers = [];
             renderTaggedUsers();
             document.getElementById('attachment-preview').classList.add('hidden');
             document.getElementById('preview-img').classList.remove('hidden');
             document.getElementById('preview-vid').classList.add('hidden');
             document.getElementById('url-paste-input').value = '';
             document.getElementById('url-paste-container').classList.add('hidden');
             document.getElementById('modal-title').innerText = "Create Post";
             document.getElementById('post-submit-btn').innerText = "Post";
             document.getElementById('post-input').value = "";
             document.getElementById('project-tags-input').classList.add('hidden');
             
             document.getElementById('post-modal').classList.remove('hidden');
             if(type === 'project') document.getElementById('post-type-select').value = 'project';
             document.getElementById('post-input').focus();
        };
        
        window.closePostModal = () => document.getElementById('post-modal').classList.add('hidden');
        
        window.submitPost = async () => {
             const text = document.getElementById('post-input').value;
             const type = document.getElementById('post-type-select').value;
             
             if(!text.trim() && !currentAttachment) return;
             
             const userHeadline = document.getElementById('edit-headline').value || "Member";
             const submitBtn = document.getElementById('post-submit-btn');
             submitBtn.disabled = true;
             submitBtn.innerText = currentAttachmentFile ? 'Uploading...' : 'Posting...';

             let attachmentUrl = currentAttachment;
             let cldPublicId = null;
             let cldResourceType = null;
             let attType = currentAttachmentType;

             if (currentAttachmentFile && cloudinaryConfig) {
                 const result = await uploadToCloudinary(currentAttachmentFile);
                 if (result) {
                     attachmentUrl = result.url;
                     cldPublicId = result.publicId;
                     cldResourceType = result.resourceType;
                 } else {
                     showToast('Upload failed. Try again.');
                     submitBtn.disabled = false;
                     submitBtn.innerText = editModeId ? 'Update Post' : 'Post';
                     return;
                 }
             }

             closePostModal();
             
             const postData = {
                 text: text,
                 type: type,
                 uid: currentUser.uid,
                 name: document.getElementById('menu-name').innerText,
                 photoURL: document.getElementById('nav-avatar').src,
                 headline: userHeadline, 
                 attachment: attachmentUrl || null,
                 attachmentType: attType || null,
                 cloudinaryPublicId: cldPublicId || null,
                 cloudinaryResourceType: cldResourceType || null,
                 taggedUsers: window.taggedUsers,
                 tags: type==='project'? document.getElementById('tags-input').value.split(',').map(s=>s.trim().replace('#','')).filter(s=>s) : [],
                 lastEdited: serverTimestamp()
             };

             if (editModeId) {
                 const oldPost = allPostsCache.find(p => p.id === editModeId);
                 if (oldPost && oldPost.cloudinaryPublicId && oldPost.attachment !== attachmentUrl) {
                     deleteFromCloudinary(oldPost.cloudinaryPublicId, oldPost.cloudinaryResourceType || 'image');
                 }
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', editModeId), postData);
                 editModeId = null; 
             } else {
                 postData.likes = 0;
                 postData.createdAt = serverTimestamp();
                 const newPostRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), postData);
                 
                 if(window.taggedUsers.length > 0) {
                     window.taggedUsers.forEach(u => {
                         if(u.id !== currentUser.uid) {
                             addDoc(collection(db, 'artifacts', appId, 'users', u.id, 'notifications'), {
                                type: 'tag',
                                fromUid: currentUser.uid,
                                fromName: currentUser.displayName,
                                postId: newPostRef.id,
                                read: false,
                                createdAt: serverTimestamp()
                             });
                         }
                     });
                 }
             }

             document.getElementById('post-input').value = '';
             currentAttachment = null;
             currentAttachmentFile = null;
             currentAttachmentType = null;
             window.taggedUsers = [];
             document.getElementById('attachment-preview').classList.add('hidden');
             submitBtn.disabled = false;
             submitBtn.innerText = 'Post';
        };

        let postToDeleteOwnerUid = null;

        window.initiateDelete = (pid, ownerUid) => {
            postToDeleteId = pid;
            postToDeleteOwnerUid = ownerUid;
            document.getElementById('delete-modal').classList.remove('hidden', 'opacity-0');
        };

        window.closeDeleteModal = () => {
            postToDeleteId = null;
            postToDeleteOwnerUid = null;
            document.getElementById('delete-modal').classList.add('hidden', 'opacity-0');
        };

        window.executeDelete = async () => {
             if(postToDeleteId) {
                 const post = allPostsCache.find(p => p.id === postToDeleteId);
                 if (post && post.cloudinaryPublicId) {
                     deleteFromCloudinary(post.cloudinaryPublicId, post.cloudinaryResourceType || 'image');
                 }

                 await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', postToDeleteId));
                 
                 if(checkIsAdmin(currentUser.email) && postToDeleteOwnerUid !== currentUser.uid) {
                     await addDoc(collection(db, 'artifacts', appId, 'users', postToDeleteOwnerUid, 'notifications'), {
                        type: 'admin_delete',
                        fromUid: 'admin',
                        fromName: 'Lumini Admin',
                        read: false,
                        createdAt: serverTimestamp()
                     });
                 }
             }
             closeDeleteModal();
        };

        window.confirmDelete = window.executeDelete;

        window.handleFileSelect = (input) => {
             if(input.files && input.files[0]) {
                 const file = input.files[0];
                 const isVideo = file.type.startsWith('video/');
                 currentAttachmentFile = file;
                 currentAttachmentType = isVideo ? 'video' : 'image';
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     currentAttachment = e.target.result;
                     const previewImg = document.getElementById('preview-img');
                     const previewVid = document.getElementById('preview-vid');
                     if(isVideo) {
                         previewImg.classList.add('hidden');
                         previewVid.src = currentAttachment;
                         previewVid.classList.remove('hidden');
                     } else {
                         previewVid.classList.add('hidden');
                         previewImg.src = currentAttachment;
                         previewImg.classList.remove('hidden');
                     }
                     document.getElementById('attachment-preview').classList.remove('hidden');
                 };
                 reader.readAsDataURL(file);
             }
        };
        
        window.clearAttachment = () => {
            currentAttachment = null;
            currentAttachmentFile = null;
            currentAttachmentType = null;
            document.getElementById('file-input').value = '';
            document.getElementById('url-paste-input').value = '';
            document.getElementById('preview-img').classList.remove('hidden');
            document.getElementById('preview-vid').classList.add('hidden');
            document.getElementById('attachment-preview').classList.add('hidden');
        };

        window.handleUrlPaste = () => {
            const url = document.getElementById('url-paste-input').value.trim();
            if(!url) return;
            const isVideo = /\.(mp4|webm|mov|ogg|avi|mkv)($|\?)/i.test(url) || url.includes('/video/');
            currentAttachment = url;
            currentAttachmentFile = null;
            currentAttachmentType = isVideo ? 'video' : 'image';
            const previewImg = document.getElementById('preview-img');
            const previewVid = document.getElementById('preview-vid');
            if(isVideo) {
                previewImg.classList.add('hidden');
                previewVid.src = url;
                previewVid.classList.remove('hidden');
            } else {
                previewVid.classList.add('hidden');
                previewImg.src = url;
                previewImg.classList.remove('hidden');
            }
            document.getElementById('attachment-preview').classList.remove('hidden');
            document.getElementById('url-paste-container').classList.add('hidden');
        };

        window.toggleUrlPasteInput = () => {
            const container = document.getElementById('url-paste-container');
            container.classList.toggle('hidden');
            if(!container.classList.contains('hidden')) {
                document.getElementById('url-paste-input').focus();
            }
        };

        // ========== CHAT MEDIA & VOICE FUNCTIONS ==========

        function formatFileSize(bytes) {
            if(bytes < 1024) return bytes + ' B';
            if(bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
            return (bytes/1048576).toFixed(1) + ' MB';
        }

        function showChatAttachPreview() {
            const el = document.getElementById('chat-attach-preview');
            const thumb = document.getElementById('chat-attach-thumb');
            const nameEl = document.getElementById('chat-attach-name');
            const sizeEl = document.getElementById('chat-attach-size');
            if(!chatAttachment) { el.classList.add('hidden'); return; }
            el.classList.remove('hidden');
            nameEl.textContent = chatAttachment.name || 'Attachment';
            sizeEl.textContent = chatAttachment.size || '';
            thumb.innerHTML = '';
            if(chatAttachment.type === 'image') {
                thumb.innerHTML = `<img src="${chatAttachment.data}" alt="preview">`;
            } else if(chatAttachment.type === 'video') {
                thumb.innerHTML = `<video src="${chatAttachment.data}" style="max-height:60px;max-width:80px;border-radius:8px;"></video>`;
            } else {
                const icon = chatAttachment.mimeType && chatAttachment.mimeType.startsWith('application/pdf') ? 'fa-file-pdf text-red-500' : 'fa-file text-blue-500';
                thumb.innerHTML = `<i class="fa-solid ${icon} text-2xl"></i>`;
            }
        }

        window.clearChatAttachment = () => {
            chatAttachment = null;
            document.getElementById('chat-attach-preview').classList.add('hidden');
            document.getElementById('chat-img-input').value = '';
            document.getElementById('chat-file-input').value = '';
        };

        window.handleChatMediaSelect = (input) => {
            if(!input.files || !input.files[0]) return;
            const file = input.files[0];
            const isVideo = file.type.startsWith('video/');
            const reader = new FileReader();
            reader.onload = (e) => {
                chatAttachment = {
                    type: isVideo ? 'video' : 'image',
                    data: e.target.result,
                    name: file.name,
                    size: formatFileSize(file.size),
                    mimeType: file.type,
                    file: file
                };
                showChatAttachPreview();
            };
            reader.readAsDataURL(file);
        };

        window.handleChatFileSelect = (input) => {
            if(!input.files || !input.files[0]) return;
            const file = input.files[0];
            if(file.type.startsWith('image/') || file.type.startsWith('video/')) {
                return handleChatMediaSelect(input);
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                chatAttachment = {
                    type: 'file',
                    data: e.target.result,
                    name: file.name,
                    size: formatFileSize(file.size),
                    mimeType: file.type,
                    file: file
                };
                showChatAttachPreview();
            };
            reader.readAsDataURL(file);
        };

        // --- VOICE RECORDING ---
        window.toggleVoiceRecording = async () => {
            if(voiceMediaRecorder && voiceMediaRecorder.state === 'recording') {
                stopAndSendVoice();
                return;
            }
            try {
                voiceRecStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceChunks = [];
                
                // Try to use webm, fallback to whatever is supported
                const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 
                                 MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' :
                                 MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
                voiceMediaRecorder = mimeType ? new MediaRecorder(voiceRecStream, { mimeType }) : new MediaRecorder(voiceRecStream);
                voiceMediaRecorder.ondataavailable = (e) => { if(e.data.size > 0) voiceChunks.push(e.data); };
                voiceMediaRecorder.onstop = () => {};
                voiceMediaRecorder.start(100);
                voiceRecStartTime = Date.now();

                // Show recording bar, hide form
                document.getElementById('voice-rec-bar').classList.remove('hidden');
                document.getElementById('message-form').classList.add('hidden');

                // Timer
                const timerEl = document.getElementById('voice-rec-timer');
                voiceRecInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - voiceRecStartTime) / 1000);
                    const m = Math.floor(elapsed/60), s = elapsed%60;
                    timerEl.textContent = m + ':' + String(s).padStart(2,'0');
                }, 200);

                // Live waveform bars
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioCtx.createAnalyser();
                analyser.fftSize = 64;
                const source = audioCtx.createMediaStreamSource(voiceRecStream);
                source.connect(analyser);
                const waveEl = document.getElementById('voice-rec-waveform');
                const bufLen = analyser.frequencyBinCount;
                const dataArr = new Uint8Array(bufLen);
                function drawWave() {
                    if(!voiceMediaRecorder || voiceMediaRecorder.state !== 'recording') return;
                    analyser.getByteFrequencyData(dataArr);
                    let html = '';
                    for(let i=0;i<28;i++) {
                        const v = dataArr[Math.floor(i*bufLen/28)] / 255;
                        html += `<div class="voice-waveform-bar" style="height:${Math.max(3,v*26)}px;background:rgba(239,68,68,${0.3+v*0.7})"></div>`;
                    }
                    waveEl.innerHTML = html;
                    requestAnimationFrame(drawWave);
                }
                drawWave();
                voiceMediaRecorder._audioCtx = audioCtx;
            } catch(err) {
                showToast('Microphone access denied');
            }
        };

        window.cancelVoiceRecording = () => {
            if(voiceMediaRecorder && voiceMediaRecorder.state === 'recording') {
                voiceMediaRecorder.stop();
            }
            cleanupVoiceRec();
            document.getElementById('voice-rec-bar').classList.add('hidden');
            document.getElementById('message-form').classList.remove('hidden');
        };

        window.stopAndSendVoice = () => {
            if(!voiceMediaRecorder || voiceMediaRecorder.state !== 'recording') return;
            const duration = (Date.now() - voiceRecStartTime) / 1000;
            voiceMediaRecorder.onstop = () => {
                const blob = new Blob(voiceChunks, { type: voiceMediaRecorder.mimeType || 'audio/webm' });
                const voiceFile = new File([blob], 'voice_message.' + (blob.type.includes('webm') ? 'webm' : 'mp4'), { type: blob.type });
                const reader = new FileReader();
                reader.onload = (e) => {
                    const waveform = Array.from({length:28}, ()=>Math.random()*0.7+0.15);
                    chatAttachment = {
                        type: 'voice',
                        data: e.target.result,
                        name: 'Voice message',
                        size: formatFileSize(blob.size),
                        mimeType: blob.type,
                        duration: duration,
                        waveform: waveform,
                        file: voiceFile
                    };
                    // Auto-send voice message
                    document.getElementById('voice-rec-bar').classList.add('hidden');
                    document.getElementById('message-form').classList.remove('hidden');
                    sendMessage(new Event('submit', {cancelable:true}));
                };
                reader.readAsDataURL(blob);
                cleanupVoiceRec();
            };
            voiceMediaRecorder.stop();
        };

        function cleanupVoiceRec() {
            clearInterval(voiceRecInterval);
            if(voiceRecStream) { voiceRecStream.getTracks().forEach(t=>t.stop()); voiceRecStream = null; }
            if(voiceMediaRecorder && voiceMediaRecorder._audioCtx) { try { voiceMediaRecorder._audioCtx.close(); } catch(e){} }
            voiceMediaRecorder = null;
            voiceChunks = [];
            voiceRecStartTime = null;
        }

        // Voice message playback with waveform progress
        window.playVoiceMsg = (playerEl) => {
            const audio = playerEl.querySelector('audio');
            const btn = playerEl.querySelector('button');
            const durEl = playerEl.querySelector('.voice-duration');
            const waveform = playerEl.querySelector('.voice-waveform');
            const bars = waveform.querySelectorAll('.voice-waveform-bar');
            const totalBars = bars.length;

            if(audio.paused) {
                // Stop any other playing voice
                document.querySelectorAll('.voice-msg-player audio').forEach(a => {
                    if(a !== audio) {
                        a.pause(); a.currentTime=0;
                        const otherPlayer = a.closest('.voice-msg-player');
                        if(otherPlayer) {
                            otherPlayer.querySelector('button i').className = 'fa-solid fa-play text-xs';
                            otherPlayer.querySelectorAll('.voice-waveform-bar').forEach(b => b.classList.remove('played'));
                        }
                    }
                });
                audio.play();
                btn.querySelector('i').className = 'fa-solid fa-pause text-xs';
                audio.onended = () => {
                    btn.querySelector('i').className = 'fa-solid fa-play text-xs';
                    // Keep all bars highlighted when finished
                    bars.forEach(b => b.classList.add('played'));
                    // Show total duration
                    if(isFinite(audio.duration)) {
                        const m = Math.floor(audio.duration/60), s = Math.floor(audio.duration%60);
                        durEl.textContent = m+':'+String(s).padStart(2,'0');
                    }
                };
                audio.ontimeupdate = () => {
                    if(!isFinite(audio.duration)) return;
                    const progress = audio.currentTime / audio.duration;
                    const playedCount = Math.floor(progress * totalBars);
                    bars.forEach((b, i) => {
                        if(i <= playedCount) b.classList.add('played');
                        else b.classList.remove('played');
                    });
                    const rem = audio.duration - audio.currentTime;
                    const m = Math.floor(rem/60), s = Math.floor(rem%60);
                    durEl.textContent = m+':'+String(s).padStart(2,'0');
                };
            } else {
                audio.pause();
                btn.querySelector('i').className = 'fa-solid fa-play text-xs';
            }
        };

        // Seek voice message by clicking on waveform
        window.seekVoice = (event, playerEl) => {
            const audio = playerEl.querySelector('audio');
            const waveform = playerEl.querySelector('.voice-waveform');
            const bars = waveform.querySelectorAll('.voice-waveform-bar');
            const rect = waveform.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const ratio = Math.max(0, Math.min(1, x / rect.width));

            if(isFinite(audio.duration)) {
                audio.currentTime = ratio * audio.duration;
                // Update bars immediately
                const playedCount = Math.floor(ratio * bars.length);
                bars.forEach((b, i) => {
                    if(i <= playedCount) b.classList.add('played');
                    else b.classList.remove('played');
                });
                // Auto-play if paused
                if(audio.paused) {
                    playVoiceMsg(playerEl);
                }
            }
        };

        // ========== END CHAT MEDIA & VOICE ==========

        window.viewMyProfile = () => { if(currentUser) viewProfile(currentUser.uid); };
        window.viewProfile = async (uid) => {
             window.currentViewedUid = uid; 
             
             let user = allUsersCache.find(u => u.id === uid);
             if(!user && uid === currentUser.uid) {
                 user = { name: "Me", photoURL: document.getElementById('nav-avatar').src, headline: "My Headline" };
             } else if (!user) {
                 const uDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', uid));
                 if(uDoc.exists()) {
                     user = uDoc.data();
                 } else {
                     user = { name: "Unknown User", photoURL: "https://placehold.co/100x100" };
                 }
             }
             
             document.getElementById('profile-page-name').innerText = user ? user.name : "User";
             document.getElementById('profile-page-avatar').src = user ? user.photoURL : "https://placehold.co/100x100";
             document.getElementById('profile-page-headline').innerText = user ? (user.headline || "") : "";
             
             // Verified badge
             const verifiedBadge = document.getElementById('profile-verified-badge');
             if(user && user.isVerified) {
                 verifiedBadge.classList.remove('hidden');
             } else {
                 verifiedBadge.classList.add('hidden');
             }
             
             // Admin verify button
             const verifyBtn = document.getElementById('verify-user-btn');
             if(checkIsAdmin(currentUser.email) && uid !== currentUser.uid) {
                 verifyBtn.classList.remove('hidden');
                 verifyBtn.classList.add('flex');
                 const btnSpan = verifyBtn.querySelector('span');
                 btnSpan.innerText = user.isVerified ? 'Unverify' : 'Verify';
             } else {
                 verifyBtn.classList.add('hidden');
             }
             
             const dateSpan = document.getElementById('profile-join-date');
             if (user.createdAt) {
                 const date = new Date(user.createdAt.seconds * 1000);
                 dateSpan.innerText = date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
             } else {
                 dateSpan.innerText = "Unknown";
             }

             if(uid === currentUser.uid) {
                 document.getElementById('edit-profile-btn').classList.remove('hidden');
                 document.getElementById('follow-btn').classList.add('hidden');
                 document.getElementById('profile-chat-btn').classList.add('hidden');
                 document.getElementById('cover-upload-btn').classList.remove('hidden');
             } else {
                 document.getElementById('edit-profile-btn').classList.add('hidden');
                 document.getElementById('follow-btn').classList.remove('hidden');
                 document.getElementById('profile-chat-btn').classList.remove('hidden');
                 document.getElementById('profile-chat-btn').onclick = () => startChat(uid, user.name);
                 document.getElementById('cover-upload-btn').classList.add('hidden');
             }
             
             const pDoc = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'profile', 'main'));
             
             let followerCount = 0;
             let followingCount = 0;
             
             if(pDoc.exists()) {
                 const d = pDoc.data();
                 document.getElementById('profile-page-bio').innerText = d.bio || "No bio yet.";
                 document.getElementById('profile-full-bio').innerText = d.bio || "No details available.";
                 followerCount = (d.followers || []).length;
                 followingCount = (d.following || []).length;
                 
                 // Cover photo
                 const coverImg = document.getElementById('profile-cover-img');
                 if(d.coverPhoto) {
                     coverImg.src = d.coverPhoto;
                     coverImg.classList.remove('hidden');
                 } else {
                     coverImg.classList.add('hidden');
                 }
                 
                 // Quick Links
                 const linksContainer = document.getElementById('profile-quick-links');
                 const links = d.links || {};
                 const linkItems = [
                     { icon: 'fa-solid fa-globe', label: 'Website', url: links.website },
                     { icon: 'fa-brands fa-github', label: 'GitHub', url: links.github },
                     { icon: 'fa-brands fa-linkedin', label: 'LinkedIn', url: links.linkedin },
                     { icon: 'fa-brands fa-twitter', label: 'Twitter/X', url: links.twitter },
                 ].filter(l => l.url);
                 
                 if(linkItems.length) {
                     linksContainer.innerHTML = linkItems.map(l => `
                         <a href="${l.url}" target="_blank" rel="noopener" class="flex items-center gap-3 text-sm text-slate-500 hover:text-blue-600 transition-colors cursor-pointer group">
                             <i class="${l.icon} w-5 text-center text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                             <span class="truncate">${l.label}</span>
                             <i class="fa-solid fa-arrow-up-right-from-square text-[10px] opacity-0 group-hover:opacity-100 transition-opacity ml-auto text-slate-400"></i>
                         </a>
                     `).join('');
                 } else {
                     linksContainer.innerHTML = '<p class="text-xs text-slate-400 italic">No links added yet.</p>';
                 }
                 
                 // Populate edit modal fields if own profile
                 if(uid === currentUser.uid) {
                     document.getElementById('edit-headline').value = d.headline || '';
                     document.getElementById('edit-bio').value = d.bio || '';
                     document.getElementById('edit-link-website').value = (d.links || {}).website || '';
                     document.getElementById('edit-link-github').value = (d.links || {}).github || '';
                     document.getElementById('edit-link-linkedin').value = (d.links || {}).linkedin || '';
                     document.getElementById('edit-link-twitter').value = (d.links || {}).twitter || '';
                 }
                 
                 if(uid !== currentUser.uid) {
                     const myRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
                     const mySnap = await getDoc(myRef);
                     const isFollowing = mySnap.exists() && (mySnap.data().following || []).includes(uid);
                     
                     const btn = document.getElementById('follow-btn');
                     const btnText = btn.querySelector('span');
                     if(isFollowing) {
                        btnText.innerText = "Unfollow";
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-slate-200', 'text-slate-700');
                     } else {
                        btnText.innerText = "Follow";
                        btn.classList.remove('bg-slate-200', 'text-slate-700');
                        btn.classList.add('bg-blue-600', 'text-white');
                     }
                 }
                 
             } else {
                 document.getElementById('profile-page-bio').innerText = "No bio yet.";
                 document.getElementById('profile-full-bio').innerText = "No details available.";
                 document.getElementById('profile-cover-img').classList.add('hidden');
                 document.getElementById('profile-quick-links').innerHTML = '<p class="text-xs text-slate-400 italic">No links added yet.</p>';
             }
             
             document.getElementById('profile-followers-count').innerText = followerCount;
             document.getElementById('profile-following-count').innerText = followingCount;
             
             if (checkIsAdmin(currentUser.email) && uid !== currentUser.uid) {
                 const isBanned = user.isBanned || false;
                 let adminControls = document.getElementById('admin-controls-container');
                 adminControls.innerHTML = `
                     <div class="flex items-center">
                         <button onclick="toggleBan('${uid}', ${isBanned})" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold text-xs hover:bg-red-200 transition-colors btn-bounce whitespace-nowrap">
                             ${isBanned ? 'Unban User' : 'Ban User'}
                         </button>
                     </div>
                 `;
             } else {
                 document.getElementById('admin-controls-container').innerHTML = '';
             }

             const userPosts = allPostsCache.filter(p => p.uid === uid);
             const profilePostsContainer = document.getElementById('profile-content-posts');
             const pvs = saveVideoStates(profilePostsContainer);
             profilePostsContainer.innerHTML = userPosts.length ? userPosts.map(p => createPostHTML(p, 'profile')).join('') : '<p class="text-center text-slate-400 py-8 animate-fade-in">No posts yet.</p>';
             restoreVideoStates(profilePostsContainer, pvs);
             pvInitVideos(profilePostsContainer);
             
             router('profile');
        };

        window.openSettingsModal = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.closeSettingsModal = () => document.getElementById('settings-modal').classList.add('hidden');
        
         window.saveSettings = async () => {
             const updates = {};
             
             const newName = document.getElementById('settings-username').value;
             if(newName && newName !== currentUser.displayName) {
                 await updateProfile(currentUser, { displayName: newName });
                 updates.name = newName;
             }
             
             if (isResettingSound) {
                 await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                     notificationSound: ""
                 });
                 isResettingSound = false;
             } else if (pendingSoundData) {
                 await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                     notificationSound: pendingSoundData
                 });
                 pendingSoundData = null;
             }

             const isDark = document.getElementById('dark-mode-toggle').checked;
             updates.theme = isDark ? 'dark' : 'light';

             if (Object.keys(updates).length > 0) {
                 await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), updates, { merge: true });
             }
             
             if (newName && newName !== currentUser.displayName) location.reload();
             else {
                 closeSettingsModal();
                 showToast("Settings saved!");
             }
        };

        window.openEditProfileModal = () => document.getElementById('edit-profile-modal').classList.remove('hidden');
        window.closeEditProfileModal = () => document.getElementById('edit-profile-modal').classList.add('hidden');
        
        window.saveProfileData = async () => {
             const headline = document.getElementById('edit-headline').value;
             const bio = document.getElementById('edit-bio').value;
             const links = {
                 website: document.getElementById('edit-link-website').value.trim(),
                 github: document.getElementById('edit-link-github').value.trim(),
                 linkedin: document.getElementById('edit-link-linkedin').value.trim(),
                 twitter: document.getElementById('edit-link-twitter').value.trim(),
             };
             // Remove empty links
             Object.keys(links).forEach(k => { if(!links[k]) delete links[k]; });
             
             await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                 headline, bio, links, savedPosts: mySavedPosts, savedCollections: window.mySavedCollections || {}
             }, { merge: true });
             
             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), {
                 name: currentUser.displayName,
                 photoURL: currentUser.photoURL,
                 headline: headline
             }, { merge: true });
             
             closeEditProfileModal();
             viewMyProfile();
        };

        window.handleCoverPhotoChange = (input) => {
             if(input.files && input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = async (e) => {
                     const dataUrl = e.target.result;
                     await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                         coverPhoto: dataUrl
                     }, { merge: true });
                     const coverImg = document.getElementById('profile-cover-img');
                     coverImg.src = dataUrl;
                     coverImg.classList.remove('hidden');
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        };

        window.handlePfpChange = (input) => {
             if(input.files && input.files[0]) {
                 const reader = new FileReader();
                 reader.onload = async (e) => {
                     const dataUrl = e.target.result;
                     await updateProfile(currentUser, { photoURL: dataUrl });
                     await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users_directory', currentUser.uid), { photoURL: dataUrl }, { merge: true });
                     document.getElementById('edit-modal-avatar').src = dataUrl;
                 };
                 reader.readAsDataURL(input.files[0]);
             }
        };

        window.switchProfileTab = (tab) => {
             document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
             document.getElementById(`tab-${tab}`).classList.add('active');
             
             if(tab === 'posts') {
                 document.getElementById('profile-content-posts').classList.remove('hidden');
                 document.getElementById('profile-content-about').classList.add('hidden');
                 document.getElementById('profile-content-saved').classList.add('hidden');
             } else if(tab === 'about') {
                 document.getElementById('profile-content-posts').classList.add('hidden');
                 document.getElementById('profile-content-about').classList.remove('hidden');
                 document.getElementById('profile-content-saved').classList.add('hidden');
             } else {
                 document.getElementById('profile-content-posts').classList.add('hidden');
                 document.getElementById('profile-content-about').classList.add('hidden');
                 document.getElementById('profile-content-saved').classList.remove('hidden');
             }
        };
        
        window.toggleProfileMenu = () => document.getElementById('profile-menu').classList.toggle('hidden');
        window.toggleNotificationDropdown = () => document.getElementById('notification-dropdown').classList.toggle('hidden');
        
        window.handleSearch = (val) => {
             const dropdown = document.getElementById('search-dropdown');
             if(!val.trim()) { dropdown.classList.add('hidden'); return; }
             
             const matches = allUsersCache.filter(u => u.name.toLowerCase().includes(val.toLowerCase()));
             dropdown.classList.remove('hidden');
             if(!matches.length) { dropdown.innerHTML = `<p class="p-4 text-xs text-slate-400">No users found.</p>`; return; }
             
             dropdown.innerHTML = matches.map(u => `<div onclick="viewProfile('${u.id}')" class="flex items-center gap-3 p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 transition-colors"><img src="${u.photoURL}" class="w-8 h-8 rounded-full bg-slate-200"><span class="font-bold text-sm text-slate-700">${u.name}</span></div>`).join('');
        };
        
        window.toggleEmojiPicker = () => document.getElementById('emoji-picker').classList.toggle('hidden');
        window.insertEmoji = (e) => { document.getElementById('post-input').value += e; };
        window.toggleTagPicker = () => {
             const p = document.getElementById('tag-picker');
             p.classList.toggle('hidden');
             if(!p.classList.contains('hidden')) {
                  document.getElementById('tag-list').innerHTML = `
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600 transition-colors" onclick="addTag('javascript')">#javascript</div>
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600 transition-colors" onclick="addTag('design')">#design</div>
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600 transition-colors" onclick="addTag('react')">#react</div>
                  <div class="p-1 hover:bg-slate-50 cursor-pointer text-xs font-bold text-slate-600 transition-colors" onclick="addTag('firebase')">#firebase</div>
                  `;
             }
        };
        window.addTag = (t) => {
             const el = document.getElementById('post-type-select');
             if(el.value !== 'project') { el.value = 'project'; document.getElementById('project-tags-input').classList.remove('hidden'); }
             const i = document.getElementById('tags-input');
             i.value = i.value ? i.value + ', ' + t : t;
             document.getElementById('tag-picker').classList.add('hidden');
        };

        document.addEventListener('click', (e) => {
            if(!e.target.closest('.relative')) {
                document.getElementById('profile-menu').classList.add('hidden');
                document.getElementById('notification-dropdown').classList.add('hidden');
                document.getElementById('emoji-picker').classList.add('hidden');
                document.getElementById('tag-picker').classList.add('hidden');
                document.getElementById('user-tag-picker').classList.add('hidden');
            }
        });

        window.openClearNotifsModal = () => {
            if(allNotifications.length === 0) return;
            document.getElementById('clear-notifs-modal').classList.remove('hidden');
        };

        window.closeClearNotifsModal = () => {
            document.getElementById('clear-notifs-modal').classList.add('hidden');
        };

        window.executeClearNotifs = async () => {
            closeClearNotifsModal();
            try {
                const batch = writeBatch(db);
                const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications'));
                const snap = await getDocs(q);
                
                snap.forEach(d => {
                    batch.delete(d.ref);
                });
                
                await batch.commit();
            } catch(e) {
                console.error("Error clearing notifications:", e);
                await showAlert("Failed to clear notifications.", "Action failed");
            }
        };
        
        window.clearAllNotifications = window.openClearNotifsModal;

        let reportTargetPostId = null;
        let reportTargetUid = null;

        window.reportPost = (postId, postUid) => {
             reportTargetPostId = postId;
             reportTargetUid = postUid;
             document.getElementById('report-reason').value = ""; 
             document.getElementById('report-modal').classList.remove('hidden');
        };

        window.closeReportModal = () => {
             document.getElementById('report-modal').classList.add('hidden');
             reportTargetPostId = null;
             reportTargetUid = null;
        };

        window.submitReport = async () => {
             const reason = document.getElementById('report-reason').value;
             if (!reason.trim()) {
                 await showAlert("Please provide a reason for the report.", "Missing reason");
                 return;
             }

             const targetUser = allUsersCache.find(u => u.id === reportTargetUid);
             const targetName = targetUser ? targetUser.name : "Unknown User";
             const postLink = window.location.origin + window.location.pathname + "#post-" + reportTargetPostId;

             try {
                 await addDoc(collection(db, 'artifacts', appId, 'reports'), {
                     reporterUid: currentUser.uid,
                     reporterName: currentUser.displayName,
                     reporterEmail: currentUser.email,
                     targetUid: reportTargetUid,
                     targetName: targetName,
                     postId: reportTargetPostId,
                     reason: reason,
                     postLink: postLink,
                     createdAt: serverTimestamp(),
                     status: 'pending' 
                 });

                 const formData = {
                     access_key: "c26a3fd9-3218-48b0-9bb6-217299229a3f",
                     subject: "LUMINI REPORT: Violation Flagged",
                     from_name: "Lumini Security",
                     message: `
                        REPORT DETAILS:
                        ----------------
                        REPORTER: ${currentUser.displayName} (${currentUser.email})
                        TARGET USER: ${targetName}
                        REASON: ${reason}
                        
                        POST LINK: ${postLink}
                        
                        Please investigate immediately.
                     `
                 };

                 await fetch("https://api.web3forms.com/submit", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Accept: "application/json"
                    },
                    body: JSON.stringify(formData)
                 });

                 showToast("Report submitted to admins.");
             } catch (e) {
                 console.error("Error submitting report:", e);
                 await showAlert("Failed to submit report.", "Submission failed");
             }

             closeReportModal();
        };

        // --- FLOATING CHAT WIDGET LOGIC ---

        window.toggleFloatingWidget = () => {
            if(window.hasDraggedWidget) return;
            const widget = document.getElementById('floating-chat-widget');
            const launcher = document.getElementById('floating-launcher');
            window.isFloatingWidgetOpen = !window.isFloatingWidgetOpen;
            if(window.isFloatingWidgetOpen) {
                widget.style.transform = 'scale(1) translateY(0)';
                widget.style.opacity = '1';
                widget.classList.remove('pointer-events-none');
                widget.classList.add('pointer-events-auto');
                launcher.style.transform = 'scale(0) rotate(90deg)';
                launcher.style.opacity = '0';
                launcher.classList.add('pointer-events-none');
                renderFloatingChatList();
            } else {
                widget.style.transform = 'scale(0) translateY(20px)';
                widget.style.opacity = '0';
                widget.classList.add('pointer-events-none');
                widget.classList.remove('pointer-events-auto');
                launcher.style.transform = 'scale(1) rotate(0deg)';
                launcher.style.opacity = '1';
                launcher.classList.remove('pointer-events-none');
                if(window.unsubscribeFloatingMessages) window.unsubscribeFloatingMessages();
                backToFloatingList(); 
            }
        };

        window.renderFloatingChatList = () => {
            const container = document.getElementById('floating-chat-list');
            if(!window.allChats || window.allChats.length === 0) {
                 container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;padding:40px 16px;"><i class="fa-regular fa-comment-dots" style="font-size:28px;color:#cbd5e1;"></i><p style="font-size:11px;color:#94a3b8;font-weight:500;">No conversations yet</p></div>';
                 return;
            }
            container.innerHTML = window.allChats.map((c, i) => {
                const parts = c.id.split('_');
                const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                const otherUser = allUsersCache.find(u => u.id === otherUid) || { name: "User", photoURL: "https://placehold.co/100x100" };
                const isUnread = c.readBy && !c.readBy.includes(currentUser.uid);
                const isOnline = otherUser.isOnline === true;
                
                return `
                <div onclick="openFloatingChat('${c.id}', '${otherUser.name}')" class="flex items-center gap-3 p-2.5 hover:bg-white rounded-xl cursor-pointer transition-all duration-200 mb-0.5 ${isUnread ? 'bg-blue-50/60' : ''}" style="animation: msgMorphIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; animation-delay: ${i * 0.05}s; writing-mode: horizontal-tb;">
                    <div class="relative flex-shrink-0">
                        <img src="${otherUser.photoURL}" class="w-9 h-9 rounded-full bg-slate-200 object-cover" style="min-width:36px;">
                        ${isOnline ? '<div class="status-dot-online" style="width:10px;height:10px;"></div>' : ''}
                        ${isUnread && !isOnline ? '<div class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-blue-500 rounded-full border-2 border-white" style="animation: pulse 2s infinite;"></div>' : ''}
                    </div>
                    <div class="truncate flex-grow" style="min-width:0;">
                        <p class="font-semibold text-xs text-slate-800 truncate" style="writing-mode: horizontal-tb;">${otherUser.name}</p>
                        ${isUnread ? '<p class="text-[10px] text-blue-600 font-bold">New message</p>' : (isOnline ? '<p class="text-[10px] text-green-500 font-semibold">Online</p>' : '<p class="text-[10px] text-slate-400">Tap to chat</p>')}
                    </div>
                </div>`;
            }).join('');
        };

        window.openFloatingChat = async (chatId, name) => {
            window.currentFloatingChatId = chatId;
            document.getElementById('floating-chat-list').style.display = 'none';
            const convo = document.getElementById('floating-conversation');
            convo.style.display = 'flex';
            convo.style.flexDirection = 'column';
            convo.style.flex = '1';
            convo.style.minHeight = '0';
            document.getElementById('floating-back-btn').classList.remove('hidden');
            document.getElementById('floating-header-title').innerText = name;
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), {
                readBy: arrayUnion(currentUser.uid)
            }, { merge: true });

            if(window.unsubscribeFloatingMessages) window.unsubscribeFloatingMessages();
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages'), orderBy('createdAt', 'asc'));
            window.unsubscribeFloatingMessages = onSnapshot(q, (snap) => {
                const container = document.getElementById('floating-messages');
                container.innerHTML = '';
                const messages = [];
                snap.forEach(d => messages.push({id: d.id, ...d.data()}));
                
                const parts = chatId.split('_');
                const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                
                messages.forEach((m, idx) => {
                    if(m.type === 'system') {
                         container.innerHTML += `<div class="text-[10px] text-center text-slate-400 my-2 font-medium">${m.text}</div>`;
                         return;
                    }
                    const isMe = m.senderId === currentUser.uid;
                    let timeStr = '';
                    let showTime = false;
                    if(m.createdAt) {
                        const dt = new Date(m.createdAt.toMillis());
                        if(idx === 0) {
                            showTime = true;
                        } else {
                            const prevMsg = messages[idx - 1];
                            if(prevMsg && prevMsg.createdAt) {
                                const gap = m.createdAt.toMillis() - prevMsg.createdAt.toMillis();
                                if(gap > 5 * 60 * 1000) showTime = true;
                            } else {
                                showTime = true;
                            }
                        }
                        if(showTime) {
                            timeStr = dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        }
                    }
                    
                    container.innerHTML += `
                    <div class="flex w-full mb-1 ${isMe?'justify-end':'justify-start'}" style="animation: msgMorphIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;">
                        <div style="max-width: 85%; writing-mode: horizontal-tb;">
                            <div class="px-3 py-2 text-xs leading-relaxed ${isMe ? 'bg-slate-800 text-white rounded-2xl rounded-br-sm' : 'bg-white text-slate-800 rounded-2xl rounded-bl-sm border border-slate-100'}" style="box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                                ${m.text}
                            </div>
                            ${timeStr ? `<div class="text-[9px] mt-0.5 ${isMe ? 'text-right' : 'text-left'}" style="color: rgba(148,163,184,0.6);">${timeStr}</div>` : ''}
                        </div>
                    </div>`;
                });
                
                // Typing indicator
                container.innerHTML += `<div id="floating-typing-indicator" class="hidden flex justify-start mb-1">
                    <div class="typing-indicator" style="padding:8px 14px;">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>`;
                
                container.scrollTop = container.scrollHeight;
            });
            
            // Monitor typing in floating chat
            if(window.unsubFloatingTyping) window.unsubFloatingTyping();
            window.unsubFloatingTyping = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId), (snap) => {
                if(!snap.exists()) return;
                const data = snap.data();
                const parts = chatId.split('_');
                const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
                const otherTyping = data[`typing_${otherUid}`] === true;
                if(window.allChats) {
                    const chatObj = window.allChats.find(ch => ch.id === chatId);
                    if(chatObj && data.readBy) chatObj.readBy = data.readBy;
                }
                updateLiveReadReceipts(chatId, data.readBy || []);
                const indicator = document.getElementById('floating-typing-indicator');
                if(indicator) indicator.classList.toggle('hidden', !otherTyping);
            });
        };

        // Floating chat typing handler
        let floatingTypingTimeout = null;
        let floatingIsTyping = false;
        window.handleFloatingTyping = () => {
            if(!window.currentFloatingChatId || !currentUser) return;
            if(!floatingIsTyping) {
                floatingIsTyping = true;
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', window.currentFloatingChatId), {
                    [`typing_${currentUser.uid}`]: true
                }, { merge: true });
            }
            clearTimeout(floatingTypingTimeout);
            floatingTypingTimeout = setTimeout(() => {
                floatingIsTyping = false;
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', window.currentFloatingChatId), {
                    [`typing_${currentUser.uid}`]: false
                }, { merge: true });
            }, 2000);
        };

        window.backToFloatingList = () => {
            // Clear typing state
            if(window.currentFloatingChatId && currentUser) {
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', window.currentFloatingChatId), {
                    [`typing_${currentUser.uid}`]: false
                }, { merge: true });
            }
            document.getElementById('floating-conversation').style.display = 'none';
            document.getElementById('floating-chat-list').style.display = '';
            document.getElementById('floating-back-btn').classList.add('hidden');
            document.getElementById('floating-header-title').innerText = "Messages";
            window.currentFloatingChatId = null;
            if(window.unsubscribeFloatingMessages) {
                window.unsubscribeFloatingMessages();
                window.unsubscribeFloatingMessages = null;
            }
            if(window.unsubFloatingTyping) {
                window.unsubFloatingTyping();
                window.unsubFloatingTyping = null;
            }
        };

        window.sendFloatingMessage = async (e) => {
            e.preventDefault();
            const input = document.getElementById('floating-input');
            const text = input.value.trim();
            if(!text || !window.currentFloatingChatId) return;

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', window.currentFloatingChatId, 'messages'), { 
                text: text, 
                senderId: currentUser.uid, 
                createdAt: serverTimestamp() 
            });
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chats', window.currentFloatingChatId), {
                lastUpdated: serverTimestamp(),
                readBy: [currentUser.uid],
                [`typing_${currentUser.uid}`]: false
            }, { merge: true });
            floatingIsTyping = false;
            clearTimeout(floatingTypingTimeout);
            
            input.value = '';
        };

        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = document.getElementById("floating-header");
            const launcher = document.getElementById("floating-launcher");
            if (header) {
                header.onmousedown = dragMouseDown;
            }
            if (launcher) {
                launcher.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                // Allow clicking buttons inside without dragging
                if(e.target.closest('button') && e.target.id !== 'floating-launcher') return;

                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            let totalDragDistance = 0;
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                totalDragDistance += Math.abs(pos1) + Math.abs(pos2);
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // Only start dragging after moving at least 8px total
                if(totalDragDistance < 8) return;
                
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                elmnt.style.bottom = "auto";
                elmnt.style.right = "auto";
                
                window.hasDraggedWidget = true;
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                totalDragDistance = 0;
                setTimeout(() => { window.hasDraggedWidget = false; }, 150);
            }
        }
        
        // Check if floating widget exists before initializing
        const floatingWidget = document.getElementById("floating-chat-container");
        if(floatingWidget) {
             makeDraggable(floatingWidget);
        }

    </script>
<!-- Image Lightbox Overlay -->
<div id="image-lightbox" onclick="closeLightbox()">
    <div class="lb-close" onclick="closeLightbox()"><i class="fa-solid fa-xmark"></i></div>
    <img id="lightbox-img" src="" alt="Preview" onclick="event.stopPropagation()">
</div>
<script>
    window.openLightbox = function(src) {
        const lb = document.getElementById('image-lightbox');
        const img = document.getElementById('lightbox-img');
        img.src = src;
        lb.classList.add('active');
        document.body.style.overflow = 'hidden';
    };
    window.closeLightbox = function() {
        const lb = document.getElementById('image-lightbox');
        lb.classList.remove('active');
        document.body.style.overflow = '';
    };
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeLightbox();
    });

    // Long-press spotlight for profile pic and cover photo  revamped with progress bar + glow
    function attachLongPressLightbox(elementId) {
        let timer = null;
        let triggered = false;
        let progressInterval = null;
        let progress = 0;
        const HOLD_DURATION = 800; // ms  snappier than before (was 2000)
        const PROGRESS_STEP = 16; // ~60fps

        const attach = () => {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (el._lpAttached) return; // prevent duplicate listeners
            el._lpAttached = true;

            // For <img> elements, we attach overlays to the parent container
            const overlayParent = el.tagName === 'IMG' ? el.parentElement : el;
            overlayParent.style.position = overlayParent.style.position || 'relative';
            overlayParent.style.overflow = 'hidden';
            el.style.cursor = 'pointer';

            // Create progress bar overlay
            let progressBar = overlayParent.querySelector('.lp-progress-bar');
            if (!progressBar) {
                progressBar = document.createElement('div');
                progressBar.className = 'lp-progress-bar';
                overlayParent.appendChild(progressBar);
            }
            // Create glow overlay
            let glow = overlayParent.querySelector('.long-press-glow');
            if (!glow) {
                glow = document.createElement('div');
                glow.className = 'long-press-glow';
                overlayParent.appendChild(glow);
            }

            const start = (e) => {
                triggered = false;
                progress = 0;
                progressBar.style.width = '0%';
                glow.classList.add('active');

                progressInterval = setInterval(() => {
                    progress += (PROGRESS_STEP / HOLD_DURATION) * 100;
                    progressBar.style.width = Math.min(progress, 100) + '%';
                }, PROGRESS_STEP);

                timer = setTimeout(() => {
                    triggered = true;
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    
                    // Haptic-like pulse feedback
                    overlayParent.style.transform = 'scale(0.97)';
                    setTimeout(() => {
                        overlayParent.style.transform = '';
                        overlayParent.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                    }, 100);

                    const src = el.tagName === 'IMG' ? el.src : el.querySelector('img')?.src;
                    if (src && !src.includes('placehold.co')) openLightbox(src);

                    // Clean up visual
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        glow.classList.remove('active');
                    }, 300);
                }, HOLD_DURATION);
            };

            const cancel = (e) => {
                clearTimeout(timer);
                clearInterval(progressInterval);
                progress = 0;
                progressBar.style.width = '0%';
                glow.classList.remove('active');
                if (triggered) { e.preventDefault && e.preventDefault(); e.stopPropagation && e.stopPropagation(); }
            };

            el.addEventListener('mousedown', start);
            el.addEventListener('mouseup', cancel);
            el.addEventListener('mouseleave', cancel);
            el.addEventListener('touchstart', start, { passive: true });
            el.addEventListener('touchend', cancel);
            el.addEventListener('touchcancel', cancel);
        };
        // Attach now and re-attach on route changes
        attach();
        const observer = new MutationObserver(() => { attach(); });
        observer.observe(document.body, { childList: true, subtree: true });
    }
    // Attach to profile avatar and cover photo once DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        attachLongPressLightbox('profile-page-avatar');
        attachLongPressLightbox('profile-cover-img');
    });
</script>
</body>
</html>
